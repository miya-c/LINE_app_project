<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>警告フラグ機能テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #0066cc;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 5px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .warning-flag {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        .flag-normal { background-color: #d4edda; color: #155724; }
        .flag-warning { background-color: #fff3cd; color: #856404; }
        .flag-input-wait { background-color: #e2e3e5; color: #383d41; }
        .flag-undetermined { background-color: #f8d7da; color: #721c24; }
        .flag-error { background-color: #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚨 警告フラグ機能テスト</h1>
        
        <div class="test-section">
            <h2>1. 警告フラグ計算テスト</h2>
            <div class="input-group">
                <label>今回指示数:</label>
                <input type="number" id="currentReading" value="150" step="0.01">
            </div>
            <div class="input-group">
                <label>前回指示数:</label>
                <input type="number" id="previousReading" value="100" step="0.01">
            </div>
            <div class="input-group">
                <label>前々回指示数:</label>
                <input type="number" id="previousPreviousReading" value="80" step="0.01">
            </div>
            <div class="input-group">
                <label>前々々回指示数:</label>
                <input type="number" id="threeTimesPreviousReading" value="60" step="0.01">
            </div>
            <button onclick="testWarningFlagCalculation()">警告フラグを計算</button>
            <div id="calculationResults" class="results"></div>
        </div>

        <div class="test-section">
            <h2>2. GAS送信データ構造テスト</h2>
            <div class="input-group">
                <label>物件ID:</label>
                <input type="text" id="propertyId" value="P000001">
            </div>
            <div class="input-group">
                <label>部屋ID:</label>
                <input type="text" id="roomId" value="R000001">
            </div>
            <div class="input-group">
                <label>GAS Web App URL:</label>
                <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <button onclick="testGASDataStructure()">送信データ構造を確認</button>
            <div id="dataStructureResults" class="results"></div>
        </div>

        <div class="test-section">
            <h2>3. 各警告フラグパターンテスト</h2>
            <button onclick="testAllWarningFlagPatterns()">全パターンをテスト</button>
            <div id="patternResults" class="results"></div>
        </div>
    </div>

    <script>
        // meter_reading.htmlから警告フラグ計算ロジックをコピー
        const calculateThreshold = (previousReading, previousPreviousReading, threeTimesPreviousReading) => {
            try {
                const validReadings = [];
                
                if (typeof previousReading === 'number' && !isNaN(previousReading) && previousReading >= 0) {
                    validReadings.push(previousReading);
                }
                if (typeof previousPreviousReading === 'number' && !isNaN(previousPreviousReading) && previousPreviousReading >= 0) {
                    validReadings.push(previousPreviousReading);
                }
                if (typeof threeTimesPreviousReading === 'number' && !isNaN(threeTimesPreviousReading) && threeTimesPreviousReading >= 0) {
                    validReadings.push(threeTimesPreviousReading);
                }
                
                if (validReadings.length < 2) {
                    return {
                        isCalculable: false,
                        standardDeviation: 0,
                        threshold: 0,
                        reason: `履歴データ不足（有効なデータ${validReadings.length}件、最低2件必要）`
                    };
                }
                
                const mean = validReadings.reduce((sum, val) => sum + val, 0) / validReadings.length;
                const variance = validReadings.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (validReadings.length - 1);
                const standardDeviation = Math.sqrt(variance);
                const threshold = mean + (2 * standardDeviation);
                
                return {
                    isCalculable: true,
                    standardDeviation: Math.round(standardDeviation * 100) / 100,
                    threshold: Math.round(threshold * 100) / 100,
                    validReadings: validReadings,
                    mean: Math.round(mean * 100) / 100,
                    reason: `計算成功（履歴${validReadings.length}件使用）`
                };
            } catch (error) {
                return {
                    isCalculable: false,
                    standardDeviation: 0,
                    threshold: 0,
                    reason: `計算エラー: ${error.message}`
                };
            }
        };

        const calculateWarningFlag = (currentReading, previousReading, previousPreviousReading, threeTimesPreviousReading) => {
            try {
                const thresholdInfo = calculateThreshold(previousReading, previousPreviousReading, threeTimesPreviousReading);
                
                if (currentReading === null || currentReading === undefined || currentReading === '' || 
                    typeof currentReading !== 'number' || isNaN(currentReading) || currentReading < 0) {
                    return {
                        warningFlag: thresholdInfo.isCalculable ? '入力待ち' : '判定不可',
                        standardDeviation: thresholdInfo.standardDeviation,
                        threshold: thresholdInfo.threshold,
                        reason: thresholdInfo.reason
                    };
                }
                
                if (typeof previousReading === 'number' && !isNaN(previousReading) && previousReading >= 0) {
                    if (currentReading < previousReading) {
                        return {
                            warningFlag: '要確認',
                            standardDeviation: thresholdInfo.standardDeviation,
                            threshold: thresholdInfo.threshold,
                            reason: '前回値未満'
                        };
                    }
                }
                
                if (!thresholdInfo.isCalculable) {
                    return {
                        warningFlag: '正常',
                        standardDeviation: 0,
                        threshold: 0,
                        reason: thresholdInfo.reason
                    };
                }
                
                const warningFlag = (currentReading > thresholdInfo.threshold) ? '要確認' : '正常';
                
                return {
                    warningFlag: warningFlag,
                    standardDeviation: thresholdInfo.standardDeviation,
                    threshold: thresholdInfo.threshold,
                    reason: thresholdInfo.reason
                };
                
            } catch (error) {
                return {
                    warningFlag: 'エラー',
                    standardDeviation: 0,
                    threshold: 0,
                    reason: 'エラー'
                };
            }
        };

        function testWarningFlagCalculation() {
            const currentReading = parseFloat(document.getElementById('currentReading').value);
            const previousReading = parseFloat(document.getElementById('previousReading').value);
            const previousPreviousReading = parseFloat(document.getElementById('previousPreviousReading').value);
            const threeTimesPreviousReading = parseFloat(document.getElementById('threeTimesPreviousReading').value);
            
            const result = calculateWarningFlag(currentReading, previousReading, previousPreviousReading, threeTimesPreviousReading);
            
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
=== 警告フラグ計算結果 ===
入力値:
  今回指示数: ${currentReading}
  前回指示数: ${previousReading}
  前々回指示数: ${previousPreviousReading}
  前々々回指示数: ${threeTimesPreviousReading}

計算結果:
  警告フラグ: ${result.warningFlag}
  標準偏差: ${result.standardDeviation}
  閾値: ${result.threshold}
  理由: ${result.reason}

GAS送信用データ構造:
{
  "date": "${new Date().toISOString().split('T')[0]}",
  "currentReading": ${currentReading},
  "warningFlag": "${result.warningFlag}"
}
            `;
        }

        function testGASDataStructure() {
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            const gasUrl = document.getElementById('gasUrl').value;
            
            // テスト用のupdatedReadings配列を作成
            const updatedReadings = [
                {
                    date: "2024-01-15",
                    currentReading: 150.5,
                    warningFlag: "正常"
                },
                {
                    date: "2024-01-16", 
                    currentReading: 145.2,
                    warningFlag: "要確認"
                }
            ];
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: propertyId,
                roomId: roomId,
                readings: JSON.stringify(updatedReadings)
            });
            
            const requestUrl = `${gasUrl}?${params}`;
            
            const resultsDiv = document.getElementById('dataStructureResults');
            resultsDiv.innerHTML = `
=== GAS送信データ構造 ===
送信URL: ${requestUrl}

送信パラメータ:
  action: "updateMeterReadings"
  propertyId: "${propertyId}"
  roomId: "${roomId}"
  readings: ${JSON.stringify(updatedReadings, null, 2)}

URLエンコード後の全体:
${requestUrl}

GAS側で受信される値:
  e.parameter.action = "updateMeterReadings"
  e.parameter.propertyId = "${propertyId}"
  e.parameter.roomId = "${roomId}"
  e.parameter.readings = "${JSON.stringify(updatedReadings)}"
  
  JSON.parse(e.parameter.readings) = ${JSON.stringify(updatedReadings, null, 2)}
            `;
        }

        function testAllWarningFlagPatterns() {
            const testCases = [
                { name: "正常パターン", current: 150, prev: 100, prevPrev: 80, prevPrevPrev: 60 },
                { name: "要確認（閾値超過）", current: 200, prev: 100, prev2: 80, prev3: 60 },
                { name: "要確認（前回値未満）", current: 90, prev: 100, prev2: 80, prev3: 60 },
                { name: "入力待ち", current: null, prev: 100, prev2: 80, prev3: 60 },
                { name: "判定不可（履歴不足）", current: 150, prev: null, prev2: null, prev3: null },
                { name: "履歴データ1件のみ", current: 150, prev: 100, prev2: null, prev3: null }
            ];
            
            let results = "=== 全パターンテスト結果 ===\n\n";
            
            testCases.forEach((testCase, index) => {
                const result = calculateWarningFlag(
                    testCase.current, 
                    testCase.prev, 
                    testCase.prev2, 
                    testCase.prev3
                );
                
                results += `${index + 1}. ${testCase.name}\n`;
                results += `   入力: 今回=${testCase.current}, 前回=${testCase.prev}, 前々回=${testCase.prev2}, 前々々回=${testCase.prev3}\n`;
                results += `   結果: 警告フラグ="${result.warningFlag}", 標準偏差=${result.standardDeviation}, 閾値=${result.threshold}\n`;
                results += `   理由: ${result.reason}\n\n`;
            });
            
            document.getElementById('patternResults').innerHTML = results;
        }

        // 初期テスト実行
        window.onload = function() {
            testWarningFlagCalculation();
            testAllWarningFlagPatterns();
        };
    </script>
</body>
</html>
