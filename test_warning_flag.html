<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­¦å‘Šãƒ•ãƒ©ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #0066cc;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 5px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .warning-flag {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        .flag-normal { background-color: #d4edda; color: #155724; }
        .flag-warning { background-color: #fff3cd; color: #856404; }
        .flag-input-wait { background-color: #e2e3e5; color: #383d41; }
        .flag-undetermined { background-color: #f8d7da; color: #721c24; }
        .flag-error { background-color: #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš¨ è­¦å‘Šãƒ•ãƒ©ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>1. è­¦å‘Šãƒ•ãƒ©ã‚°è¨ˆç®—ãƒ†ã‚¹ãƒˆ</h2>
            <div class="input-group">
                <label>ä»Šå›æŒ‡ç¤ºæ•°:</label>
                <input type="number" id="currentReading" value="150" step="0.01">
            </div>
            <div class="input-group">
                <label>å‰å›æŒ‡ç¤ºæ•°:</label>
                <input type="number" id="previousReading" value="100" step="0.01">
            </div>
            <div class="input-group">
                <label>å‰ã€…å›æŒ‡ç¤ºæ•°:</label>
                <input type="number" id="previousPreviousReading" value="80" step="0.01">
            </div>
            <div class="input-group">
                <label>å‰ã€…ã€…å›æŒ‡ç¤ºæ•°:</label>
                <input type="number" id="threeTimesPreviousReading" value="60" step="0.01">
            </div>
            <button onclick="testWarningFlagCalculation()">è­¦å‘Šãƒ•ãƒ©ã‚°ã‚’è¨ˆç®—</button>
            <div id="calculationResults" class="results"></div>
        </div>

        <div class="test-section">
            <h2>2. GASé€ä¿¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒ†ã‚¹ãƒˆ</h2>
            <div class="input-group">
                <label>ç‰©ä»¶ID:</label>
                <input type="text" id="propertyId" value="P000001">
            </div>
            <div class="input-group">
                <label>éƒ¨å±‹ID:</label>
                <input type="text" id="roomId" value="R000001">
            </div>
            <div class="input-group">
                <label>GAS Web App URL:</label>
                <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <button onclick="testGASDataStructure()">é€ä¿¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª</button>
            <div id="dataStructureResults" class="results"></div>
        </div>

        <div class="test-section">
            <h2>3. å„è­¦å‘Šãƒ•ãƒ©ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testAllWarningFlagPatterns()">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="patternResults" class="results"></div>
        </div>
    </div>

    <script>
        // meter_reading.htmlã‹ã‚‰è­¦å‘Šãƒ•ãƒ©ã‚°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼
        const calculateThreshold = (previousReading, previousPreviousReading, threeTimesPreviousReading) => {
            try {
                const validReadings = [];
                
                if (typeof previousReading === 'number' && !isNaN(previousReading) && previousReading >= 0) {
                    validReadings.push(previousReading);
                }
                if (typeof previousPreviousReading === 'number' && !isNaN(previousPreviousReading) && previousPreviousReading >= 0) {
                    validReadings.push(previousPreviousReading);
                }
                if (typeof threeTimesPreviousReading === 'number' && !isNaN(threeTimesPreviousReading) && threeTimesPreviousReading >= 0) {
                    validReadings.push(threeTimesPreviousReading);
                }
                
                if (validReadings.length < 2) {
                    return {
                        isCalculable: false,
                        standardDeviation: 0,
                        threshold: 0,
                        reason: `å±¥æ­´ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼ˆæœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿${validReadings.length}ä»¶ã€æœ€ä½2ä»¶å¿…è¦ï¼‰`
                    };
                }
                
                const mean = validReadings.reduce((sum, val) => sum + val, 0) / validReadings.length;
                const variance = validReadings.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (validReadings.length - 1);
                const standardDeviation = Math.sqrt(variance);
                const threshold = mean + (2 * standardDeviation);
                
                return {
                    isCalculable: true,
                    standardDeviation: Math.round(standardDeviation * 100) / 100,
                    threshold: Math.round(threshold * 100) / 100,
                    validReadings: validReadings,
                    mean: Math.round(mean * 100) / 100,
                    reason: `è¨ˆç®—æˆåŠŸï¼ˆå±¥æ­´${validReadings.length}ä»¶ä½¿ç”¨ï¼‰`
                };
            } catch (error) {
                return {
                    isCalculable: false,
                    standardDeviation: 0,
                    threshold: 0,
                    reason: `è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        };

        const calculateWarningFlag = (currentReading, previousReading, previousPreviousReading, threeTimesPreviousReading) => {
            try {
                const thresholdInfo = calculateThreshold(previousReading, previousPreviousReading, threeTimesPreviousReading);
                
                if (currentReading === null || currentReading === undefined || currentReading === '' || 
                    typeof currentReading !== 'number' || isNaN(currentReading) || currentReading < 0) {
                    return {
                        warningFlag: thresholdInfo.isCalculable ? 'å…¥åŠ›å¾…ã¡' : 'åˆ¤å®šä¸å¯',
                        standardDeviation: thresholdInfo.standardDeviation,
                        threshold: thresholdInfo.threshold,
                        reason: thresholdInfo.reason
                    };
                }
                
                if (typeof previousReading === 'number' && !isNaN(previousReading) && previousReading >= 0) {
                    if (currentReading < previousReading) {
                        return {
                            warningFlag: 'è¦ç¢ºèª',
                            standardDeviation: thresholdInfo.standardDeviation,
                            threshold: thresholdInfo.threshold,
                            reason: 'å‰å›å€¤æœªæº€'
                        };
                    }
                }
                
                if (!thresholdInfo.isCalculable) {
                    return {
                        warningFlag: 'æ­£å¸¸',
                        standardDeviation: 0,
                        threshold: 0,
                        reason: thresholdInfo.reason
                    };
                }
                
                const warningFlag = (currentReading > thresholdInfo.threshold) ? 'è¦ç¢ºèª' : 'æ­£å¸¸';
                
                return {
                    warningFlag: warningFlag,
                    standardDeviation: thresholdInfo.standardDeviation,
                    threshold: thresholdInfo.threshold,
                    reason: thresholdInfo.reason
                };
                
            } catch (error) {
                return {
                    warningFlag: 'ã‚¨ãƒ©ãƒ¼',
                    standardDeviation: 0,
                    threshold: 0,
                    reason: 'ã‚¨ãƒ©ãƒ¼'
                };
            }
        };

        function testWarningFlagCalculation() {
            const currentReading = parseFloat(document.getElementById('currentReading').value);
            const previousReading = parseFloat(document.getElementById('previousReading').value);
            const previousPreviousReading = parseFloat(document.getElementById('previousPreviousReading').value);
            const threeTimesPreviousReading = parseFloat(document.getElementById('threeTimesPreviousReading').value);
            
            const result = calculateWarningFlag(currentReading, previousReading, previousPreviousReading, threeTimesPreviousReading);
            
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
=== è­¦å‘Šãƒ•ãƒ©ã‚°è¨ˆç®—çµæœ ===
å…¥åŠ›å€¤:
  ä»Šå›æŒ‡ç¤ºæ•°: ${currentReading}
  å‰å›æŒ‡ç¤ºæ•°: ${previousReading}
  å‰ã€…å›æŒ‡ç¤ºæ•°: ${previousPreviousReading}
  å‰ã€…ã€…å›æŒ‡ç¤ºæ•°: ${threeTimesPreviousReading}

è¨ˆç®—çµæœ:
  è­¦å‘Šãƒ•ãƒ©ã‚°: ${result.warningFlag}
  æ¨™æº–åå·®: ${result.standardDeviation}
  é–¾å€¤: ${result.threshold}
  ç†ç”±: ${result.reason}

GASé€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ :
{
  "date": "${new Date().toISOString().split('T')[0]}",
  "currentReading": ${currentReading},
  "warningFlag": "${result.warningFlag}"
}
            `;
        }

        function testGASDataStructure() {
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            const gasUrl = document.getElementById('gasUrl').value;
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®updatedReadingsé…åˆ—ã‚’ä½œæˆ
            const updatedReadings = [
                {
                    date: "2024-01-15",
                    currentReading: 150.5,
                    warningFlag: "æ­£å¸¸"
                },
                {
                    date: "2024-01-16", 
                    currentReading: 145.2,
                    warningFlag: "è¦ç¢ºèª"
                }
            ];
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: propertyId,
                roomId: roomId,
                readings: JSON.stringify(updatedReadings)
            });
            
            const requestUrl = `${gasUrl}?${params}`;
            
            const resultsDiv = document.getElementById('dataStructureResults');
            resultsDiv.innerHTML = `
=== GASé€ä¿¡ãƒ‡ãƒ¼ã‚¿æ§‹é€  ===
é€ä¿¡URL: ${requestUrl}

é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  action: "updateMeterReadings"
  propertyId: "${propertyId}"
  roomId: "${roomId}"
  readings: ${JSON.stringify(updatedReadings, null, 2)}

URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¾Œã®å…¨ä½“:
${requestUrl}

GASå´ã§å—ä¿¡ã•ã‚Œã‚‹å€¤:
  e.parameter.action = "updateMeterReadings"
  e.parameter.propertyId = "${propertyId}"
  e.parameter.roomId = "${roomId}"
  e.parameter.readings = "${JSON.stringify(updatedReadings)}"
  
  JSON.parse(e.parameter.readings) = ${JSON.stringify(updatedReadings, null, 2)}
            `;
        }

        function testAllWarningFlagPatterns() {
            const testCases = [
                { name: "æ­£å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³", current: 150, prev: 100, prevPrev: 80, prevPrevPrev: 60 },
                { name: "è¦ç¢ºèªï¼ˆé–¾å€¤è¶…éï¼‰", current: 200, prev: 100, prev2: 80, prev3: 60 },
                { name: "è¦ç¢ºèªï¼ˆå‰å›å€¤æœªæº€ï¼‰", current: 90, prev: 100, prev2: 80, prev3: 60 },
                { name: "å…¥åŠ›å¾…ã¡", current: null, prev: 100, prev2: 80, prev3: 60 },
                { name: "åˆ¤å®šä¸å¯ï¼ˆå±¥æ­´ä¸è¶³ï¼‰", current: 150, prev: null, prev2: null, prev3: null },
                { name: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿1ä»¶ã®ã¿", current: 150, prev: 100, prev2: null, prev3: null }
            ];
            
            let results = "=== å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆçµæœ ===\n\n";
            
            testCases.forEach((testCase, index) => {
                const result = calculateWarningFlag(
                    testCase.current, 
                    testCase.prev, 
                    testCase.prev2, 
                    testCase.prev3
                );
                
                results += `${index + 1}. ${testCase.name}\n`;
                results += `   å…¥åŠ›: ä»Šå›=${testCase.current}, å‰å›=${testCase.prev}, å‰ã€…å›=${testCase.prev2}, å‰ã€…ã€…å›=${testCase.prev3}\n`;
                results += `   çµæœ: è­¦å‘Šãƒ•ãƒ©ã‚°="${result.warningFlag}", æ¨™æº–åå·®=${result.standardDeviation}, é–¾å€¤=${result.threshold}\n`;
                results += `   ç†ç”±: ${result.reason}\n\n`;
            });
            
            document.getElementById('patternResults').innerHTML = results;
        }

        // åˆæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        window.onload = function() {
            testWarningFlagCalculation();
            testAllWarningFlagPatterns();
        };
    </script>
</body>
</html>
