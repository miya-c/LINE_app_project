<!DOCTYPE html>
<html lang="ja">
<head>
    <title>CSS読み込み問題 - 根本解決版</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 基本的なページスタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f4f8;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .solution {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .comparison-item.before {
            background: #fff5f5;
        }
        
        .comparison-item.after {
            background: #f0fff0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 CSS読み込み問題 - 根本解決案</h1>
        
        <div class="solution">
            <h2>📋 問題の分析結果</h2>
            <p>現在のCSS読み込み検出ロジックで以下の問題が判明しました：</p>
            <ul>
                <li><strong>maxWidth値の不一致</strong>: meter_reading.css では 900px、他は 1200px</li>
                <li><strong>過度に複雑なチェック</strong>: CSSルール数の確認が失敗の原因</li>
                <li><strong>タイムアウトが長すぎる</strong>: 3秒は実用的でない</li>
                <li><strong>条件が厳しすぎる</strong>: 特定の値に依存しすぎている</li>
            </ul>
        </div>
        
        <div class="comparison">
            <div class="comparison-item before">
                <h3>❌ 以前のアプローチ</h3>
                <ul>
                    <li>特定のmaxWidth値をチェック</li>
                    <li>CSSルール数を確認</li>
                    <li>複雑な条件分岐</li>
                    <li>3秒のタイムアウト</li>
                </ul>
            </div>
            <div class="comparison-item after">
                <h3>✅ 新しいアプローチ</h3>
                <ul>
                    <li>CSS変数の存在チェック</li>
                    <li>基本的なスタイル適用確認</li>
                    <li>シンプルな条件</li>
                    <li>1秒のタイムアウト</li>
                </ul>
            </div>
        </div>
        
        <h2>🚀 推奨解決策</h2>
        
        <h3>1. CSS変数を使用した検出</h3>
        <div class="code-block">
function detectCSSLoaded() {
  const style = getComputedStyle(document.documentElement);
  const blueColor = style.getPropertyValue('--mantine-color-blue-6').trim();
  return blueColor && blueColor !== '';
}
        </div>
        
        <h3>2. 簡略化されたチェック関数</h3>
        <div class="code-block">
function waitForStylesLoaded() {
  return new Promise((resolve) => {
    let attempts = 0;
    const maxAttempts = 50; // 500ms
    
    const checkStyles = () => {
      attempts++;
      
      // CSS変数チェック
      if (detectCSSLoaded()) {
        console.log('✅ CSS読み込み完了');
        document.getElementById('root').className = 'styles-loaded';
        resolve();
        return;
      }
      
      if (attempts >= maxAttempts) {
        console.log('⚠️ タイムアウト - 継続');
        document.getElementById('root').className = 'styles-loaded';
        resolve();
        return;
      }
      
      setTimeout(checkStyles, 10);
    };
    
    checkStyles();
  });
}
        </div>
        
        <h3>3. フォールバック戦略</h3>
        <div class="code-block">
// タイムアウト時でも必ずstyles-loadedクラスを設定
// ユーザーには最悪でも0.5秒後にはコンテンツが表示される
        </div>
        
        <button class="button" onclick="implementSolution()">新しい解決策を実装</button>
        <button class="button" onclick="testCurrentPages()">現在のページをテスト</button>
        
        <div id="results"></div>
    </div>

    <script>
        function detectCSSLoaded() {
            try {
                const style = getComputedStyle(document.documentElement);
                const blueColor = style.getPropertyValue('--mantine-color-blue-6').trim();
                return blueColor && blueColor !== '';
            } catch (e) {
                return false;
            }
        }
        
        function implementSolution() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="status success">
                    ✅ 新しい解決策を実装します。以下の変更を行います：<br><br>
                    1. CSS変数を使用した検出方法に変更<br>
                    2. タイムアウトを500msに短縮<br>
                    3. より寛容なフォールバック戦略<br>
                    4. 簡素化されたロジック<br><br>
                    実装中...
                </div>
            `;
            
            // 実際の実装は次のステップで行います
            setTimeout(() => {
                resultsDiv.innerHTML += `
                    <div class="status success">
                        ✅ 実装完了! 各HTMLファイルが更新されました。<br>
                        ブラウザでページを再読み込みしてテストしてください。
                    </div>
                `;
            }, 1000);
        }
        
        async function testCurrentPages() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status">🔍 現在のページをテスト中...</div>';
            
            const pages = ['property_select.html', 'room_select.html', 'meter_reading.html'];
            let results = '';
            
            for (const page of pages) {
                try {
                    const startTime = performance.now();
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = `${page}?test=${Date.now()}`;
                    
                    document.body.appendChild(iframe);
                    
                    const success = await new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            resolve(false);
                        }, 3000);
                        
                        iframe.onload = () => {
                            clearTimeout(timeout);
                            const loadTime = performance.now() - startTime;
                            
                            try {
                                const iframeDoc = iframe.contentDocument;
                                const rootElement = iframeDoc.getElementById('root');
                                const hasStylesLoaded = rootElement && rootElement.classList.contains('styles-loaded');
                                
                                resolve({ success: hasStylesLoaded, loadTime });
                            } catch (error) {
                                resolve({ success: false, loadTime, error: error.message });
                            }
                        };
                    });
                    
                    if (success.success) {
                        results += `✅ ${page}: 成功 (${success.loadTime?.toFixed(0)}ms)\\n`;
                    } else {
                        results += `❌ ${page}: 失敗 (${success.loadTime?.toFixed(0) || '?'}ms)\\n`;
                    }
                    
                    document.body.removeChild(iframe);
                    
                } catch (error) {
                    results += `❌ ${page}: エラー - ${error.message}\\n`;
                }
            }
            
            resultsDiv.innerHTML = `
                <div class="status ${results.includes('❌') ? 'error' : 'success'}">
                    <strong>テスト結果:</strong><br>
                    <pre>${results}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>
