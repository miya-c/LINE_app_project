<!DOCTYPE html>
<html lang="ja">
<head>
  <title>CSSèª­ã¿è¾¼ã¿æ”¹å–„ãƒ†ã‚¹ãƒˆ - æœ€çµ‚ç‰ˆ</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5; line-height: 1.6;
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px; margin: 20px 0;
    }
    .test-card {
      background: #f8f9fa; padding: 20px; border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .test-card h3 { margin-top: 0; color: #007bff; }
    .test-result {
      margin: 10px 0; padding: 10px; border-radius: 4px;
      background-color: #fff; border-left: 3px solid #28a745;
      font-family: monospace; font-size: 14px;
    }
    .error { border-left-color: #dc3545; background-color: #f8d7da; }
    .warning { border-left-color: #ffc107; background-color: #fff3cd; }
    .success { border-left-color: #28a745; background-color: #d4edda; }
    button {
      padding: 8px 16px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .link-button {
      display: inline-block; padding: 8px 16px; margin: 5px;
      background-color: #6c757d; color: white; text-decoration: none;
      border-radius: 4px; transition: all 0.2s;
    }
    .link-button:hover { background-color: #545b62; }
    .metrics {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px; margin: 15px 0;
    }
    .metric {
      background: white; padding: 10px; border-radius: 4px;
      text-align: center; border: 1px solid #ddd;
    }
    .metric-value { font-size: 20px; font-weight: bold; color: #007bff; }
    .metric-label { font-size: 12px; color: #6c757d; }
    .timeline {
      background: #f8f9fa; padding: 15px; border-radius: 4px;
      margin: 15px 0; max-height: 300px; overflow-y: auto;
    }
    .timeline-entry {
      margin: 5px 0; padding: 5px 10px;
      background: white; border-left: 3px solid #007bff;
      border-radius: 3px; font-family: monospace; font-size: 12px;
    }
    .timeline-entry.critical { border-left-color: #dc3545; }
    .timeline-entry.warning { border-left-color: #ffc107; }
    .timeline-entry.success { border-left-color: #28a745; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ CSSèª­ã¿è¾¼ã¿æ”¹å–„ãƒ†ã‚¹ãƒˆ - æœ€çµ‚ç‰ˆ v20250615</h1>
    <p>åˆå›ç”»é¢è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ«å´©ã‚Œå•é¡Œã®ä¿®æ­£åŠ¹æœã‚’æ¤œè¨¼ã—ã¾ã™ã€‚</p>
    
    <div class="test-grid">
      <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– -->
      <div class="test-card">
        <h3>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</h3>
        <div class="metrics" id="realtime-metrics">
          <div class="metric">
            <div class="metric-value" id="total-tests">0</div>
            <div class="metric-label">å®Ÿè¡Œå›æ•°</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="success-rate">0%</div>
            <div class="metric-label">æˆåŠŸç‡</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="avg-load-time">-</div>
            <div class="metric-label">å¹³å‡èª­ã¿è¾¼ã¿æ™‚é–“</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="fouc-protection">-</div>
            <div class="metric-label">FOUCå¯¾ç­–ç‡</div>
          </div>
        </div>
        <button onclick="startContinuousTest()">é€£ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button onclick="stopContinuousTest()">åœæ­¢</button>
        <button onclick="clearMetrics()">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      
      <!-- å€‹åˆ¥ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ -->
      <div class="test-card">
        <h3>ğŸ” å€‹åˆ¥ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</h3>
        <div id="individual-results"></div>
        <button onclick="testPage('property_select.html', 'ç‰©ä»¶é¸æŠ')">ç‰©ä»¶é¸æŠãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testPage('room_select.html', 'éƒ¨å±‹é¸æŠ')">éƒ¨å±‹é¸æŠãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testPage('meter_reading.html', 'ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š')">ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ</button>
        <a href="property_select.html" target="_blank" class="link-button">ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸</a>
        <a href="room_select.html" target="_blank" class="link-button">éƒ¨å±‹é¸æŠãƒšãƒ¼ã‚¸</a>
        <a href="meter_reading.html" target="_blank" class="link-button">ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒšãƒ¼ã‚¸</a>
      </div>
      
      <!-- ä¿®æ­£å‰å¾Œæ¯”è¼ƒ -->
      <div class="test-card">
        <h3>ğŸ“ˆ ä¿®æ­£å‰å¾Œæ¯”è¼ƒ</h3>
        <div id="comparison-results"></div>
        <button onclick="runBeforeAfterComparison()">æ¯”è¼ƒãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <a href="property_select_broken.html" target="_blank" class="link-button">ä¿®æ­£å‰ãƒšãƒ¼ã‚¸</a>
        <a href="before_after_comparison.html" target="_blank" class="link-button">è©³ç´°æ¯”è¼ƒãƒšãƒ¼ã‚¸</a>
      </div>
      
      <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ -->
      <div class="test-card">
        <h3>ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</h3>
        <div id="performance-results"></div>
        <button onclick="analyzePerformance()">è©³ç´°åˆ†æå®Ÿè¡Œ</button>
        <a href="css_performance_audit.html" target="_blank" class="link-button">ç›£æŸ»ãƒ„ãƒ¼ãƒ«</a>
      </div>
    </div>
    
    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="test-card">
      <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
      <div class="timeline" id="test-timeline"></div>
      <button onclick="clearTimeline()">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <script>
    let testData = {
      totalTests: 0,
      successfulTests: 0,
      loadTimes: [],
      foucProtectionCount: 0,
      continuousTestInterval: null
    };

    function addToTimeline(message, type = 'info') {
      const timeline = document.getElementById('test-timeline');
      const entry = document.createElement('div');
      entry.className = `timeline-entry ${type}`;
      entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      timeline.appendChild(entry);
      timeline.scrollTop = timeline.scrollHeight;
    }

    function updateMetrics() {
      document.getElementById('total-tests').textContent = testData.totalTests;
      
      const successRate = testData.totalTests > 0 ? 
        Math.round((testData.successfulTests / testData.totalTests) * 100) : 0;
      document.getElementById('success-rate').textContent = `${successRate}%`;
      
      const avgLoadTime = testData.loadTimes.length > 0 ?
        (testData.loadTimes.reduce((sum, time) => sum + time, 0) / testData.loadTimes.length).toFixed(1) : '-';
      document.getElementById('avg-load-time').textContent = avgLoadTime !== '-' ? `${avgLoadTime}ms` : '-';
      
      const foucRate = testData.totalTests > 0 ?
        Math.round((testData.foucProtectionCount / testData.totalTests) * 100) : 0;
      document.getElementById('fouc-protection').textContent = `${foucRate}%`;
    }

    function testPage(url, pageName) {
      addToTimeline(`${pageName}ã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹`, 'info');
      
      const startTime = performance.now();
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      
      iframe.onload = () => {
        const loadTime = performance.now() - startTime;
        testData.totalTests++;
        testData.loadTimes.push(loadTime);
        
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          const iframeWindow = iframe.contentWindow;
          
          // CSSèª­ã¿è¾¼ã¿çŠ¶æ³
          const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
          const cssLoaded = Array.from(cssLinks).every(link => link.sheet !== null);
          
          // FOUCå¯¾ç­–ç¢ºèª
          const rootElement = iframeDoc.getElementById('root');
          const hasFOUCProtection = rootElement && 
            (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
          
          if (hasFOUCProtection) testData.foucProtectionCount++;
          
          // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ç¢ºèª
          const testElement = iframeDoc.createElement('div');
          testElement.className = 'mantine-container';
          testElement.style.position = 'absolute';
          testElement.style.visibility = 'hidden';
          iframeDoc.body.appendChild(testElement);
          
          const computedStyle = iframeWindow.getComputedStyle(testElement);
          const hasStyles = computedStyle.maxWidth === '1200px' || 
                           computedStyle.marginLeft === 'auto' ||
                           computedStyle.padding !== '0px';
          
          iframeDoc.body.removeChild(testElement);
          
          if (cssLoaded && hasFOUCProtection && hasStyles) {
            testData.successfulTests++;
            addToTimeline(`âœ… ${pageName}: æˆåŠŸ (${loadTime.toFixed(1)}ms)`, 'success');
          } else {
            addToTimeline(`âŒ ${pageName}: å¤±æ•— - CSS:${cssLoaded} FOUC:${hasFOUCProtection} ã‚¹ã‚¿ã‚¤ãƒ«:${hasStyles}`, 'critical');
          }
          
          const resultDiv = document.getElementById('individual-results');
          resultDiv.innerHTML += `
            <div class="test-result ${cssLoaded && hasFOUCProtection && hasStyles ? 'success' : 'error'}">
              <strong>${pageName}</strong>: ${loadTime.toFixed(1)}ms<br>
              CSS: ${cssLoaded ? 'âœ…' : 'âŒ'} | FOUC: ${hasFOUCProtection ? 'âœ…' : 'âŒ'} | ã‚¹ã‚¿ã‚¤ãƒ«: ${hasStyles ? 'âœ…' : 'âŒ'}
            </div>
          `;
          
        } catch (error) {
          addToTimeline(`âŒ ${pageName}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'critical');
        }
        
        document.body.removeChild(iframe);
        updateMetrics();
      };
      
      iframe.onerror = () => {
        addToTimeline(`âŒ ${pageName}: èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`, 'critical');
        document.body.removeChild(iframe);
      };
      
      document.body.appendChild(iframe);
    }

    function startContinuousTest() {
      if (testData.continuousTestInterval) return;
      
      addToTimeline('é€£ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹', 'info');
      
      testData.continuousTestInterval = setInterval(() => {
        const pages = [
          ['property_select.html', 'ç‰©ä»¶é¸æŠ'],
          ['room_select.html', 'éƒ¨å±‹é¸æŠ'],
          ['meter_reading.html', 'ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š']
        ];
        
        const randomPage = pages[Math.floor(Math.random() * pages.length)];
        testPage(randomPage[0], randomPage[1]);
      }, 3000);
    }

    function stopContinuousTest() {
      if (testData.continuousTestInterval) {
        clearInterval(testData.continuousTestInterval);
        testData.continuousTestInterval = null;
        addToTimeline('é€£ç¶šãƒ†ã‚¹ãƒˆã‚’åœæ­¢', 'warning');
      }
    }

    function clearMetrics() {
      testData = {
        totalTests: 0,
        successfulTests: 0,
        loadTimes: [],
        foucProtectionCount: 0,
        continuousTestInterval: testData.continuousTestInterval
      };
      updateMetrics();
      document.getElementById('individual-results').innerHTML = '';
      addToTimeline('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ', 'info');
    }

    function clearTimeline() {
      document.getElementById('test-timeline').innerHTML = '';
    }

    function runBeforeAfterComparison() {
      addToTimeline('ä¿®æ­£å‰å¾Œæ¯”è¼ƒãƒ†ã‚¹ãƒˆã‚’é–‹å§‹', 'info');
      
      Promise.all([
        testPageForComparison('property_select_broken.html', 'ä¿®æ­£å‰'),
        testPageForComparison('property_select.html', 'ä¿®æ­£å¾Œ')
      ]).then(results => {
        const [before, after] = results;
        
        const improvement = before.loadTime - after.loadTime;
        const improvementPercent = ((improvement / before.loadTime) * 100).toFixed(1);
        
        const resultsDiv = document.getElementById('comparison-results');
        resultsDiv.innerHTML = `
          <div class="test-result success">
            <strong>æ¯”è¼ƒçµæœ:</strong><br>
            ä¿®æ­£å‰: ${before.loadTime.toFixed(1)}ms (FOUCå¯¾ç­–: ${before.foucProtection ? 'âœ…' : 'âŒ'})<br>
            ä¿®æ­£å¾Œ: ${after.loadTime.toFixed(1)}ms (FOUCå¯¾ç­–: ${after.foucProtection ? 'âœ…' : 'âŒ'})<br>
            æ”¹å–„: ${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}ms (${improvementPercent}%)
          </div>
        `;
        
        addToTimeline(`æ¯”è¼ƒå®Œäº†: ${improvementPercent}%ã®æ”¹å–„`, 'success');
      });
    }

    function testPageForComparison(url, name) {
      return new Promise((resolve) => {
        const startTime = performance.now();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        
        iframe.onload = () => {
          const loadTime = performance.now() - startTime;
          
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const rootElement = iframeDoc.getElementById('root');
            const foucProtection = rootElement && 
              (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
            
            resolve({ loadTime, foucProtection });
          } catch (error) {
            resolve({ loadTime, foucProtection: false });
          }
          
          document.body.removeChild(iframe);
        };
        
        iframe.onerror = () => {
          resolve({ loadTime: 9999, foucProtection: false });
          document.body.removeChild(iframe);
        };
        
        document.body.appendChild(iframe);
      });
    }

    function analyzePerformance() {
      addToTimeline('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã‚’é–‹å§‹', 'info');
      
      const performanceData = {
        averageLoadTime: testData.loadTimes.length > 0 ? 
          testData.loadTimes.reduce((sum, time) => sum + time, 0) / testData.loadTimes.length : 0,
        minLoadTime: Math.min(...testData.loadTimes),
        maxLoadTime: Math.max(...testData.loadTimes),
        successRate: testData.totalTests > 0 ? (testData.successfulTests / testData.totalTests) * 100 : 0
      };
      
      const resultsDiv = document.getElementById('performance-results');
      resultsDiv.innerHTML = `
        <div class="test-result ${performanceData.successRate >= 90 ? 'success' : performanceData.successRate >= 70 ? 'warning' : 'error'}">
          <strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æçµæœ:</strong><br>
          å¹³å‡èª­ã¿è¾¼ã¿æ™‚é–“: ${performanceData.averageLoadTime.toFixed(1)}ms<br>
          æœ€é€Ÿ: ${performanceData.minLoadTime.toFixed(1)}ms<br>
          æœ€é…: ${performanceData.maxLoadTime.toFixed(1)}ms<br>
          æˆåŠŸç‡: ${performanceData.successRate.toFixed(1)}%<br>
          è©•ä¾¡: ${performanceData.successRate >= 90 ? 'å„ªç§€' : performanceData.successRate >= 70 ? 'è‰¯å¥½' : 'è¦æ”¹å–„'}
        </div>
      `;
      
      addToTimeline(`åˆ†æå®Œäº†: æˆåŠŸç‡${performanceData.successRate.toFixed(1)}%`, 
        performanceData.successRate >= 90 ? 'success' : 'warning');
    }

    // åˆæœŸåŒ–
    addToTimeline('CSSèª­ã¿è¾¼ã¿æ”¹å–„ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸ', 'success');
    updateMetrics();
  </script>
</body>
</html>
