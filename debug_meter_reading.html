<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‡ãƒãƒƒã‚°</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .debug-title { font-weight: bold; color: #333; margin-bottom: 10px; }
        .log-output { background: #f5f5f5; padding: 10px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; }
        .test-button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .input-group { margin: 10px 0; }
        .input-group label { display: inline-block; width: 120px; }
        .input-group input { padding: 5px; margin-left: 10px; width: 200px; }
    </style>
</head>
<body>
    <h1>æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function DebugApp() {
            const [gasUrl, setGasUrl] = useState('');
            const [propertyId, setPropertyId] = useState('');
            const [roomId, setRoomId] = useState('');
            const [logs, setLogs] = useState('');
            const [testResults, setTestResults] = useState('');

            const addLog = (message) => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => prev + `[${timestamp}] ${message}\n`);
            };

            useEffect(() => {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸå€¤ã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const propId = urlParams.get('propertyId') || '';
                const rId = urlParams.get('roomId') || '';
                
                setPropertyId(propId);
                setRoomId(rId);
                
                addLog(`URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—: propertyId="${propId}", roomId="${rId}"`);
                
                // ä¿å­˜ã•ã‚ŒãŸGAS URLã‚’å–å¾—
                const savedUrl = sessionStorage.getItem('gasWebAppUrl');
                if (savedUrl) {
                    setGasUrl(savedUrl);
                    addLog(`ä¿å­˜ã•ã‚ŒãŸGAS URL: ${savedUrl}`);
                }
            }, []);

            const testGasConnection = async () => {
                if (!gasUrl) {
                    addLog('âŒ GAS URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                try {
                    addLog('ğŸš€ GASæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
                    const response = await fetch(`${gasUrl}?action=getVersion`);
                    const result = await response.json();
                    addLog('âœ… GASæ¥ç¶šæˆåŠŸ');
                    addLog(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(result, null, 2)}`);
                    setTestResults(JSON.stringify(result, null, 2));
                } catch (error) {
                    addLog(`âŒ GASæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };

            const testMeterReadings = async () => {
                if (!gasUrl || !propertyId || !roomId) {
                    addLog('âŒ GAS URLã€ç‰©ä»¶IDã€éƒ¨å±‹IDãŒã™ã¹ã¦å¿…è¦ã§ã™');
                    return;
                }

                try {
                    addLog('ğŸ” æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                    addLog(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: propertyId="${propertyId}", roomId="${roomId}"`);
                    
                    const fetchUrl = `${gasUrl}?action=getMeterReadings&propertyId=${propertyId}&roomId=${roomId}`;
                    addLog(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${fetchUrl}`);
                    
                    const response = await fetch(fetchUrl);
                    const result = await response.json();
                    
                    addLog('âœ… æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
                    addLog(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(result, null, 2)}`);
                    setTestResults(JSON.stringify(result, null, 2));
                    
                    if (result.readings && Array.isArray(result.readings)) {
                        addLog(`ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${result.readings.length}ä»¶`);
                    }
                    
                } catch (error) {
                    addLog(`âŒ æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };

            const clearLogs = () => {
                setLogs('');
                setTestResults('');
            };

            return (
                <div>
                    <div className="debug-section">
                        <div className="debug-title">è¨­å®š</div>
                        <div className="input-group">
                            <label>GAS URL:</label>
                            <input 
                                type="text" 
                                value={gasUrl} 
                                onChange={(e) => setGasUrl(e.target.value)}
                                placeholder="https://script.google.com/macros/s/.../exec"
                            />
                        </div>
                        <div className="input-group">
                            <label>ç‰©ä»¶ID:</label>
                            <input 
                                type="text" 
                                value={propertyId} 
                                onChange={(e) => setPropertyId(e.target.value)}
                                placeholder="ä¾‹: P001"
                            />
                        </div>
                        <div className="input-group">
                            <label>éƒ¨å±‹ID:</label>
                            <input 
                                type="text" 
                                value={roomId} 
                                onChange={(e) => setRoomId(e.target.value)}
                                placeholder="ä¾‹: R001"
                            />
                        </div>
                    </div>

                    <div className="debug-section">
                        <div className="debug-title">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</div>
                        <button className="test-button" onClick={testGasConnection}>
                            GASæ¥ç¶šãƒ†ã‚¹ãƒˆ
                        </button>
                        <button className="test-button" onClick={testMeterReadings}>
                            æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
                        </button>
                        <button className="test-button" onClick={clearLogs}>
                            ãƒ­ã‚°ã‚¯ãƒªã‚¢
                        </button>
                    </div>

                    <div className="debug-section">
                        <div className="debug-title">å®Ÿè¡Œãƒ­ã‚°</div>
                        <div className="log-output">{logs}</div>
                    </div>

                    {testResults && (
                        <div className="debug-section">
                            <div className="debug-title">æœ€æ–°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹</div>
                            <div className="log-output">{testResults}</div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DebugApp />, document.getElementById('root'));
    </script>
</body>
</html>
