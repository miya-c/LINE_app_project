<!DOCTYPE html>
<html>
<head>
  <title>部屋選択</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- WOFF SDKの読み込み (LINE WORKS用) -->
  <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    h1, h2 { margin-top: 0; }
    #room-list button { display: block; width: 100%; padding: 10px; margin-bottom: 5px; text-align: left; }
    .property-name { font-size: 1.2em; margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>部屋選択</h1>
  <div id="property-info">
    <p class="property-name">物件名：<span id="property-name-display">読み込み中...</span></p>
  </div>

  <div id="room-list">
    <!-- ここにJavaScriptで部屋ボタンが追加される -->
    <p>部屋情報を読み込み中です...</p>
  </div>

  <script>
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    // ★ ここに、GASをデプロイした時に取得した「ウェブアプリのURL」を設定してください！ ★
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    let gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxlUjH3_cTauAeu_QF2uHCTqmPnJt-T-qGWpDVYxjIvkKwLyYvmRGA2NFlhVme1m4G4Zg/exec'; 

    window.addEventListener('DOMContentLoaded', (event) => {
      initializeLiff();
    });

    async function initializeLiff() {
      try {
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここに、LINE Developersコンソールで取得したLIFF IDを設定してください！ ★
        // ★ (これはLINE WORKSのWOFFアプリのエンドポイントURLです) ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const woffIdForInit = "https://woff.worksmobile.com/woff/Mtmj4rddmxBddYCPD0G81A"; // WOFF ID (エンドポイントURL)
        console.log('[room_select] woff.init with woffId:', woffIdForInit);
        await woff.init({ liffId: woffIdForInit }); // キーを liffId にして試してみる
        console.log('[room_select] woff.init successful.');

        if (!woff.isLoggedIn()) {
          console.log("[initializeLiff] Not logged in.");
          // woff.login(); // 必要に応じてログイン処理
        } else {
          console.log("[initializeLiff] Logged in. OS:", woff.getOS(), "Language:", woff.getLanguage(), "Version:", woff.getVersion(), "isInClient:", woff.isInClient());
        }
        // URLパラメータから物件情報を取得
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('propertyId');
        const propertyName = urlParams.get('propertyName');

        if (propertyName) {
          document.getElementById('property-name-display').textContent = propertyName;
        } else {
          document.getElementById('property-name-display').textContent = '物件情報なし';
        }

        if (propertyId) {
          fetchRooms(propertyId, propertyName);
        } else {
          document.getElementById('room-list').innerHTML = '<p>物件IDが指定されていません。</p>';
        }
      } catch (initError) {
        console.error('[room_select] Error during initialization or fetching room info:', initError);
        console.error('[room_select] Error details:', JSON.stringify(initError, Object.getOwnPropertyNames(initError))); // エラーオブジェクトの詳細を出力
        document.getElementById('room-list').innerHTML = '<p>アプリの起動または部屋情報の取得に失敗しました。</p>';
      }
    }

    // GASから部屋リストを取得して表示する関数
    async function fetchRooms(propertyId, propertyName) {
      const roomListDiv = document.getElementById('room-list');
      roomListDiv.innerHTML = '<p>部屋情報を読み込み中です...</p>';

      // GASから実際に部屋データを取得する処理
      // actionパラメータなどを適宜変更してください。
      try {
        // GASに物件IDを渡して部屋リストを要求
        const response = await fetch(`${gasWebAppUrl}?action=getRooms&propertyId=${propertyId}`);
        if (!response.ok) {
          throw new Error('ネットワークの応答が正しくありませんでした。');
        }
        const rooms = await response.json(); // GASから返ってきたJSONデータをJavaScriptのオブジェクトに変換
        displayRooms(rooms, propertyId, propertyName);
      } catch (error) {
        console.error('部屋情報の取得に失敗しました:', error);
        roomListDiv.innerHTML = '<p>部屋情報の取得に失敗しました。時間をおいて再度お試しください。</p>';
        return;
      }

      // // 現時点ではダミーデータで表示します (上記GAS連携を有効にしたためコメントアウト)
      // const dummyRooms = [
      //   { id: "R101", name: "101号室" },
      //   { id: "R102", name: "102号室" },
      //   { id: "R201", name: "201号室" },
      //   { id: "R202", name: "202号室" }
      // ];
      // displayRooms(dummyRooms, propertyId, propertyName);
    }

    function displayRooms(rooms, propertyId, propertyName) {
      const roomListDiv = document.getElementById('room-list');
      roomListDiv.innerHTML = ''; // 「読み込み中です」を消す

      if (!rooms || rooms.length === 0) {
        roomListDiv.innerHTML = '<p>この物件に登録されている部屋はありません。</p>';
        return;
      }

      rooms.forEach(room => {
        const button = document.createElement('button');
        button.textContent = room.name; // GASから取得する部屋名に応じて調整
        button.onclick = function() {
          // meter_reading.html に物件ID、物件名、部屋ID、部屋名を渡して画面遷移
          const params = new URLSearchParams();
          params.append('propertyId', propertyId);
          params.append('propertyName', propertyName);
          params.append('roomId', room.id); // GASから取得する部屋IDに応じて調整
          params.append('roomName', room.name); // GASから取得する部屋名に応じて調整
          
          if (woff.isInClient()) {
            woff.openWindow({
              url: `meter_reading.html?${params.toString()}`, // 次の画面名を meter_reading.html と仮定
              external: false
            });
          } else {
            // LIFFブラウザ外の場合のフォールバック
            window.location.href = `meter_reading.html?${params.toString()}`;
          }
        };
        roomListDiv.appendChild(button);
      });
    }
  </script>
</body>
</html>