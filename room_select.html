<!DOCTYPE html>
<html>
<head>
  <title>部屋選択 (React)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
  
  <!-- Mantine CSS -->
  <link href="https://unpkg.com/@mantine/core@7.0.0/styles.css" rel="stylesheet">
  
  <!-- ReactとReactDOMのCDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Mantine Core (UMD) -->
  <script src="https://unpkg.com/@mantine/core@7.0.0/umd/mantine-core.min.js"></script>
  
  <!-- BabelのCDN (JSXをブラウザで変換するため) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; }
    #root { min-height: 100vh; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { MantineProvider, Container, Stack, Title, Text, Button, Loader, Alert, Group } = window.MantineCore;

    const RoomSelectApp = () => {
      const [propertyId, setPropertyId] = React.useState(null);
      const [propertyName, setPropertyName] = React.useState('');
      const [rooms, setRooms] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [woffInitialized, setWoffInitialized] = React.useState(false);

      const woffIdForWorks = "Mtmj4rddmxBddYCPD0G81A";

      React.useEffect(() => {
        const initializeWoff = async () => {
          try {
            console.log('[room_select] woff.init with woffId:', woffIdForWorks);
            await woff.init({ woffId: woffIdForWorks });
            console.log('[room_select] woff.init successful.');

            if (!woff.isLoggedIn()) {
              console.log("[room_select] Not logged in.");
            } else {
              console.log("[room_select] Logged in. OS:", woff.getOS(), "Language:", woff.getLanguage(), "Version:", woff.getVersion(), "isInClient:", woff.isInClient());
            }

            setWoffInitialized(true);
          } catch (initError) {
            console.error('[room_select] WOFF initialization failed:', initError);
            setError('アプリの起動に失敗しました。WOFFの初期化エラー。');
            setLoading(false);
          }
        };
        initializeWoff();
      }, [woffIdForWorks]);

      React.useEffect(() => {
        if (!woffInitialized) return;

        const loadRoomData = () => {
          try {
            // sessionStorageから物件情報と部屋情報を取得
            const storedPropertyId = sessionStorage.getItem('selectedPropertyId');
            const storedPropertyName = sessionStorage.getItem('selectedPropertyName');
            const roomsString = sessionStorage.getItem('selectedRooms');
            
            console.log('[room_select] Loaded from sessionStorage - propertyId:', storedPropertyId, 'propertyName:', storedPropertyName, 'roomsString:', roomsString);

            if (storedPropertyName) {
              setPropertyName(storedPropertyName);
            } else {
              setPropertyName('物件情報なし');
            }

            if (storedPropertyId && roomsString) {
              try {
                const parsedRooms = JSON.parse(roomsString);
                console.log('[room_select] Parsed rooms from sessionStorage:', parsedRooms);
                console.log('[room_select] Before setting rooms - Type of parsedRooms:', typeof parsedRooms, 'Is Array:', Array.isArray(parsedRooms), 'Content:', JSON.stringify(parsedRooms));
                
                setPropertyId(storedPropertyId);
                setRooms(Array.isArray(parsedRooms) ? parsedRooms : []);
              } catch (e) {
                console.error('[room_select] sessionStorageから部屋情報の解析に失敗しました:', e);
                setError('部屋情報の読み込みに失敗しました。(不正なデータ形式)');
              }
            } else {
              let errorMsg = '';
              if (!storedPropertyId) errorMsg += '物件IDがありません。';
              if (!roomsString) errorMsg += (errorMsg ? ' ' : '') + '部屋情報がありません。';
              console.warn('[room_select] sessionStorageからの情報が不足:', errorMsg);
              setError(`部屋情報の読み込みに失敗しました。(${errorMsg})`);
            }
          } catch (error) {
            console.error('[room_select] Error during room data loading:', error);
            setError('アプリの起動または部屋情報の表示に失敗しました。');
          } finally {
            setLoading(false);
          }
        };

        loadRoomData();
      }, [woffInitialized]);

      const handleBackToPropertySelect = () => {
        window.location.href = 'property_select.html';
      };

      const handleRoomSelect = (room) => {
        if (!propertyId || !propertyName || !room) {
          console.error('[room_select] Invalid data for room selection:', { propertyId, propertyName, room });
          alert('選択された部屋情報が無効です。');
          return;
        }

        // meter_reading.html に物件ID、物件名、部屋ID、部屋名を渡して画面遷移
        const params = new URLSearchParams();
        params.append('propertyId', propertyId);
        params.append('propertyName', propertyName);
        params.append('roomId', room.id);
        params.append('roomName', room.name);
        
        const targetUrl = `meter_reading.html?${params.toString()}`;
        
        if (woff.isInClient()) {
          console.log(`[room_select] Opening window in client: ${targetUrl}`);
          woff.openWindow({
            url: targetUrl,
            external: false
          });
        } else {
          console.log(`[room_select] Redirecting to: ${targetUrl}`);
          window.location.href = targetUrl;
        }
      };

      // WOFF SDK初期化前のローディング
      if (!woffInitialized && loading) {
        return (
          <MantineProvider>
            <Container size="md" p="md">
              <Stack align="center" gap="md">
                <Loader size="lg" />
                <Text>アプリを初期化中です...</Text>
              </Stack>
            </Container>
          </MantineProvider>
        );
      }

      // WOFF SDK初期化エラー
      if (!woffInitialized && error) {
        return (
          <MantineProvider>
            <Container size="md" p="md">
              <Alert color="red" title="エラー">
                {error}
              </Alert>
            </Container>
          </MantineProvider>
        );
      }

      // データ読み込み中
      if (loading && woffInitialized) {
        return (
          <MantineProvider>
            <Container size="md" p="md">
              <Stack gap="md">
                <Button variant="light" color="gray" onClick={handleBackToPropertySelect}>
                  物件選択へ戻る
                </Button>
                <Title order={1}>部屋選択</Title>
                <Text size="lg" fw={500}>物件名：読み込み中...</Text>
                <Stack align="center" gap="md">
                  <Loader size="lg" />
                  <Text>部屋情報を読み込み中です...</Text>
                </Stack>
              </Stack>
            </Container>
          </MantineProvider>
        );
      }

      // エラー時の表示
      if (error) {
        return (
          <MantineProvider>
            <Container size="md" p="md">
              <Stack gap="md">
                <Button variant="light" color="gray" onClick={handleBackToPropertySelect}>
                  物件選択へ戻る
                </Button>
                <Title order={1}>部屋選択</Title>
                <Text size="lg" fw={500}>物件名：{propertyName}</Text>
                <Alert color="red" title="エラー">
                  {error}
                </Alert>
              </Stack>
            </Container>
          </MantineProvider>
        );
      }

      return (
        <MantineProvider>
          <Container size="md" p="md">
            <Stack gap="md">
              <Button variant="light" color="gray" onClick={handleBackToPropertySelect}>
                物件選択へ戻る
              </Button>
              <Title order={1}>部屋選択</Title>
              <Text size="lg" fw={500}>物件名：{propertyName}</Text>

              {!Array.isArray(rooms) && (
                <Alert color="red" title="エラー">
                  部屋データの形式が正しくありません。
                </Alert>
              )}
              
              {Array.isArray(rooms) && rooms.length === 0 && (
                <Text ta="center">この物件に登録されている部屋はありません。</Text>
              )}

              {Array.isArray(rooms) && rooms.length > 0 && (
                <Stack gap="xs">
                  {rooms.map(room => (
                    <Button
                      key={room.id}
                      variant="light"
                      size="md"
                      fullWidth
                      onClick={() => handleRoomSelect(room)}
                      disabled={loading}
                      style={{ textAlign: 'left', justifyContent: 'flex-start' }}
                    >
                      {room.name || 'N/A'}
                    </Button>
                  ))}
                </Stack>
              )}
            </Stack>
          </Container>
        </MantineProvider>
      );
    };

    ReactDOM.render(<RoomSelectApp />, document.getElementById('root'));
  </script>
</body>
</html>