<!DOCTYPE html>
<html>
<head>
  <title>éƒ¨å±‹é¸æŠ (React + Mantine Style)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- WOFF SDK -->
  <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
  
  <!-- Reactã¨ReactDOMã®CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babelã®CDN (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ã™ã‚‹ãŸã‚) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ -->
  <link rel="stylesheet" href="room_select.css">
</head>
<body>
  <div id="root"></div>  <script type="text/babel">
    // ===================================
    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ç¾¤ï¼ˆéƒ¨å±‹é¸æŠç”¨ï¼‰
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å—ä¿¡ã—ãŸæ¤œé‡æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’UIã«é©ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
    // YYYY-MM-DDå½¢å¼ã®ã¿å¯¾å¿œã€ãã®ä»–ã¯æœªæ¤œé‡ã¨ã—ã¦æ‰±ã†
    // ===================================
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°: YYYY-MM-DD â†’ XæœˆYæ—¥
    const formatDate = (rawDate) => {
      // ç©ºå€¤ãƒã‚§ãƒƒã‚¯
      if (!rawDate || rawDate === '' || rawDate === null || rawDate === undefined) {
        return null;
      }
      
      // YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—ã‚’ç›´æ¥å¤‰æ›
      if (typeof rawDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(rawDate.trim())) {
        const [year, month, day] = rawDate.trim().split('-');
        return `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
      }
      
      return null; // ãã®ä»–ã®å½¢å¼ã¯æœªå¯¾å¿œã¨ã—ã¦æœªæ¤œé‡æ‰±ã„
    };
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ¤œé‡çŠ¶æ³åˆ¤å®š
    const formatInspectionStatus = (rawDate) => {
      const formattedDate = formatDate(rawDate);
      return formattedDate ? 
        { status: 'æ¤œé‡æ¸ˆã¿', displayDate: formattedDate } : 
        { status: 'æœªæ¤œé‡', displayDate: null };
    };
    
    // ===================================
    // Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    // ===================================
    
    const RoomSelectApp = () => {
      const [propertyId, setPropertyId] = React.useState(null);
      const [propertyName, setPropertyName] = React.useState('');
      const [rooms, setRooms] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [woffInitialized, setWoffInitialized] = React.useState(false);
      const [isNavigating, setIsNavigating] = React.useState(false);
      const [navigationMessage, setNavigationMessage] = React.useState('');

      const woffIdForWorks = "Mtmj4rddmxBddYCPD0G81A";

      React.useEffect(() => {
        const initializeWoff = async () => {
          try {
            console.log('[room_select] woff.init with woffId:', woffIdForWorks);
            await woff.init({ woffId: woffIdForWorks });
            console.log('[room_select] woff.init successful.');

            if (!woff.isLoggedIn()) {
              console.log("[room_select] Not logged in.");
            } else {
              console.log("[room_select] Logged in. OS:", woff.getOS(), "Language:", woff.getLanguage(), "Version:", woff.getVersion(), "isInClient:", woff.isInClient());
            }

            setWoffInitialized(true);
          } catch (initError) {
            console.error('[room_select] WOFF initialization failed:', initError);
            setError('ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚WOFFã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã€‚');
            setLoading(false);
          }
        };
        initializeWoff();
      }, [woffIdForWorks]);

      // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
      React.useEffect(() => {
        window.scrollTo(0, 0);
      }, []);

      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ã®éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      const refreshRoomDataFromBackend = async (propertyId) => {
        try {
          console.log('[room_select] ğŸ”„ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', propertyId);
          
          const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
          if (!gasWebAppUrl) {
            throw new Error('GAS Web Appã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }

          const requestUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
          const response = await fetch(requestUrl, { method: 'GET' });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('[room_select] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
          
          if (result.error) {
            throw new Error(result.error);
          }

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æŸ”è»Ÿãªå‡¦ç†
          let roomsData;
          if (Array.isArray(result.result)) {
            roomsData = result.result;
          } else if (result.result && Array.isArray(result.result.rooms)) {
            roomsData = result.result.rooms;
          } else if (Array.isArray(result.rooms)) {
            roomsData = result.rooms;
          } else {
            throw new Error('äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™');
          }

          console.log('[room_select] âœ… æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', roomsData.length, 'ä»¶');
          
          // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã§ä¿å­˜
          sessionStorage.setItem('selectedRooms', JSON.stringify(roomsData));
          console.log('[room_select] ğŸ“¦ çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ (selectedRooms) ã§ä¿å­˜å®Œäº†');
          
          return roomsData;
          
        } catch (error) {
          console.error('[room_select] âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      };

      React.useEffect(() => {
        if (!woffInitialized) return;

        const loadRoomData = async () => {
          try {
            // ===================================
            // â­ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒã‚§ãƒƒã‚¯
            // meter_reading.htmlã‹ã‚‰ã®å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ã‚’ç¢ºèª
            // ===================================
            const forceRefresh = sessionStorage.getItem('forceRefreshRooms');
            const updatedRoomId = sessionStorage.getItem('updatedRoomId');
            const lastUpdateTime = sessionStorage.getItem('lastUpdateTime');
            
            console.log('[room_select] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒã‚§ãƒƒã‚¯ - forceRefresh:', forceRefresh, 'updatedRoomId:', updatedRoomId, 'lastUpdateTime:', lastUpdateTime);

            // sessionStorageã‹ã‚‰ç‰©ä»¶æƒ…å ±ã‚’å–å¾—
            const storedPropertyId = sessionStorage.getItem('selectedPropertyId');
            const storedPropertyName = sessionStorage.getItem('selectedPropertyName');
            
            console.log('[room_select] sessionStorageæƒ…å ± - propertyId:', storedPropertyId, 'propertyName:', storedPropertyName);

            if (storedPropertyName) {
              setPropertyName(storedPropertyName);
            } else {
              setPropertyName('ç‰©ä»¶æƒ…å ±ãªã—');
            }

            if (!storedPropertyId) {
              setError('ç‰©ä»¶IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
              setLoading(false);
              return;
            }

            setPropertyId(storedPropertyId);

            // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®å ´åˆï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (forceRefresh === 'true') {
              console.log('[room_select] ğŸ”„ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œä¸­ - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—');
              
              try {
                const latestRooms = await refreshRoomDataFromBackend(storedPropertyId);
                
                // æ›´æ–°ã•ã‚ŒãŸéƒ¨å±‹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ­ã‚°
                if (updatedRoomId) {
                  const updatedRoom = latestRooms.find(room => room.roomId === updatedRoomId || room.id === updatedRoomId);
                  if (updatedRoom) {
                    console.log('[room_select] âœ… æ¤œé‡å®Œäº†ã«ã‚ˆã‚Šæ›´æ–°ã•ã‚ŒãŸéƒ¨å±‹:', updatedRoom.roomName || updatedRoom.name, 'æ¤œé‡æ—¥:', updatedRoom.rawInspectionDate);
                  }
                }
                
                setRooms(latestRooms);
                
                // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('forceRefreshRooms');
                sessionStorage.removeItem('updatedRoomId');
                sessionStorage.removeItem('lastUpdateTime');
                
                console.log('[room_select] ğŸ‰ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†');
                
              } catch (refreshError) {
                console.error('[room_select] âŒ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—:', refreshError);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿
                const roomsString = sessionStorage.getItem('selectedRooms');
                if (roomsString) {
                  try {
                    const parsedRooms = JSON.parse(roomsString);
                    setRooms(Array.isArray(parsedRooms) ? parsedRooms : []);
                    console.log('[room_select] ğŸ“¦ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿å®Œäº†');
                  } catch (parseError) {
                    console.error('[room_select] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®è§£æå¤±æ•—:', parseError);
                    setError('éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                  }
                } else {
                  setError('éƒ¨å±‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                }
              }
            } 
            // é€šå¸¸æ™‚ï¼šçµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿
            else {
              const roomsString = sessionStorage.getItem('selectedRooms');
              console.log('[room_select] ğŸ“¦ çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ (selectedRooms) ã‹ã‚‰èª­ã¿è¾¼ã¿ - ãƒ‡ãƒ¼ã‚¿é•·:', roomsString?.length);
              
              if (roomsString) {
                try {
                  const parsedRooms = JSON.parse(roomsString);
                  console.log('[room_select] Parsed rooms from unified cache:', parsedRooms.length, 'ä»¶');
                  setRooms(Array.isArray(parsedRooms) ? parsedRooms : []);
                } catch (e) {
                  console.error('[room_select] sessionStorageã‹ã‚‰éƒ¨å±‹æƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                  setError('éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼)');
                }
              } else {
                console.warn('[room_select] çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãªã— - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ');
                
                try {
                  const latestRooms = await refreshRoomDataFromBackend(storedPropertyId);
                  setRooms(latestRooms);
                } catch (fetchError) {
                  console.error('[room_select] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', fetchError);
                  setError('éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                }
              }
            }
            
          } catch (error) {
            console.error('[room_select] Error during room data loading:', error);
            setError('ã‚¢ãƒ—ãƒªã®èµ·å‹•ã¾ãŸã¯éƒ¨å±‹æƒ…å ±ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          } finally {
            setLoading(false);
          }
        };

        loadRoomData();
      }, [woffInitialized]);

      const handleBackToPropertySelect = () => {
        setIsNavigating(true);
        setNavigationMessage('ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...');
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é·ç§»
        window.scrollTo(0, 0);
        window.location.href = 'property_select.html';
      };

      // LoadingOverlayã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      const LoadingOverlay = ({ message }) => (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 50000,
        }}>
          <div style={{
            width: '40px',
            height: '40px',
            border: '4px solid #f3f3f3',
            borderTop: '4px solid #3498db',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
          }} />
          <p style={{
            marginTop: '16px',
            color: '#666',
            fontSize: '14px',
            textAlign: 'center',
          }}>
            {message}
          </p>
          <style>
            {`
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            `}
          </style>
        </div>
      );

      const handleRoomSelect = (room) => {
        if (!propertyId || !propertyName || !room) {
          console.error('[room_select] Invalid data for room selection:', { propertyId, propertyName, room });
          alert('é¸æŠã•ã‚ŒãŸéƒ¨å±‹æƒ…å ±ãŒç„¡åŠ¹ã§ã™ã€‚');
          return;
        }

        setIsNavigating(true);
        setNavigationMessage('æ¤œé‡ç”»é¢ã«ç§»å‹•ã—ã¦ã„ã¾ã™...');
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é·ç§»
        window.scrollTo(0, 0);

        // meter_reading.html ã«ç‰©ä»¶IDã€ç‰©ä»¶åã€éƒ¨å±‹IDã€éƒ¨å±‹åã‚’æ¸¡ã—ã¦ç”»é¢é·ç§»
        const params = new URLSearchParams();
        params.append('propertyId', propertyId);
        params.append('propertyName', propertyName);
        params.append('roomId', room.id);
        params.append('roomName', room.name);
        
        const targetUrl = `meter_reading.html?${params.toString()}`;
        
        if (woff.isInClient()) {
          console.log(`[room_select] Opening window in client: ${targetUrl}`);
          woff.openWindow({
            url: targetUrl,
            external: false
          });
        } else {
          console.log(`[room_select] Redirecting to: ${targetUrl}`);
          window.location.href = targetUrl;
        }
      };      const handleInspectionComplete = async () => {
        if (!propertyId) {
          alert('ç‰©ä»¶IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        try {
          setLoading(true);

          // sessionStorageã‹ã‚‰GAS URLã‚’å–å¾—ï¼ˆproperty_select.htmlã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼‰
          const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
          
          if (!gasWebAppUrl) {
            alert('ã‚¨ãƒ©ãƒ¼: GAS Web Appã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            console.error('[room_select] gasWebAppUrlãŒsessionStorageã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            setLoading(false);
            return;
          }
            // ä¸€æ™‚çš„ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§CORSã‚¨ãƒ©ãƒ¼ã‚’å›é¿
          const requestUrl = `${gasWebAppUrl}?action=updateInspectionComplete&propertyId=${encodeURIComponent(propertyId)}`;

          console.log('[room_select] æ¤œé‡å®Œäº†ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ (GETæ–¹å¼):', {
            url: requestUrl,
            propertyId: propertyId
          });

          const response = await fetch(requestUrl, {
            method: 'GET'
          });

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          alert('æ¤œé‡å®Œäº†æ—¥ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
          
        } catch (error) {
          console.error('[room_select] æ¤œé‡å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          alert(`æ¤œé‡å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      // WOFF SDKåˆæœŸåŒ–å‰ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      if (!woffInitialized && loading) {
        return (
          <div className="mantine-container">
            <div className="mantine-center">
              <div className="mantine-stack center">
                <div className="mantine-loader"></div>
                <p className="mantine-text">ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ä¸­ã§ã™...</p>
              </div>
            </div>
          </div>
        );
      }      // WOFF SDKåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼
      if (!woffInitialized && error) {
        return (
          <div className="mantine-container">
            <div className="mantine-stack">
              <div className="mantine-alert">
                <h3 className="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p className="mantine-text">{error}</p>
              </div>
            </div>
          </div>
        );
      }      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­
      if (loading && woffInitialized) {
        return (
          <div className="mantine-container">
            <div className="mantine-stack">
              <button
                onClick={handleBackToPropertySelect}
                className="mantine-button variant-outline"
              >
                ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
              </button>
              <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
              <p className="mantine-subtitle">ç‰©ä»¶åï¼šèª­ã¿è¾¼ã¿ä¸­...</p>
              <div className="mantine-center">
                <div className="mantine-stack center">
                  <div className="mantine-loader"></div>
                  <p className="mantine-text">éƒ¨å±‹æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
                </div>
              </div>
            </div>
          </div>
        );
      }      // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤º
      if (error) {
        return (
          <div className="mantine-container">
            <div className="mantine-stack">
              <button
                onClick={handleBackToPropertySelect}
                className="mantine-button variant-outline"
              >
                ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
              </button>
              <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
              <p className="mantine-subtitle">ç‰©ä»¶åï¼š{propertyName}</p>
              <div className="mantine-alert">
                <h3 className="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p className="mantine-text">{error}</p>
              </div>
            </div>
          </div>
        );
      }      return (
        <div className="mantine-container">
          {isNavigating && <LoadingOverlay message={navigationMessage} />}
          <div className="mantine-stack">            <button
              onClick={handleBackToPropertySelect}
              className="mantine-button variant-outline"
            >
              ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
            </button>
            <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
            <p className="mantine-subtitle">ç‰©ä»¶åï¼š{propertyName}</p>
            
            <button
              onClick={handleInspectionComplete}
              disabled={loading}
              className="mantine-button variant-filled inspection-complete-btn"
            >
              {loading ? 'æ›´æ–°ä¸­...' : 'æ¤œé‡å®Œäº†'}
            </button>

            {!Array.isArray(rooms) && (
              <div className="mantine-alert">
                <h3 className="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p className="mantine-text">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              </div>
            )}
            
            {Array.isArray(rooms) && rooms.length === 0 && (
              <p className="mantine-text center">ã“ã®ç‰©ä»¶ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            )}

            {Array.isArray(rooms) && rooms.length > 0 && (
              <div className="mantine-stack">
                {rooms.map(room => {
                  // åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ã‚’ä½¿ç”¨
                  const displayName = room.name || room.roomName || 'éƒ¨å±‹åæœªè¨­å®š';
                  const inspectionStatus = formatInspectionStatus(room.rawInspectionDate, room.hasActualReading);
                  
                  return (
                    <div key={room.id} className="mantine-paper">
                      <button
                        onClick={() => handleRoomSelect(room)}
                        disabled={loading || isNavigating}
                        className="room-card"
                      >
                        <div className="room-info">
                          <div className="room-header">
                            <span className="room-number">
                              {displayName}
                              {/* åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿æ¤œé‡çŠ¶æ³ã‚’è¡¨ç¤º */}
                              {inspectionStatus.status === 'æ¤œé‡æ¸ˆã¿' && inspectionStatus.displayDate && (
                                <span style={{
                                  color: 'var(--mantine-color-blue-6)',
                                  fontWeight: '500',
                                  fontSize: '0.9em',
                                  marginLeft: '8px'
                                }}>
                                  [æ¤œé‡æ—¥ï¼š{inspectionStatus.displayDate}]
                                </span>
                              )}
                              {inspectionStatus.status === 'æœªæ¤œé‡' && (
                                <span style={{
                                  color: 'var(--mantine-color-red-6)',
                                  fontWeight: '600',
                                  fontSize: '0.9em',
                                  marginLeft: '8px'
                                }}>
                                  [æœªæ¤œé‡]
                                </span>
                              )}
                            </span>
                          </div>
                        </div>
                        <svg className="room-arrow" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                        </svg>
                      </button>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );    };

    // Use React 18 createRoot API instead of ReactDOM.render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<RoomSelectApp />);
  </script>
</body>
</html>