<!DOCTYPE html>
<html>
<head>
    <title>GAS Manual Test - æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        input { padding: 8px; margin: 5px; font-size: 14px; }
        .url-input { width: 600px; }
        .note { background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Google Apps Script æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="note">
        <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
        <ol>
            <li>Google Apps Script ã§ ç‰©ä»¶.gs ã‚’æœ€æ–°ç‰ˆã«ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ</li>
            <li>æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½œæˆ</li>
            <li>å–å¾—ã—ãŸæ–°ã—ã„URLã‚’ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›</li>
            <li>å„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>ğŸŒ GAS Web App URLè¨­å®š</h3>        <input type="text" id="gasUrl" class="url-input" 
               value="https://script.google.com/macros/s/AKfycbxTTWidncWsObUx0wyXy_hQI1WCzxFwXgQiD9sjlLSLe5-G_xYH14jV2PnUeJhcrTYO2A/exec"
               placeholder="Google Apps Script Web App URL">
        <button onclick="saveUrl()">URLä¿å­˜</button>
        <div id="url-status"></div>
    </div>

    <div class="test-section">
        <h3>1ï¸âƒ£ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆ</h3>
        <button onclick="testVersion()">getVersion ãƒ†ã‚¹ãƒˆ</button>
        <div id="version-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2ï¸âƒ£ åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h3>
        <button onclick="testGetProperties()">getProperties ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testGetRooms()">getRooms ãƒ†ã‚¹ãƒˆ</button>
        <div id="basic-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3ï¸âƒ£ æ¤œé‡ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h3>
        <input type="text" id="testPropertyId" placeholder="ç‰©ä»¶ID (ä¾‹: P000001)" value="P000001">
        <input type="text" id="testRoomId" placeholder="éƒ¨å±‹ID (ä¾‹: R000001)" value="R000001">
        <br>
        <button onclick="testGetMeterReadings()">getMeterReadings ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testUpdateMeterReadings()">updateMeterReadings ãƒ†ã‚¹ãƒˆ</button>
        <div id="meter-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4ï¸âƒ£ æ¤œé‡å®Œäº†ãƒ†ã‚¹ãƒˆ</h3>
        <input type="text" id="inspectionPropertyId" placeholder="ç‰©ä»¶ID" value="P000001">
        <button onclick="testUpdateInspectionComplete()">updateInspectionComplete ãƒ†ã‚¹ãƒˆ</button>
        <div id="inspection-result" class="result"></div>
    </div>

    <script>
        let gasWebAppUrl = '';

        function saveUrl() {
            gasWebAppUrl = document.getElementById('gasUrl').value;
            sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
            document.getElementById('url-status').innerHTML = '<span style="color: green;">âœ… URLä¿å­˜å®Œäº†</span>';
        }

        function getGasUrl() {
            return gasWebAppUrl || sessionStorage.getItem('gasWebAppUrl') || document.getElementById('gasUrl').value;
        }

        async function makeRequest(action, params = {}) {
            const url = getGasUrl();
            if (!url) {
                throw new Error('GAS Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            const urlParams = new URLSearchParams({action, ...params});
            const fullUrl = `${url}?${urlParams.toString()}`;
            
            console.log(`ğŸŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: ${fullUrl}`);
            
            const response = await fetch(fullUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        async function testVersion() {
            const resultDiv = document.getElementById('version-result');
            resultDiv.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const result = await makeRequest('getVersion');
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
                if (result.version === '2025-01-02-v3') {
                    resultDiv.innerHTML += '\n\nâœ… æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³(v3)ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ï¼';
                } else if (result.version === '2025-01-02-v2') {
                    resultDiv.innerHTML += '\n\nâš ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³v2ã§ã™ã€‚v3ã¸ã®æ›´æ–°ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
                } else {
                    resultDiv.innerHTML += '\n\nâŒ å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ã€‚';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testGetProperties() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.textContent = 'getProperties ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const result = await makeRequest('getProperties');
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testGetRooms() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.textContent = 'getRooms ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const result = await makeRequest('getRooms', {propertyId: 'P000001'});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testGetMeterReadings() {
            const resultDiv = document.getElementById('meter-result');
            const propertyId = document.getElementById('testPropertyId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ç‰©ä»¶IDã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            resultDiv.textContent = 'getMeterReadings ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const result = await makeRequest('getMeterReadings', {propertyId, roomId});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testUpdateMeterReadings() {
            const resultDiv = document.getElementById('meter-result');
            const propertyId = document.getElementById('testPropertyId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ç‰©ä»¶IDã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            resultDiv.textContent = 'updateMeterReadings ãƒ†ã‚¹ãƒˆä¸­...';
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿
            const testReadings = [
                {
                    date: '2025-01-02',
                    currentReading: '1234.56',
                    photoData: null,
                    usage: '50'
                }
            ];
            
            try {
                const result = await makeRequest('updateMeterReadings', {
                    propertyId,
                    roomId,
                    readings: JSON.stringify(testReadings)
                });
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        async function testUpdateInspectionComplete() {
            const resultDiv = document.getElementById('inspection-result');
            const propertyId = document.getElementById('inspectionPropertyId').value;
            
            if (!propertyId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ç‰©ä»¶IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            resultDiv.textContent = 'updateInspectionComplete ãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const result = await makeRequest('updateInspectionComplete', {propertyId});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            const savedUrl = sessionStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                gasWebAppUrl = savedUrl;
                document.getElementById('gasUrl').value = savedUrl;
                document.getElementById('url-status').innerHTML = '<span style="color: blue;">ğŸ’¾ ä¿å­˜æ¸ˆã¿URLèª­ã¿è¾¼ã¿å®Œäº†</span>';
            }
        };
    </script>
</body>
</html>
