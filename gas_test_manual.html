<!DOCTYPE html>
<html>
<head>
    <title>GAS Manual Test - 手動テスト</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        input { padding: 8px; margin: 5px; font-size: 14px; }
        .url-input { width: 600px; }
        .note { background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔧 Google Apps Script 手動テスト</h1>
    
    <div class="note">
        <h3>📋 使用方法</h3>
        <ol>
            <li>Google Apps Script で 物件.gs を最新版にコピー&ペースト</li>
            <li>新しいデプロイを作成</li>
            <li>取得した新しいURLを下のフィールドに入力</li>
            <li>各ボタンをクリックしてテスト実行</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>🌐 GAS Web App URL設定</h3>        <input type="text" id="gasUrl" class="url-input" 
               value="https://script.google.com/macros/s/AKfycbxTTWidncWsObUx0wyXy_hQI1WCzxFwXgQiD9sjlLSLe5-G_xYH14jV2PnUeJhcrTYO2A/exec"
               placeholder="Google Apps Script Web App URL">
        <button onclick="saveUrl()">URL保存</button>
        <div id="url-status"></div>
    </div>

    <div class="test-section">
        <h3>1️⃣ バージョン確認テスト</h3>
        <button onclick="testVersion()">getVersion テスト</button>
        <div id="version-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2️⃣ 基本機能テスト</h3>
        <button onclick="testGetProperties()">getProperties テスト</button>
        <button onclick="testGetRooms()">getRooms テスト</button>
        <div id="basic-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3️⃣ 検針データテスト</h3>
        <input type="text" id="testPropertyId" placeholder="物件ID (例: P000001)" value="P000001">
        <input type="text" id="testRoomId" placeholder="部屋ID (例: R000001)" value="R000001">
        <br>
        <button onclick="testGetMeterReadings()">getMeterReadings テスト</button>
        <button onclick="testUpdateMeterReadings()">updateMeterReadings テスト</button>
        <div id="meter-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4️⃣ 検針完了テスト</h3>
        <input type="text" id="inspectionPropertyId" placeholder="物件ID" value="P000001">
        <button onclick="testUpdateInspectionComplete()">updateInspectionComplete テスト</button>
        <div id="inspection-result" class="result"></div>
    </div>

    <script>
        let gasWebAppUrl = '';

        function saveUrl() {
            gasWebAppUrl = document.getElementById('gasUrl').value;
            sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
            document.getElementById('url-status').innerHTML = '<span style="color: green;">✅ URL保存完了</span>';
        }

        function getGasUrl() {
            return gasWebAppUrl || sessionStorage.getItem('gasWebAppUrl') || document.getElementById('gasUrl').value;
        }

        async function makeRequest(action, params = {}) {
            const url = getGasUrl();
            if (!url) {
                throw new Error('GAS Web App URLが設定されていません');
            }

            const urlParams = new URLSearchParams({action, ...params});
            const fullUrl = `${url}?${urlParams.toString()}`;
            
            console.log(`🌐 リクエスト送信: ${fullUrl}`);
            
            const response = await fetch(fullUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        async function testVersion() {
            const resultDiv = document.getElementById('version-result');
            resultDiv.textContent = 'テスト中...';
            
            try {
                const result = await makeRequest('getVersion');
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                  // バージョンチェック
                if (result.version === '2025-01-02-v3') {
                    resultDiv.innerHTML += '\n\n✅ 最新バージョン(v3)が正常にデプロイされています！';
                } else if (result.version === '2025-01-02-v2') {
                    resultDiv.innerHTML += '\n\n⚠️ バージョンv2です。v3への更新を推奨します。';
                } else {
                    resultDiv.innerHTML += '\n\n❌ 古いバージョンです。再デプロイが必要です。';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function testGetProperties() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.textContent = 'getProperties テスト中...';
            
            try {
                const result = await makeRequest('getProperties');
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function testGetRooms() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.textContent = 'getRooms テスト中...';
            
            try {
                const result = await makeRequest('getRooms', {propertyId: 'P000001'});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function testGetMeterReadings() {
            const resultDiv = document.getElementById('meter-result');
            const propertyId = document.getElementById('testPropertyId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 物件IDと部屋IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'getMeterReadings テスト中...';
            
            try {
                const result = await makeRequest('getMeterReadings', {propertyId, roomId});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function testUpdateMeterReadings() {
            const resultDiv = document.getElementById('meter-result');
            const propertyId = document.getElementById('testPropertyId').value;
            const roomId = document.getElementById('testRoomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 物件IDと部屋IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'updateMeterReadings テスト中...';
            
            // テスト用の検針データ
            const testReadings = [
                {
                    date: '2025-01-02',
                    currentReading: '1234.56',
                    photoData: null,
                    usage: '50'
                }
            ];
            
            try {
                const result = await makeRequest('updateMeterReadings', {
                    propertyId,
                    roomId,
                    readings: JSON.stringify(testReadings)
                });
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        async function testUpdateInspectionComplete() {
            const resultDiv = document.getElementById('inspection-result');
            const propertyId = document.getElementById('inspectionPropertyId').value;
            
            if (!propertyId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 物件IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'updateInspectionComplete テスト中...';
            
            try {
                const result = await makeRequest('updateInspectionComplete', {propertyId});
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ エラー: ${error.message}`;
            }
        }

        // 初期化
        window.onload = function() {
            const savedUrl = sessionStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                gasWebAppUrl = savedUrl;
                document.getElementById('gasUrl').value = savedUrl;
                document.getElementById('url-status').innerHTML = '<span style="color: blue;">💾 保存済みURL読み込み完了</span>';
            }
        };
    </script>
</body>
</html>
