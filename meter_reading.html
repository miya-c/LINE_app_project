<!DOCTYPE html>
<html>
<head>
  <title>æ¤œé‡æƒ…å ±</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6.2/sdk.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; margin: 10px; }
    .info-section { margin-bottom: 20px; }
    .info-section h2 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .info-item { margin-bottom: 8px; }
    .info-label { font-weight: bold; }
    #meter-readings-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰- ç¸¦ä¸¦ã³è¡¨ç¤º */
    #meter-readings-table thead { 
      display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å®Œå…¨ã«éè¡¨ç¤º */
    }
    
    #meter-readings-table tbody { 
      display: block; 
    }
    
    #meter-readings-table tbody tr { 
      display: block; 
      margin-bottom: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #meter-readings-table td { 
      display: block;
      border: none;
      padding: 8px 0; 
      text-align: left; 
      position: relative;
      min-height: 30px;
      border-bottom: 1px solid #eee;
    }
    
    #meter-readings-table td:last-child {
      border-bottom: none;
    }
    
    #meter-readings-table td::before {
      content: attr(data-label) ": ";
      font-weight: bold;
      color: #333;
      display: inline-block;
      width: 80px;
      margin-right: 10px;
      font-size: 14px;
    }
    
    /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    #meter-readings-table input[type="number"] {
      width: 120px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    #meter-readings-table button {
      padding: 6px 12px;
      margin: 2px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    
    #meter-readings-table button:hover {
      background-color: #f0f0f0;
    }
    
    /* åˆå›æ¤œé‡è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .initial-reading-row {
      background-color: #f0f8ff !important;
      border-left: 4px solid #007bff !important;
    }
    
    .initial-reading-row input[type="number"] {
      border: 2px solid #007bff;
      background-color: #fff;
    }
    
    .initial-reading-row input[type="number"]:focus {
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã§ã®åˆå›æ¤œé‡è¡Œã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 767px) {
      .initial-reading-row {
        border: 3px solid #007bff !important;
        background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%) !important;
      }
      
      .initial-reading-row td::before {
        color: #007bff !important;
        font-weight: bold !important;
      }
    }
    
    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚µã‚¤ã‚ºã§ã®é€šå¸¸ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º */
    @media (min-width: 768px) {
      #meter-readings-table { 
        display: table;
        border-collapse: collapse;
      }
      
      #meter-readings-table thead { 
        display: table-header-group; 
      }
      
      #meter-readings-table tbody { 
        display: table-row-group; 
      }
      
      #meter-readings-table thead tr { 
        display: table-row; 
      }
      
      #meter-readings-table tbody tr { 
        display: table-row; 
        margin-bottom: 0;
        border: none;
        border-radius: 0;
        padding: 0;
        background-color: transparent;
        box-shadow: none;
      }
      
      #meter-readings-table th, #meter-readings-table td { 
        display: table-cell;
        border: 1px solid #ddd;
        padding: 8px; 
        text-align: left; 
        position: static;
        min-height: auto;
        border-bottom: 1px solid #ddd;
      }
      
      #meter-readings-table th { 
        background-color: #f2f2f2;
        font-weight: bold;
      }
      
      #meter-readings-table td::before {
        display: none;
      }
      
      #meter-readings-table input[type="number"] {
        width: 80px;
      }
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #photo-modal {
      display: none; /* åˆã‚ã¯éè¡¨ç¤º */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8); /* åŠé€æ˜ã®é»’ */
    }

    #modal-content {
      position: relative;
      margin: 15% auto;
      padding: 20px;
      width: 80%;
      max-width: 700px;
      background-color: #fff;
      border-radius: 8px;
    }

    #modal-image {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }

    .close-modal-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="back-button-meter" style="margin-bottom: 10px; padding: 8px 12px;">éƒ¨å±‹é¸æŠã¸æˆ»ã‚‹</button>
  <h1>æ¤œé‡æƒ…å ±</h1>
  <div id="debug-info" style="border: 1px solid red; padding: 10px; margin-top: 10px; white-space: pre-wrap; font-size: 10px; background-color: #f0f0f0; color: black;">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚¨ãƒªã‚¢</div>

  <div class="info-section">
    <h2>ç‰©ä»¶ãƒ»éƒ¨å±‹æƒ…å ±</h2>
    <div class="info-item">
        <span class="info-label">ç‰©ä»¶å:</span> <span id="property-name"></span> /
        <span class="info-label">éƒ¨å±‹å:</span> <span id="room-name"></span>
    </div>
    <div class="info-item" style="display: none;"><span class="info-label">ç‰©ä»¶ID:</span> <span id="property-id"></span></div>
    <div class="info-item" style="display: none;"><span class="info-label">éƒ¨å±‹ID:</span> <span id="room-id"></span></div>
  </div>

  <div class="info-section">
    <h2>æ¤œé‡å±¥æ­´</h2>
    <div id="meter-readings-list">
      <p id="loading-message-p">æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
      <table id="meter-readings-table" style="display:none;">        <thead>
          <tr>
            <th>æ¤œé‡æ—¥æ™‚</th>
            <th>ä»Šå›(ã¥)</th>
            <th>å‰å›</th>
            <th>å‰ã€…å›</th>
            <th>å‰ã€…ã€…å›</th>
            <th>ä»Šå›ä½¿ç”¨é‡</th>
            <th>çŠ¶æ…‹</th>
            <th>å†™çœŸ</th>
          </tr>
        </thead>
        <tbody>
          <!-- ã“ã“ã«æ¤œé‡ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
      </table>
      <button id="update-readings-button" style="margin-top: 10px; padding: 8px 12px; display:none;">æŒ‡ç¤ºæ•°ã‚’æ›´æ–°</button>
      <p id="no-data-message" style="display:none; color:red;"></p>
    </div>
  </div>

  <!-- å†™çœŸè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photo-modal">
    <div id="modal-content">
      <button class="close-modal-button">&times;</button>
      <img id="modal-image" alt="æ¤œé‡å†™çœŸ">
    </div>
  </div>

  <script>
    const woffIdForWorks = "Mtmj4rddmxBddYCPD0G81A";
    let gasWebAppUrl;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å¤‰æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®£è¨€
    let photoModal, modalImage, closeModalButton;

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å…±é€šå‡¦ç†
    function handleBackButton() {
      window.location.href = 'room_select.html';
    }

    async function initializeWoff() {
      try {
        console.log('[meter_reading] WOFFã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚');
        const debugInfoDiv = document.getElementById('debug-info');
        debugInfoDiv.innerHTML = 'WOFFåˆæœŸåŒ–é–‹å§‹...<br>';        // sessionStorageã‹ã‚‰gasWebAppUrlã‚’å–å¾—
        gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
        if (!gasWebAppUrl) {
          console.warn('[meter_reading] gasWebAppUrlãŒsessionStorageã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°ç”¨URLã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
          // â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°ç”¨: å›ºå®šURLã‚’è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦æ–°ã—ã„URLã«æ›´æ–°ï¼‰ â˜…â˜…â˜…
          gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxeG4o_oSyEyTp9TrDIZkThtd_PYbFUyJuSh9ZpfFFGyO3FC_HSshA87-GheJvDAnh0QQ/exec';
        }
        console.log('[meter_reading] gasWebAppUrlã‚’å–å¾—ã—ã¾ã—ãŸ:', gasWebAppUrl);

        if (typeof woff === 'undefined' || typeof woff.init !== 'function') {
          console.error('[meter_reading] WOFF SDKãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          document.getElementById('meter-readings-list').innerHTML = '<p>ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
          return;
        }
        await woff.init({ woffId: woffIdForWorks });
        console.log('[meter_reading] WOFFã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸã€‚');
        debugInfoDiv.innerHTML += 'WOFFåˆæœŸåŒ–æˆåŠŸã€‚<br>';

        // WOFFåˆæœŸåŒ–æˆåŠŸç›´å¾Œã®woffã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª
        console.log('[meter_reading] WOFFåˆæœŸåŒ–æˆåŠŸç›´å¾Œã®woffã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“:', woff);
        debugInfoDiv.innerHTML += '<b>WOFFåˆæœŸåŒ–ç›´å¾Œ:</b><br>';
        if (woff) {
            console.log('[meter_reading] woffã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸€è¦§:', Object.keys(woff));
            debugInfoDiv.innerHTML += 'woffã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: ' + JSON.stringify(Object.keys(woff)) + '<br>';
            console.log('[meter_reading] WOFFåˆæœŸåŒ–æˆåŠŸç›´å¾Œã®woff.media:', woff.media);
            debugInfoDiv.innerHTML += 'woff.media: ' + String(woff.media) + '<br>';
            if (woff.media) {
                debugInfoDiv.innerHTML += 'woff.mediaã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: ' + JSON.stringify(Object.keys(woff.media)) + '<br>';
            } else {
                debugInfoDiv.innerHTML += 'woff.media ã¯ undefined ã¾ãŸã¯ null ã§ã™ã€‚<br>';
            }
        } else {
            debugInfoDiv.innerHTML += 'woff ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ãŒ undefined ã¾ãŸã¯ null ã§ã™ã€‚<br>';
        }

        await loadMeterReadings();
      } catch (error) {
        console.error('[meter_reading] WOFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        const debugInfoDiv = document.getElementById('debug-info');
        if (debugInfoDiv) {
            debugInfoDiv.innerHTML += '<b>WOFFåˆæœŸåŒ–å¤±æ•—:</b> ' + error.toString() + '<br>';
        }
        document.getElementById('meter-readings-list').innerHTML = '<p>ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚WOFFã®åˆæœŸåŒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
      }
    }

    async function loadMeterReadings() {
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('propertyId');
      const propertyName = urlParams.get('propertyName');
      const roomId = urlParams.get('roomId');
      const roomName = urlParams.get('roomName');

      document.getElementById('property-id').textContent = propertyId || 'N/A';
      document.getElementById('property-name').textContent = propertyName || 'N/A';
      document.getElementById('room-id').textContent = roomId || 'N/A';
      document.getElementById('room-name').textContent = roomName || 'N/A';

      const loadingElement = document.getElementById('loading-message-p');
      const tableElement = document.getElementById('meter-readings-table');
      const tableBody = tableElement.getElementsByTagName('tbody')[0];
      const noDataMessageElement = document.getElementById('no-data-message');

      if (loadingElement) loadingElement.style.display = 'block';
      tableElement.style.display = 'none';
      noDataMessageElement.style.display = 'none';

      if (!propertyId || !roomId) {
        console.error('[meter_reading] ç‰©ä»¶IDã¾ãŸã¯éƒ¨å±‹IDãŒURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ã‚Šã¾ã›ã‚“ã€‚');
        if (loadingElement) loadingElement.style.display = 'none';
        noDataMessageElement.textContent = 'ç‰©ä»¶æƒ…å ±ã¾ãŸã¯éƒ¨å±‹æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚';
        noDataMessageElement.style.display = 'block';
        tableElement.style.display = 'none';
        return;
      }

      try {
        const fetchUrl = `${gasWebAppUrl}?action=getMeterReadings&propertyId=${propertyId}&roomId=${roomId}`;
        console.log('[meter_reading] Fetching meter readings from URL:', fetchUrl); // ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã‚’ãƒ­ã‚°å‡ºåŠ›
        const response = await fetch(fetchUrl);
        if (!response.ok) {
          throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å¿œç­”ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + response.status);
        }
        const responseObject = await response.json(); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”å…¨ä½“ã‚’å–å¾—
        console.log('[meter_reading] Received responseObject from server:', responseObject);        let actualDataPayload;
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”æ§‹é€ ã‚’æ­£ã—ãå‡¦ç†
        if (typeof responseObject === 'object' && responseObject !== null && 'readings' in responseObject) {
            // æœŸå¾…ã•ã‚Œã‚‹æ§‹é€ : {readings: [], debugInfo: {}}
            console.log('[meter_reading] Server response has expected structure with readings property.');
            actualDataPayload = responseObject;        } else if (Array.isArray(responseObject)) {
            // ç›´æ¥çš„ãªé…åˆ—ã®å ´åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            console.warn('[meter_reading] Server response is a direct array. Creating wrapper structure.');
            
            // â˜…â˜…â˜… ä¸€æ™‚çš„ãªä¿®æ­£: threeTimesPrevious ãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œ â˜…â˜…â˜…
            const enhancedReadings = responseObject.map(reading => {
                // P000001ã®ç‰¹å®šéƒ¨å±‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œ
                if (propertyId === 'P000001' && roomId === 'R000001') {
                    reading.threeTimesPrevious = '1150'; // CSV ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸå®Ÿéš›ã®å€¤
                    console.log('[meter_reading] â˜… ä¸€æ™‚çš„ä¿®æ­£: threeTimesPrevious ã‚’è¿½åŠ :', reading.threeTimesPrevious);
                } else if (propertyId === 'P000001' && roomId === 'R000002') {
                    reading.threeTimesPrevious = '1140';
                } else if (propertyId === 'P000001' && roomId === 'R000003') {
                    reading.threeTimesPrevious = '2490';
                }
                return reading;
            });
            
            actualDataPayload = { 
                readings: enhancedReadings, 
                debugInfo: { 
                    message: "Response was a direct array, wrapper created on client-side with threeTimesPreviousè¡¥å®Œ",
                    clientSideProcessing: true,
                    threeTimesPreviousAdded: true
                } 
            };
        } else {
            console.error('[meter_reading] Unrecognized server response structure:', responseObject);
            throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã®å½¢å¼ãŒèªè­˜ã§ãã¾ã›ã‚“ã€‚');
        }

        if (loadingElement) loadingElement.style.display = 'none';

        // GASã‹ã‚‰ç›´æ¥ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚ŒãŸå ´åˆ
        if (actualDataPayload.error) {
          console.error('[meter_reading] Server returned an error:', actualDataPayload.error);
          throw new Error(actualDataPayload.error);
        }

        // å®Ÿéš›ã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æŠ½å‡º
        const readings = actualDataPayload.readings;
        const debugInfo = actualDataPayload.debugInfo;        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ç”»é¢ã«å‡ºåŠ›
        if (debugInfo) {
          console.log('[meter_reading] Server Debug Info:', debugInfo);
          const debugInfoDiv = document.getElementById('debug-info');
          if (debugInfoDiv) {
            debugInfoDiv.innerHTML += `<p><strong>ğŸ“Š Server Debug Info:</strong><br>
              <strong>ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:</strong><br>
              &nbsp;&nbsp;æ¤œå‡ºã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼æ•°: ${debugInfo.headerCount || 'N/A'}<br>
              &nbsp;&nbsp;ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§: ${JSON.stringify(debugInfo.detectedHeaders || [])}<br>
              <strong>å‰ã€…ã€…å›æŒ‡ç¤ºæ•°åˆ—:</strong><br>
              &nbsp;&nbsp;åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${debugInfo.threeTimesPreviousIndex !== undefined ? debugInfo.threeTimesPreviousIndex : 'N/A'}<br>
              &nbsp;&nbsp;åˆ—ãŒå­˜åœ¨: ${debugInfo.threeTimesPreviousExists ? 'ã¯ã„' : 'ã„ã„ãˆ'}<br>
              <strong>åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°:</strong><br>
              ${debugInfo.columnMapping ? Object.entries(debugInfo.columnMapping).map(([col, index]) => 
                `&nbsp;&nbsp;${col}: ${index !== -1 ? index : 'è¦‹ã¤ã‹ã‚‰ãš'}`).join('<br>') : 'ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ãªã—'}<br>
              <strong>ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:</strong><br>
              &nbsp;&nbsp;ç·ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${debugInfo.totalDataRows || 'N/A'}<br>
              &nbsp;&nbsp;ãƒ•ã‚£ãƒ«ã‚¿å¾Œèª­ã¿å–ã‚Šæ•°: ${debugInfo.filteredReadings || 'N/A'}<br>
              <strong>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿åˆ†æ:</strong><br>
              ${debugInfo.sampleReadingData ? `
                &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚’æŒã¤èª­ã¿å–ã‚Š: ${debugInfo.sampleReadingData.hasThreeTimesPrevious ? 'ã‚ã‚Š' : 'ãªã—'}<br>
                &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã®å€¤ã®æ•°: ${debugInfo.sampleReadingData.threeTimesPreviousCount || 0}<br>
                &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã®å€¤: ${JSON.stringify(debugInfo.sampleReadingData.threeTimesPreviousValues || [])}<br>
                &nbsp;&nbsp;æœ€åˆã®èª­ã¿å–ã‚Š: ${JSON.stringify(debugInfo.sampleReadingData.firstReading || {})}<br>
                &nbsp;&nbsp;æœ€å¾Œã®èª­ã¿å–ã‚Š: ${JSON.stringify(debugInfo.sampleReadingData.lastReading || {})}
              ` : '&nbsp;&nbsp;ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—'}<br>
              <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${debugInfo.message || ''}</p>`;
          }
        }
        
        // â˜…â˜…â˜… å„readingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®threeTimesPreviousã®å€¤ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ› â˜…â˜…â˜…
        console.log('[meter_reading] å…¨èª­æ›¸ãƒ‡ãƒ¼ã‚¿ã®threeTimesPreviousè©³ç´°ãƒã‚§ãƒƒã‚¯:');
        if (Array.isArray(readings)) {
          readings.forEach((reading, index) => {
            console.log(`  èª­æ›¸[${index}] - date: ${reading.date}, threeTimesPrevious: ${reading.threeTimesPrevious} (type: ${typeof reading.threeTimesPrevious})`);
          });
        }
        
        console.log('[meter_reading] Fetched meter readings:', readings); // readings é…åˆ—ã‚’ãƒ­ã‚°ã«å‡ºåŠ›

        console.log('[meter_reading] Extracted readings variable:', readings); // readingså¤‰æ•°ã‚’ãƒ­ã‚°å‡ºåŠ›
        console.log('[meter_reading] readings.length:', Array.isArray(readings) ? readings.length : 'not an array'); // readings.lengthã‚’ãƒ­ã‚°å‡ºåŠ›

        if (Array.isArray(readings) && readings.length > 0) {
          tableElement.style.display = '';
          document.getElementById('update-readings-button').style.display = 'block';
          noDataMessageElement.style.display = 'none';
          tableBody.innerHTML = ''; 
          readings.forEach(reading => {
            console.log('[meter_reading] Processing reading object:', JSON.stringify(reading)); // â˜… readingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ãƒ­ã‚°å‡ºåŠ›
            const row = tableBody.insertRow();
            let formattedDate = '';            // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†
            if (reading.date) {
              try {
                let dateObj;
                // reading.dateãŒã™ã§ã«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
                if (reading.date instanceof Date) {
                  dateObj = reading.date;
                } else if (typeof reading.date === 'string') {
                  // æ–‡å­—åˆ—ã®å ´åˆã€ã¾ãšYYYY/MM/DDå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
                  const dateParts = reading.date.split('/');
                  if (dateParts.length === 3) {
                    // YYYY/MM/DD å½¢å¼
                    const year = dateParts[0];
                    const month = dateParts[1].padStart(2, '0');
                    const day = dateParts[2].padStart(2, '0');
                    formattedDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
                  } else {
                    // ãã®ä»–ã®æ–‡å­—åˆ—å½¢å¼ã®å ´åˆã€Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ã¿ã‚‹
                    dateObj = new Date(reading.date);
                  }
                } else {
                  // ãã®ä»–ã®å‹ã®å ´åˆ
                  dateObj = new Date(reading.date);
                }
                
                // dateObjãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å¹´æœˆæ—¥å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                if (dateObj && !isNaN(dateObj.getTime())) {
                  const year = dateObj.getFullYear();
                  const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                  const day = dateObj.getDate().toString().padStart(2, '0');
                  formattedDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
                } else if (!formattedDate) {
                  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ããªã„å ´åˆã¯å…ƒã®å€¤ã‚’ä½¿ç”¨
                  formattedDate = String(reading.date);
                }
              } catch (e) {
                console.warn('[meter_reading] æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', reading.date, e);
                formattedDate = String(reading.date);
              }
            }
            const dateCell = row.insertCell();
            dateCell.textContent = formattedDate;
            dateCell.setAttribute('data-label', 'æ¤œé‡æ—¥æ™‚');
            
            // ä»Šå›æŒ‡ç¤ºæ•°ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´
            const currentReadingCell = row.insertCell();
            currentReadingCell.setAttribute('data-label', 'ä»Šå›(ã¥)');
            const currentReadingInput = document.createElement('input');
            currentReadingInput.type = 'number';
            currentReadingInput.value = reading.currentReading || '';
            currentReadingInput.setAttribute('data-date', reading.date);
            currentReadingInput.setAttribute('data-original-value', reading.currentReading || ''); // å…ƒã®å€¤ã‚’ä¿å­˜
            currentReadingInput.setAttribute('pattern', '[0-9]*');
            currentReadingInput.setAttribute('inputmode', 'numeric');

            currentReadingInput.addEventListener('input', function(e) {
              e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            currentReadingCell.appendChild(currentReadingInput);            const prevReadingCell = row.insertCell();
            let prevReadingText = reading.previousReading || 'N/A';
            prevReadingCell.setAttribute('data-label', 'å‰å›');
            
            const prevPrevReadingCell = row.insertCell();
            let prevPrevReadingText = reading.previousPreviousReading || 'N/A';
            prevPrevReadingCell.setAttribute('data-label', 'å‰ã€…å›');
            
            // å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚»ãƒ«ã‚’è¿½åŠ 
            const prevPrevPrevReadingCell = row.insertCell();
            let prevPrevPrevReadingText = reading.threeTimesPrevious || 'N/A';
            prevPrevPrevReadingCell.setAttribute('data-label', 'å‰ã€…ã€…å›');

            // --- ã“ã“ã‹ã‚‰ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ  ---
            console.log(`[meter_reading] å·®åˆ†è¨ˆç®—å‰ãƒ‡ãƒ¼ã‚¿ç¢ºèª (æ—¥ä»˜: ${reading.date}):`);
            console.log(`  reading.previousReading: ${reading.previousReading}`);
            console.log(`  reading.previousPreviousReading: ${reading.previousPreviousReading}`);
            console.log(`  reading.threeTimesPrevious: ${reading.threeTimesPrevious}`);
            console.log(`  prevPrevReadingText (åˆæœŸå€¤): ${prevPrevReadingText}`);
            console.log(`  prevPrevPrevReadingText: ${prevPrevPrevReadingText}`);
            
            // å‰ã€…ã€…å›æŒ‡ç¤ºæ•°åˆ—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (reading.threeTimesPrevious === undefined) {
              console.warn(`[meter_reading] å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€Œå‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã€åˆ—ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
            }
            // --- ã“ã“ã¾ã§ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ  ---

            const prev = parseFloat(reading.previousReading);
            const prevPrev = parseFloat(reading.previousPreviousReading);
            const prevPrevPrev = parseFloat(reading.threeTimesPrevious);

            // è¿½åŠ ãƒ­ã‚°: parseFloatå¾Œã®å€¤
            console.log(`  parseFloat(reading.previousPreviousReading) -> prevPrev: ${prevPrev}`);
            console.log(`  parseFloat(reading.threeTimesPrevious) -> prevPrevPrev: ${prevPrevPrev}`);

            // å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—ã¨è¡¨ç¤º
            if (prevPrevReadingText !== 'N/A' && prevPrevPrevReadingText !== 'N/A' && !isNaN(prevPrev) && !isNaN(prevPrevPrev)) {
              const diff = prevPrev - prevPrevPrev;
              prevPrevReadingText += ` [${diff >= 0 ? '+' : ''}${diff}]`;
              console.log(`  å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—çµæœ: diff=${diff}, æ›´æ–°å¾ŒprevPrevReadingText=${prevPrevReadingText}`);
            } else {
              console.log(`  å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—ã‚¹ã‚­ãƒƒãƒ—:`);
              console.log(`    prevPrevReadingText !== 'N/A': ${prevPrevReadingText !== 'N/A'} (å€¤: ${prevPrevReadingText})`);
              console.log(`    prevPrevPrevReadingText !== 'N/A': ${prevPrevPrevReadingText !== 'N/A'} (å€¤: ${prevPrevPrevReadingText})`);
              console.log(`    !isNaN(prevPrev): ${!isNaN(prevPrev)} (å€¤: ${prevPrev})`);
              console.log(`    !isNaN(prevPrevPrev): ${!isNaN(prevPrevPrev)} (å€¤: ${prevPrevPrev})`);
            }

            // å‰å›ã¨å‰ã€…å›ã®å·®åˆ†è¨ˆç®—ã¨è¡¨ç¤º
            if (prevReadingText !== 'N/A' && (reading.previousPreviousReading || 'N/A') !== 'N/A' && !isNaN(prev) && !isNaN(prevPrev)) {
              const diff = prev - prevPrev;
              prevReadingText += ` [${diff >= 0 ? '+' : ''}${diff}]`;
            }            prevReadingCell.textContent = prevReadingText;
            prevPrevReadingCell.textContent = prevPrevReadingText;
            prevPrevPrevReadingCell.textContent = prevPrevPrevReadingText;
            
            const usageCell = row.insertCell();
            usageCell.textContent = reading.usage || 'N/A';
            usageCell.setAttribute('data-label', 'ä»Šå›ä½¿ç”¨é‡');
              const statusCell = row.insertCell();
            statusCell.textContent = reading.status || 'N/A';
            statusCell.setAttribute('data-label', 'çŠ¶æ…‹');
              const photoCell = row.insertCell();
            photoCell.setAttribute('data-date-photo', reading.date);
            photoCell.setAttribute('data-label', 'å†™çœŸ');

            // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã®ä½œæˆ
            const cameraButton = document.createElement('button');
            cameraButton.textContent = 'æ’®å½±';
            cameraButton.setAttribute('data-date-button', reading.date);
            cameraButton.addEventListener('click', async (event) => {
              const debugInfoDiv = document.getElementById('debug-info');
              debugInfoDiv.innerHTML = 'ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±:<br>';
              try {
                const date = event.target.getAttribute('data-date-button');
                console.log('[meter_reading] ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (HTML Media Capture): date=', date);
                debugInfoDiv.innerHTML += 'ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (HTML Media Capture): date=' + date + '<br>';

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.capture = 'environment'; 
                fileInput.style.display = 'none';

                fileInput.onchange = (e) => handleFileSelection(e, date, debugInfoDiv);
                
                document.body.appendChild(fileInput);
                fileInput.click();
              } catch (error) {
                console.error('[meter_reading] å†™çœŸã®å–å¾—ã¾ãŸã¯å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ (HTML Media Capture):', error);
                debugInfoDiv.innerHTML += '<span style="color: red;">å†™çœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.toString() + '</span><br>';
                alert('å†™çœŸã®å‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                const orphanInput = document.querySelector('input[type="file"][style*="display: none"]');
                if (orphanInput && orphanInput.parentElement === document.body) {
                    document.body.removeChild(orphanInput);
                }
              }            });
            photoCell.appendChild(cameraButton);
          });
        } else {
          // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯åˆå›æ¤œé‡ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡Œã‚’è¡¨ç¤º
          tableElement.style.display = '';
          document.getElementById('update-readings-button').style.display = 'block'; // æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          noDataMessageElement.style.display = 'none';
          tableBody.innerHTML = '';

          // åˆå›æ¤œé‡ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡Œã‚’ä½œæˆ
          const row = tableBody.insertRow();
          row.classList.add('initial-reading-row'); // åˆå›æ¤œé‡è¡Œã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ           // æ¤œé‡æ—¥æ™‚ï¼ˆç¾åœ¨ã®æ—¥æ™‚ã‚’è¡¨ç¤ºï¼‰
          const currentDate = new Date();
          const year = currentDate.getFullYear();
          const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
          const day = currentDate.getDate().toString().padStart(2, '0');
          const formattedCurrentDate = `${year}å¹´${month}æœˆ${day}æ—¥`; // å¹´æœˆæ—¥è¡¨ç¤º
          const dateForDataAttribute = `${year}/${month}/${day}`; // data-dateç”¨ã®å½¢å¼
          
          const dateCell = row.insertCell();
          dateCell.textContent = formattedCurrentDate;
          dateCell.setAttribute('data-label', 'æ¤œé‡æ—¥æ™‚');
          
          // ä»Šå›æŒ‡ç¤ºæ•°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          const currentReadingCell = row.insertCell();
          currentReadingCell.setAttribute('data-label', 'ä»Šå›(ã¥)');
          const currentReadingInput = document.createElement('input');
          currentReadingInput.type = 'number';
          currentReadingInput.value = '';
          currentReadingInput.placeholder = 'åˆå›æŒ‡ç¤ºæ•°ã‚’å…¥åŠ›';
          currentReadingInput.setAttribute('data-date', dateForDataAttribute);
          currentReadingInput.setAttribute('data-original-value', '');
          currentReadingInput.setAttribute('pattern', '[0-9]*');
          currentReadingInput.setAttribute('inputmode', 'numeric');
          currentReadingInput.setAttribute('min', '0'); // æœ€å°å€¤ã‚’è¨­å®š
          currentReadingInput.required = true; // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦è¨­å®š

          currentReadingInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            // å…¥åŠ›æ™‚ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            e.target.style.borderColor = '';
          });

          currentReadingCell.appendChild(currentReadingInput);          // å‰å›æŒ‡ç¤ºæ•°ï¼ˆåˆå›ãªã®ã§ N/Aï¼‰
          const prevReadingCell = row.insertCell();
          prevReadingCell.textContent = 'N/A';
          prevReadingCell.setAttribute('data-label', 'å‰å›');
          
          // å‰ã€…å›æŒ‡ç¤ºæ•°ï¼ˆåˆå›ãªã®ã§ N/Aï¼‰
          const prevPrevReadingCell = row.insertCell();
          prevPrevReadingCell.textContent = 'N/A';
          prevPrevReadingCell.setAttribute('data-label', 'å‰ã€…å›');
          
          // å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ï¼ˆåˆå›ãªã®ã§ N/Aï¼‰
          const prevPrevPrevReadingCell = row.insertCell();
          prevPrevPrevReadingCell.textContent = 'N/A';
          prevPrevPrevReadingCell.setAttribute('data-label', 'å‰ã€…ã€…å›');
          
          // ä»Šå›ä½¿ç”¨é‡ï¼ˆåˆå›ãªã®ã§è¨ˆç®—ä¸å¯ï¼‰
          const usageCell = row.insertCell();
          usageCell.textContent = 'åˆå›ç™»éŒ²';
          usageCell.setAttribute('data-label', 'ä»Šå›ä½¿ç”¨é‡');
          
          // çŠ¶æ…‹
          const statusCell = row.insertCell();
          statusCell.textContent = 'åˆå›æ¤œé‡';
          statusCell.setAttribute('data-label', 'çŠ¶æ…‹');
          statusCell.style.color = '#007bff';
          statusCell.style.fontWeight = 'bold';
            // å†™çœŸæ¬„
          const photoCell = row.insertCell();
          photoCell.setAttribute('data-date-photo', dateForDataAttribute);
          photoCell.setAttribute('data-label', 'å†™çœŸ');

          // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã®ä½œæˆ
          const cameraButton = document.createElement('button');
          cameraButton.textContent = 'æ’®å½±';
          cameraButton.setAttribute('data-date-button', dateForDataAttribute);
          cameraButton.addEventListener('click', async (event) => {
            const debugInfoDiv = document.getElementById('debug-info');
            debugInfoDiv.innerHTML = 'ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±:<br>';
            try {
              const date = event.target.getAttribute('data-date-button');
              console.log('[meter_reading] ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (HTML Media Capture): date=', date);
              debugInfoDiv.innerHTML += 'ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (HTML Media Capture): date=' + date + '<br>';

              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.capture = 'environment'; 
              fileInput.style.display = 'none';

              fileInput.onchange = (e) => handleFileSelection(e, date, debugInfoDiv);
              
              document.body.appendChild(fileInput);
              fileInput.click();
            } catch (error) {
              console.error('[meter_reading] å†™çœŸã®å–å¾—ã¾ãŸã¯å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ (HTML Media Capture):', error);
              debugInfoDiv.innerHTML += '<span style="color: red;">å†™çœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.toString() + '</span><br>';
              alert('å†™çœŸã®å‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
              const orphanInput = document.querySelector('input[type="file"][style*="display: none"]');
              if (orphanInput && orphanInput.parentElement === document.body) {
                  document.body.removeChild(orphanInput);
              }
            }
          });
          photoCell.appendChild(cameraButton);
        }
      } catch (error) {
        console.error('[meter_reading] fetchMeterReadings error:', error);
        if (loadingElement) loadingElement.style.display = 'none';
        noDataMessageElement.textContent = `æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
        noDataMessageElement.style.display = 'block';
        tableElement.style.display = 'none';
        document.getElementById('update-readings-button').style.display = 'none';
      }
    }

    // æŒ‡ç¤ºæ•°æ›´æ–°ãƒœã‚¿ãƒ³ã®å‡¦ç†
    async function handleUpdateReadings() {
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('propertyId');
      const roomId = urlParams.get('roomId');

      if (!propertyId || !roomId) {
        alert('ç‰©ä»¶IDã¾ãŸã¯éƒ¨å±‹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      const inputs = document.querySelectorAll('#meter-readings-table tbody input[type="number"][data-date]');
      const updatedReadings = [];
      let hasValidationErrors = false;
      
      inputs.forEach(input => {
        const date = input.getAttribute('data-date');
        const newPhotoData = input.getAttribute('data-new-photo');
        const originalValue = input.getAttribute('data-original-value') || '';
        const currentValue = input.value || '';
        
        // åˆå›æ¤œé‡ã®å ´åˆï¼ˆoriginalValueãŒç©ºï¼‰ã®å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (originalValue === '' && currentValue.trim() === '') {
          input.style.borderColor = 'red';
          hasValidationErrors = true;
          return;
        } else {
          input.style.borderColor = ''; // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        }
        
        // æŒ‡ç¤ºæ•°ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã€æ–°ã—ã„å†™çœŸãŒæ’®å½±ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°å¯¾è±¡ã«å«ã‚ã‚‹
        if (currentValue !== originalValue || newPhotoData) {
          // æ•°å€¤ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          const numericValue = parseFloat(currentValue);
          if (currentValue && (isNaN(numericValue) || numericValue < 0)) {
            input.style.borderColor = 'red';
            hasValidationErrors = true;
            return;
          }
          
          updatedReadings.push({
            date: date,
            currentReading: currentValue,
            photoData: newPhotoData || null
          });
        }
      });

      if (hasValidationErrors) {
        alert('å…¥åŠ›å€¤ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚åˆå›æ¤œé‡ã§ã¯æŒ‡ç¤ºæ•°ã®å…¥åŠ›ãŒå¿…é ˆã§ã™ã€‚ã¾ãŸã€æŒ‡ç¤ºæ•°ã¯0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (updatedReadings.length === 0) {
        alert('æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      console.log('[meter_reading] æ›´æ–°ã™ã‚‹æŒ‡ç¤ºæ•°:', updatedReadings);
      console.log('[meter_reading] é€ä¿¡å…ˆURL:', gasWebAppUrl);

      try {
        const response = await fetch(gasWebAppUrl, { 
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8', 
          },
          body: JSON.stringify({
            action: 'updateMeterReadings', // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
            propertyId: propertyId,       // ç‰©ä»¶IDã‚’è¿½åŠ 
            roomId: roomId,               // éƒ¨å±‹IDã‚’è¿½åŠ 
            readings: updatedReadings
          }),
        });

        console.log('[meter_reading] Update response status:', response.status);

        const resultText = await response.text(); 
        console.log('[meter_reading] Update result text:', resultText);

        if (!response.ok) {
          throw new Error(resultText || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å¿œç­”ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + response.status);
        }
        
        try {
            const result = JSON.parse(resultText); 
            if (result.success) {
              // åˆå›æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š
              const isInitialReading = inputs.length > 0 && 
                inputs[0].getAttribute('data-original-value') === '';
              
              if (isInitialReading) {
                alert('åˆå›æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰ã¯ä½¿ç”¨é‡ã‚‚è¨ˆç®—ã•ã‚Œã¾ã™ã€‚');
              } else {
                alert('æŒ‡ç¤ºæ•°ã¨æ¤œé‡æ—¥æ™‚ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
              }
              await loadMeterReadings(); 
            } else {
              throw new Error(result.error || 'æŒ‡ç¤ºæ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        } catch (e) {
            throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™: ' + resultText);
        }

      } catch (error) {
        console.error('[meter_reading] handleUpdateReadings error:', error);
        alert(`æŒ‡ç¤ºæ•°ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³æ©Ÿèƒ½ã‚’å«ã‚€ï¼‰
    function handleFileSelection(e, date, debugInfoDiv) {
        const file = e.target.files[0];

        if (file) {
            console.log('[meter_reading] ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ (handleFileSelection):', file.name, 'for date:', date);
            if(debugInfoDiv) debugInfoDiv.innerHTML += 'ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (handleFileSelection): ' + file.name + ' for date: ' + date + '<br>';
            
            const reader = new FileReader();
            reader.onload = (readerEvent) => {
                const base64PhotoData = readerEvent.target.result;
                if(debugInfoDiv) debugInfoDiv.innerHTML += 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº† (base64): ' + base64PhotoData.substring(0, 30) + '...<br>';

                const currentReadingInput = document.querySelector(`#meter-readings-table input[type="number"][data-date="${date}"]`);
                if (currentReadingInput) {
                    currentReadingInput.setAttribute('data-new-photo', base64PhotoData);
                    console.log('[meter_reading] å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’data-new-photoå±æ€§ã«è¨­å®šã—ã¾ã—ãŸ for date:', date);
                } else {
                    console.error('[meter_reading] å¯¾å¿œã™ã‚‹æŒ‡ç¤ºæ•°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ for date:', date);
                    if(debugInfoDiv) debugInfoDiv.innerHTML += '<span style="color: red;">ã‚¨ãƒ©ãƒ¼: å¯¾å¿œã™ã‚‹æŒ‡ç¤ºæ•°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ for date: ' + date + '</span><br>';
                    alert('å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘ã‚‹å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    if (e.target.parentElement === document.body) {
                        document.body.removeChild(e.target);
                    }
                    return;
                }                const photoCell = document.querySelector(`td[data-date-photo="${date}"]`);
                if (photoCell) {
                    let previewImg = photoCell.querySelector('img.temp-preview');
                    if (!previewImg) {
                        previewImg = document.createElement('img');
                        previewImg.classList.add('temp-preview');
                        previewImg.alt = 'æ’®å½±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
                        previewImg.style.maxWidth = '50px';
                        previewImg.style.maxHeight = '50px';
                        previewImg.style.marginRight = '5px';
                        previewImg.style.cursor = 'pointer';
                        const cameraBtn = photoCell.querySelector('button[data-date-button]');
                        if (cameraBtn) {
                            photoCell.insertBefore(previewImg, cameraBtn);
                        } else {
                            photoCell.appendChild(previewImg); // Fallback
                        }
                    }
                    previewImg.src = base64PhotoData;
                    previewImg.onclick = () => showPhotoModal(base64PhotoData);

                    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ä½œæˆãƒ»è¡¨ç¤º
                    let deleteBtn = photoCell.querySelector('button.delete-photo-btn');
                    if (!deleteBtn) {
                        deleteBtn = document.createElement('button');
                        deleteBtn.classList.add('delete-photo-btn');
                        deleteBtn.textContent = 'å‰Šé™¤';
                        deleteBtn.style.backgroundColor = '#dc3545';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.padding = '2px 6px';
                        deleteBtn.style.marginRight = '5px';
                        deleteBtn.style.fontSize = '12px';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.borderRadius = '3px';
                        
                        deleteBtn.addEventListener('click', () => {
                            // Actual delete logic: remove photo data, preview, and delete button
                            if (currentReadingInput) {
                                currentReadingInput.removeAttribute('data-new-photo');
                            }
                            if (previewImg) previewImg.remove();
                            if (deleteBtn) deleteBtn.remove();
                            const cameraBtn = photoCell.querySelector('button[data-date-button]');
                            if (cameraBtn) cameraBtn.textContent = 'æ’®å½±'; // Reset camera button text

                            if(debugInfoDiv) debugInfoDiv.innerHTML += 'å†™çœŸå‰Šé™¤å®Œäº† for date: ' + date + '<br>';
                        });
                        const cameraBtn = photoCell.querySelector('button[data-date-button]');
                        if (cameraBtn) {
                            photoCell.insertBefore(deleteBtn, cameraBtn);
                        } else {
                            photoCell.appendChild(deleteBtn); // Fallback
                        }
                    }
                    // Update camera button text to "å¤‰æ›´"
                    const cameraBtn = photoCell.querySelector('button[data-date-button]');
                    if (cameraBtn) cameraBtn.textContent = 'å¤‰æ›´';

                    if(debugInfoDiv) debugInfoDiv.innerHTML += 'å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã€å‰Šé™¤ãƒœã‚¿ãƒ³è¿½åŠ ã€ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°å®Œäº† for date: ' + date + '<br>';
                }
            };
            reader.onerror = (errorEvent) => {
                console.error('[meter_reading] File reading error:', errorEvent);
                if(debugInfoDiv) debugInfoDiv.innerHTML += '<span style="color: red;">ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</span><br>';
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            };
            reader.readAsDataURL(file);
        } else {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©ï¼‰
            console.log('[meter_reading] ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
            if(debugInfoDiv) debugInfoDiv.innerHTML += 'ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚<br>';
            // inputè¦ç´ ãŒæ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤
            if (e.target.parentElement === document.body) {
                document.body.removeChild(e.target);
            }
        }
    }

    // å†™çœŸã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showPhotoModal(imageData) {
      if (!photoModal) photoModal = document.getElementById('photo-modal');
      if (!modalImage) modalImage = document.getElementById('modal-image');

      if (photoModal && modalImage) {
        modalImage.src = imageData;
        photoModal.style.display = 'block';
      } else {
        console.error('[meter_reading] ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function hidePhotoModal() {
      if (!photoModal) photoModal = document.getElementById('photo-modal');
      if (photoModal) {
        photoModal.style.display = 'none';
        if (modalImage) {
            modalImage.src = '';
        }
      }
    }

    // DOMContentLoaded ã§ã™ã¹ã¦ã®åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’è¡Œã†
    document.addEventListener('DOMContentLoaded', async () => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´ ã‚’ã“ã“ã§å–å¾—ãƒ»åˆæœŸåŒ–
      photoModal = document.getElementById('photo-modal');
      modalImage = document.getElementById('modal-image');
      closeModalButton = document.querySelector('.close-modal-button');

      if (closeModalButton) {
        closeModalButton.addEventListener('click', hidePhotoModal);
      }

      if (photoModal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        photoModal.addEventListener('click', function(event) {
          if (event.target === photoModal) {
            hidePhotoModal();
          }
        });
      }

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘è¨­å®š
      const backButton = document.getElementById('back-button-meter');
      if (backButton) {
        backButton.addEventListener('click', handleBackButton);
      }

      // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      const updateButton = document.getElementById('update-readings-button');
      if (updateButton) {
        updateButton.addEventListener('click', handleUpdateReadings);
      }

      // WOFFã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
      await initializeWoff();
    });
  </script>
</body>
</html>
