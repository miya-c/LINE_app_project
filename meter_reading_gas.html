<!DOCTYPE html>
<html lang="ja">
<head>
  <title>検針情報 - 水道メーター読み取りアプリ (GAS版)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA メタタグ -->
  <meta name="description" content="水道メーターの読み取りを管理するアプリケーション">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="メーター読み取り">
  <meta name="msapplication-TileColor" content="#007bff">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  
  <!-- Inlined CSS Styles -->
  <style>
/* Meter Reading Application Styles */
:root {
  --mantine-color-blue-6: #228be6;
  --mantine-color-blue-7: #1c7ed6;
  --mantine-color-blue-8: #1971c2;
  --mantine-color-blue-light: #e7f5ff;
  --mantine-color-gray-0: #f8f9fa;
  --mantine-color-gray-1: #f1f3f4;
  --mantine-color-gray-2: #e9ecef;
  --mantine-color-gray-3: #dee2e6;
  --mantine-color-gray-6: #868e96;
  --mantine-color-gray-7: #495057;
  --mantine-color-gray-8: #343a40;
  --mantine-color-red-6: #fa5252;
  --mantine-color-red-light: #fff5f5;
  --mantine-color-green-6: #40c057;
  --mantine-color-green-light: #ebfbee;
  --mantine-radius-xs: 2px;
  --mantine-radius-sm: 4px;
  --mantine-radius-md: 8px;
  --mantine-spacing-xs: 10px;
  --mantine-spacing-sm: 12px;
  --mantine-spacing-md: 16px;
  --mantine-spacing-lg: 20px;
  --mantine-spacing-xl: 32px;
  --app-bg-color: #f0f4f8;
  --header-bg-color: #007bff;
  --header-text-color: #ffffff;
  --card-bg-color: #ffffff;
  --primary-text-color: #333333;
  --secondary-text-color: #555555;
  --accent-color: #007bff;
  --border-color: #dddddd;
  --font-family-sans-serif: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  line-height: 1.55;
  color: var(--mantine-color-gray-7);
  background-color: var(--app-bg-color);
  font-size: 24px;
}

#root {
  min-height: 100vh;
  background-color: var(--app-bg-color);
}

.mantine-container {
  min-height: 100vh;
  padding: var(--mantine-spacing-lg);
  max-width: 900px;
  margin: 0 auto;
}

.mantine-stack {
  display: flex;
  flex-direction: column;
  gap: var(--mantine-spacing-xl);
}

@media (max-width: 768px) {
  .mantine-stack {
    gap: 8px;
  }
}

.mantine-stack.center {
  align-items: center;
  text-align: center;
}

.mantine-title {
  font-size: 3.2rem;
  font-weight: 700;
  margin: 0;
  color: var(--mantine-color-gray-8);
}

.mantine-subtitle {
  font-size: clamp(1.6rem, 4vw, 2.2rem);
  font-weight: 600;
  margin: 0;
  color: var(--mantine-color-gray-7);
}

.mantine-text {
  font-size: 1.3rem;
  color: var(--mantine-color-gray-6);
  margin: 0;
  line-height: 1.6;
}

.mantine-text.center {
  text-align: center;
}

.mantine-text.weight-600 {
  font-weight: 600;
}

.mantine-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--mantine-spacing-xs);
  padding: 20px 28px;
  border-radius: var(--mantine-radius-sm);
  border: 1px solid transparent;
  font-size: 1.2rem;
  font-weight: 600;
  line-height: 1;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
  min-height: 48px;
}

.mantine-button.variant-filled {
  background-color: var(--mantine-color-blue-6);
  color: white;
}

.mantine-button.variant-filled:hover {
  background-color: var(--mantine-color-blue-7);
}

.mantine-button.variant-outline {
  background-color: transparent;
  border: 1px solid var(--mantine-color-gray-3);
  color: var(--mantine-color-gray-7);
}

.mantine-button.variant-outline:hover {
  background-color: var(--mantine-color-gray-1);
}

.mantine-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.mantine-paper {
  background-color: white;
  border: 1px solid var(--mantine-color-gray-2);
  border-radius: var(--mantine-radius-md);
  padding: var(--mantine-spacing-md);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
}

.mantine-loader {
  width: 48px;
  height: 48px;
  border: 3px solid var(--mantine-color-gray-2);
  border-top: 3px solid var(--mantine-color-blue-6);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.mantine-alert {
  padding: var(--mantine-spacing-md);
  border-radius: var(--mantine-radius-sm);
  border-left: 4px solid var(--mantine-color-red-6);
  background-color: var(--mantine-color-red-light);
  color: var(--mantine-color-gray-7);
}

.mantine-alert.info {
  border-left-color: var(--mantine-color-blue-6);
  background-color: var(--mantine-color-blue-light);
}

.mantine-center {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--mantine-spacing-xl);
}

.usage-highlight { 
  background-color: var(--mantine-color-blue-light);
  padding: 2px 4px; 
  border-radius: 3px; 
  color: var(--mantine-color-blue-7);
  font-weight: bold; 
}

.mantine-table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--mantine-color-gray-3);
}

.mantine-table th,
.mantine-table td {
  border: 1px solid var(--mantine-color-gray-3);
  padding: 20px;
  text-align: left;
  font-size: 1.2rem;
}

.mantine-table th {
  background-color: var(--mantine-color-gray-1);
  font-weight: 600;
  color: var(--mantine-color-gray-7);
}

.mantine-table tbody tr:hover {
  background-color: var(--mantine-color-gray-0);
}

.mantine-input {
  width: 100%;
  padding: 20px;
  border: 1px solid var(--mantine-color-gray-3);
  border-radius: var(--mantine-radius-sm);
  font-size: 1.4rem;
  transition: border-color 0.15s ease;
  min-height: 60px;
}

.mantine-input:focus {
  outline: none;
  border-color: var(--mantine-color-blue-6);
  box-shadow: 0 0 0 2px var(--mantine-color-blue-light);
}

.inline-error {
  color: var(--mantine-color-red-6);
  font-size: 0.85em;
  margin-top: 4px;
}

@keyframes fadeInScale {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* モバイルレスポンシブスタイル */
@media (max-width: 768px) {
  body {
    font-size: 20px;
    padding-left: 0;
    padding-right: 0;
    margin-left: 0;
    margin-right: 0;
  }
  
  .mantine-container {
    padding: 0;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
  }

  .mantine-title {
    font-size: 2.2rem;
  }

  .app-header {
    background-color: var(--header-bg-color);
    color: var(--header-text-color);
    padding: 12px 16px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .back-button {
    background-color: transparent;
    border: none;
    color: var(--header-text-color);
    font-size: 28px;
    cursor: pointer;
    position: absolute;
    left: 16px;
  }

  .header-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: bold;
  }

  .content-area {
    padding-top: 60px;
    padding-left: 0;
    padding-right: 0;
    padding-bottom: 24px;
    margin-left: 0;
    margin-right: 0;
  }

  .property-info-card {
    background-color: var(--accent-color);
    color: var(--header-text-color);
    padding: 5px 8px;
    margin-bottom: 8px;
    margin-left: 0;
    margin-right: 0;
    border-radius: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .property-name {
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    font-weight: bold;
    margin: 0 0 10px 0;
  }

  .room-info {
    font-size: clamp(1.3rem, 4vw, 2.0rem);
    font-weight: bold;
    margin: 0;
  }

  .mantine-paper.reading-history-container {
    padding: 8px;
    margin: 0;
    background-color: transparent;
    box-shadow: none;
    border: none;
  }

  .mantine-table {
    border: none;
    border-collapse: separate;
    border-spacing: 0;
  }

  .mantine-table thead {
    display: none;
  }
  
  .mantine-table tbody {
    display: block;
    width: 100%;
  }

  .mantine-table tr {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas: 
      "date date"
      "reading history"
      "usage history"
      "status .";
    gap: 8px;
    margin-bottom: 2em;
    margin-left: 0;
    margin-right: 0;
    border: 1px solid var(--mantine-color-gray-3);
    border-radius: 0;
    background-color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    padding: 8px;
  }

  .mantine-table td[data-label="検針日時"] {
    grid-area: date;
    text-align: center;
    font-weight: bold;
    background-color: #f8f9fa;
    margin: -8px -8px 0 -8px;
    padding: 16px 8px;
    border-radius: 0;
    border-bottom: 1px solid var(--mantine-color-gray-2);
    margin-bottom: 0;
  }

  .mantine-table td[data-label="今回指示数(㎥)"] {
    grid-area: reading;
    border-right: 1px solid var(--mantine-color-gray-2);
    padding-right: 2px;
  }

  .mantine-table td[data-label="今回使用量"] {
    grid-area: usage;
    background-color: #e3f2fd;
    padding: 6px 8px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 3rem;
    line-height: 1.1;
    border-right: 1px solid var(--mantine-color-gray-2);
    margin: 0;
    border-bottom: none;
  }

  .mantine-table td[data-label="状態"] {
    grid-area: status;
    border-right: 1px solid var(--mantine-color-gray-2);
    padding-right: 2px;
    padding-top: 8px;
  }

  .mantine-table td[data-label="前回履歴"] {
    grid-area: history;
    padding-left: 2px;
    font-size: 1.1rem;
    line-height: 1.4;
    align-self: stretch;
    min-height: 120px;
    border-left: 1px solid var(--mantine-color-gray-2);
  }

  .mantine-table td {
    display: block;
    padding: 8px 0;
    border: none;
    background-color: transparent;
    font-size: 1.2rem;
    line-height: 1.5;
    border-bottom: none;
    margin-bottom: 0;
  }

  .mantine-table td::before {
    content: attr(data-label) ": ";
    font-weight: bold;
    color: var(--mantine-color-gray-7);
    display: block;
    margin-bottom: 6px;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .mantine-table td[data-label="検針日時"]::before {
    display: none;
  }

  .fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1001;
  }

  .fab-button {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    font-size: 28px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

.desktop-only {
  display: block;
}

@media (max-width: 768px) {
  .desktop-only {
    display: none !important;
  }
}
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // GASテンプレート構文（本番用）
    window.gasPropertyId = '<?= propertyId ?>';
    window.gasPropertyName = '<?= propertyName ?>';
    window.gasRoomId = '<?= roomId ?>';
    window.gasRoomName = '<?= roomName ?>';
    // Use server-side JSON stringification (GAS template)
    window.gasMeterReadings = /* <?!= JSON.stringify(meterReadings) ?> */ [];

    console.log('GAS Template Data:');
    console.log('Property ID:', window.gasPropertyId);
    console.log('Property Name:', window.gasPropertyName);
    console.log('Room ID:', window.gasRoomId);
    console.log('Room Name:', window.gasRoomName);
    console.log('Meter Readings:', window.gasMeterReadings);

    // 実行環境を判定
    const isWebApp = () => {
      return !window.google?.script?.run;
    };

    const callGasFunction = (functionName, ...args) => {
      if (isWebApp()) {
        // Web App環境では制限（今後拡張可能）
        return Promise.reject(new Error(`Web App環境では ${functionName} 関数は制限されています`));
      }
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    };

    // ===================================
    // Utility Functions
    // ===================================
    
    const formatDateForDisplay = (rawDate) => {
      if (!rawDate) return null;
      
      try {
        if (rawDate instanceof Date && !isNaN(rawDate.getTime())) {
          console.log('[formatDateForDisplay] Date型を処理:', rawDate);
          const year = rawDate.getFullYear();
          const month = rawDate.getMonth() + 1;
          const day = rawDate.getDate();
          console.log(`[formatDateForDisplay] Date型から抽出: ${year}年${month}月${day}日`);
          return `${month}月${day}日`;
        }
        
        let dateStr = String(rawDate).trim();
        console.log('[formatDateForDisplay] 文字列を処理:', dateStr);
        
        const match = dateStr.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
        if (match) {
          const [, year, month, day] = match;
          const result = `${parseInt(month)}月${parseInt(day)}日`;
          console.log(`[formatDateForDisplay] 文字列から抽出: ${result}`);
          return result;
        }
        
        const dateObj = new Date(dateStr);
        if (!isNaN(dateObj.getTime())) {
          const month = dateObj.getMonth() + 1;
          const day = dateObj.getDate();
          console.log(`[formatDateForDisplay] Date変換成功: ${month}月${day}日`);
          return `${month}月${day}日`;
        }
        
        console.warn('[formatDateForDisplay] 解析できない日付形式:', rawDate);
        return null;
      } catch (error) {
        console.warn('[formatDateForDisplay] 日付フォーマットエラー:', rawDate, error);
        return null;
      }
    };
    
    const formatInspectionStatus = (rawDate) => {
      const formattedDate = formatDateForDisplay(rawDate);
      return formattedDate ? 
        { status: '検針済み', displayDate: formattedDate } : 
        { status: '未検針', displayDate: null };
    };
    
    const calculateUsage = (currentReading, previousReading) => {
      const current = parseFloat(currentReading);
      const previous = parseFloat(previousReading);
      
      if (isNaN(current)) return '';
      
      if (!previousReading || previousReading === '' || previous === 0 || isNaN(previous)) {
        return current.toString();
      }
      
      const usage = current - previous;
      return (usage >= 0 ? usage : 0).toString();
    };

    const calculateUsageDisplay = calculateUsage;
    
    const getCurrentJSTDateString = () => {
      const now = new Date();
      const jstOffset = 9 * 60;
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const jstTime = new Date(utc + (jstOffset * 60000));
      
      const year = jstTime.getFullYear();
      const month = String(jstTime.getMonth() + 1).padStart(2, '0');
      const day = String(jstTime.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    };
    
    const formatReading = (value) => {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      return String(value).trim();
    };
    
    const formatUsage = (value) => {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      const numValue = parseFloat(value);
      if (isNaN(numValue)) {
        return '';
      }
      return numValue.toString();
    };
    
    const formatStatus = (value) => {
      if (!value || value === '' || value === '未入力' || value === null || value === undefined) {
        return '正常';
      }
      return String(value).trim();
    };

    // ===================================
    // Application State
    // ===================================
    
    let appState = {
      loading: true,
      error: null,
      propertyId: '',
      propertyName: '',
      roomId: '',
      roomName: '',
      meterReadings: [],
      debugInfo: null,
      updating: false,
      usageStates: {},
      toastMessage: '',
      showToast: false,
      inputErrors: {},
      isNavigating: false,
      navigationMessage: ''
    };

    // ===================================
    // UI Rendering Functions
    // ===================================
    
    const renderLoadingOverlay = (message) => {
      return `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.95);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 50000;
        ">
          <div style="
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
          "></div>
          <p style="
            margin-top: 16px;
            color: #666;
            font-size: 14px;
            text-align: center;
          ">
            ${message}
          </p>
        </div>
      `;
    };

    const renderHeader = () => {
      return `
        <div class="app-header">
          <button onclick="handleBackButton()" class="back-button" aria-label="戻る">
            &lt;
          </button>
          <h1 class="header-title">検針情報</h1>
        </div>
      `;
    };

    const renderPropertyInfo = () => {
      return `
        <div class="property-info-card">
          <h2 class="property-name">${appState.propertyName}</h2>
          <p class="room-info">部屋: ${appState.roomName}</p>
        </div>
      `;
    };

    const getPreviousReadingsText = (reading) => {
      let parts = [];
      if (reading.previousReading && reading.previousReading !== 'N/A') {
        let text = `前回: ${reading.previousReading}`;
        if (reading.previousPreviousReading && reading.previousPreviousReading !== 'N/A') {
          const prev = parseFloat(reading.previousReading);
          const prevPrev = parseFloat(reading.previousPreviousReading);
          if (!isNaN(prev) && !isNaN(prevPrev)) {
            const diff = prev - prevPrev;
            text += ` [${diff >= 0 ? '+' : ''}${diff}]`;
          }
        }
        parts.push(text);
      }
      if (reading.previousPreviousReading && reading.previousPreviousReading !== 'N/A') {
        let text = `前々回: ${reading.previousPreviousReading}`;
        if (reading.threeTimesPrevious && reading.threeTimesPrevious !== 'N/A') {
          const prevPrev = parseFloat(reading.previousPreviousReading);
          const prevPrevPrev = parseFloat(reading.threeTimesPrevious);
          if (!isNaN(prevPrev) && !isNaN(prevPrevPrev)) {
            const diff = prevPrev - prevPrevPrev;
            text += ` [${diff >= 0 ? '+' : ''}${diff}]`;
          }
        }
        parts.push(text);
      }
      if (reading.threeTimesPrevious && reading.threeTimesPrevious !== 'N/A') {
        parts.push(`前々々回: ${reading.threeTimesPrevious}`);
      }
      return parts;
    };

    const renderMeterReadingTable = () => {
      if (!Array.isArray(appState.meterReadings) || appState.meterReadings.length === 0) {
        return `
          <div class="mantine-stack">
            <div class="mantine-alert info">
              <h3 class="mantine-text weight-600">初回検針</h3>
              <p class="mantine-text">
                この部屋の検針データはまだありません。下のフォームから最初の検針データを入力してください。<br/>
                <strong>初回検針では、入力された指示数がそのまま今月の使用量として記録されます。</strong>
              </p>
            </div>
            <div class="mantine-paper" style="margin-top: var(--mantine-spacing-md); padding: var(--mantine-spacing-md);">
              <h4 class="mantine-subtitle" style="margin-bottom: var(--mantine-spacing-sm);">初回データ入力</h4>
              <div class="mantine-stack" style="gap: var(--mantine-spacing-lg);">
                <div>
                  <label for="initialReadingDate" class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">検針日:</label>
                  <input 
                    type="text" 
                    id="initialReadingDate" 
                    value="未検針" 
                    readonly 
                    class="mantine-input" 
                    style="font-size: 1rem; padding: 10px;" 
                  />
                </div>
                <div>
                  <label for="initialReadingValue" class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">今回指示数(㎥):</label>
                  <input
                    type="number"
                    id="initialReadingValue"
                    class="mantine-input"
                    placeholder="指示数入力"
                    min="0"
                    step="any"
                    style="font-size: 1rem; padding: 10px;"
                    data-date="" 
                    data-original-value=""
                    data-previous-reading=""
                    onchange="handleInputChange(this, '')"
                  />
                  <div id="error-" style="color: var(--mantine-color-red-6); font-size: 0.9em; margin-top: 4px;"></div>
                </div>
                <div>
                  <label class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">今回使用量:</label>
                  <div id="usage-display" style="
                    background-color: #e3f2fd;
                    border: 1px solid var(--mantine-color-gray-3);
                    border-radius: var(--mantine-radius-sm);
                    padding: 10px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: var(--mantine-color-blue-7);
                    min-height: 44px;
                    display: flex;
                    align-items: center;
                  ">-</div>
                  <div style="font-size: 0.85em; color: var(--mantine-color-gray-6); margin-top: 4px;">
                    ※初回検針では、指示数がそのまま使用量になります
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      let tableRows = '';
      appState.meterReadings.forEach((reading, index) => {
        const formattedDate = formatDateForDisplay(reading.date);
        const inspectionStatus = formatInspectionStatus(reading.date);
        const dateForDataAttribute = reading.date;
        const currentReadingDisplay = formatReading(reading.currentReading);
        
        const usageToDisplay = appState.usageStates[dateForDataAttribute] !== undefined 
                            ? appState.usageStates[dateForDataAttribute]
                            : calculateUsageDisplay(reading.currentReading, reading.previousReading);
        
        const usageDisplayString = `${usageToDisplay}${usageToDisplay !== '-' ? '㎥' : ''}`;
        const statusDisplay = formatStatus(reading.status);
        const previousReadingsInfo = getPreviousReadingsText(reading);

        const previousReadingsHtml = previousReadingsInfo && previousReadingsInfo.length > 0 ? 
          previousReadingsInfo.map(info => `<div class="previous-reading-text">${info}</div>`).join('') :
          '<div>-</div>';
        
        tableRows += `
          <tr>
            <td data-label="検針日時">
              <span style="
                color: ${inspectionStatus.status === '未検針' ? 'var(--mantine-color-red-6)' : 'inherit'};
                font-weight: ${inspectionStatus.status === '未検針' ? 'bold' : 'normal'};
              ">
                最終検針日: ${inspectionStatus.status === '未検針' ? '未検針' : inspectionStatus.displayDate}
              </span>
            </td>
            <td data-label="今回指示数(㎥)">
              <input 
                type="number" 
                step="any" 
                value="${currentReadingDisplay}" 
                placeholder="指示数入力" 
                min="0" 
                data-date="${dateForDataAttribute}" 
                data-original-value="${formatReading(reading.currentReading)}" 
                data-previous-reading="${formatReading(reading.previousReading)}" 
                class="mantine-input" 
                onchange="handleInputChange(this, '${dateForDataAttribute}')"
              />
              <div id="error-${dateForDataAttribute}" style="color: var(--mantine-color-red-6); font-size: 0.9em; margin-top: 4px;"></div>
            </td>
            <td data-label="今回使用量">
              ${usageDisplayString}
            </td>
            <td data-label="状態">
              <span style=" 
                display: inline-block; 
                padding: 3px 9px; 
                font-size: 0.9em; 
                font-weight: 500; 
                background-color: ${statusDisplay === 'N/A' ? 'var(--mantine-color-gray-2)' : 'var(--mantine-color-blue-light)'}; 
                color: ${statusDisplay === 'N/A' ? 'var(--mantine-color-gray-7)' : 'var(--mantine-color-blue-8)'}; 
                border-radius: var(--mantine-radius-sm); 
              ">
                ${statusDisplay}
              </span>
            </td>
            <td data-label="前回履歴">
              <div style="line-height: 1.6;">
                ${previousReadingsHtml}
              </div>
            </td>
          </tr>
        `;
      });

      return `
        <table class="mantine-table">
          <thead style="display: none;">
            <tr>
              <th>検針日時</th>
              <th>今回指示数(㎥)</th>
              <th>今回使用量</th>
              <th>状態</th>
              <th>前回履歴</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
    };

    const renderFAB = () => {
      if (appState.loading || appState.error) return '';
      
      return `
        <div class="fab-container">
          <button
            class="fab-button mantine-button variant-filled"
            onclick="handleUpdateReadings()"
            ${appState.updating || appState.isNavigating ? 'disabled' : ''}
            title="${Array.isArray(appState.meterReadings) && appState.meterReadings.length > 0 ? '指示数を更新' : '初回検針データを保存'}"
          >
            ${appState.updating ? '<div class="mantine-loader" style="width: 32px; height: 32px; border-top-color: white;"></div>' : '💾'}
          </button>
        </div>
      `;
    };

    const renderToast = () => {
      if (!appState.showToast) return '';
      
      return `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.6);
          z-index: 2000;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            background-color: var(--mantine-color-blue-6);
            color: white;
            padding: 24px 32px;
            border-radius: var(--mantine-radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            min-width: 240px;
            animation: fadeInScale 0.3s ease-out;
          ">
            ${appState.toastMessage}
          </div>
        </div>
      `;
    };

    const renderApp = () => {
      let content = '';

      if (appState.isNavigating) {
        content += renderLoadingOverlay(appState.navigationMessage);
      }

      content += renderHeader();

      if (appState.loading) {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack center">
              <div class="mantine-loader"></div>
              <p class="mantine-text">検針データを読み込んでいます...</p>
            </div>
          </div>
        `;
      } else if (appState.error) {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack">
              <div class="mantine-alert">
                <h3 class="mantine-text weight-600">エラー</h3>
                <p class="mantine-text">${appState.error}</p>
              </div>
            </div>
          </div>
        `;
      } else {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack">
              ${renderPropertyInfo()}
              <div class="mantine-paper reading-history-container" style="padding: var(--mantine-spacing-xs); margin: 0;">
                <h3 class="mantine-subtitle desktop-only" style="text-align: center; margin-bottom: var(--mantine-spacing-md);">検針履歴</h3>
                ${renderMeterReadingTable()}
              </div>
            </div>
          </div>
        `;
      }

      content += renderFAB();
      content += renderToast();

      document.getElementById('root').innerHTML = content;
    };

    // ===================================
    // Event Handlers
    // ===================================
    
    const handleInputChange = (inputElement, dateForDataAttribute) => {
      const currentValue = inputElement.value;
      const originalValue = inputElement.getAttribute('data-original-value') || '';
      const previousValue = inputElement.getAttribute('data-previous-reading') || '';
      const numericValue = parseFloat(currentValue);
      
      const errorElement = document.getElementById(`error-${dateForDataAttribute}`);
      
      if (originalValue === '' && currentValue.trim() === '') {
        inputElement.style.borderColor = 'var(--mantine-color-red-6)';
        appState.inputErrors[dateForDataAttribute] = '初回検針では指示数の入力が必須です。';
        if (errorElement) errorElement.textContent = appState.inputErrors[dateForDataAttribute];
        appState.usageStates[dateForDataAttribute] = '-';
      } else if (currentValue && (isNaN(numericValue) || numericValue < 0)) {
        inputElement.style.borderColor = 'var(--mantine-color-red-6)';
        appState.inputErrors[dateForDataAttribute] = '指示数は0以上の数値を入力してください。';
        if (errorElement) errorElement.textContent = appState.inputErrors[dateForDataAttribute];
        appState.usageStates[dateForDataAttribute] = '-';
      } else {
        inputElement.style.borderColor = '';
        appState.inputErrors[dateForDataAttribute] = '';
        if (errorElement) errorElement.textContent = '';
        appState.usageStates[dateForDataAttribute] = calculateUsageDisplay(currentValue, previousValue);
      }

      // Update usage display for initial reading
      if (dateForDataAttribute === '') {
        const usageDisplay = document.getElementById('usage-display');
        if (usageDisplay) {
          const usage = appState.usageStates[dateForDataAttribute];
          usageDisplay.textContent = usage !== '-' ? `${usage}㎥` : '-';
        }
      } else {
        // Update existing reading usage display
        renderApp();
      }
    };

    const displayToast = (message) => {
      appState.toastMessage = message;
      appState.showToast = true;
      renderApp();
      setTimeout(() => {
        appState.showToast = false;
        appState.toastMessage = '';
        renderApp();
      }, 3000);
    };

    const handleBackButton = async () => {
      try {
        appState.isNavigating = true;
        appState.navigationMessage = '画面を切り替えています...';
        renderApp();
        
        if (isWebApp()) {
          // ✅ Web App環境: 部屋選択ページへ遷移
          const baseUrl = window.location.origin + window.location.pathname;
          const roomSelectUrl = `${baseUrl}?page=room_select&propertyId=${encodeURIComponent(appState.propertyId)}&propertyName=${encodeURIComponent(appState.propertyName)}`;
          window.location.href = roomSelectUrl;
        } else {
          // GAS環境: ダイアログを開く
          await callGasFunction('openRoomSelectDialog', appState.propertyId, appState.propertyName);
        }
        
      } catch (error) {
        console.error('[meter_reading] 戻るボタン処理エラー:', error);
        displayToast('画面の切り替えに失敗しました。');
      } finally {
        appState.isNavigating = false;
        renderApp();
      }
    };

    const handleUpdateReadings = async () => {
      if (!appState.propertyId || !appState.roomId) {
        displayToast('物件IDまたは部屋IDが取得できませんでした。');
        return;
      }

      const numberInputs = document.querySelectorAll('input[data-date]');
      const updatedReadings = [];
      let hasValidationErrors = false;
      
      numberInputs.forEach(input => {
        const date = input.getAttribute('data-date');
        const originalValue = input.getAttribute('data-original-value') || '';
        const currentValue = input.value || '';
        
        input.style.borderColor = '';
        appState.inputErrors[date] = '';

        if (originalValue === '' && currentValue.trim() === '') {
          input.style.borderColor = 'var(--mantine-color-red-6)';
          appState.inputErrors[date] = '初回検針では指示数の入力が必須です。';
          hasValidationErrors = true;
          return;
        }
        
        if (currentValue !== originalValue) {
          const numericValue = parseFloat(currentValue);
          if (currentValue && (isNaN(numericValue) || numericValue < 0)) {
            input.style.borderColor = 'var(--mantine-color-red-6)';
            appState.inputErrors[date] = '指示数は0以上の数値を入力してください。';
            hasValidationErrors = true;
            return;
          }
          
          let inspectionDate;
          if (date && date !== '') {
            inspectionDate = date;
          } else {
            inspectionDate = currentValue && currentValue.trim() !== '' ? getCurrentJSTDateString() : '';
          }
          updatedReadings.push({
            date: inspectionDate,
            currentReading: currentValue
          });
        }
      });

      if (hasValidationErrors) {
        displayToast('入力値に誤りがあります。各項目のエラーを確認してください。');
        renderApp();
        return;
      }

      if (updatedReadings.length === 0) {
        displayToast('更新するデータがありません。');
        return;
      }

      console.log('[meter_reading] 更新する指示数:', updatedReadings);
      appState.updating = true;
      renderApp();
      
      try {
        const result = await callGasFunction('updateMeterReadings', appState.propertyId, appState.roomId, updatedReadings);
        console.log('[meter_reading] 更新レスポンス:', result);
        
        if (result.success) {
          displayToast('検針データが正常に更新されました');
          appState.inputErrors = {};
          
          // Reload meter readings
          await loadMeterReadings(appState.propertyId, appState.roomId);
        } else {
          throw new Error(result.error || '指示数の更新に失敗しました。');
        }
      } catch (error) {
        console.error('[meter_reading] handleUpdateReadings error:', error);
        displayToast('更新エラー: ' + error.message);
      } finally {
        appState.updating = false;
        renderApp();
      }
    };

    // ===================================
    // Data Loading Functions
    // ===================================
    
    const loadMeterReadings = async (propId, rId) => {
      try {
        console.log('[meter_reading] 検針データ取得開始 - propertyId:', propId, 'roomId:', rId);
        
        const result = await callGasFunction('getMeterReadings', propId, rId);
        console.log('[meter_reading] Received responseObject from server:', result);
        
        if (result.error) {
          console.error('[meter_reading] Server returned an error:', result.error);
          throw new Error(result.error);
        }

        const readings = result.readings || result;
        const debugInfoData = result.debugInfo;

        if (debugInfoData) {
          console.log('[meter_reading] Server Debug Info:', debugInfoData);
          appState.debugInfo = debugInfoData;
        }

        console.log('[meter_reading] Fetched meter readings:', readings);
        console.log('[meter_reading] Readings is array?', Array.isArray(readings));
        console.log('[meter_reading] Readings length:', readings ? readings.length : 'N/A');
        
        if (Array.isArray(readings) && readings.length > 0) {
          console.log('[meter_reading] ✅ データ取得成功 - 件数:', readings.length);
          console.log('[meter_reading] 最初のデータ:', readings[0]);
        } else if (Array.isArray(readings) && readings.length === 0) {
          console.log('[meter_reading] ⚠️ データは空配列（初回検針状態）');
          console.log('[meter_reading] 検索条件 - propertyId:', propId, 'roomId:', rId);
        } else {
          console.log('[meter_reading] ❌ データ取得失敗または無効な形式');
          console.log('[meter_reading] readingsの型:', typeof readings);
          console.log('[meter_reading] readings値:', readings);
        }
        
        appState.meterReadings = Array.isArray(readings) ? readings : [];
        appState.loading = false;
        renderApp();
      } catch (error) {
        console.error('[meter_reading] loadMeterReadings error:', error);
        appState.error = `検針データの取得に失敗しました: ${error.message}`;
        appState.loading = false;
        renderApp();
      }
    };

    // Web App環境での検針データ取得
    const loadMeterReadingsWebApp = async (propertyId, roomId) => {
      try {
        const baseUrl = window.location.origin + window.location.pathname;
        const fetchUrl = `${baseUrl}?action=getMeterReadings&propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(roomId)}`;
        
        console.log('[meter_reading] Web App検針データ取得URL:', fetchUrl);
        
        const response = await fetch(fetchUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('[meter_reading] Web App検針データ取得結果:', result);
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        // 🔥 統一レスポンス形式に対応した処理
        let readings;
        if (result.success === true && Array.isArray(result.data)) {
          // 新しい統一形式: {success: true, data: [], count: 0}
          readings = result.data;
          console.log('[meter_reading_gas] ✅ 統一形式のデータを使用:', readings.length, '件');
        } else if (result.readings && Array.isArray(result.readings)) {
          // readings プロパティ形式
          readings = result.readings;
          console.log('[meter_reading_gas] ⚠️ readingsプロパティ形式を使用');
        } else if (Array.isArray(result)) {
          // 直接配列形式
          readings = result;
          console.log('[meter_reading_gas] ⚠️ 直接配列形式を使用');
        } else if (result.result && Array.isArray(result.result)) {
          // result プロパティ形式
          readings = result.result;
          console.log('[meter_reading_gas] ⚠️ レガシーresult形式を使用');
        } else {
          console.error('[meter_reading_gas] 予期しないレスポンス形式:', result);
          console.error('[meter_reading_gas] Response keys:', Object.keys(result || {}));
          console.error('[meter_reading_gas] Response content:', result);
          throw new Error('検針データの形式が正しくありません。APIレスポンスを確認してください。');
        }
        
        return readings || [];
      } catch (error) {
        console.error('[meter_reading] Web App検針データ取得エラー:', error);
        throw error;
      }
    };

    // ===================================
    // Application Initialization
    // ===================================
    
    const initializeApp = async () => {
      try {
        console.log('[meter_reading] アプリを初期化します。');
        
        // Web App環境でのURLパラメータ処理
        if (isWebApp()) {
          const urlParams = new URLSearchParams(window.location.search);
          const propertyIdFromUrl = urlParams.get('propertyId');
          const propertyNameFromUrl = urlParams.get('propertyName');
          const roomIdFromUrl = urlParams.get('roomId');
          const roomNameFromUrl = urlParams.get('roomName');
          
          if (propertyIdFromUrl && propertyNameFromUrl && roomIdFromUrl && roomNameFromUrl) {
            console.log('[meter_reading] Web App環境: URLパラメータを使用');
            appState.propertyId = decodeURIComponent(propertyIdFromUrl);
            appState.propertyName = decodeURIComponent(propertyNameFromUrl);
            appState.roomId = decodeURIComponent(roomIdFromUrl);
            appState.roomName = decodeURIComponent(roomNameFromUrl);
            
            console.log('[meter_reading] URLパラメータ詳細:');
            console.log('[meter_reading] - propertyId:', `"${appState.propertyId}"`);
            console.log('[meter_reading] - propertyName:', `"${appState.propertyName}"`);
            console.log('[meter_reading] - roomId:', `"${appState.roomId}"`);
            console.log('[meter_reading] - roomName:', `"${appState.roomName}"`);
            
            // Web App環境で検針データを取得
            try {
              const readings = await loadMeterReadingsWebApp(appState.propertyId, appState.roomId);
              appState.meterReadings = Array.isArray(readings) ? readings : [];
              console.log('[meter_reading] ✅ Web App検針データ取得成功 - 件数:', appState.meterReadings.length);
            } catch (error) {
              console.error('[meter_reading] Web App検針データ取得失敗:', error);
              appState.meterReadings = [];
            }
          } else {
            console.error('[meter_reading] Web App環境: 必要なURLパラメータが不足しています');
            appState.error = 'URLパラメータが不足しています。物件選択画面から再度アクセスしてください。';
            appState.loading = false;
            renderApp();
            return;
          }
        } else {
          // GAS環境: テンプレートからのデータを取得
          appState.propertyId = window.gasPropertyId || 'N/A';
          appState.propertyName = window.gasPropertyName || 'N/A';
          appState.roomId = window.gasRoomId || 'N/A';
          appState.roomName = window.gasRoomName || 'N/A';

          console.log('[meter_reading] GASテンプレートデータ詳細:');
          console.log('[meter_reading] - propertyId:', `"${appState.propertyId}"`, '型:', typeof appState.propertyId);
          console.log('[meter_reading] - propertyName:', `"${appState.propertyName}"`, '型:', typeof appState.propertyName);
          console.log('[meter_reading] - roomId:', `"${appState.roomId}"`, '型:', typeof appState.roomId);
          console.log('[meter_reading] - roomName:', `"${appState.roomName}"`, '型:', typeof appState.roomName);

          if (!appState.propertyId || !appState.roomId || appState.propertyId === 'N/A' || appState.roomId === 'N/A') {
            console.error('[meter_reading] 物件IDまたは部屋IDがGASテンプレートから正しく取得できません。');
            appState.error = '物件情報または部屋情報が不足しているため、検針データを取得できません。';
            appState.loading = false;
            renderApp();
            return;
          }

          // GASテンプレートから検針データを取得
          if (window.gasMeterReadings) {
            console.log('[meter_reading] GASテンプレートから検針データを取得:', window.gasMeterReadings);
            let readings;
            if (Array.isArray(window.gasMeterReadings)) {
              readings = window.gasMeterReadings;
              console.log('[meter_reading_gas] ⚠️ GAS直接配列形式を使用');
            } else if (window.gasMeterReadings.success === true && Array.isArray(window.gasMeterReadings.data)) {
              readings = window.gasMeterReadings.data;
              console.log('[meter_reading_gas] ✅ GAS統一形式データを使用:', readings.length, '件');
            } else if (window.gasMeterReadings.readings && Array.isArray(window.gasMeterReadings.readings)) {
              readings = window.gasMeterReadings.readings;
              console.log('[meter_reading_gas] ⚠️ GASreadingsプロパティ形式を使用');
            } else if (window.gasMeterReadings.result && Array.isArray(window.gasMeterReadings.result)) {
              readings = window.gasMeterReadings.result;
              console.log('[meter_reading_gas] ⚠️ GASレガシーresult形式を使用');
            } else {
              console.error('[meter_reading] 予期しない検針データ形式:', window.gasMeterReadings);
              readings = [];
            }
            
            appState.meterReadings = readings;
            console.log('[meter_reading] ✅ テンプレートデータ取得成功 - 件数:', readings.length);
          } else {
            console.log('[meter_reading] ⚠️ GASテンプレートに検針データがありません（初回検針状態）');
            appState.meterReadings = [];
          }
        }
        
        appState.loading = false;
        renderApp();
        
      } catch (error) {
        console.error('[meter_reading] アプリの初期化に失敗しました:', error);
        appState.error = 'アプリの起動に失敗しました。初期化を確認してください。';
        appState.loading = false;
        renderApp();
      }
    };

    // Start the application
    window.addEventListener('load', () => {
      window.scrollTo(0, 0);
      initializeApp();
    });

    // Initial render
    renderApp();
  </script>

  <!-- PWA関連のスクリプト -->
  <link rel="stylesheet" href="/pwa-styles.css">
  <script src="/pwa-utils.js"></script>
</body>
</html>
