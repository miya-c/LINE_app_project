# 🔥 GAS強制デプロイメント手順書 🔥

## 問題の概要
Google Apps Scriptで新しいバージョンをデプロイしても、古いバージョンが実行され続ける問題が発生しています。

## ✅ 解決手順（推奨順）

### 1. 完全な新規デプロイ（最も確実）

1. **Google Apps Scriptエディタを開く**
   - 現在のプロジェクトを開く

2. **コード全体を再配置**
   - `物件.gs`ファイルの内容を全選択してコピー
   - 一度すべて削除
   - 再度貼り付け
   - `Ctrl+S`で保存

3. **新規デプロイメント実行**
   - 右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」を選択
   - **重要：「種類を選択」で「ウェブアプリ」を選択**
   - 「新しいバージョンの説明」に `v3-DEBUG-FORCE-$(現在時刻)` を入力
   - 「実行ユーザー」：「自分」
   - 「アクセスできるユーザー」：「全員」
   - 「デプロイ」ボタンをクリック

4. **新しいURLの確認**
   - 新しいウェブアプリのURLをコピー
   - **このURLは必ず新しいものになります**

### 2. プロジェクト完全再作成（上記で解決しない場合）

1. **新しいGoogle Apps Scriptプロジェクトを作成**
   - https://script.google.com/ にアクセス
   - 「新しいプロジェクト」をクリック

2. **ファイル設定**
   - プロジェクト名を「水道検針WOFF-v3-FINAL」に変更
   - `Code.gs`ファイルの内容を削除
   - `物件.gs`の内容を全てコピペ
   - 保存

3. **スプレッドシート接続**
   - 左側の「リソース」→「ライブラリ」
   - 必要に応じてSpreadsheetサービスを有効化

4. **ウェブアプリとしてデプロイ**
   - 「デプロイ」→「新しいデプロイ」
   - 「ウェブアプリ」を選択
   - 「実行ユーザー」：「自分」
   - 「アクセスできるユーザー」：「全員」
   - デプロイ実行

### 3. キャッシュクリア（補助手順）

1. **ブラウザキャッシュクリア**
   - `Ctrl+Shift+Delete`でキャッシュクリア
   - またはシークレットモードで動作確認

2. **GASエディタ強制リフレッシュ**
   - Google Apps Scriptエディタで`Ctrl+F5`
   - 完全リロード実行

## 🧪 デプロイ確認方法

### A. テストページでの確認
1. `gas_deploy_test.html`を開く
2. 新しいGAS URLを入力
3. 「バージョン確認」ボタンをクリック
4. レスポンスで `"version": "2025-01-02-v3-DEBUG"` が表示されることを確認

### B. 直接URLアクセス確認
新しいGAS URLに `?action=getVersion` を追加してブラウザでアクセス：
```
https://script.google.com/macros/s/[新しいID]/exec?action=getVersion
```

**期待レスポンス（v3-DEBUG版）：**
```json
{
  "version": "2025-01-02-v3-DEBUG",
  "availableActions": ["getProperties", "getRooms", "updateInspectionComplete", "getMeterReadings", "updateMeterReadings", "getVersion"],
  "description": "🔥🔥🔥 v3-DEBUG版が動作中です！ 🔥🔥🔥",
  "debugInfo": {
    "deploymentCheck": "🔥 v3-DEBUG版が正常に動作しています 🔥"
  }
}
```

**古いバージョンのレスポンス（修正が必要）：**
```json
{
  "error": "無効なアクションです。",
  "expectedActions": ["getProperties", "getRooms", "getMeterReadings"]
}
```

## 🚨 よくある問題と対処法

### Q1: デプロイしても古いバージョンが実行される
**A1:** 
- GASは時々キャッシュが残る
- 完全新規デプロイ（手順1）を実行
- 新しいURLを確実に使用

### Q2: 「アクセス権限がありません」エラー
**A2:**
- デプロイ設定で「アクセスできるユーザー」を「全員」に設定
- Google アカウントでの認証が必要な場合は認証実行

### Q3: CORS エラーが続く
**A3:**
- 新しいデプロイメントでCORS設定が自動的に修正される
- ブラウザキャッシュをクリア
- シークレットモードで動作確認

## 📝 チェックリスト

- [ ] `物件.gs`ファイルの内容が最新版（v3-DEBUG）になっている
- [ ] GASエディタで保存済み
- [ ] 新しいデプロイメントを実行済み
- [ ] 新しいURLを取得済み
- [ ] テストページで動作確認済み
- [ ] レスポンスに「v3-DEBUG」が含まれている
- [ ] 6つのアクションすべてが利用可能になっている

## 🎯 成功の判定基準

1. **バージョン確認**で`v3-DEBUG`が返される
2. **全6アクション**が正常に動作する：
   - getProperties
   - getRooms  
   - updateInspectionComplete
   - getMeterReadings
   - updateMeterReadings
   - getVersion
3. **CORS関連エラー**が発生しない
4. **POST リクエスト**が正常に処理される

---

**⚡ 緊急時の対応**
もし上記手順でも解決しない場合は、Google Apps Scriptの管理画面で「プロジェクトを複製」して完全に新しいプロジェクトを作成してください。
