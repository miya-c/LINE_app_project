<!DOCTYPE html>
<html lang="ja">
<head>
  <title>CSS読み込み修正 Before/After 比較検証</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1400px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .comparison-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 20px; margin: 20px 0;
    }
    .comparison-card {
      background: #f8f9fa; padding: 20px; border-radius: 8px;
      border: 2px solid #dee2e6;
    }
    .comparison-card.before { border-color: #dc3545; }
    .comparison-card.after { border-color: #28a745; }
    .comparison-card h3 { 
      margin-top: 0; text-align: center;
      padding: 10px; border-radius: 4px;
    }
    .before h3 { background-color: #f8d7da; color: #721c24; }
    .after h3 { background-color: #d4edda; color: #155724; }
    .test-iframe {
      width: 100%; height: 400px; border: 1px solid #ddd;
      border-radius: 4px; margin: 10px 0;
    }
    .metrics-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px; margin: 15px 0;
    }
    .metric {
      background: white; padding: 10px; border-radius: 4px;
      text-align: center; border: 1px solid #ddd;
    }
    .metric-value { font-size: 18px; font-weight: bold; }
    .metric-label { font-size: 12px; color: #6c757d; }
    .before .metric-value { color: #dc3545; }
    .after .metric-value { color: #28a745; }
    button {
      padding: 8px 16px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .result-log {
      background: #f8f9fa; border: 1px solid #dee2e6;
      border-radius: 4px; padding: 15px; margin: 10px 0;
      max-height: 200px; overflow-y: auto;
      font-family: monospace; font-size: 14px;
    }
    .log-entry {
      margin: 5px 0; padding: 5px;
      border-left: 3px solid #007bff;
      background: white;
    }
    .log-success { border-left-color: #28a745; }
    .log-warning { border-left-color: #ffc107; }
    .log-error { border-left-color: #dc3545; }
    .improvement {
      background: #e7f5e7; border: 2px solid #28a745;
      border-radius: 8px; padding: 15px; margin: 20px 0;
      text-align: center;
    }
    .improvement h4 { margin: 0 0 10px 0; color: #155724; }
    .improvement-value {
      font-size: 24px; font-weight: bold; color: #28a745;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 CSS読み込み修正 Before/After 比較検証</h1>
    <p>実装前後でのCSS読み込み性能とFOUC対策の効果を比較検証します。</p>
    
    <div class="comparison-grid">
      <!-- Before: 修正前 -->
      <div class="comparison-card before">
        <h3>❌ 修正前 (property_select_broken.html)</h3>
        <div class="metrics-grid" id="before-metrics">
          <div class="metric">
            <div class="metric-value" id="before-load-time">-</div>
            <div class="metric-label">読み込み時間</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="before-css-status">-</div>
            <div class="metric-label">CSS読み込み</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="before-fouc">-</div>
            <div class="metric-label">FOUC対策</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="before-critical">-</div>
            <div class="metric-label">クリティカルCSS</div>
          </div>
        </div>
        <button onclick="testVersion('before')">修正前をテスト</button>
        <a href="property_select_broken.html" target="_blank" style="color: #dc3545; text-decoration: none;">🔗 ページを開く</a>
        <div class="result-log" id="before-log"></div>
      </div>
      
      <!-- After: 修正後 -->
      <div class="comparison-card after">
        <h3>✅ 修正後 (property_select.html)</h3>
        <div class="metrics-grid" id="after-metrics">
          <div class="metric">
            <div class="metric-value" id="after-load-time">-</div>
            <div class="metric-label">読み込み時間</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="after-css-status">-</div>
            <div class="metric-label">CSS読み込み</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="after-fouc">-</div>
            <div class="metric-label">FOUC対策</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="after-critical">-</div>
            <div class="metric-label">クリティカルCSS</div>
          </div>
        </div>
        <button onclick="testVersion('after')">修正後をテスト</button>
        <a href="property_select.html" target="_blank" style="color: #28a745; text-decoration: none;">🔗 ページを開く</a>
        <div class="result-log" id="after-log"></div>
      </div>
    </div>
    
    <!-- 改善効果 -->
    <div class="improvement" id="improvement-summary" style="display: none;">
      <h4>📈 修正による改善効果</h4>
      <div id="improvement-details"></div>
    </div>
    
    <!-- 一括テスト -->
    <div class="comparison-card">
      <h3>🚀 一括比較テスト</h3>
      <p>修正前後の両方のページを同時にテストして効果を比較します。</p>
      <button onclick="runComparisonTest()">比較テスト実行</button>
      <button onclick="runMultipleTests()">複数回テスト実行 (5回)</button>
      <button onclick="clearAllLogs()">ログクリア</button>
      
      <div id="comparison-results"></div>
    </div>
  </div>

  <script>
    let testResults = {
      before: [],
      after: []
    };

    function addLog(version, message, type = 'log-entry') {
      const logDiv = document.getElementById(`${version}-log`);
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function testVersion(version) {
      const url = version === 'before' ? 'property_select_broken.html' : 'property_select.html';
      
      addLog(version, `テスト開始: ${url}`);
      
      const startTime = performance.now();
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      
      iframe.onload = () => {
        const loadTime = performance.now() - startTime;
        
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          const iframeWindow = iframe.contentWindow;
          
          // CSS読み込み状況
          const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
          const cssLoaded = Array.from(cssLinks).every(link => link.sheet !== null);
          
          // クリティカルCSSの存在確認
          const inlineStyles = iframeDoc.querySelectorAll('style');
          const hasCriticalCSS = inlineStyles.length > 0;
          
          // FOUC対策の確認
          const rootElement = iframeDoc.getElementById('root');
          const hasFOUCProtection = rootElement && 
            (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
          
          // スタイル適用確認
          const testElement = iframeDoc.createElement('div');
          testElement.className = 'mantine-button';
          testElement.style.position = 'absolute';
          testElement.style.visibility = 'hidden';
          iframeDoc.body.appendChild(testElement);
          
          const computedStyle = iframeWindow.getComputedStyle(testElement);
          const hasButtonStyles = computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                                 computedStyle.backgroundColor !== 'transparent';
          
          iframeDoc.body.removeChild(testElement);
          
          // 結果を保存
          const result = {
            loadTime: loadTime.toFixed(2),
            cssLoaded,
            hasCriticalCSS,
            hasFOUCProtection,
            hasButtonStyles,
            cssCount: cssLinks.length,
            timestamp: Date.now()
          };
          
          testResults[version].push(result);
          updateMetrics(version, result);
          
          addLog(version, `読み込み完了: ${result.loadTime}ms`, 'log-success');
          addLog(version, `CSS読み込み: ${cssLoaded ? '成功' : '失敗'}`, cssLoaded ? 'log-success' : 'log-error');
          addLog(version, `クリティカルCSS: ${hasCriticalCSS ? 'あり' : 'なし'}`, hasCriticalCSS ? 'log-success' : 'log-warning');
          addLog(version, `FOUC対策: ${hasFOUCProtection ? '適用済み' : '未適用'}`, hasFOUCProtection ? 'log-success' : 'log-error');
          
        } catch (error) {
          addLog(version, `エラー: ${error.message}`, 'log-error');
        }
        
        document.body.removeChild(iframe);
        updateImprovementSummary();
      };
      
      iframe.onerror = () => {
        addLog(version, 'ページ読み込みエラー', 'log-error');
        document.body.removeChild(iframe);
      };
      
      document.body.appendChild(iframe);
    }

    function updateMetrics(version, result) {
      document.getElementById(`${version}-load-time`).textContent = `${result.loadTime}ms`;
      document.getElementById(`${version}-css-status`).textContent = result.cssLoaded ? '✅' : '❌';
      document.getElementById(`${version}-fouc`).textContent = result.hasFOUCProtection ? '✅' : '❌';
      document.getElementById(`${version}-critical`).textContent = result.hasCriticalCSS ? '✅' : '❌';
    }

    function updateImprovementSummary() {
      if (testResults.before.length === 0 || testResults.after.length === 0) return;
      
      const beforeAvg = testResults.before.reduce((sum, r) => sum + parseFloat(r.loadTime), 0) / testResults.before.length;
      const afterAvg = testResults.after.reduce((sum, r) => sum + parseFloat(r.loadTime), 0) / testResults.after.length;
      
      const improvement = beforeAvg - afterAvg;
      const improvementPercent = ((improvement / beforeAvg) * 100).toFixed(1);
      
      const beforeSuccess = testResults.before.filter(r => r.cssLoaded && r.hasButtonStyles).length;
      const afterSuccess = testResults.after.filter(r => r.cssLoaded && r.hasButtonStyles && r.hasFOUCProtection).length;
      
      const summaryDiv = document.getElementById('improvement-summary');
      const detailsDiv = document.getElementById('improvement-details');
      
      summaryDiv.style.display = 'block';
      detailsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <div class="improvement-value">${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}ms</div>
            <div>読み込み時間の改善</div>
          </div>
          <div>
            <div class="improvement-value">${improvementPercent}%</div>
            <div>パフォーマンス向上</div>
          </div>
          <div>
            <div class="improvement-value">${afterSuccess}/${testResults.after.length}</div>
            <div>修正後の成功率</div>
          </div>
          <div>
            <div class="improvement-value">${testResults.after.every(r => r.hasFOUCProtection) ? '100%' : '0%'}</div>
            <div>FOUC対策率</div>
          </div>
        </div>
      `;
    }

    function runComparisonTest() {
      addLog('before', '比較テスト開始', 'log-success');
      addLog('after', '比較テスト開始', 'log-success');
      
      testVersion('before');
      setTimeout(() => testVersion('after'), 1000);
    }

    function runMultipleTests() {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          addLog('before', `テスト ${i+1}/5 実行中`, 'log-success');
          addLog('after', `テスト ${i+1}/5 実行中`, 'log-success');
          testVersion('before');
          setTimeout(() => testVersion('after'), 500);
        }, i * 2000);
      }
    }

    function clearAllLogs() {
      document.getElementById('before-log').innerHTML = '';
      document.getElementById('after-log').innerHTML = '';
      document.getElementById('comparison-results').innerHTML = '';
      testResults = { before: [], after: [] };
      document.getElementById('improvement-summary').style.display = 'none';
      
      // メトリクスをリセット
      ['before', 'after'].forEach(version => {
        document.getElementById(`${version}-load-time`).textContent = '-';
        document.getElementById(`${version}-css-status`).textContent = '-';
        document.getElementById(`${version}-fouc`).textContent = '-';
        document.getElementById(`${version}-critical`).textContent = '-';
      });
    }
  </script>
</body>
</html>
