# 水道検針WOFFアプリ 要件定義書・仕様書

## 1. はじめに

### 1.1. プロジェクト名
水道検針WOFFアプリ

### 1.2. 目的
検針員による水道メーターの検針作業を効率化し、データの正確性を向上させる。LINE WORKS上で動作するミニアプリ（WOFF）として提供し、検針員が使い慣れた環境で作業できるようにする。

### 1.3. 対象ユーザー
水道検針員

## 2. システム概要

### 2.1. システム構成
*   **フロントエンド:** WOFFアプリ (HTML, CSS, JavaScript)
    *   Vercel等の静的ホスティングサービスで配信
*   **バックエンド:** Google Apps Script (GAS)
    *   ウェブアプリとしてデプロイし、WOFFアプリからのAPIリクエストを処理
*   **データベース:** Googleスプレッドシート
    *   物件マスタ、部屋マスタ、検針データ、設定値を管理

### 2.2. 使用技術
*   LINE WORKS (WOFF)
*   HTML5
*   CSS3
*   JavaScript (ES6+)
*   Google Apps Script
*   Googleスプレッドシート
*   Google Drive (写真保存用)
*   Vercel (または類似の静的ホスティングサービス)

## 3. 機能要件

### 3.1. 検針員向け機能 (WOFFアプリ)

#### 3.1.1. 物件選択機能
*   登録されている物件の一覧を「物件ID：物件名」形式で表示する。
*   物件IDまたは物件名（部分一致）で物件を検索できる。
*   選択した物件の部屋選択画面へ遷移する。

#### 3.1.2. 部屋選択機能
*   選択された物件に紐づく部屋番号の一覧を表示する。
*   検索機能はなし（スクロールで選択）。
*   選択した部屋の指示数入力画面へ遷移する。

#### 3.1.3. 指示数入力機能
*   選択中の物件名・部屋番号を表示する。
*   直近3ヶ月分の指示数を表示する。
*   前回指示数を明確に表示する。
*   今回の指示数を入力する数値入力ボックスを設ける。
*   入力された今回の指示数と前回指示数から、今回使用量を自動計算して表示する。

#### 3.1.4. 写真撮影・保存機能 (指示数入力画面)
*   メーターの写真を撮影するボタンを設ける。
*   撮影した写真は、指示数データと共にGoogle Driveに保存され、そのURLがスプレッドシートに記録される。

#### 3.1.5. 異常値警告機能 (指示数入力画面)
*   入力された指示数から計算した今回使用量が、過去3ヶ月の平均使用量と比較して、設定された標準偏差の倍率（例: 3倍）以上乖離していた場合、警告メッセージを表示する。
    *   警告判定ロジック: 平均使用量 ± (標準偏差 × 設定倍率) の範囲外
    *   標準偏差の倍率はGoogleスプレッドシートの「設定値」シートで管理し、調整可能とする。

#### 3.1.6. データ一時保存機能 (指示数入力画面)
*   指示数入力画面で「保存」ボタンを押すと、入力された指示数と写真データ（あれば）をWOFFアプリ内に一時的に保存する。
*   保存後、部屋選択画面へ戻る。

#### 3.1.7. データ一括送信機能 (部屋選択画面)
*   部屋選択画面に「（この物件のデータを）まとめて送信する」ボタンを設ける。
*   このボタンは、該当物件に未送信の保存データがある場合にのみ表示（または有効化）される。
*   ボタンを押すと、一時保存されていた該当物件の全検針データが一括でGoogle Apps Script (GAS) に送信され、スプレッドシートに記録される。
*   送信中のフィードバック（ローディング表示など）を行う。
*   送信成功時には成功メッセージを表示し、一時保存データをクリアする。
*   送信失敗時には失敗メッセージを表示し、一時保存データは保持して再送信を促す。

#### 3.1.8. 未送信データクリア機能 (部屋選択画面)
*   部屋選択画面に「未送信データをクリアする」ボタンを設ける（未送信データがある場合のみ）。
*   ボタンを押すと確認メッセージを表示後、該当物件の未送信データをWOFFアプリ内から削除する。

### 3.2. 管理者向け機能 (Googleスプレッドシート)

#### 3.2.1. 年間検針レポート表示機能
*   Googleスプレッドシート上に「年間検針レポート」シートを設ける。
*   物件IDと年を入力することで、該当物件の1年間の各部屋の検針データ（指示数、使用量、年間合計使用量など）を表形式で表示する。
*   データは「検針データ」シートから`QUERY`関数等で抽出・整形して表示する。

## 4. 非機能要件

### 4.1. オフライン対応
*   WOFFアプリは、オフライン時でも以下の操作を可能とする。
    *   マスタデータ（物件・部屋）の閲覧・選択（事前にオンライン時に取得・保存しておく）。
    *   指示数の入力、写真撮影、アプリ内への一時保存。
    *   異常値警告表示（必要な過去データがあれば）。
*   データ送信はオンライン時に行う。オフライン時に送信しようとした場合は、その旨をユーザーに通知する。

### 4.2. セキュリティ
*   Google Apps Scriptのウェブアプリは、「アクセスできるユーザー：全員」としてデプロイする。
*   WOFFアプリからGASへの通信はHTTPSで行われる。
*   （本格運用時には、GASのアクセス権限やCORS設定をより厳密にすることを検討）

### 4.3. パフォーマンス
*   Google Apps Scriptでスプレッドシートから大量の過去データを参照する際は、一度にまとめてデータを取得し、GASのメモリ上で処理することで、スプレッドシートへのアクセス回数を最小限に抑える。

## 5. 画面仕様

### 5.1. 物件選択画面 (`/Users/miya/Project/LINE_app_project/property_select.html`)
*   **表示項目:**
    *   画面タイトル「物件選択」
    *   検索ボックス（プレースホルダー「物件IDまたは物件名で検索...」）
    *   物件リスト表示エリア（初期表示「物件情報を読み込み中です...」）
*   **動作:**
    *   画面読み込み時、GAS APIを呼び出し物件リストを取得。
    *   取得した物件を「物件ID：物件名」形式のボタンとしてリスト表示。
    *   検索ボックスに入力された文字列（部分一致、大文字・小文字区別なし）で物件リストを絞り込み表示。
    *   物件ボタンクリック時、選択された物件の`propertyId`と`propertyName`をURLパラメータとして付与し、部屋選択画面 (`/Users/miya/Project/LINE_app_project/room_select.html`) へ遷移。
    *   API通信失敗時はエラーメッセージを表示。

### 5.2. 部屋選択画面 (`/Users/miya/Project/LINE_app_project/room_select.html`)
*   **表示項目:**
    *   「物件選択に戻る」ボタン
    *   選択中の物件名（例：「〇〇アパート」）
    *   部屋リスト表示エリア（初期表示「（物件ID）の部屋情報を読み込み中です...」）
    *   「（この物件のデータを）まとめて送信する」ボタン（未送信データがある場合のみ）
    *   「未送信データをクリアする」ボタン（未送信データがある場合のみ）
*   **動作:**
    *   画面読み込み時、URLパラメータから`propertyId`と`propertyName`を取得し、物件名を表示。
    *   取得した`propertyId`を元に、GAS APIを呼び出し部屋リストを取得。
    *   取得した部屋を「部屋番号」のボタンとしてリスト表示。
    *   部屋ボタンクリック時、選択された部屋の情報を元に指示数入力画面へ遷移（遷移先は未作成）。
    *   API通信失敗時はエラーメッセージを表示。
    *   「まとめて送信する」ボタンクリック時、WOFFアプリ内に一時保存された該当物件の検針データをGAS API経由でスプレッドシートに送信。
    *   「未送信データをクリアする」ボタンクリック時、確認後、該当物件の未送信データを削除。

### 5.3. 指示数入力画面 (未作成)
*   **表示項目（予定）:**
    *   選択中の物件名・部屋番号
    *   直近3ヶ月の指示数
    *   前回指示数
    *   今回の指示数入力ボックス
    *   今回ご使用量（自動計算）
    *   写真撮影ボタン
    *   警告メッセージ表示エリア
    *   「保存」ボタン
*   **動作（予定）:**
    *   指示数入力後、使用量を自動計算。
    *   異常値判定を行い、該当する場合は警告メッセージを表示。
    *   「保存」ボタンクリック時、入力データ（写真含む）をWOFFアプリ内に一時保存し、部屋選択画面へ戻る。

## 6. データ仕様

### 6.1. Googleスプレッドシート構成

#### 6.1.1. `物件マスタ` シート
| 列 |項目名   | データ型 | 説明                     | 例        |
|----|---------|----------|--------------------------|-----------|
| A  | 物件ID  | 文字列   | 物件の一意識別子         | P001      |
| B  | 物件名  | 文字列   | 物件の名称               | 〇〇アパート |

#### 6.1.2. `部屋マスタ` シート
| 列 |項目名   | データ型 | 説明                     | 例        |
|----|---------|----------|--------------------------|-----------|
| A  | 部屋ID  | 文字列   | 部屋の一意識別子         | R0001     |
| B  | 物件ID  | 文字列   | `物件マスタ`の物件IDと紐づく | P001      |
| C  | 部屋番号 | 文字列   | 部屋の番号または名称     | 101       |

#### 6.1.3. `検針データ` シート
| 列 |項目名       | データ型 | 説明                                 | 例                  |
|----|-------------|----------|--------------------------------------|---------------------|
| A  | 記録ID      | 文字列   | 検針記録の一意識別子（GASで自動生成） | (UUID)              |
| B  | 部屋ID      | 文字列   | `部屋マスタ`の部屋IDと紐づく         | R0001               |
| C  | 検針日時    | 日時     | 検針を行った日時                     | 2023/10/28 10:30:00 |
| D  | 今回の指示数 | 数値     | 今回検針したメーターの指示数         | 1234                |
| E  | 写真URL     | 文字列   | 撮影した写真のGoogle Drive URL       | (URL)               |
| F  | 前回指示数  | 数値     | 前回の検針時のメーター指示数         | 1200                |
| G  | 今回使用量  | 数値     | 今回の指示数 - 前回指示数            | 34                  |
| H  | 警告フラグ  | 文字列   | 異常値の場合「警告あり」、それ以外「正常」 | 正常                |

#### 6.1.4. `設定値` シート
| 列 |項目名     | データ型 | 説明                     | 例        |
|----|-----------|----------|--------------------------|-----------|
| A  | 設定項目名 | 文字列   | 設定の名称               | 標準偏差倍率 |
| B  | 設定値     | 数値/文字列 | 設定の値                 | 3         |

### 6.2. WOFFアプリ内一時保存データ形式 (JavaScriptオブジェクトの配列)
```javascript
[
  {
    "propertyId": "P001",
    "roomId": "R0001",
    "currentReading": 1234,
    "photoData": null, // またはBase64文字列など
    "inputTimestamp": "2023-10-28T01:30:00Z" // ISO 8601形式
  },
  // ... 他の部屋のデータ
]
