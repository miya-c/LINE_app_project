<!DOCTYPE html>
<html>
<head>
    <title>Google Apps Script CORS ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }
        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }
        .warning {
            background: #ffc;
            border: 1px solid #fc6;
            color: #c90;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        .test-header {
            background: #e9ecef;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .test-content {
            padding: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Google Apps Script CORS ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="container warning">
        <h3>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h3>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
        <ul>
            <li>Google Apps Script ã§æœ€æ–°ã®ç‰©ä»¶.gs ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹</li>
            <li>Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ï¼ˆå…¨å“¡ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰</li>
            <li>æ­£ã—ã„Webã‚¢ãƒ—ãƒªURLãŒä¸‹ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹</li>
        </ul>
    </div>

    <div class="test-section">
        <div class="test-header">ğŸ“ è¨­å®š</div>
        <div class="test-content">
            <label>Google Apps Script Webã‚¢ãƒ—ãƒªURL:</label>
            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
            <button onclick="saveUrl()">URLä¿å­˜</button>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">ğŸ§ª åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆ</div>
        <div class="test-content">
            <button onclick="testBasicConnection()">åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testOptionsRequest()">OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testGetVersion()">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆ</button>
            <div id="basicResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">ğŸ“¤ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ</div>
        <div class="test-content">
            <button onclick="testSimplePost()">ã‚·ãƒ³ãƒ—ãƒ«POSTãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testUpdateMeterReadings()">æ¤œé‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testPostWithPhoto()">å†™çœŸä»˜ãPOSTãƒ†ã‚¹ãƒˆ</button>
            <div id="postResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">ğŸ“¥ GETãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</div>
        <div class="test-content">
            <button onclick="testGetFallback()">GETãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testLongUrlGet()">é•·ã„URL GETãƒ†ã‚¹ãƒˆ</button>
            <div id="getResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">ğŸ“Š è©³ç´°ãƒ­ã‚°</div>
        <div class="test-content">
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="exportLog()">ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <div id="detailLog" class="log">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...\n</div>
        </div>
    </div>

    <script>
        let logDiv = document.getElementById('detailLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            const formattedMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            logDiv.textContent += formattedMessage;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(formattedMessage);
        }

        function clearLog() {
            logDiv.textContent = 'ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ...\n';
        }

        function exportLog() {
            const logContent = logDiv.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gas_debug_log_${new Date().toISOString().replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveUrl() {
            const url = document.getElementById('gasUrl').value.trim();
            if (url) {
                sessionStorage.setItem('gasWebAppUrl', url);
                log(`URLä¿å­˜: ${url}`, 'success');
            } else {
                log('URLãŒç©ºã§ã™', 'error');
            }
        }

        function getGasUrl() {
            const url = document.getElementById('gasUrl').value.trim() || sessionStorage.getItem('gasWebAppUrl');
            if (!url) {
                log('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return null;
            }
            return url;
        }

        async function testBasicConnection() {
            const url = getGasUrl();
            if (!url) return;

            log('åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            try {
                const response = await fetch(url + '?action=getVersion', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`HTTP Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('åŸºæœ¬æ¥ç¶šæˆåŠŸ: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('basicResults').innerHTML = '<div class="container success">âœ… åŸºæœ¬æ¥ç¶šæˆåŠŸ</div>';
                } else {
                    const errorText = await response.text();
                    log(`åŸºæœ¬æ¥ç¶šå¤±æ•—: ${errorText}`, 'error');
                    document.getElementById('basicResults').innerHTML = '<div class="container error">âŒ åŸºæœ¬æ¥ç¶šå¤±æ•—</div>';
                }
            } catch (error) {
                log(`åŸºæœ¬æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('basicResults').innerHTML = '<div class="container error">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
            }
        }

        async function testOptionsRequest() {
            const url = getGasUrl();
            if (!url) return;

            log('OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log(`OPTIONS Status: ${response.status} ${response.statusText}`);
                log('OPTIONS Headers: ' + JSON.stringify([...response.headers.entries()], null, 2));
                
                if (response.ok || response.status === 200) {
                    log('OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ', 'success');
                } else {
                    log('OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', 'error');
                }
            } catch (error) {
                log(`OPTIONSã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testGetVersion() {
            const url = getGasUrl();
            if (!url) return;

            log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            try {
                const response = await fetch(url + '?action=getVersion', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªå¤±æ•—: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testSimplePost() {
            const url = getGasUrl();
            if (!url) return;

            log('ã‚·ãƒ³ãƒ—ãƒ«POSTãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROP',
                roomId: 'TEST_ROOM',
                readings: []
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`POST Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('POSTãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('postResults').innerHTML = '<div class="container success">âœ… POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ</div>';
                } else {
                    const errorText = await response.text();
                    log(`POSTå¤±æ•—: ${errorText}`, 'error');
                    document.getElementById('postResults').innerHTML = '<div class="container error">âŒ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—</div>';
                }
            } catch (error) {
                log(`POSTã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('postResults').innerHTML = '<div class="container error">âŒ POSTã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
            }
        }

        async function testUpdateMeterReadings() {
            const url = getGasUrl();
            if (!url) return;

            log('æ¤œé‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_001',
                roomId: 'TEST_ROOM_001',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '1234',
                        photoData: null
                    }
                ]
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`æ¤œé‡æ›´æ–° Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('æ¤œé‡æ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`æ¤œé‡æ›´æ–°å¤±æ•—: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`æ¤œé‡æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testPostWithPhoto() {
            const url = getGasUrl();
            if (!url) return;

            log('å†™çœŸä»˜ãPOSTãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            // å°ã•ãªãƒ†ã‚¹ãƒˆç”¨Base64ç”»åƒ
            const testPhotoData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_PHOTO',
                roomId: 'TEST_ROOM_PHOTO',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '5678',
                        photoData: testPhotoData
                    }
                ]
            };
            
            log(`å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${testPhotoData.length} æ–‡å­—`);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`å†™çœŸä»˜ãPOST Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('å†™çœŸä»˜ãPOSTãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`å†™çœŸä»˜ãPOSTå¤±æ•—: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`å†™çœŸä»˜ãPOSTã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testGetFallback() {
            const url = getGasUrl();
            if (!url) return;

            log('GETãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_GET',
                roomId: 'TEST_ROOM_GET',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '9999',
                        photoData: null
                    }
                ]
            };
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: testData.propertyId,
                roomId: testData.roomId,
                readings: JSON.stringify(testData.readings)
            });
            
            const getUrl = `${url}?${params}`;
            log(`GET URLé•·: ${getUrl.length} æ–‡å­—`);
            
            try {
                const response = await fetch(getUrl, {
                    method: 'GET'
                });
                
                log(`GET Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('GETãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('getResults').innerHTML = '<div class="container success">âœ… GETãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ</div>';
                } else {
                    const errorText = await response.text();
                    log(`GETå¤±æ•—: ${errorText}`, 'error');
                    document.getElementById('getResults').innerHTML = '<div class="container error">âŒ GETãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—</div>';
                }
            } catch (error) {
                log(`GETã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('getResults').innerHTML = '<div class="container error">âŒ GETã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
            }
        }

        async function testLongUrlGet() {
            const url = getGasUrl();
            if (!url) return;

            log('é•·ã„URL GETãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            // é•·ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const longReadings = [];
            for (let i = 0; i < 50; i++) {
                longReadings.push({
                    date: `2025-06-${String(i + 1).padStart(2, '0')}`,
                    currentReading: `${1000 + i}`,
                    photoData: null
                });
            }
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: 'LONG_TEST_PROPERTY',
                roomId: 'LONG_TEST_ROOM',
                readings: JSON.stringify(longReadings)
            });
            
            const getUrl = `${url}?${params}`;
            log(`é•·ã„URLé•·: ${getUrl.length} æ–‡å­—`);
            
            if (getUrl.length > 8000) {
                log('URLé•·ãŒ8000æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ - åˆ¶é™ãƒ†ã‚¹ãƒˆ', 'warning');
            }
            
            try {
                const response = await fetch(getUrl, {
                    method: 'GET'
                });
                
                log(`é•·ã„GET Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('é•·ã„GETãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`é•·ã„GETå¤±æ•—: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`é•·ã„GETã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            const savedUrl = sessionStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                document.getElementById('gasUrl').value = savedUrl;
                log(`ä¿å­˜ã•ã‚ŒãŸURL: ${savedUrl}`, 'info');
            }
            
            log('CORSè¨ºæ–­ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†', 'success');
            log('Google Apps Script Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ã€å„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'info');
        };
    </script>
</body>
</html>
