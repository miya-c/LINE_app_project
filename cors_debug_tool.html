<!DOCTYPE html>
<html>
<head>
    <title>Google Apps Script CORS エラー診断ツール</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }
        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }
        .warning {
            background: #ffc;
            border: 1px solid #fc6;
            color: #c90;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        .test-header {
            background: #e9ecef;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .test-content {
            padding: 15px;
        }
    </style>
</head>
<body>
    <h1>🔧 Google Apps Script CORS エラー診断ツール</h1>
    
    <div class="container warning">
        <h3>⚠️ 重要な注意事項</h3>
        <p>このツールを使用する前に、以下を確認してください：</p>
        <ul>
            <li>Google Apps Script で最新の物件.gs がデプロイされている</li>
            <li>Webアプリとして公開されている（全員がアクセス可能）</li>
            <li>正しいWebアプリURLが下に入力されている</li>
        </ul>
    </div>

    <div class="test-section">
        <div class="test-header">📝 設定</div>
        <div class="test-content">
            <label>Google Apps Script WebアプリURL:</label>
            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
            <button onclick="saveUrl()">URL保存</button>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">🧪 基本接続テスト</div>
        <div class="test-content">
            <button onclick="testBasicConnection()">基本接続テスト</button>
            <button onclick="testOptionsRequest()">OPTIONSリクエストテスト</button>
            <button onclick="testGetVersion()">バージョン確認テスト</button>
            <div id="basicResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">📤 POSTリクエストテスト</div>
        <div class="test-content">
            <button onclick="testSimplePost()">シンプルPOSTテスト</button>
            <button onclick="testUpdateMeterReadings()">検針データ更新テスト</button>
            <button onclick="testPostWithPhoto()">写真付きPOSTテスト</button>
            <div id="postResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">📥 GETフォールバックテスト</div>
        <div class="test-content">
            <button onclick="testGetFallback()">GETフォールバックテスト</button>
            <button onclick="testLongUrlGet()">長いURL GETテスト</button>
            <div id="getResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-header">📊 詳細ログ</div>
        <div class="test-content">
            <button onclick="clearLog()">ログクリア</button>
            <button onclick="exportLog()">ログエクスポート</button>
            <div id="detailLog" class="log">ログがここに表示されます...\n</div>
        </div>
    </div>

    <script>
        let logDiv = document.getElementById('detailLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            const formattedMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            logDiv.textContent += formattedMessage;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(formattedMessage);
        }

        function clearLog() {
            logDiv.textContent = 'ログがクリアされました...\n';
        }

        function exportLog() {
            const logContent = logDiv.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gas_debug_log_${new Date().toISOString().replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveUrl() {
            const url = document.getElementById('gasUrl').value.trim();
            if (url) {
                sessionStorage.setItem('gasWebAppUrl', url);
                log(`URL保存: ${url}`, 'success');
            } else {
                log('URLが空です', 'error');
            }
        }

        function getGasUrl() {
            const url = document.getElementById('gasUrl').value.trim() || sessionStorage.getItem('gasWebAppUrl');
            if (!url) {
                log('Google Apps Script URLが設定されていません', 'error');
                return null;
            }
            return url;
        }

        async function testBasicConnection() {
            const url = getGasUrl();
            if (!url) return;

            log('基本接続テストを開始...');
            
            try {
                const response = await fetch(url + '?action=getVersion', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`HTTP Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('基本接続成功: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('basicResults').innerHTML = '<div class="container success">✅ 基本接続成功</div>';
                } else {
                    const errorText = await response.text();
                    log(`基本接続失敗: ${errorText}`, 'error');
                    document.getElementById('basicResults').innerHTML = '<div class="container error">❌ 基本接続失敗</div>';
                }
            } catch (error) {
                log(`基本接続エラー: ${error.message}`, 'error');
                document.getElementById('basicResults').innerHTML = '<div class="container error">❌ 接続エラー: ' + error.message + '</div>';
            }
        }

        async function testOptionsRequest() {
            const url = getGasUrl();
            if (!url) return;

            log('OPTIONSリクエストテストを開始...');
            
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log(`OPTIONS Status: ${response.status} ${response.statusText}`);
                log('OPTIONS Headers: ' + JSON.stringify([...response.headers.entries()], null, 2));
                
                if (response.ok || response.status === 200) {
                    log('OPTIONSリクエスト成功', 'success');
                } else {
                    log('OPTIONSリクエスト失敗', 'error');
                }
            } catch (error) {
                log(`OPTIONSエラー: ${error.message}`, 'error');
            }
        }

        async function testGetVersion() {
            const url = getGasUrl();
            if (!url) return;

            log('バージョン確認テストを開始...');
            
            try {
                const response = await fetch(url + '?action=getVersion', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('バージョン情報: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`バージョン確認失敗: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`バージョン確認エラー: ${error.message}`, 'error');
            }
        }

        async function testSimplePost() {
            const url = getGasUrl();
            if (!url) return;

            log('シンプルPOSTテストを開始...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROP',
                roomId: 'TEST_ROOM',
                readings: []
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`POST Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('POSTレスポンス: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('postResults').innerHTML = '<div class="container success">✅ POSTリクエスト成功</div>';
                } else {
                    const errorText = await response.text();
                    log(`POST失敗: ${errorText}`, 'error');
                    document.getElementById('postResults').innerHTML = '<div class="container error">❌ POSTリクエスト失敗</div>';
                }
            } catch (error) {
                log(`POSTエラー: ${error.message}`, 'error');
                document.getElementById('postResults').innerHTML = '<div class="container error">❌ POSTエラー: ' + error.message + '</div>';
            }
        }

        async function testUpdateMeterReadings() {
            const url = getGasUrl();
            if (!url) return;

            log('検針データ更新テストを開始...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_001',
                roomId: 'TEST_ROOM_001',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '1234',
                        photoData: null
                    }
                ]
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`検針更新 Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('検針更新レスポンス: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`検針更新失敗: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`検針更新エラー: ${error.message}`, 'error');
            }
        }

        async function testPostWithPhoto() {
            const url = getGasUrl();
            if (!url) return;

            log('写真付きPOSTテストを開始...');
            
            // 小さなテスト用Base64画像
            const testPhotoData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_PHOTO',
                roomId: 'TEST_ROOM_PHOTO',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '5678',
                        photoData: testPhotoData
                    }
                ]
            };
            
            log(`写真データサイズ: ${testPhotoData.length} 文字`);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                log(`写真付きPOST Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('写真付きPOSTレスポンス: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`写真付きPOST失敗: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`写真付きPOSTエラー: ${error.message}`, 'error');
            }
        }

        async function testGetFallback() {
            const url = getGasUrl();
            if (!url) return;

            log('GETフォールバックテストを開始...');
            
            const testData = {
                action: 'updateMeterReadings',
                propertyId: 'TEST_PROPERTY_GET',
                roomId: 'TEST_ROOM_GET',
                readings: [
                    {
                        date: '2025-06-06',
                        currentReading: '9999',
                        photoData: null
                    }
                ]
            };
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: testData.propertyId,
                roomId: testData.roomId,
                readings: JSON.stringify(testData.readings)
            });
            
            const getUrl = `${url}?${params}`;
            log(`GET URL長: ${getUrl.length} 文字`);
            
            try {
                const response = await fetch(getUrl, {
                    method: 'GET'
                });
                
                log(`GET Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('GETレスポンス: ' + JSON.stringify(data, null, 2), 'success');
                    document.getElementById('getResults').innerHTML = '<div class="container success">✅ GETフォールバック成功</div>';
                } else {
                    const errorText = await response.text();
                    log(`GET失敗: ${errorText}`, 'error');
                    document.getElementById('getResults').innerHTML = '<div class="container error">❌ GETフォールバック失敗</div>';
                }
            } catch (error) {
                log(`GETエラー: ${error.message}`, 'error');
                document.getElementById('getResults').innerHTML = '<div class="container error">❌ GETエラー: ' + error.message + '</div>';
            }
        }

        async function testLongUrlGet() {
            const url = getGasUrl();
            if (!url) return;

            log('長いURL GETテストを開始...');
            
            // 長いデータを生成
            const longReadings = [];
            for (let i = 0; i < 50; i++) {
                longReadings.push({
                    date: `2025-06-${String(i + 1).padStart(2, '0')}`,
                    currentReading: `${1000 + i}`,
                    photoData: null
                });
            }
            
            const params = new URLSearchParams({
                action: 'updateMeterReadings',
                propertyId: 'LONG_TEST_PROPERTY',
                roomId: 'LONG_TEST_ROOM',
                readings: JSON.stringify(longReadings)
            });
            
            const getUrl = `${url}?${params}`;
            log(`長いURL長: ${getUrl.length} 文字`);
            
            if (getUrl.length > 8000) {
                log('URL長が8000文字を超えています - 制限テスト', 'warning');
            }
            
            try {
                const response = await fetch(getUrl, {
                    method: 'GET'
                });
                
                log(`長いGET Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('長いGETレスポンス: ' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorText = await response.text();
                    log(`長いGET失敗: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`長いGETエラー: ${error.message}`, 'error');
            }
        }

        // ページ読み込み時の初期化
        window.onload = function() {
            const savedUrl = sessionStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                document.getElementById('gasUrl').value = savedUrl;
                log(`保存されたURL: ${savedUrl}`, 'info');
            }
            
            log('CORS診断ツール準備完了', 'success');
            log('Google Apps Script WebアプリURLを入力して、各テストを実行してください。', 'info');
        };
    </script>
</body>
</html>
