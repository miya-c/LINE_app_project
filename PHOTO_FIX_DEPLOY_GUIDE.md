# 写真保存機能修正 - デプロイと確認手順

## 修正内容サマリー

### 1. バックエンド改善（物件.gs）
- ✅ `savePhotoToGoogleDrive`関数の包括的な改善
- ✅ 入力パラメータの詳細検証（Base64形式、ファイルサイズ制限）
- ✅ 10MBファイルサイズ制限の実装
- ✅ Google Driveフォルダ管理の強化
- ✅ 複数画像形式サポート（JPEG、PNG、WebP）
- ✅ ファイル名の特殊文字サニタイゼーション
- ✅ ファイル共有権限の設定
- ✅ 詳細ログとエラー処理
- ✅ 構文エラーの修正

### 2. フロントエンド改善（meter_reading.html）
- ✅ クライアント側ファイルサイズ検証（10MB制限）
- ✅ ファイル形式検証（JPEG、PNG、WebP）
- ✅ Base64データサイズ検証
- ✅ Base64データ形式検証
- ✅ 強化されたエラーハンドリング
- ✅ ブラウザAPI互換性チェック
- ✅ タイムアウト処理

### 3. テスト環境
- ✅ `photo_test.html` - 独立したテストページ作成

## デプロイ手順

### Step 1: Google Apps Scriptの更新
1. Google Apps Script エディタ（script.google.com）にアクセス
2. プロジェクトを開く
3. `物件.gs`ファイルの内容を更新されたコードで置き換え
4. **保存** (Ctrl+S)
5. **デプロイ** → **新しいデプロイ**
6. 実行可能ファイル名を変更（例：`v2.1_photo_fix`）
7. **デプロイ**ボタンをクリック
8. **新しいURL**をコピーして保存

### Step 2: HTMLファイルの更新
1. `meter_reading.html`が最新バージョンであることを確認
2. 必要に応じてWebサーバーにアップロード

### Step 3: 権限の確認
以下の権限がGoogle Apps Scriptプロジェクトで有効になっていることを確認：
- Google Drive API
- Google Sheets API
- 外部URLへのアクセス権限

## テスト手順

### Phase 1: 基本機能テスト（photo_test.html使用）
1. `photo_test.html`をブラウザで開く
2. 新しいGoogle Apps Script URLを入力
3. テスト用の物件ID、部屋IDを設定
4. 小さな画像ファイル（例：100KB）をアップロード
5. 結果を確認

### Phase 2: 制限値テスト
1. 10MB以上のファイルをアップロード（制限エラーの確認）
2. サポートされていない形式（例：GIF、BMP）をアップロード
3. 破損した画像ファイルをアップロード

### Phase 3: 実環境テスト（meter_reading.html）
1. 物件選択ページから実際の物件を選択
2. 部屋を選択
3. 検針データ入力ページで写真を追加
4. 検針データとともに写真を保存
5. Google Driveで保存されたファイルを確認

## 確認ポイント

### ✅ 成功の指標
- 写真ファイルがGoogle Driveの`WaterMeterReadingPhotos`フォルダに保存される
- ファイル名が適切にフォーマットされている（例：`meter_PROP001_ROOM001_20250606_20250606123456789.jpg`）
- スプレッドシートの写真URL列にGoogle DriveのURLが記録される
- エラーログにエラーが記録されない

### ❌ 失敗の指標
- 写真アップロード時にエラーメッセージが表示される
- Google Driveにファイルが保存されない
- スプレッドシートに写真URLが記録されない
- ブラウザコンソールにエラーが表示される

## トラブルシューティング

### 問題: 「権限が不足しています」エラー
**解決策:**
1. Google Apps Script の実行権限を確認
2. Google Drive APIが有効になっているか確認
3. 必要に応じてOAuth同意画面を再設定

### 問題: 「フォルダが作成できません」エラー
**解決策:**
1. Google Driveのストレージ容量を確認
2. 手動で`WaterMeterReadingPhotos`フォルダを作成
3. フォルダの共有設定を確認

### 問題: 写真が表示されない
**解決策:**
1. ファイル共有設定を確認（`ANYONE_WITH_LINK`、`VIEW`権限）
2. Google DriveのURLが正しく生成されているか確認
3. ファイルが実際にアップロードされているか確認

### 問題: ファイルサイズ制限に引っかかる
**解決策:**
1. 画像を圧縮してサイズを削減
2. 必要に応じて制限値を調整（現在：10MB）
3. より効率的な画像形式（WebP）の使用を推奨

## ログの確認方法

### Google Apps Script ログ
1. Google Apps Script エディタで**実行トランスクリプト**を確認
2. `console.log`の出力を確認
3. エラーの詳細とスタックトレースを確認

### ブラウザ コンソール ログ
1. ブラウザの開発者ツール（F12）を開く
2. **Console**タブでエラーメッセージを確認
3. **Network**タブでHTTPリクエスト/レスポンスを確認

## バックアップ計画
修正前のファイルは以下に保管されています：
- `物件.gs` - 修正前バージョンをGitで管理
- `meter_reading.html` - 修正前バージョンをGitで管理

問題が発生した場合は、これらのバックアップから復元できます。

---

**注意事項:**
- Google Apps Scriptのデプロイには数分かかる場合があります
- テストは段階的に実施し、問題を早期発見してください
- 本番環境での テスト前に、必ずテスト用データで動作確認を行ってください
