<!DOCTYPE html>
<html lang="ja">
<head>
  <title>æ¤œé‡æƒ…å ± - æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒª (GASç‰ˆ)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA ãƒ¡ã‚¿ã‚¿ã‚° -->
  <meta name="description" content="æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®èª­ã¿å–ã‚Šã‚’ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š">
  <meta name="msapplication-TileColor" content="#007bff">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  
  <!-- Inlined CSS Styles -->
  <style>
/* Meter Reading Application Styles */
:root {
  --mantine-color-blue-6: #228be6;
  --mantine-color-blue-7: #1c7ed6;
  --mantine-color-blue-8: #1971c2;
  --mantine-color-blue-light: #e7f5ff;
  --mantine-color-gray-0: #f8f9fa;
  --mantine-color-gray-1: #f1f3f4;
  --mantine-color-gray-2: #e9ecef;
  --mantine-color-gray-3: #dee2e6;
  --mantine-color-gray-6: #868e96;
  --mantine-color-gray-7: #495057;
  --mantine-color-gray-8: #343a40;
  --mantine-color-red-6: #fa5252;
  --mantine-color-red-light: #fff5f5;
  --mantine-color-green-6: #40c057;
  --mantine-color-green-light: #ebfbee;
  --mantine-radius-xs: 2px;
  --mantine-radius-sm: 4px;
  --mantine-radius-md: 8px;
  --mantine-spacing-xs: 10px;
  --mantine-spacing-sm: 12px;
  --mantine-spacing-md: 16px;
  --mantine-spacing-lg: 20px;
  --mantine-spacing-xl: 32px;
  --app-bg-color: #f0f4f8;
  --header-bg-color: #007bff;
  --header-text-color: #ffffff;
  --card-bg-color: #ffffff;
  --primary-text-color: #333333;
  --secondary-text-color: #555555;
  --accent-color: #007bff;
  --border-color: #dddddd;
  --font-family-sans-serif: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  line-height: 1.55;
  color: var(--mantine-color-gray-7);
  background-color: var(--app-bg-color);
  font-size: 24px;
}

#root {
  min-height: 100vh;
  background-color: var(--app-bg-color);
}

.mantine-container {
  min-height: 100vh;
  padding: var(--mantine-spacing-lg);
  max-width: 900px;
  margin: 0 auto;
}

.mantine-stack {
  display: flex;
  flex-direction: column;
  gap: var(--mantine-spacing-xl);
}

@media (max-width: 768px) {
  .mantine-stack {
    gap: 8px;
  }
}

.mantine-stack.center {
  align-items: center;
  text-align: center;
}

.mantine-title {
  font-size: 3.2rem;
  font-weight: 700;
  margin: 0;
  color: var(--mantine-color-gray-8);
}

.mantine-subtitle {
  font-size: clamp(1.6rem, 4vw, 2.2rem);
  font-weight: 600;
  margin: 0;
  color: var(--mantine-color-gray-7);
}

.mantine-text {
  font-size: 1.3rem;
  color: var(--mantine-color-gray-6);
  margin: 0;
  line-height: 1.6;
}

.mantine-text.center {
  text-align: center;
}

.mantine-text.weight-600 {
  font-weight: 600;
}

.mantine-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--mantine-spacing-xs);
  padding: 20px 28px;
  border-radius: var(--mantine-radius-sm);
  border: 1px solid transparent;
  font-size: 1.2rem;
  font-weight: 600;
  line-height: 1;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
  min-height: 48px;
}

.mantine-button.variant-filled {
  background-color: var(--mantine-color-blue-6);
  color: white;
}

.mantine-button.variant-filled:hover {
  background-color: var(--mantine-color-blue-7);
}

.mantine-button.variant-outline {
  background-color: transparent;
  border: 1px solid var(--mantine-color-gray-3);
  color: var(--mantine-color-gray-7);
}

.mantine-button.variant-outline:hover {
  background-color: var(--mantine-color-gray-1);
}

.mantine-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.mantine-paper {
  background-color: white;
  border: 1px solid var(--mantine-color-gray-2);
  border-radius: var(--mantine-radius-md);
  padding: var(--mantine-spacing-md);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
}

.mantine-loader {
  width: 48px;
  height: 48px;
  border: 3px solid var(--mantine-color-gray-2);
  border-top: 3px solid var(--mantine-color-blue-6);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.mantine-alert {
  padding: var(--mantine-spacing-md);
  border-radius: var(--mantine-radius-sm);
  border-left: 4px solid var(--mantine-color-red-6);
  background-color: var(--mantine-color-red-light);
  color: var(--mantine-color-gray-7);
}

.mantine-alert.info {
  border-left-color: var(--mantine-color-blue-6);
  background-color: var(--mantine-color-blue-light);
}

.mantine-center {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--mantine-spacing-xl);
}

.usage-highlight { 
  background-color: var(--mantine-color-blue-light);
  padding: 2px 4px; 
  border-radius: 3px; 
  color: var(--mantine-color-blue-7);
  font-weight: bold; 
}

.mantine-table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--mantine-color-gray-3);
}

.mantine-table th,
.mantine-table td {
  border: 1px solid var(--mantine-color-gray-3);
  padding: 20px;
  text-align: left;
  font-size: 1.2rem;
}

.mantine-table th {
  background-color: var(--mantine-color-gray-1);
  font-weight: 600;
  color: var(--mantine-color-gray-7);
}

.mantine-table tbody tr:hover {
  background-color: var(--mantine-color-gray-0);
}

.mantine-input {
  width: 100%;
  padding: 20px;
  border: 1px solid var(--mantine-color-gray-3);
  border-radius: var(--mantine-radius-sm);
  font-size: 1.4rem;
  transition: border-color 0.15s ease;
  min-height: 60px;
}

.mantine-input:focus {
  outline: none;
  border-color: var(--mantine-color-blue-6);
  box-shadow: 0 0 0 2px var(--mantine-color-blue-light);
}

.inline-error {
  color: var(--mantine-color-red-6);
  font-size: 0.85em;
  margin-top: 4px;
}

@keyframes fadeInScale {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
@media (max-width: 768px) {
  body {
    font-size: 20px;
    padding-left: 0;
    padding-right: 0;
    margin-left: 0;
    margin-right: 0;
  }
  
  .mantine-container {
    padding: 0;
    max-width: 100%;
    margin-left: 0;
    margin-right: 0;
  }

  .mantine-title {
    font-size: 2.2rem;
  }

  .app-header {
    background-color: var(--header-bg-color);
    color: var(--header-text-color);
    padding: 12px 16px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .back-button {
    background-color: transparent;
    border: none;
    color: var(--header-text-color);
    font-size: 28px;
    cursor: pointer;
    position: absolute;
    left: 16px;
  }

  .header-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: bold;
  }

  .content-area {
    padding-top: 60px;
    padding-left: 0;
    padding-right: 0;
    padding-bottom: 24px;
    margin-left: 0;
    margin-right: 0;
  }

  .property-info-card {
    background-color: var(--accent-color);
    color: var(--header-text-color);
    padding: 5px 8px;
    margin-bottom: 8px;
    margin-left: 0;
    margin-right: 0;
    border-radius: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .property-name {
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    font-weight: bold;
    margin: 0 0 10px 0;
  }

  .room-info {
    font-size: clamp(1.3rem, 4vw, 2.0rem);
    font-weight: bold;
    margin: 0;
  }

  .mantine-paper.reading-history-container {
    padding: 8px;
    margin: 0;
    background-color: transparent;
    box-shadow: none;
    border: none;
  }

  .mantine-table {
    border: none;
    border-collapse: separate;
    border-spacing: 0;
  }

  .mantine-table thead {
    display: none;
  }
  
  .mantine-table tbody {
    display: block;
    width: 100%;
  }

  .mantine-table tr {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas: 
      "date date"
      "reading history"
      "usage history"
      "status .";
    gap: 8px;
    margin-bottom: 2em;
    margin-left: 0;
    margin-right: 0;
    border: 1px solid var(--mantine-color-gray-3);
    border-radius: 0;
    background-color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    padding: 8px;
  }

  .mantine-table td[data-label="æ¤œé‡æ—¥æ™‚"] {
    grid-area: date;
    text-align: center;
    font-weight: bold;
    background-color: #f8f9fa;
    margin: -8px -8px 0 -8px;
    padding: 16px 8px;
    border-radius: 0;
    border-bottom: 1px solid var(--mantine-color-gray-2);
    margin-bottom: 0;
  }

  .mantine-table td[data-label="ä»Šå›æŒ‡ç¤ºæ•°(ã¥)"] {
    grid-area: reading;
    border-right: 1px solid var(--mantine-color-gray-2);
    padding-right: 2px;
  }

  .mantine-table td[data-label="ä»Šå›ä½¿ç”¨é‡"] {
    grid-area: usage;
    background-color: #e3f2fd;
    padding: 6px 8px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 3rem;
    line-height: 1.1;
    border-right: 1px solid var(--mantine-color-gray-2);
    margin: 0;
    border-bottom: none;
  }

  .mantine-table td[data-label="çŠ¶æ…‹"] {
    grid-area: status;
    border-right: 1px solid var(--mantine-color-gray-2);
    padding-right: 2px;
    padding-top: 8px;
  }

  .mantine-table td[data-label="å‰å›å±¥æ­´"] {
    grid-area: history;
    padding-left: 2px;
    font-size: 1.1rem;
    line-height: 1.4;
    align-self: stretch;
    min-height: 120px;
    border-left: 1px solid var(--mantine-color-gray-2);
  }

  .mantine-table td {
    display: block;
    padding: 8px 0;
    border: none;
    background-color: transparent;
    font-size: 1.2rem;
    line-height: 1.5;
    border-bottom: none;
    margin-bottom: 0;
  }

  .mantine-table td::before {
    content: attr(data-label) ": ";
    font-weight: bold;
    color: var(--mantine-color-gray-7);
    display: block;
    margin-bottom: 6px;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .mantine-table td[data-label="æ¤œé‡æ—¥æ™‚"]::before {
    display: none;
  }

  .fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1001;
  }

  .fab-button {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    font-size: 28px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

.desktop-only {
  display: block;
}

@media (max-width: 768px) {
  .desktop-only {
    display: none !important;
  }
}
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ï¼ˆæœ¬ç•ªç”¨ï¼‰
    window.gasPropertyId = '<?= propertyId ?>';
    window.gasPropertyName = '<?= propertyName ?>';
    window.gasRoomId = '<?= roomId ?>';
    window.gasRoomName = '<?= roomName ?>';
    // Use server-side JSON stringification (GAS template)
    window.gasMeterReadings = /* <?!= JSON.stringify(meterReadings) ?> */ [];

    console.log('GAS Template Data:');
    console.log('Property ID:', window.gasPropertyId);
    console.log('Property Name:', window.gasPropertyName);
    console.log('Room ID:', window.gasRoomId);
    console.log('Room Name:', window.gasRoomName);
    console.log('Meter Readings:', window.gasMeterReadings);

    // å®Ÿè¡Œç’°å¢ƒã‚’åˆ¤å®š
    const isWebApp = () => {
      return !window.google?.script?.run;
    };

    const callGasFunction = (functionName, ...args) => {
      if (isWebApp()) {
        // Web Appç’°å¢ƒã§ã¯åˆ¶é™ï¼ˆä»Šå¾Œæ‹¡å¼µå¯èƒ½ï¼‰
        return Promise.reject(new Error(`Web Appç’°å¢ƒã§ã¯ ${functionName} é–¢æ•°ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™`));
      }
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    };

    // ===================================
    // Utility Functions
    // ===================================
    
    const formatDateForDisplay = (rawDate) => {
      if (!rawDate) return null;
      
      try {
        if (rawDate instanceof Date && !isNaN(rawDate.getTime())) {
          console.log('[formatDateForDisplay] Dateå‹ã‚’å‡¦ç†:', rawDate);
          const year = rawDate.getFullYear();
          const month = rawDate.getMonth() + 1;
          const day = rawDate.getDate();
          console.log(`[formatDateForDisplay] Dateå‹ã‹ã‚‰æŠ½å‡º: ${year}å¹´${month}æœˆ${day}æ—¥`);
          return `${month}æœˆ${day}æ—¥`;
        }
        
        let dateStr = String(rawDate).trim();
        console.log('[formatDateForDisplay] æ–‡å­—åˆ—ã‚’å‡¦ç†:', dateStr);
        
        const match = dateStr.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
        if (match) {
          const [, year, month, day] = match;
          const result = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
          console.log(`[formatDateForDisplay] æ–‡å­—åˆ—ã‹ã‚‰æŠ½å‡º: ${result}`);
          return result;
        }
        
        const dateObj = new Date(dateStr);
        if (!isNaN(dateObj.getTime())) {
          const month = dateObj.getMonth() + 1;
          const day = dateObj.getDate();
          console.log(`[formatDateForDisplay] Dateå¤‰æ›æˆåŠŸ: ${month}æœˆ${day}æ—¥`);
          return `${month}æœˆ${day}æ—¥`;
        }
        
        console.warn('[formatDateForDisplay] è§£æã§ããªã„æ—¥ä»˜å½¢å¼:', rawDate);
        return null;
      } catch (error) {
        console.warn('[formatDateForDisplay] æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', rawDate, error);
        return null;
      }
    };
    
    const formatInspectionStatus = (rawDate) => {
      const formattedDate = formatDateForDisplay(rawDate);
      return formattedDate ? 
        { status: 'æ¤œé‡æ¸ˆã¿', displayDate: formattedDate } : 
        { status: 'æœªæ¤œé‡', displayDate: null };
    };
    
    const calculateUsage = (currentReading, previousReading) => {
      const current = parseFloat(currentReading);
      const previous = parseFloat(previousReading);
      
      if (isNaN(current)) return '';
      
      if (!previousReading || previousReading === '' || previous === 0 || isNaN(previous)) {
        return current.toString();
      }
      
      const usage = current - previous;
      return (usage >= 0 ? usage : 0).toString();
    };

    const calculateUsageDisplay = calculateUsage;
    
    const getCurrentJSTDateString = () => {
      const now = new Date();
      const jstOffset = 9 * 60;
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const jstTime = new Date(utc + (jstOffset * 60000));
      
      const year = jstTime.getFullYear();
      const month = String(jstTime.getMonth() + 1).padStart(2, '0');
      const day = String(jstTime.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    };
    
    const formatReading = (value) => {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      return String(value).trim();
    };
    
    const formatUsage = (value) => {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      const numValue = parseFloat(value);
      if (isNaN(numValue)) {
        return '';
      }
      return numValue.toString();
    };
    
    const formatStatus = (value) => {
      if (!value || value === '' || value === 'æœªå…¥åŠ›' || value === null || value === undefined) {
        return 'æ­£å¸¸';
      }
      return String(value).trim();
    };

    // ===================================
    // Application State
    // ===================================
    
    let appState = {
      loading: true,
      error: null,
      propertyId: '',
      propertyName: '',
      roomId: '',
      roomName: '',
      meterReadings: [],
      debugInfo: null,
      updating: false,
      usageStates: {},
      toastMessage: '',
      showToast: false,
      inputErrors: {},
      isNavigating: false,
      navigationMessage: ''
    };

    // ===================================
    // UI Rendering Functions
    // ===================================
    
    const renderLoadingOverlay = (message) => {
      return `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.95);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 50000;
        ">
          <div style="
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
          "></div>
          <p style="
            margin-top: 16px;
            color: #666;
            font-size: 14px;
            text-align: center;
          ">
            ${message}
          </p>
        </div>
      `;
    };

    const renderHeader = () => {
      return `
        <div class="app-header">
          <button onclick="handleBackButton()" class="back-button" aria-label="æˆ»ã‚‹">
            &lt;
          </button>
          <h1 class="header-title">æ¤œé‡æƒ…å ±</h1>
        </div>
      `;
    };

    const renderPropertyInfo = () => {
      return `
        <div class="property-info-card">
          <h2 class="property-name">${appState.propertyName}</h2>
          <p class="room-info">éƒ¨å±‹: ${appState.roomName}</p>
        </div>
      `;
    };

    const getPreviousReadingsText = (reading) => {
      let parts = [];
      if (reading.previousReading && reading.previousReading !== 'N/A') {
        let text = `å‰å›: ${reading.previousReading}`;
        if (reading.previousPreviousReading && reading.previousPreviousReading !== 'N/A') {
          const prev = parseFloat(reading.previousReading);
          const prevPrev = parseFloat(reading.previousPreviousReading);
          if (!isNaN(prev) && !isNaN(prevPrev)) {
            const diff = prev - prevPrev;
            text += ` [${diff >= 0 ? '+' : ''}${diff}]`;
          }
        }
        parts.push(text);
      }
      if (reading.previousPreviousReading && reading.previousPreviousReading !== 'N/A') {
        let text = `å‰ã€…å›: ${reading.previousPreviousReading}`;
        if (reading.threeTimesPrevious && reading.threeTimesPrevious !== 'N/A') {
          const prevPrev = parseFloat(reading.previousPreviousReading);
          const prevPrevPrev = parseFloat(reading.threeTimesPrevious);
          if (!isNaN(prevPrev) && !isNaN(prevPrevPrev)) {
            const diff = prevPrev - prevPrevPrev;
            text += ` [${diff >= 0 ? '+' : ''}${diff}]`;
          }
        }
        parts.push(text);
      }
      if (reading.threeTimesPrevious && reading.threeTimesPrevious !== 'N/A') {
        parts.push(`å‰ã€…ã€…å›: ${reading.threeTimesPrevious}`);
      }
      return parts;
    };

    const renderMeterReadingTable = () => {
      if (!Array.isArray(appState.meterReadings) || appState.meterReadings.length === 0) {
        return `
          <div class="mantine-stack">
            <div class="mantine-alert info">
              <h3 class="mantine-text weight-600">åˆå›æ¤œé‡</h3>
              <p class="mantine-text">
                ã“ã®éƒ¨å±‹ã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æœ€åˆã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br/>
                <strong>åˆå›æ¤œé‡ã§ã¯ã€å…¥åŠ›ã•ã‚ŒãŸæŒ‡ç¤ºæ•°ãŒãã®ã¾ã¾ä»Šæœˆã®ä½¿ç”¨é‡ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</strong>
              </p>
            </div>
            <div class="mantine-paper" style="margin-top: var(--mantine-spacing-md); padding: var(--mantine-spacing-md);">
              <h4 class="mantine-subtitle" style="margin-bottom: var(--mantine-spacing-sm);">åˆå›ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h4>
              <div class="mantine-stack" style="gap: var(--mantine-spacing-lg);">
                <div>
                  <label for="initialReadingDate" class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">æ¤œé‡æ—¥:</label>
                  <input 
                    type="text" 
                    id="initialReadingDate" 
                    value="æœªæ¤œé‡" 
                    readonly 
                    class="mantine-input" 
                    style="font-size: 1rem; padding: 10px;" 
                  />
                </div>
                <div>
                  <label for="initialReadingValue" class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">ä»Šå›æŒ‡ç¤ºæ•°(ã¥):</label>
                  <input
                    type="number"
                    id="initialReadingValue"
                    class="mantine-input"
                    placeholder="æŒ‡ç¤ºæ•°å…¥åŠ›"
                    min="0"
                    step="any"
                    style="font-size: 1rem; padding: 10px;"
                    data-date="" 
                    data-original-value=""
                    data-previous-reading=""
                    onchange="handleInputChange(this, '')"
                  />
                  <div id="error-" style="color: var(--mantine-color-red-6); font-size: 0.9em; margin-top: 4px;"></div>
                </div>
                <div>
                  <label class="mantine-text weight-600" style="font-size: 0.9rem; margin-bottom: 4px; display: block;">ä»Šå›ä½¿ç”¨é‡:</label>
                  <div id="usage-display" style="
                    background-color: #e3f2fd;
                    border: 1px solid var(--mantine-color-gray-3);
                    border-radius: var(--mantine-radius-sm);
                    padding: 10px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: var(--mantine-color-blue-7);
                    min-height: 44px;
                    display: flex;
                    align-items: center;
                  ">-</div>
                  <div style="font-size: 0.85em; color: var(--mantine-color-gray-6); margin-top: 4px;">
                    â€»åˆå›æ¤œé‡ã§ã¯ã€æŒ‡ç¤ºæ•°ãŒãã®ã¾ã¾ä½¿ç”¨é‡ã«ãªã‚Šã¾ã™
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      let tableRows = '';
      appState.meterReadings.forEach((reading, index) => {
        const formattedDate = formatDateForDisplay(reading.date);
        const inspectionStatus = formatInspectionStatus(reading.date);
        const dateForDataAttribute = reading.date;
        const currentReadingDisplay = formatReading(reading.currentReading);
        
        const usageToDisplay = appState.usageStates[dateForDataAttribute] !== undefined 
                            ? appState.usageStates[dateForDataAttribute]
                            : calculateUsageDisplay(reading.currentReading, reading.previousReading);
        
        const usageDisplayString = `${usageToDisplay}${usageToDisplay !== '-' ? 'ã¥' : ''}`;
        const statusDisplay = formatStatus(reading.status);
        const previousReadingsInfo = getPreviousReadingsText(reading);

        const previousReadingsHtml = previousReadingsInfo && previousReadingsInfo.length > 0 ? 
          previousReadingsInfo.map(info => `<div class="previous-reading-text">${info}</div>`).join('') :
          '<div>-</div>';
        
        tableRows += `
          <tr>
            <td data-label="æ¤œé‡æ—¥æ™‚">
              <span style="
                color: ${inspectionStatus.status === 'æœªæ¤œé‡' ? 'var(--mantine-color-red-6)' : 'inherit'};
                font-weight: ${inspectionStatus.status === 'æœªæ¤œé‡' ? 'bold' : 'normal'};
              ">
                æœ€çµ‚æ¤œé‡æ—¥: ${inspectionStatus.status === 'æœªæ¤œé‡' ? 'æœªæ¤œé‡' : inspectionStatus.displayDate}
              </span>
            </td>
            <td data-label="ä»Šå›æŒ‡ç¤ºæ•°(ã¥)">
              <input 
                type="number" 
                step="any" 
                value="${currentReadingDisplay}" 
                placeholder="æŒ‡ç¤ºæ•°å…¥åŠ›" 
                min="0" 
                data-date="${dateForDataAttribute}" 
                data-original-value="${formatReading(reading.currentReading)}" 
                data-previous-reading="${formatReading(reading.previousReading)}" 
                class="mantine-input" 
                onchange="handleInputChange(this, '${dateForDataAttribute}')"
              />
              <div id="error-${dateForDataAttribute}" style="color: var(--mantine-color-red-6); font-size: 0.9em; margin-top: 4px;"></div>
            </td>
            <td data-label="ä»Šå›ä½¿ç”¨é‡">
              ${usageDisplayString}
            </td>
            <td data-label="çŠ¶æ…‹">
              <span style=" 
                display: inline-block; 
                padding: 3px 9px; 
                font-size: 0.9em; 
                font-weight: 500; 
                background-color: ${statusDisplay === 'N/A' ? 'var(--mantine-color-gray-2)' : 'var(--mantine-color-blue-light)'}; 
                color: ${statusDisplay === 'N/A' ? 'var(--mantine-color-gray-7)' : 'var(--mantine-color-blue-8)'}; 
                border-radius: var(--mantine-radius-sm); 
              ">
                ${statusDisplay}
              </span>
            </td>
            <td data-label="å‰å›å±¥æ­´">
              <div style="line-height: 1.6;">
                ${previousReadingsHtml}
              </div>
            </td>
          </tr>
        `;
      });

      return `
        <table class="mantine-table">
          <thead style="display: none;">
            <tr>
              <th>æ¤œé‡æ—¥æ™‚</th>
              <th>ä»Šå›æŒ‡ç¤ºæ•°(ã¥)</th>
              <th>ä»Šå›ä½¿ç”¨é‡</th>
              <th>çŠ¶æ…‹</th>
              <th>å‰å›å±¥æ­´</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      `;
    };

    const renderFAB = () => {
      if (appState.loading || appState.error) return '';
      
      return `
        <div class="fab-container">
          <button
            class="fab-button mantine-button variant-filled"
            onclick="handleUpdateReadings()"
            ${appState.updating || appState.isNavigating ? 'disabled' : ''}
            title="${Array.isArray(appState.meterReadings) && appState.meterReadings.length > 0 ? 'æŒ‡ç¤ºæ•°ã‚’æ›´æ–°' : 'åˆå›æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜'}"
          >
            ${appState.updating ? '<div class="mantine-loader" style="width: 32px; height: 32px; border-top-color: white;"></div>' : 'ğŸ’¾'}
          </button>
        </div>
      `;
    };

    const renderToast = () => {
      if (!appState.showToast) return '';
      
      return `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.6);
          z-index: 2000;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            background-color: var(--mantine-color-blue-6);
            color: white;
            padding: 24px 32px;
            border-radius: var(--mantine-radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            min-width: 240px;
            animation: fadeInScale 0.3s ease-out;
          ">
            ${appState.toastMessage}
          </div>
        </div>
      `;
    };

    const renderApp = () => {
      let content = '';

      if (appState.isNavigating) {
        content += renderLoadingOverlay(appState.navigationMessage);
      }

      content += renderHeader();

      if (appState.loading) {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack center">
              <div class="mantine-loader"></div>
              <p class="mantine-text">æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
          </div>
        `;
      } else if (appState.error) {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack">
              <div class="mantine-alert">
                <h3 class="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p class="mantine-text">${appState.error}</p>
              </div>
            </div>
          </div>
        `;
      } else {
        content += `
          <div class="content-area mantine-container">
            <div class="mantine-stack">
              ${renderPropertyInfo()}
              <div class="mantine-paper reading-history-container" style="padding: var(--mantine-spacing-xs); margin: 0;">
                <h3 class="mantine-subtitle desktop-only" style="text-align: center; margin-bottom: var(--mantine-spacing-md);">æ¤œé‡å±¥æ­´</h3>
                ${renderMeterReadingTable()}
              </div>
            </div>
          </div>
        `;
      }

      content += renderFAB();
      content += renderToast();

      document.getElementById('root').innerHTML = content;
    };

    // ===================================
    // Event Handlers
    // ===================================
    
    const handleInputChange = (inputElement, dateForDataAttribute) => {
      const currentValue = inputElement.value;
      const originalValue = inputElement.getAttribute('data-original-value') || '';
      const previousValue = inputElement.getAttribute('data-previous-reading') || '';
      const numericValue = parseFloat(currentValue);
      
      const errorElement = document.getElementById(`error-${dateForDataAttribute}`);
      
      if (originalValue === '' && currentValue.trim() === '') {
        inputElement.style.borderColor = 'var(--mantine-color-red-6)';
        appState.inputErrors[dateForDataAttribute] = 'åˆå›æ¤œé‡ã§ã¯æŒ‡ç¤ºæ•°ã®å…¥åŠ›ãŒå¿…é ˆã§ã™ã€‚';
        if (errorElement) errorElement.textContent = appState.inputErrors[dateForDataAttribute];
        appState.usageStates[dateForDataAttribute] = '-';
      } else if (currentValue && (isNaN(numericValue) || numericValue < 0)) {
        inputElement.style.borderColor = 'var(--mantine-color-red-6)';
        appState.inputErrors[dateForDataAttribute] = 'æŒ‡ç¤ºæ•°ã¯0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        if (errorElement) errorElement.textContent = appState.inputErrors[dateForDataAttribute];
        appState.usageStates[dateForDataAttribute] = '-';
      } else {
        inputElement.style.borderColor = '';
        appState.inputErrors[dateForDataAttribute] = '';
        if (errorElement) errorElement.textContent = '';
        appState.usageStates[dateForDataAttribute] = calculateUsageDisplay(currentValue, previousValue);
      }

      // Update usage display for initial reading
      if (dateForDataAttribute === '') {
        const usageDisplay = document.getElementById('usage-display');
        if (usageDisplay) {
          const usage = appState.usageStates[dateForDataAttribute];
          usageDisplay.textContent = usage !== '-' ? `${usage}ã¥` : '-';
        }
      } else {
        // Update existing reading usage display
        renderApp();
      }
    };

    const displayToast = (message) => {
      appState.toastMessage = message;
      appState.showToast = true;
      renderApp();
      setTimeout(() => {
        appState.showToast = false;
        appState.toastMessage = '';
        renderApp();
      }, 3000);
    };

    const handleBackButton = async () => {
      try {
        appState.isNavigating = true;
        appState.navigationMessage = 'ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...';
        renderApp();
        
        if (isWebApp()) {
          // âœ… Web Appç’°å¢ƒ: éƒ¨å±‹é¸æŠãƒšãƒ¼ã‚¸ã¸é·ç§»
          const baseUrl = window.location.origin + window.location.pathname;
          const roomSelectUrl = `${baseUrl}?page=room_select&propertyId=${encodeURIComponent(appState.propertyId)}&propertyName=${encodeURIComponent(appState.propertyName)}`;
          window.location.href = roomSelectUrl;
        } else {
          // GASç’°å¢ƒ: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
          await callGasFunction('openRoomSelectDialog', appState.propertyId, appState.propertyName);
        }
        
      } catch (error) {
        console.error('[meter_reading] æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        displayToast('ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      } finally {
        appState.isNavigating = false;
        renderApp();
      }
    };

    const handleUpdateReadings = async () => {
      if (!appState.propertyId || !appState.roomId) {
        displayToast('ç‰©ä»¶IDã¾ãŸã¯éƒ¨å±‹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      const numberInputs = document.querySelectorAll('input[data-date]');
      const updatedReadings = [];
      let hasValidationErrors = false;
      
      numberInputs.forEach(input => {
        const date = input.getAttribute('data-date');
        const originalValue = input.getAttribute('data-original-value') || '';
        const currentValue = input.value || '';
        
        input.style.borderColor = '';
        appState.inputErrors[date] = '';

        if (originalValue === '' && currentValue.trim() === '') {
          input.style.borderColor = 'var(--mantine-color-red-6)';
          appState.inputErrors[date] = 'åˆå›æ¤œé‡ã§ã¯æŒ‡ç¤ºæ•°ã®å…¥åŠ›ãŒå¿…é ˆã§ã™ã€‚';
          hasValidationErrors = true;
          return;
        }
        
        if (currentValue !== originalValue) {
          const numericValue = parseFloat(currentValue);
          if (currentValue && (isNaN(numericValue) || numericValue < 0)) {
            input.style.borderColor = 'var(--mantine-color-red-6)';
            appState.inputErrors[date] = 'æŒ‡ç¤ºæ•°ã¯0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            hasValidationErrors = true;
            return;
          }
          
          let inspectionDate;
          if (date && date !== '') {
            inspectionDate = date;
          } else {
            inspectionDate = currentValue && currentValue.trim() !== '' ? getCurrentJSTDateString() : '';
          }
          updatedReadings.push({
            date: inspectionDate,
            currentReading: currentValue
          });
        }
      });

      if (hasValidationErrors) {
        displayToast('å…¥åŠ›å€¤ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚å„é …ç›®ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        renderApp();
        return;
      }

      if (updatedReadings.length === 0) {
        displayToast('æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      console.log('[meter_reading] æ›´æ–°ã™ã‚‹æŒ‡ç¤ºæ•°:', updatedReadings);
      appState.updating = true;
      renderApp();
      
      try {
        const result = await callGasFunction('updateMeterReadings', appState.propertyId, appState.roomId, updatedReadings);
        console.log('[meter_reading] æ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
        
        if (result.success) {
          displayToast('æ¤œé‡ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
          appState.inputErrors = {};
          
          // Reload meter readings
          await loadMeterReadings(appState.propertyId, appState.roomId);
        } else {
          throw new Error(result.error || 'æŒ‡ç¤ºæ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (error) {
        console.error('[meter_reading] handleUpdateReadings error:', error);
        displayToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
      } finally {
        appState.updating = false;
        renderApp();
      }
    };

    // ===================================
    // Data Loading Functions
    // ===================================
    
    const loadMeterReadings = async (propId, rId) => {
      try {
        console.log('[meter_reading] æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ - propertyId:', propId, 'roomId:', rId);
        
        const result = await callGasFunction('getMeterReadings', propId, rId);
        console.log('[meter_reading] Received responseObject from server:', result);
        
        if (result.error) {
          console.error('[meter_reading] Server returned an error:', result.error);
          throw new Error(result.error);
        }

        const readings = result.readings || result;
        const debugInfoData = result.debugInfo;

        if (debugInfoData) {
          console.log('[meter_reading] Server Debug Info:', debugInfoData);
          appState.debugInfo = debugInfoData;
        }

        console.log('[meter_reading] Fetched meter readings:', readings);
        console.log('[meter_reading] Readings is array?', Array.isArray(readings));
        console.log('[meter_reading] Readings length:', readings ? readings.length : 'N/A');
        
        if (Array.isArray(readings) && readings.length > 0) {
          console.log('[meter_reading] âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ - ä»¶æ•°:', readings.length);
          console.log('[meter_reading] æœ€åˆã®ãƒ‡ãƒ¼ã‚¿:', readings[0]);
        } else if (Array.isArray(readings) && readings.length === 0) {
          console.log('[meter_reading] âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¯ç©ºé…åˆ—ï¼ˆåˆå›æ¤œé‡çŠ¶æ…‹ï¼‰');
          console.log('[meter_reading] æ¤œç´¢æ¡ä»¶ - propertyId:', propId, 'roomId:', rId);
        } else {
          console.log('[meter_reading] âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã¾ãŸã¯ç„¡åŠ¹ãªå½¢å¼');
          console.log('[meter_reading] readingsã®å‹:', typeof readings);
          console.log('[meter_reading] readingså€¤:', readings);
        }
        
        appState.meterReadings = Array.isArray(readings) ? readings : [];
        appState.loading = false;
        renderApp();
      } catch (error) {
        console.error('[meter_reading] loadMeterReadings error:', error);
        appState.error = `æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
        appState.loading = false;
        renderApp();
      }
    };

    // Web Appç’°å¢ƒã§ã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—
    const loadMeterReadingsWebApp = async (propertyId, roomId) => {
      try {
        const baseUrl = window.location.origin + window.location.pathname;
        const fetchUrl = `${baseUrl}?action=getMeterReadings&propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(roomId)}`;
        
        console.log('[meter_reading] Web Appæ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—URL:', fetchUrl);
        
        const response = await fetch(fetchUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('[meter_reading] Web Appæ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ:', result);
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        // ğŸ”¥ çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œã—ãŸå‡¦ç†
        let readings;
        if (result.success === true && Array.isArray(result.data)) {
          // æ–°ã—ã„çµ±ä¸€å½¢å¼: {success: true, data: [], count: 0}
          readings = result.data;
          console.log('[meter_reading_gas] âœ… çµ±ä¸€å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', readings.length, 'ä»¶');
        } else if (result.readings && Array.isArray(result.readings)) {
          // readings ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å½¢å¼
          readings = result.readings;
          console.log('[meter_reading_gas] âš ï¸ readingsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å½¢å¼ã‚’ä½¿ç”¨');
        } else if (Array.isArray(result)) {
          // ç›´æ¥é…åˆ—å½¢å¼
          readings = result;
          console.log('[meter_reading_gas] âš ï¸ ç›´æ¥é…åˆ—å½¢å¼ã‚’ä½¿ç”¨');
        } else if (result.result && Array.isArray(result.result)) {
          // result ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å½¢å¼
          readings = result.result;
          console.log('[meter_reading_gas] âš ï¸ ãƒ¬ã‚¬ã‚·ãƒ¼resultå½¢å¼ã‚’ä½¿ç”¨');
        } else {
          console.error('[meter_reading_gas] äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼:', result);
          console.error('[meter_reading_gas] Response keys:', Object.keys(result || {}));
          console.error('[meter_reading_gas] Response content:', result);
          throw new Error('æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        
        return readings || [];
      } catch (error) {
        console.error('[meter_reading] Web Appæ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    };

    // ===================================
    // Application Initialization
    // ===================================
    
    const initializeApp = async () => {
      try {
        console.log('[meter_reading] ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚');
        
        // Web Appç’°å¢ƒã§ã®URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
        if (isWebApp()) {
          const urlParams = new URLSearchParams(window.location.search);
          const propertyIdFromUrl = urlParams.get('propertyId');
          const propertyNameFromUrl = urlParams.get('propertyName');
          const roomIdFromUrl = urlParams.get('roomId');
          const roomNameFromUrl = urlParams.get('roomName');
          
          if (propertyIdFromUrl && propertyNameFromUrl && roomIdFromUrl && roomNameFromUrl) {
            console.log('[meter_reading] Web Appç’°å¢ƒ: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
            appState.propertyId = decodeURIComponent(propertyIdFromUrl);
            appState.propertyName = decodeURIComponent(propertyNameFromUrl);
            appState.roomId = decodeURIComponent(roomIdFromUrl);
            appState.roomName = decodeURIComponent(roomNameFromUrl);
            
            console.log('[meter_reading] URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°:');
            console.log('[meter_reading] - propertyId:', `"${appState.propertyId}"`);
            console.log('[meter_reading] - propertyName:', `"${appState.propertyName}"`);
            console.log('[meter_reading] - roomId:', `"${appState.roomId}"`);
            console.log('[meter_reading] - roomName:', `"${appState.roomName}"`);
            
            // Web Appç’°å¢ƒã§æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            try {
              const readings = await loadMeterReadingsWebApp(appState.propertyId, appState.roomId);
              appState.meterReadings = Array.isArray(readings) ? readings : [];
              console.log('[meter_reading] âœ… Web Appæ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ - ä»¶æ•°:', appState.meterReadings.length);
            } catch (error) {
              console.error('[meter_reading] Web Appæ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
              appState.meterReadings = [];
            }
          } else {
            console.error('[meter_reading] Web Appç’°å¢ƒ: å¿…è¦ãªURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
            appState.error = 'URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç‰©ä»¶é¸æŠç”»é¢ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
            appState.loading = false;
            renderApp();
            return;
          }
        } else {
          // GASç’°å¢ƒ: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          appState.propertyId = window.gasPropertyId || 'N/A';
          appState.propertyName = window.gasPropertyName || 'N/A';
          appState.roomId = window.gasRoomId || 'N/A';
          appState.roomName = window.gasRoomName || 'N/A';

          console.log('[meter_reading] GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿è©³ç´°:');
          console.log('[meter_reading] - propertyId:', `"${appState.propertyId}"`, 'å‹:', typeof appState.propertyId);
          console.log('[meter_reading] - propertyName:', `"${appState.propertyName}"`, 'å‹:', typeof appState.propertyName);
          console.log('[meter_reading] - roomId:', `"${appState.roomId}"`, 'å‹:', typeof appState.roomId);
          console.log('[meter_reading] - roomName:', `"${appState.roomName}"`, 'å‹:', typeof appState.roomName);

          if (!appState.propertyId || !appState.roomId || appState.propertyId === 'N/A' || appState.roomId === 'N/A') {
            console.error('[meter_reading] ç‰©ä»¶IDã¾ãŸã¯éƒ¨å±‹IDãŒGASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æ­£ã—ãå–å¾—ã§ãã¾ã›ã‚“ã€‚');
            appState.error = 'ç‰©ä»¶æƒ…å ±ã¾ãŸã¯éƒ¨å±‹æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚';
            appState.loading = false;
            renderApp();
            return;
          }

          // GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          if (window.gasMeterReadings) {
            console.log('[meter_reading] GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', window.gasMeterReadings);
            let readings;
            if (Array.isArray(window.gasMeterReadings)) {
              readings = window.gasMeterReadings;
              console.log('[meter_reading_gas] âš ï¸ GASç›´æ¥é…åˆ—å½¢å¼ã‚’ä½¿ç”¨');
            } else if (window.gasMeterReadings.success === true && Array.isArray(window.gasMeterReadings.data)) {
              readings = window.gasMeterReadings.data;
              console.log('[meter_reading_gas] âœ… GASçµ±ä¸€å½¢å¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', readings.length, 'ä»¶');
            } else if (window.gasMeterReadings.readings && Array.isArray(window.gasMeterReadings.readings)) {
              readings = window.gasMeterReadings.readings;
              console.log('[meter_reading_gas] âš ï¸ GASreadingsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å½¢å¼ã‚’ä½¿ç”¨');
            } else if (window.gasMeterReadings.result && Array.isArray(window.gasMeterReadings.result)) {
              readings = window.gasMeterReadings.result;
              console.log('[meter_reading_gas] âš ï¸ GASãƒ¬ã‚¬ã‚·ãƒ¼resultå½¢å¼ã‚’ä½¿ç”¨');
            } else {
              console.error('[meter_reading] äºˆæœŸã—ãªã„æ¤œé‡ãƒ‡ãƒ¼ã‚¿å½¢å¼:', window.gasMeterReadings);
              readings = [];
            }
            
            appState.meterReadings = readings;
            console.log('[meter_reading] âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ - ä»¶æ•°:', readings.length);
          } else {
            console.log('[meter_reading] âš ï¸ GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¤œé‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆåˆå›æ¤œé‡çŠ¶æ…‹ï¼‰');
            appState.meterReadings = [];
          }
        }
        
        appState.loading = false;
        renderApp();
        
      } catch (error) {
        console.error('[meter_reading] ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        appState.error = 'ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆæœŸåŒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        appState.loading = false;
        renderApp();
      }
    };

    // Start the application
    window.addEventListener('load', () => {
      window.scrollTo(0, 0);
      initializeApp();
    });

    // Initial render
    renderApp();
  </script>

  <!-- PWAé–¢é€£ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <link rel="stylesheet" href="/pwa-styles.css">
  <script src="/pwa-utils.js"></script>
</body>
</html>
