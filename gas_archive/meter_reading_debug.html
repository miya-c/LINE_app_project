<!DOCTYPE html>
<html lang="ja">
<head>
  <title>🔧 Meter Reading Debug Test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #007bff;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d1edff; color: #0984e3; }
    .status.error { background: #ffe0e0; color: #d63031; }
    .data-display {
      background: #2d3748;
      color: #fff;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9em;
    }
    .test-button:hover { background: #0056b3; }
    .test-button:disabled { background: #6c757d; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🔧 Meter Reading Debug Test</h1>
      <p>検針データの取得・表示問題を詳細デバッグします</p>
    </div>

    <div class="test-section">
      <h3>1. GAS WebApp URL設定</h3>
      <input type="text" id="gasUrlInput" placeholder="GAS WebApp URLを入力" 
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
             value="https://script.google.com/macros/s/AKfycbzZr2vV6oSyTYnF9z6eqz5OGKdMKVF_A2U9eYYhQNAKN8ZLcABJ41zdS8y1OBw7lVup/exec">
      <button class="test-button" onclick="setGasUrl()">URL設定</button>
      <div id="url-status"></div>
    </div>

    <div class="test-section">
      <h3>2. 検針データ取得テスト</h3>
      <p>特定の物件・部屋での検針データ取得をテストします</p>
      <div>
        <label>物件ID: <input type="text" id="propertyId" value="P000001" style="padding: 4px;"></label>
        <label style="margin-left: 10px;">部屋ID: <input type="text" id="roomId" value="R000001" style="padding: 4px;"></label>
      </div>
      <button class="test-button" onclick="testMeterReadingData()">検針データ取得テスト</button>
      <div id="meter-data-status"></div>
      <div id="meter-data-display" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>3. データ形式解析</h3>
      <p>取得したデータの形式を詳細解析します</p>
      <button class="test-button" onclick="analyzeDataFormat()">データ形式解析</button>
      <div id="analysis-status"></div>
      <div id="analysis-display" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>4. Meter Reading画面テスト</h3>
      <p>実際のmeter reading画面での表示テストを行います</p>
      <button class="test-button" onclick="openMeterReadingTest()">Meter Reading画面を開く</button>
      <button class="test-button" onclick="openMeterReadingWithDebug()">デバッグモードで開く</button>
      <div id="page-test-status"></div>
    </div>
  </div>

  <script>
    let gasWebAppUrl = '';
    let lastFetchedData = null;

    function updateStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status ${type}`;
      element.textContent = message;
    }

    function displayData(elementId, data) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.textContent = JSON.stringify(data, null, 2);
    }

    function setGasUrl() {
      const urlInput = document.getElementById('gasUrlInput');
      gasWebAppUrl = urlInput.value.trim();
      
      if (gasWebAppUrl) {
        sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
        updateStatus('url-status', 'success', `✅ URL設定完了: ${gasWebAppUrl}`);
        console.log('[Debug] GAS WebApp URL set:', gasWebAppUrl);
      } else {
        updateStatus('url-status', 'error', '❌ URLが入力されていません');
      }
    }

    async function testMeterReadingData() {
      if (!gasWebAppUrl) {
        updateStatus('meter-data-status', 'error', '❌ まずGAS WebApp URLを設定してください');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim();
      const roomId = document.getElementById('roomId').value.trim();

      if (!propertyId || !roomId) {
        updateStatus('meter-data-status', 'error', '❌ 物件IDと部屋IDを入力してください');
        return;
      }

      updateStatus('meter-data-status', 'loading', '🔄 検針データを取得中...');

      try {
        const fetchUrl = `${gasWebAppUrl}?action=getMeterReadings&propertyId=${propertyId}&roomId=${roomId}&debug=true&_t=${Date.now()}`;
        console.log('[Debug] Fetching from:', fetchUrl);

        const response = await fetch(fetchUrl);
        console.log('[Debug] Response status:', response.status);
        console.log('[Debug] Response headers:', [...response.headers.entries()]);

        const responseText = await response.text();
        console.log('[Debug] Raw response text:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('[Debug] JSON parse error:', parseError);
          throw new Error(`JSON解析エラー: ${parseError.message}\n生レスポンス: ${responseText.substring(0, 500)}`);
        }

        console.log('[Debug] Parsed JSON data:', data);
        lastFetchedData = data;

        if (response.ok) {
          updateStatus('meter-data-status', 'success', `✅ 検針データ取得成功 (HTTP ${response.status})`);
          
          const detailedInfo = {
            httpStatus: response.status,
            responseHeaders: Object.fromEntries(response.headers.entries()),
            rawResponse: responseText,
            parsedData: data,
            dataType: typeof data,
            isArray: Array.isArray(data),
            keys: typeof data === 'object' ? Object.keys(data) : null,
            fetchUrl: fetchUrl,
            timestamp: new Date().toISOString()
          };

          displayData('meter-data-display', detailedInfo);
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

      } catch (error) {
        console.error('[Debug] Error:', error);
        updateStatus('meter-data-status', 'error', `❌ エラー: ${error.message}`);
        displayData('meter-data-display', { 
          error: error.message, 
          stack: error.stack,
          url: gasWebAppUrl,
          timestamp: new Date().toISOString()
        });
      }
    }

    async function analyzeDataFormat() {
      if (!lastFetchedData) {
        updateStatus('analysis-status', 'error', '❌ まず検針データを取得してください');
        return;
      }

      updateStatus('analysis-status', 'loading', '🔄 データ形式を解析中...');

      try {
        const analysis = {
          dataType: typeof lastFetchedData,
          isArray: Array.isArray(lastFetchedData),
          keys: typeof lastFetchedData === 'object' ? Object.keys(lastFetchedData) : null,
          
          // meter_reading.htmlと同じロジックでの判定
          formatAnalysis: {
            unifiedFormat: lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data),
            readingsFormat: lastFetchedData && Array.isArray(lastFetchedData.readings),
            directArrayFormat: Array.isArray(lastFetchedData),
            unknownFormat: !(
              (lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data)) ||
              (lastFetchedData && Array.isArray(lastFetchedData.readings)) ||
              Array.isArray(lastFetchedData)
            )
          },

          // 実際のデータ抽出
          extractedReadings: null,
          extractedDebugInfo: null
        };

        // meter_reading.htmlと同じロジックでデータ抽出
        let actualDataPayload;
        if (lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data)) {
          actualDataPayload = { 
            readings: lastFetchedData.data,
            debugInfo: lastFetchedData.debugInfo || {}
          };
          analysis.selectedFormat = 'unified';
        }
        else if (lastFetchedData && Array.isArray(lastFetchedData.readings)) {
          actualDataPayload = lastFetchedData;
          analysis.selectedFormat = 'readings';
        }
        else if (Array.isArray(lastFetchedData)) {
          actualDataPayload = { 
            readings: lastFetchedData, 
            debugInfo: { directArray: true }
          };
          analysis.selectedFormat = 'directArray';
        }
        else {
          analysis.selectedFormat = 'unknown';
          analysis.error = 'すべてのパターンに該当しません';
        }

        if (actualDataPayload) {
          analysis.extractedReadings = actualDataPayload.readings;
          analysis.extractedDebugInfo = actualDataPayload.debugInfo;
          analysis.readingsCount = Array.isArray(actualDataPayload.readings) ? actualDataPayload.readings.length : 0;
        }

        analysis.originalData = lastFetchedData;

        updateStatus('analysis-status', 'success', `✅ データ形式解析完了 (形式: ${analysis.selectedFormat || 'unknown'})`);
        displayData('analysis-display', analysis);

      } catch (error) {
        console.error('[Debug] Analysis error:', error);
        updateStatus('analysis-status', 'error', `❌ 解析エラー: ${error.message}`);
        displayData('analysis-display', { error: error.message, stack: error.stack });
      }
    }

    function openMeterReadingTest() {
      if (!gasWebAppUrl) {
        updateStatus('page-test-status', 'error', '❌ まずGAS WebApp URLを設定してください');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim() || 'P000001';
      const roomId = document.getElementById('roomId').value.trim() || 'R000001';

      const testUrl = `meter_reading.html?propertyId=${propertyId}&propertyName=テスト物件&roomId=${roomId}&roomName=テスト部屋`;
      
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      updateStatus('page-test-status', 'success', '✅ Meter Reading画面を新しいタブで開きました');
      
      window.open(testUrl, '_blank');
    }

    function openMeterReadingWithDebug() {
      if (!gasWebAppUrl) {
        updateStatus('page-test-status', 'error', '❌ まずGAS WebApp URLを設定してください');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim() || 'P000001';
      const roomId = document.getElementById('roomId').value.trim() || 'R000001';

      const testUrl = `meter_reading.html?propertyId=${propertyId}&propertyName=デバッグテスト物件&roomId=${roomId}&roomName=デバッグテスト部屋&debug=true&verbose=true`;
      
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      updateStatus('page-test-status', 'success', '✅ デバッグモードでMeter Reading画面を開きました (コンソールを確認してください)');
      
      window.open(testUrl, '_blank');
    }

    // ページ読み込み時の初期設定
    window.addEventListener('load', () => {
      console.log('[Debug] Meter Reading Debug Test page loaded');
      
      // sessionStorageからURLを復元
      const savedUrl = sessionStorage.getItem('gasWebAppUrl');
      if (savedUrl) {
        document.getElementById('gasUrlInput').value = savedUrl;
        gasWebAppUrl = savedUrl;
        updateStatus('url-status', 'success', `✅ 保存されたURL: ${savedUrl}`);
      }
    });
  </script>
</body>
</html>
