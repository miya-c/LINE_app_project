<!DOCTYPE html>
<html lang="ja">
<head>
  <title>ğŸ”§ Meter Reading Debug Test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #007bff;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d1edff; color: #0984e3; }
    .status.error { background: #ffe0e0; color: #d63031; }
    .data-display {
      background: #2d3748;
      color: #fff;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9em;
    }
    .test-button:hover { background: #0056b3; }
    .test-button:disabled { background: #6c757d; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”§ Meter Reading Debug Test</h1>
      <p>æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»è¡¨ç¤ºå•é¡Œã‚’è©³ç´°ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™</p>
    </div>

    <div class="test-section">
      <h3>1. GAS WebApp URLè¨­å®š</h3>
      <input type="text" id="gasUrlInput" placeholder="GAS WebApp URLã‚’å…¥åŠ›" 
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
             value="https://script.google.com/macros/s/AKfycbzZr2vV6oSyTYnF9z6eqz5OGKdMKVF_A2U9eYYhQNAKN8ZLcABJ41zdS8y1OBw7lVup/exec">
      <button class="test-button" onclick="setGasUrl()">URLè¨­å®š</button>
      <div id="url-status"></div>
    </div>

    <div class="test-section">
      <h3>2. æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</h3>
      <p>ç‰¹å®šã®ç‰©ä»¶ãƒ»éƒ¨å±‹ã§ã®æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
      <div>
        <label>ç‰©ä»¶ID: <input type="text" id="propertyId" value="P000001" style="padding: 4px;"></label>
        <label style="margin-left: 10px;">éƒ¨å±‹ID: <input type="text" id="roomId" value="R000001" style="padding: 4px;"></label>
      </div>
      <button class="test-button" onclick="testMeterReadingData()">æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</button>
      <div id="meter-data-status"></div>
      <div id="meter-data-display" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>3. ãƒ‡ãƒ¼ã‚¿å½¢å¼è§£æ</h3>
      <p>å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’è©³ç´°è§£æã—ã¾ã™</p>
      <button class="test-button" onclick="analyzeDataFormat()">ãƒ‡ãƒ¼ã‚¿å½¢å¼è§£æ</button>
      <div id="analysis-status"></div>
      <div id="analysis-display" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>4. Meter Readingç”»é¢ãƒ†ã‚¹ãƒˆ</h3>
      <p>å®Ÿéš›ã®meter readingç”»é¢ã§ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™</p>
      <button class="test-button" onclick="openMeterReadingTest()">Meter Readingç”»é¢ã‚’é–‹ã</button>
      <button class="test-button" onclick="openMeterReadingWithDebug()">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã</button>
      <div id="page-test-status"></div>
    </div>
  </div>

  <script>
    let gasWebAppUrl = '';
    let lastFetchedData = null;

    function updateStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status ${type}`;
      element.textContent = message;
    }

    function displayData(elementId, data) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.textContent = JSON.stringify(data, null, 2);
    }

    function setGasUrl() {
      const urlInput = document.getElementById('gasUrlInput');
      gasWebAppUrl = urlInput.value.trim();
      
      if (gasWebAppUrl) {
        sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
        updateStatus('url-status', 'success', `âœ… URLè¨­å®šå®Œäº†: ${gasWebAppUrl}`);
        console.log('[Debug] GAS WebApp URL set:', gasWebAppUrl);
      } else {
        updateStatus('url-status', 'error', 'âŒ URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
    }

    async function testMeterReadingData() {
      if (!gasWebAppUrl) {
        updateStatus('meter-data-status', 'error', 'âŒ ã¾ãšGAS WebApp URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim();
      const roomId = document.getElementById('roomId').value.trim();

      if (!propertyId || !roomId) {
        updateStatus('meter-data-status', 'error', 'âŒ ç‰©ä»¶IDã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      updateStatus('meter-data-status', 'loading', 'ğŸ”„ æ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

      try {
        const fetchUrl = `${gasWebAppUrl}?action=getMeterReadings&propertyId=${propertyId}&roomId=${roomId}&debug=true&_t=${Date.now()}`;
        console.log('[Debug] Fetching from:', fetchUrl);

        const response = await fetch(fetchUrl);
        console.log('[Debug] Response status:', response.status);
        console.log('[Debug] Response headers:', [...response.headers.entries()]);

        const responseText = await response.text();
        console.log('[Debug] Raw response text:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('[Debug] JSON parse error:', parseError);
          throw new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${parseError.message}\nç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${responseText.substring(0, 500)}`);
        }

        console.log('[Debug] Parsed JSON data:', data);
        lastFetchedData = data;

        if (response.ok) {
          updateStatus('meter-data-status', 'success', `âœ… æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ (HTTP ${response.status})`);
          
          const detailedInfo = {
            httpStatus: response.status,
            responseHeaders: Object.fromEntries(response.headers.entries()),
            rawResponse: responseText,
            parsedData: data,
            dataType: typeof data,
            isArray: Array.isArray(data),
            keys: typeof data === 'object' ? Object.keys(data) : null,
            fetchUrl: fetchUrl,
            timestamp: new Date().toISOString()
          };

          displayData('meter-data-display', detailedInfo);
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

      } catch (error) {
        console.error('[Debug] Error:', error);
        updateStatus('meter-data-status', 'error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        displayData('meter-data-display', { 
          error: error.message, 
          stack: error.stack,
          url: gasWebAppUrl,
          timestamp: new Date().toISOString()
        });
      }
    }

    async function analyzeDataFormat() {
      if (!lastFetchedData) {
        updateStatus('analysis-status', 'error', 'âŒ ã¾ãšæ¤œé‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„');
        return;
      }

      updateStatus('analysis-status', 'loading', 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’è§£æä¸­...');

      try {
        const analysis = {
          dataType: typeof lastFetchedData,
          isArray: Array.isArray(lastFetchedData),
          keys: typeof lastFetchedData === 'object' ? Object.keys(lastFetchedData) : null,
          
          // meter_reading.htmlã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã®åˆ¤å®š
          formatAnalysis: {
            unifiedFormat: lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data),
            readingsFormat: lastFetchedData && Array.isArray(lastFetchedData.readings),
            directArrayFormat: Array.isArray(lastFetchedData),
            unknownFormat: !(
              (lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data)) ||
              (lastFetchedData && Array.isArray(lastFetchedData.readings)) ||
              Array.isArray(lastFetchedData)
            )
          },

          // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
          extractedReadings: null,
          extractedDebugInfo: null
        };

        // meter_reading.htmlã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        let actualDataPayload;
        if (lastFetchedData && lastFetchedData.success === true && Array.isArray(lastFetchedData.data)) {
          actualDataPayload = { 
            readings: lastFetchedData.data,
            debugInfo: lastFetchedData.debugInfo || {}
          };
          analysis.selectedFormat = 'unified';
        }
        else if (lastFetchedData && Array.isArray(lastFetchedData.readings)) {
          actualDataPayload = lastFetchedData;
          analysis.selectedFormat = 'readings';
        }
        else if (Array.isArray(lastFetchedData)) {
          actualDataPayload = { 
            readings: lastFetchedData, 
            debugInfo: { directArray: true }
          };
          analysis.selectedFormat = 'directArray';
        }
        else {
          analysis.selectedFormat = 'unknown';
          analysis.error = 'ã™ã¹ã¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©²å½“ã—ã¾ã›ã‚“';
        }

        if (actualDataPayload) {
          analysis.extractedReadings = actualDataPayload.readings;
          analysis.extractedDebugInfo = actualDataPayload.debugInfo;
          analysis.readingsCount = Array.isArray(actualDataPayload.readings) ? actualDataPayload.readings.length : 0;
        }

        analysis.originalData = lastFetchedData;

        updateStatus('analysis-status', 'success', `âœ… ãƒ‡ãƒ¼ã‚¿å½¢å¼è§£æå®Œäº† (å½¢å¼: ${analysis.selectedFormat || 'unknown'})`);
        displayData('analysis-display', analysis);

      } catch (error) {
        console.error('[Debug] Analysis error:', error);
        updateStatus('analysis-status', 'error', `âŒ è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
        displayData('analysis-display', { error: error.message, stack: error.stack });
      }
    }

    function openMeterReadingTest() {
      if (!gasWebAppUrl) {
        updateStatus('page-test-status', 'error', 'âŒ ã¾ãšGAS WebApp URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim() || 'P000001';
      const roomId = document.getElementById('roomId').value.trim() || 'R000001';

      const testUrl = `meter_reading.html?propertyId=${propertyId}&propertyName=ãƒ†ã‚¹ãƒˆç‰©ä»¶&roomId=${roomId}&roomName=ãƒ†ã‚¹ãƒˆéƒ¨å±‹`;
      
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      updateStatus('page-test-status', 'success', 'âœ… Meter Readingç”»é¢ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸ');
      
      window.open(testUrl, '_blank');
    }

    function openMeterReadingWithDebug() {
      if (!gasWebAppUrl) {
        updateStatus('page-test-status', 'error', 'âŒ ã¾ãšGAS WebApp URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
        return;
      }

      const propertyId = document.getElementById('propertyId').value.trim() || 'P000001';
      const roomId = document.getElementById('roomId').value.trim() || 'R000001';

      const testUrl = `meter_reading.html?propertyId=${propertyId}&propertyName=ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆç‰©ä»¶&roomId=${roomId}&roomName=ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆéƒ¨å±‹&debug=true&verbose=true`;
      
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      updateStatus('page-test-status', 'success', 'âœ… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§Meter Readingç”»é¢ã‚’é–‹ãã¾ã—ãŸ (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„)');
      
      window.open(testUrl, '_blank');
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸè¨­å®š
    window.addEventListener('load', () => {
      console.log('[Debug] Meter Reading Debug Test page loaded');
      
      // sessionStorageã‹ã‚‰URLã‚’å¾©å…ƒ
      const savedUrl = sessionStorage.getItem('gasWebAppUrl');
      if (savedUrl) {
        document.getElementById('gasUrlInput').value = savedUrl;
        gasWebAppUrl = savedUrl;
        updateStatus('url-status', 'success', `âœ… ä¿å­˜ã•ã‚ŒãŸURL: ${savedUrl}`);
      }
    });
  </script>
</body>
</html>
