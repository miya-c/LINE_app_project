# 総合カスタム処理.gs 機能説明書

## 📋 概要

`総合カスタム処理.gs` は、Google Sheets上で不動産物件の検針データ管理を自動化するための統合Google Apps Scriptです。複数の個別機能を一つのファイルに統合し、使いやすいカスタムメニューインターフェースを提供します。

## 🎯 主要機能

### 1. データ連携機能

- **マスタデータから検針データの自動生成**
- **新規物件・部屋の自動反映**
- **データ整合性の維持**

### 2. データフォーマット機能

- **物件IDの標準化（P + 6桁数字形式）**
- **一括フォーマット変換**

### 3. データ整合性チェック機能

- **孤立データの検出と削除**
- **マスタデータとの同期チェック**

### 4. 月次データ処理機能

- **検針データの月次アーカイブ**
- **データのリセットと次月準備**

---

## 🚀 セットアップ方法

### 前提条件

- Google Sheets スプレッドシート
- 以下のシートが存在する必要があります：
  - `物件マスタ` (列: 物件ID, 物件名)
  - `部屋マスタ` (列: 物件ID, 部屋ID, 部屋名)
  - `inspection_data` (自動作成されます)

### インストール手順

1. Google Sheetsを開く
2. 「拡張機能」→「Apps Script」をクリック
3. デフォルトコードを削除し、`総合カスタム処理.gs`の内容を貼り付け
4. 保存（Ctrl+S）
5. スプレッドシートに戻り、ページを再読み込み（F5）
6. メニューバーに「総合カスタム処理」が表示される

---

## 📖 機能詳細

### 🔧 ユーティリティ関数

#### `safeAlert(title, message)`

**目的**: UI操作を安全に処理し、エラー時にログ出力にフォールバック

**使用場面**: すべての関数でユーザー通知に使用

---

### 1️⃣ データ連携機能

#### `populateInspectionDataFromMasters()`

**目的**: 物件マスタと部屋マスタから検針データシートに新規データを追加

**処理フロー**:

1. 物件マスタから物件ID→物件名のマップを作成
2. inspection_dataの既存データを読み込み（重複チェック用）
3. 部屋マスタから新規部屋データを取得
4. 既存にない部屋のみを新規追加

**追加されるデータ**:

- 記録ID (UUID)
- 物件名（物件マスタから取得）
- 物件ID
- 部屋ID  
- 部屋名
- その他の列は空白で初期化

**メニュー位置**: `2. マスタから検針データへ新規部屋反映`

---

### 2️⃣ 初期データ作成機能

#### `createInitialInspectionData()`

**目的**: inspection_dataシートの初期作成と初期データ生成

**自動シート作成機能**:

```javascript
if (!inspectionDataSheet) {
  inspectionDataSheet = ss.insertSheet(INSPECTION_DATA_SHEET_NAME);
  Logger.log(`"${INSPECTION_DATA_SHEET_NAME}" シートを新規作成しました。`);
}
```

**ヘッダー構成**:

```javascript
const INSPECTION_DATA_HEADERS = [
  '記録ID', '物件名', '物件ID', '部屋ID', '部屋名',
  '検針日時', '警告フラグ', '写真URL', '標準偏差値',
  '当月指示数', '前回指示数', '前々回指示数', '使用量',
  '単価', '金額', '備考'
];
```

**処理手順**:

1. inspection_dataシートの存在確認・作成
2. ヘッダー行の設定
3. 物件マスタ・部屋マスタからデータ取得
4. 初期データの一括挿入

**メニュー位置**: `1. 初期検針データ作成`

---

### 3️⃣ 物件IDフォーマット機能

#### `formatPropertyIDs()`

**目的**: 物件マスタシートの物件IDを標準形式（P + 6桁数字）に統一

**対象データ判定**:

- 数値のみ（例：`1` → `P000001`）
- `P1` → `P000001`
- `123` → `P000123`
- `P000123` → そのまま（既に正しい形式）

**処理対象**:

- 数値データ
- `P`で始まる数値

**メニュー位置**: `3. 物件マスタの物件IDフォーマット`

#### `formatRoomPropertyIDs()`

**目的**: 部屋マスタシートの物件IDを標準形式に統一

**メニュー位置**: `4. 部屋マスタの物件IDフォーマット`

---

### 4️⃣ データ整合性チェック機能

#### `removeOrphanedRoomsFromMaster()`

**目的**: 部屋マスタで物件マスタに存在しない物件IDを参照している行を削除

**処理フロー**:

1. 物件マスタから有効な物件IDセットを作成
2. 部屋マスタの各行の物件IDをチェック
3. 存在しない物件IDを参照する行を特定
4. 孤立行を削除

**削除対象例**:

- 物件マスタに`P000001`,`P000002`のみ存在
- 部屋マスタに`P000003`を参照する行がある場合、その行を削除

**メニュー位置**: `5. 孤立データ削除（部屋マスタから無効物件ID行削除）`

---

### 5️⃣ 月次データ処理機能

#### `saveCurrentMonthAndReset()`

**目的**: 月次の検針データアーカイブとデータリセット

**処理フロー**:

1. 現在の年月でアーカイブシート名を作成
2. 既存同名シートの確認と上書き確認
3. 検針データの指定列をアーカイブにコピー
4. データの月次リセット

**アーカイブ対象列**:

```javascript
const columnsToCopy = [
  '記録ID', '物件名', '物件ID', '部屋ID', '部屋名',
  '検針日時', '警告フラグ', '写真URL', '標準偏差値',
  '当月指示数', '前回指示数', '前々回指示数', '使用量',
  '単価', '金額', '備考'
];
```

**リセット処理**:

- 前々回指示数 ← 前回指示数
- 前回指示数 ← 当月指示数
- 当月指示数 ← 空白
- その他フィールドのクリア

**メニュー位置**: `6. 月次検針データ保存とリセット`

---

### 6️⃣ メニュー機能

#### `onOpen()`

**目的**: スプレッドシートが開かれた時に自動実行され、カスタムメニューを作成

**作成されるメニュー構造**:

```text
総合カスタム処理
├── 1. 初期検針データ作成
├── 2. マスタから検針データへ新規部屋反映
├── 3. 物件マスタの物件IDフォーマット
├── 4. 部屋マスタの物件IDフォーマット
├── 5. 孤立データ削除（部屋マスタから無効物件ID行削除）
└── 6. 月次検針データ保存とリセット
```

---

## 🎨 **使い方ガイド（初心者向け）**

### 📋 **メニュー1: 初期検針データ作成**

**何をするメニューか**: 検針作業で使う基本データを自動で作成してくれる

#### 🏠 **このメニューが行うこと**

1. **準備確認**

   - 「物件マスタ」と「部屋マスタ」のシートがあるかチェック
   - 無い場合は、エラーメッセージでお知らせ

2. **検針データシートの作成**

   - 「inspection_data」という名前のシートを新しく作る
   - 既にある場合は、そのまま使用

3. **データの項目を設定**

   - 記録ID、物件名、部屋名、検針数値などの項目（列）を自動で作成

4. **基本データの準備**

   - 物件マスタと部屋マスタから情報を取得
   - 全ての部屋の基本情報を検針データに登録

#### 💡 **こんな時に使います**

- 🆕 **初めて検針システムを使い始める時**
- 🔄 **検針データをゼロから作り直したい時**
- 🏗️ **システムの初期設定を行う時**

#### 📝 **使用例**

例：アパート3棟、計30部屋の検針データを初めて作る場合

→ このメニューを実行すると30部屋分の空の検針データが自動で作成される

---

### 📋 **メニュー2: マスタから検針データへ新規部屋反映**

**何をするメニューか**: 新しく追加した物件や部屋を検針データに自動で追加してくれる

#### 🏠 **メニュー2の処理内容**

1. **必要なシートの確認**

   - 「物件マスタ」「部屋マスタ」「inspection_data」の3つのシートがあるかチェック
   - 無い場合は、エラーメッセージでお知らせ

2. **新しいデータの発見**

   - 物件マスタ・部屋マスタに新しく追加された部屋を自動で発見
   - 既に検針データにある部屋は重複追加しない

3. **自動での追加**

   - 新しい部屋の情報を検針データに自動で追加
   - 追加した部屋の数をメッセージでお知らせ

#### 💡 **メニュー2の利用場面**

- 🏢 **新しい物件を管理対象に追加した後**
- 🚪 **既存の物件に新しい部屋を追加した後**
- 🔄 **マスタデータを更新した後の同期作業**

#### 📝 **メニュー2の使用例**

例：新しいマンション（10部屋）を物件マスタと部屋マスタに登録した後

→ このメニューを実行すると10部屋分の検針データが自動で追加される

---

### 📋 **メニュー3: 物件マスタの物件IDフォーマット**

**何をするメニューか**: 物件IDを統一された見やすい形式に自動で整理してくれる

#### 🏠 **メニュー3の処理内容**

1. **物件マスタシートの確認**

   - 「物件マスタ」シートがあるかチェック
   - 無い場合は、エラーメッセージでお知らせ

2. **データの読み込み**

   - 物件マスタのタイトル行（1行目）をスキップ
   - 物件IDが入っているA列のデータを対象として処理

3. **形式の統一**

   - バラバラな物件IDを「P000001」のような統一された形式に変換
   - 例：
     - `1` → `P000001`
     - `P1` → `P000001`  
     - `123` → `P000123`
     - `P000123` → そのまま（既に正しい形式）

4. **対象データの判定**

   - 数字だけのもの（例：1, 123）
   - Pで始まって数字が続くもの（例：P1, P123）
   - 既に正しい形式のものは変更しない

5. **一括での更新**

   - 変更が必要なデータのみを自動で更新
   - 更新した件数をメッセージでお知らせ

#### 💡 **メニュー3の利用場面**

- 📥 **外部からデータを取り込んだ後**（ExcelファイルやCSVファイルなど）
- 🔄 **データの見た目を統一したい時**
- 🏷️ **物件IDの形式をきれいに揃えたい時**

#### 📝 **メニュー3の使用例**

例：物件IDが「1」「P2」「123」「P000004」とバラバラに入力されている場合

→ このメニューを実行すると「P000001」「P000002」「P000123」「P000004」に統一される

---

### 🔧 **メニュー4: 部屋マスタの物件IDフォーマット**

**何をするメニューか**: 部屋マスタの物件IDも統一された見やすい形式に自動で整理してくれる

#### 🏠 **メニュー4の処理内容**

1. **部屋マスタシートの確認**

   - 「部屋マスタ」シートがあるかチェック

2. **既に正しい形式かチェック**

   - 「P000001」のような正しい形式の物件IDは変更しない
   - 変更が必要なもののみを対象とする

3. **形式の統一**

   - メニュー3と同じように、物件IDを「P000001」形式に変換
   - 数字部分を6桁に揃えて、前に「P」を付ける

4. **データの整理**

   - 「P」で始まる場合は、その後ろの数字部分を取得
   - 数字のみの場合は、そのままの数値を使用
   - 6桁になるよう前ゼロで埋める

#### 💡 **メニュー4の利用場面**

- 🏠 **部屋マスタのデータを整理したい時**
- 🔗 **物件マスタとの形式を合わせたい時**
- 📊 **データの見た目を統一したい時**

#### 📝 **メニュー4の使用例**

例：部屋マスタの物件IDが「1」「P2」「123」となっている場合

→ このメニューを実行すると「P000001」「P000002」「P000123」に統一される

---

### 🧹 **メニュー5: 孤立データ削除**

**何をするメニューか**: 存在しない物件を参照している部屋のデータを自動で見つけて削除してくれる

#### 🏠 **メニュー5の処理内容**

1. **必要なシートの確認**

   - 「部屋マスタ」と「物件マスタ」の両方があるかチェック
   - 無い場合は、エラーメッセージでお知らせ

2. **物件マスタのデータ読み込み**

   - 現在登録されている物件IDの一覧を作成
   - これを「正しい物件ID」として使用

3. **部屋マスタのチェック**

   - 部屋マスタの各行の物件IDが、物件マスタに存在するかチェック
   - 存在しない物件IDを参照している行を「孤立データ」として特定

4. **自動削除**

   - 孤立データとして特定された行を自動で削除
   - 削除した行数をメッセージでお知らせ

#### 💡 **メニュー5の利用場面**

- 🧹 **データの定期的なお掃除をしたい時**
- 🔍 **データに矛盾がないか確認したい時**
- 🗑️ **不要なデータを自動で削除したい時**

#### 📝 **メニュー5の使用例**

例：物件マスタには「P000001」「P000002」しか無いのに、部屋マスタに「P000003」を参照する部屋がある場合

→ このメニューを実行すると「P000003」を参照する部屋のデータが自動で削除される

#### ⚠️ **注意事項**

- 削除されたデータは元に戻せないので、事前にバックアップを取ることをお勧めします
- 物件を削除する前に、その物件に関連する部屋データがあるかを確認してから実行してください

---

### 📅 **メニュー6: 月次検針データ保存とリセット**

**何をするメニューか**: 今月の検針結果を保存して、来月の検針準備を自動で行ってくれる

#### 🏠 **メニュー6の処理内容**

1. **検針データシートの確認**

   - 「inspection_data」シートがあるかチェック
   - 無い場合は、エラーメッセージでお知らせ

2. **今月のデータを保存**

   - 現在の年月（例：「202406_inspection_data」）の名前で新しいシートを作成
   - 今月の検針結果を全てコピーして保存

3. **既存の保存データの確認**

   - 同じ月のデータが既に保存されている場合は、上書きするか確認

4. **来月の準備**

   - 各部屋の検針データをリセット
   - 今月の数値を「前回の数値」として保存
   - 新しい検針欄を空にして、来月の入力準備を完了

#### 💡 **メニュー6の利用場面**

- 📅 **月末の定期処理として**
- 💾 **検針データの長期保存のため**
- 🔄 **次の月の検針作業を始める前**

#### 📝 **メニュー6の使用例**

例：6月の検針が終わった時にこのメニューを実行すると：

1. 「202406_inspection_data」シートが作成される
2. 6月の検針結果が全て保存される
3. 検針データシートが7月用にリセットされる
4. 7月の検針作業を開始できる状態になる

#### 🔄 **数値の引き継ぎについて**

検針では過去の数値と比較することが重要なので、このメニューでは：

- **前回の数値** → **前々回の数値**として保存
- **今月の数値** → **前回の数値**として保存
- **今月の数値** → 空にして新しい入力を待つ

---

## 🛠️ **技術情報（管理者向け）**

### カスタムメニューの動作確認

もしメニューが表示されない場合や、エラーが発生した場合に使用できる診断機能も用意されています：

#### 📊 **処理の流れ**

1. **処理開始**: メニューをクリックすると処理が始まります

2. **進行状況**: 処理中の詳細は背景で記録されます

3. **完了通知**: 処理が完了すると結果をお知らせします

#### 🚨 **エラー時の対応**

1. **エラー検出**: 問題があると自動で検出されます

2. **安全停止**: データが壊れないよう、適切な場所で処理を停止します

3. **エラー内容の通知**: 何が問題だったかをメッセージでお知らせします

#### 🔒 **安全機能**

すべてのメニューには以下のような安全機能が組み込まれています：

- **データの形式が正しいかチェック**
- **必要なシートがあるかチェック**
- **処理前の確認メッセージ**
- **エラー時の安全停止**

---

## 🐛 トラブルシューティング

### 一般的な問題と解決方法

#### メニューが表示されない

**原因**: スクリプトがスプレッドシートに関連付けられていない

**解決方法**:

1. Apps Scriptエディタでスクリプトを確認
2. スクリプトを保存
3. スプレッドシートでページを再読み込み

#### 実行時エラー: 「重複する変数宣言」

**原因**: 重複する変数宣言

**解決方法**: 統合版スクリプトを使用する（本バージョンで解決済み）

#### 「必要なシートが見つかりません」エラー

**原因**: 必要なシートが存在しない

**解決方法**:

- `物件マスタ`シートを作成（列: 物件ID, 物件名）
- `部屋マスタ`シートを作成（列: 物件ID, 部屋ID, 部屋名）

#### UI関連エラー

**原因**: スタンドアロンスクリプトでUI操作を試行

**解決方法**: スプレッドシートに関連付けられたスクリプトとして実行

---

### エラーハンドリング

#### 実装されている安全機能

- **Try-catch文**: すべての主要関数で例外処理を実装
- **存在チェック**: シートやデータの存在を事前確認
- **データ検証**: 処理前にデータ形式を確認
- **ユーザー通知**: 処理結果とエラー情報を適切に通知

#### ログレベル

- **📋 情報**: 一般的な処理状況
- **⚠️ 警告**: 注意が必要な状況
- **❌ エラー**: 処理が中断された問題
- **✅ 成功**: 正常完了

---

## 📊 データ構造

### 物件マスタシート

| 列 | 項目名 | データ型 | 例 |
|---|---|---|---|
| A | 物件ID | 文字列 | P000001 |
| B | 物件名 | 文字列 | サンプルマンション |

### 部屋マスタシート

| 列 | 項目名 | データ型 | 例 |
|---|---|---|---|
| A | 物件ID | 文字列 | P000001 |
| B | 部屋ID | 文字列 | 101 |
| C | 部屋名 | 文字列 | 1階101号室 |

### inspection_dataシート

| 列 | 項目名 | データ型 | 自動設定 |
|---|---|---|---|
| A | 記録ID | UUID | ✅ |
| B | 物件名 | 文字列 | ✅ |
| C | 物件ID | 文字列 | ✅ |
| D | 部屋ID | 文字列 | ✅ |
| E | 部屋名 | 文字列 | ✅ |
| F | 検針日時 | 日時 | - |
| G | 警告フラグ | 文字列 | - |
| H | 写真URL | URL | - |
| I | 標準偏差値 | 数値 | - |
| J | 当月指示数 | 数値 | - |
| K | 前回指示数 | 数値 | - |
| L | 前々回指示数 | 数値 | - |
| M | 使用量 | 数値 | - |
| N | 単価 | 数値 | - |
| O | 金額 | 数値 | - |
| P | 備考 | 文字列 | - |

---

## 📋 **運用フロー例**

### システム導入時の手順

```text
1. 物件マスタの準備
   ↓
2. 部屋マスタの準備  
   ↓
3. Apps Scriptのインストール
   ↓
4. メニュー1を実行「初期検針データ作成」
   ↓
5. 完了：検針作業を開始できます
```

### 新規物件追加時の手順

```text
【新しい物件を追加した時】
1. 物件マスタに新しい物件を追加
   ↓
2. 部屋マスタに新しい部屋を追加
   ↓  
3. メニュー3,4を実行：物件IDの形式を統一
   ↓
4. メニュー2を実行「新規部屋反映」
   ↓
5. 完了：新しい物件の検針ができるようになります

【月末の処理】
1. その月の検針データを確認
   ↓
2. メニュー6を実行「月次検針データ保存とリセット」
   ↓
3. 今月のデータが保存され、来月の準備が完了
   ↓
4. 完了：来月の検針作業を開始できます

【定期的なお手入れ】
1. メニュー5を実行「孤立データ削除」
   ↓
2. データの整合性をチェック・修正
   ↓
3. 必要に応じて物件・部屋マスタを修正
```

### 🎯 **どのメニューを使えばいいか迷った時**

#### 🆕 **初めて使う時**

→ **メニュー1「初期検針データ作成」**を使ってください

#### 🏢 **新しい物件・部屋を追加した時**

→ **メニュー2「新規部屋反映」**を使ってください

#### 🏷️ **物件IDの見た目がバラバラな時**

→ **メニュー3,4「物件IDフォーマット」**を使ってください

#### 🧹 **データを整理したい時**

→ **メニュー5「孤立データ削除」**を使ってください

#### 📅 **月が変わった時**

→ **メニュー6「月次保存とリセット」**を使ってください

### ⚡ **困った時の対処法**

```text
【メニューが表示されない時】
1. ページを更新する（F5キー）
   ↓
2. 別のブラウザで試してみる
   ↓
3. システム管理者に相談

【エラーメッセージが出た時】
1. エラーメッセージの内容を記録
   ↓
2. 同じ操作をもう一度試してみる
   ↓
3. それでも解決しない場合は管理者に相談

【データが消えてしまった時】
1. あわてずに、まずは状況を確認
   ↓
2. 月次保存で作られたアーカイブシートを確認
   ↓
3. Google Sheetsの「編集履歴」から復元を試す
   ↓
4. 管理者と一緒に復旧作業
```

---

## 🔐 セキュリティとベストプラクティス

### データ保護

- **バックアップ**: 月次アーカイブで自動バックアップ
- **アクセス制御**: Google Sheetsの共有設定で制御
- **変更履歴**: Google Sheetsの版履歴機能を活用

### 運用推奨事項

- **定期的な整合性チェック**: 月1回程度実行
- **ログ確認**: エラー発生時はログを確認
- **段階的実行**: 大量データ処理前にテスト実行

---

## 📝 更新履歴

### バージョン 1.0

- 初回統合版リリース
- 6つの個別機能を統合
- 自動シート作成機能追加
- 包括的エラーハンドリング実装

### 修正済み問題

- ✅ 変数重複宣言エラーの解決
- ✅ inspection_dataシート自動作成の実装
- ✅ ローカル変数スコープの最適化

---

## 🤝 サポート

### 問題報告

問題が発生した場合は以下の情報を記録してください：

- エラーメッセージ
- 実行していた機能
- スプレッドシートの構成
- ログ出力（Apps Scriptエディタの「実行」→「実行履歴」で確認）

### 機能拡張

新しい機能が必要な場合は、既存の機能構造を参考に追加開発が可能です。

---

このドキュメントは `総合カスタム処理.gs` (769行) の機能を包括的に説明しています。

最終更新: 2024年03月
