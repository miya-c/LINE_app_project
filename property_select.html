<!DOCTYPE html>
<html>
<head>
  <title>物件選択</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- LIFF SDKの読み込み -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- ここにWOFF特有の初期設定やCSSのリンクなどが入るかもしれないね -->
  <style>
    /* 簡単な見た目のためのCSS（後でちゃんと作る） */
    body { font-family: sans-serif; margin: 10px; }
    #search-box { margin-bottom: 10px; padding: 8px; width: calc(100% - 20px); }
    #property-list button { display: block; width: 100%; padding: 10px; margin-bottom: 5px; text-align: left; }
  </style>
</head>
<body>
  <h1>物件選択</h1>

  <input type="text" id="search-box" placeholder="物件IDまたは物件名で検索...">

  <div id="property-list">
    <!-- ここにJavaScriptで物件ボタンが追加される -->
    <p>物件情報を読み込み中です...</p>
  </div>

  <script>
    // WOFFアプリが初期化されたら実行される関数
    window.addEventListener('DOMContentLoaded', (event) => {
      initializeLiff();
    });

    async function initializeLiff() {
      try {
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここに、LINE Developersコンソールで取得したLIFF IDを設定してください！ ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        await liff.init({ liffId: "YOUR_LIFF_ID" }); // YOUR_LIFF_IDを実際のLIFF IDに置き換えてください
        if (!liff.isLoggedIn()) {
          // ログインしていなければログインを促す（WOFFでは通常自動ログインされることが多い）
          // 必要に応じてログイン処理を実装してください
          console.log("ログインしていません。");
          // liff.login();
        }
        // LIFFの初期化が成功したら、アプリのメイン処理を開始
        fetchProperties();
        setupSearch();
      } catch (error) {
        console.error('LIFFの初期化に失敗しました:', error);
        // ユーザーにエラーを通知する処理（例: アラート表示など）
        document.getElementById('property-list').innerHTML = '<p>アプリの起動に失敗しました。LIFF IDが正しく設定されているか確認してください。</p>';
      }
    }

    // GASから物件リストを取得して表示する関数
    async function fetchProperties() {
      const propertyListDiv = document.getElementById('property-list');
      propertyListDiv.innerHTML = '<p>物件情報を読み込み中です...</p>'; // いったん表示をリセット

      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
      // ★ ここに、さっきGASをデプロイした時に取得した「ウェブアプリのURL」を貼り付けてね！ ★
      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
      const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxNpmAydEOsQaDgkwf7R4Qk4A1c-h5yEq6z62GLZE3dMGxYR-6_aB7OzZUMO_ncU8D1Lg/exec';

      try {
        const response = await fetch(gasWebAppUrl);
        if (!response.ok) {
          throw new Error('ネットワークの応答が正しくありませんでした。');
        }
        const properties = await response.json(); // GASから返ってきたJSONデータをJavaScriptのオブジェクトに変換

        propertyListDiv.innerHTML = ''; // 「読み込み中です」を消す

        if (properties.length === 0) {
          propertyListDiv.innerHTML = '<p>登録されている物件がありません。</p>';
          return;
        }

        properties.forEach(property => {
          const button = document.createElement('button');
          button.textContent = `${property.id}：${property.name}`;
          button.onclick = function() {
            // room_select.html に物件IDと物件名を渡して画面遷移する
            const params = new URLSearchParams();
            params.append('propertyId', property.id);
            params.append('propertyName', property.name);
            // liff.openWindow() を使って画面遷移
            if (liff.isInClient()) {
              liff.openWindow({
                url: `room_select.html?${params.toString()}`,
                external: false // WOFF内部での遷移
              });
            } else {
              // LIFFブラウザ外の場合のフォールバック（通常のブラウザ遷移）
              window.location.href = `room_select.html?${params.toString()}`;
            }
          };
          propertyListDiv.appendChild(button);
        });
      } catch (error) {
        console.error('物件情報の取得に失敗しました:', error);
        propertyListDiv.innerHTML = '<p>物件情報の取得に失敗しました。時間をおいて再度お試しください。</p>';
      }
    }

    // 検索機能のセットアップ関数
    function setupSearch() {
      const searchBox = document.getElementById('search-box');
      const propertyListDiv = document.getElementById('property-list');

      searchBox.addEventListener('input', function() {
        const searchTerm = searchBox.value.toLowerCase(); // 入力された文字を小文字に変換
        const buttons = propertyListDiv.getElementsByTagName('button'); // 物件ボタンのリストを取得

        for (let i = 0; i < buttons.length; i++) {
          const button = buttons[i];
          const buttonText = button.textContent.toLowerCase(); // ボタンのテキストも小文字に変換

          // ボタンのテキストに検索キーワードが含まれていれば表示、そうでなければ非表示
          if (buttonText.includes(searchTerm)) {
            button.style.display = 'block';
          } else {
            button.style.display = 'none';
          }
        }
      });
    }
  </script>
</body>
</html>