<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水道検針写真アップロード（Direct Google Drive API版）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            color: #2c5aa0;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #2c5aa0;
            outline: none;
        }
        button {
            padding: 12px 24px;
            background-color: #2c5aa0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1e3d72;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .success-btn {
            background-color: #28a745;
        }
        .success-btn:hover {
            background-color: #1e7e34;
        }
        .danger-btn {
            background-color: #dc3545;
        }
        .danger-btn:hover {
            background-color: #c82333;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background-color: #e0a800;
        }
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin: 0 5px;
            position: relative;
        }
        .step.active {
            background-color: #2c5aa0;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background-color: #dc3545;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .offline-indicator.show {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #2c5aa0;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        📶 オフライン - 接続を確認してください
    </div>

    <div class="container">
        <div class="header">
            <h1>🚿 水道検針写真アップロード</h1>
            <p>Google Drive API直接アクセス版 - CORS問題完全回避</p>
        </div>

        <!-- ステップ指示 -->
        <div class="step-indicator">
            <div class="step completed" id="step1">
                <strong>STEP 1</strong><br>
                API設定
            </div>
            <div class="step active" id="step2">
                <strong>STEP 2</strong><br>
                写真選択
            </div>
            <div class="step" id="step3">
                <strong>STEP 3</strong><br>
                アップロード
            </div>
            <div class="step" id="step4">
                <strong>STEP 4</strong><br>
                完了
            </div>
        </div>

        <!-- API設定セクション -->
        <div class="section">
            <h3>🔧 API設定</h3>
            <div class="form-group">
                <label for="apiKey">Google Drive API キー:</label>
                <input type="password" id="apiKey" placeholder="Google Cloud ConsoleのAPIキーを入力">
                <small style="color: #666; font-size: 12px;">
                    ※ Google Cloud Console > 認証情報 > APIキー で取得
                </small>
            </div>
            <div class="form-group">
                <label for="gasUrl">Google Apps Script URL:</label>
                <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <small style="color: #666; font-size: 12px;">
                    ※ 写真URLをスプレッドシートに保存するためのGAS WebアプリURL
                </small>
            </div>
            <button onclick="testApiConnection()" id="testApiBtn">API接続テスト</button>
        </div>

        <!-- 検針情報セクション -->
        <div class="section">
            <h3>📋 検針情報</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="propertyId">物件ID:</label>
                    <input type="text" id="propertyId" value="PROP_001" required>
                </div>
                <div class="form-group">
                    <label for="roomId">部屋ID:</label>
                    <input type="text" id="roomId" value="ROOM_001" required>
                </div>
            </div>
            <div class="form-group">
                <label for="meterReading">メーター指示数:</label>
                <input type="number" id="meterReading" step="0.1" placeholder="例: 123.4">
            </div>
            <div class="form-group">
                <label for="remarks">備考:</label>
                <textarea id="remarks" rows="3" placeholder="特記事項があれば記入"></textarea>
            </div>
        </div>

        <!-- 写真選択セクション -->
        <div class="section">
            <h3>📸 写真選択</h3>
            <div class="form-group">
                <label for="photoInput">写真を選択:</label>
                <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp" required>
                <small style="color: #666; font-size: 12px;">
                    ※ JPEG、PNG、WebP形式 / 最大10MB
                </small>
            </div>
            <div id="photoPreview"></div>
            <div id="photoInfo"></div>
        </div>

        <!-- アップロードセクション -->
        <div class="section">
            <h3>☁️ アップロード</h3>
            <div class="progress-bar" id="progressBarContainer" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="uploadPhoto()" id="uploadBtn" class="success-btn" disabled>
                    📤 写真をアップロード
                </button>
                <button onclick="saveToIndexedDB()" id="saveOfflineBtn" class="warning-btn" disabled>
                    💾 オフライン保存
                </button>
                <button onclick="clearForm()" class="danger-btn">
                    🗑️ フォームクリア
                </button>
            </div>
        </div>

        <!-- オフライン管理セクション -->
        <div class="section">
            <h3>📱 オフライン管理</h3>
            <div id="offlineList"></div>
            <button onclick="syncOfflineData()" id="syncBtn" class="warning-btn">
                🔄 オフラインデータを同期
            </button>
        </div>

        <!-- ログセクション -->
        <div class="section">
            <h3>📝 ログ</h3>
            <div id="messages" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="clearLog()" class="danger-btn">ログクリア</button>
        </div>
    </div>

    <!-- Google APIs Core Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script>
        // グローバル変数
        let selectedPhotoFile = null;
        let selectedPhotoData = null;
        let offlineDB = null;
        
        // IndexedDB初期化
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WaterMeterPhotoDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    offlineDB = request.result;
                    resolve(offlineDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('propertyId', 'propertyId', { unique: false });
                    }
                };
            });
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', async function() {
            showMessage('📱 水道検針写真アップロードシステムを読み込みました', 'info');
            
            try {
                await initIndexedDB();
                showMessage('💾 オフラインデータベースを初期化しました', 'success');
                await loadOfflineData();
            } catch (error) {
                showMessage('❌ オフラインデータベースの初期化に失敗: ' + error.message, 'error');
            }
            
            // オンライン/オフライン状態監視
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showMessage('🌐 オンライン状態に復帰しました', 'success');
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
                showMessage('📶 オフライン状態です', 'warning');
            });
            
            // ファイル選択イベント
            document.getElementById('photoInput').addEventListener('change', handleFileSelection);
        });

        // ファイル選択処理
        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ファイルサイズ検証（10MB制限）
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage(`❌ ファイルサイズが大きすぎます（${Math.round(file.size / 1024 / 1024)}MB）。10MB以下の画像を選択してください。`, 'error');
                return;
            }

            // ファイル形式検証
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showMessage(`❌ サポートされていないファイル形式です（${file.type}）。JPEG、PNG、WebP形式の画像を選択してください。`, 'error');
                return;
            }

            selectedPhotoFile = file;
            
            // プレビュー表示
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedPhotoData = e.target.result;
                
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = `
                    <h4>📸 選択された画像:</h4>
                    <img src="${selectedPhotoData}" class="photo-preview" alt="選択された画像">
                `;
                
                const info = document.getElementById('photoInfo');
                info.innerHTML = `
                    <div class="message info">
                        <strong>📄 ファイル情報:</strong><br>
                        ファイル名: ${file.name}<br>
                        サイズ: ${Math.round(file.size / 1024)} KB<br>
                        形式: ${file.type}<br>
                        最終更新: ${new Date(file.lastModified).toLocaleString()}
                    </div>
                `;
                
                // ステップ更新
                updateStep(3);
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('saveOfflineBtn').disabled = false;
                
                showMessage('✅ 画像を選択しました。アップロードボタンを押してください。', 'success');
            };

            reader.onerror = function() {
                showMessage('❌ ファイルの読み込み中にエラーが発生しました。', 'error');
            };

            reader.readAsDataURL(file);
        }

        // API接続テスト
        async function testApiConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const gasUrl = document.getElementById('gasUrl').value;
            
            if (!apiKey || !gasUrl) {
                showMessage('❌ APIキーとGAS URLの両方を入力してください。', 'error');
                return;
            }
            
            const testBtn = document.getElementById('testApiBtn');
            testBtn.disabled = true;
            testBtn.textContent = '接続テスト中...';
            
            try {
                // Google Drive API テスト
                showMessage('🔧 Google Drive API接続テスト中...', 'info');
                
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                await gapi.client.init({
                    apiKey: apiKey,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });
                
                // 簡単なAPI呼び出しテスト
                const response = await gapi.client.drive.about.get({
                    fields: 'user'
                });
                
                showMessage('✅ Google Drive API接続成功', 'success');
                
                // GAS接続テスト
                showMessage('🔧 Google Apps Script接続テスト中...', 'info');
                
                const testResponse = await fetch(`${gasUrl}?action=getVersion`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    showMessage('✅ Google Apps Script接続成功', 'success');
                    showMessage(`📋 GASバージョン: ${data.version || '不明'}`, 'info');
                } else {
                    throw new Error(`GAS接続失敗: ${testResponse.status}`);
                }
                
                updateStep(2);
                showMessage('🎉 API接続テスト完了！写真を選択してください。', 'success');
                
            } catch (error) {
                showMessage(`❌ API接続テスト失敗: ${error.message}`, 'error');
                console.error('API接続エラー:', error);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'API接続テスト';
            }
        }

        // 写真アップロード（Google Drive API直接）
        async function uploadPhoto() {
            if (!selectedPhotoFile) {
                showMessage('❌ まず写真を選択してください。', 'error');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value;
            const gasUrl = document.getElementById('gasUrl').value;
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!apiKey || !gasUrl || !propertyId || !roomId) {
                showMessage('❌ すべての必須フィールドを入力してください。', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = '📤 アップロード中...';
            
            const progressContainer = document.getElementById('progressBarContainer');
            const progressFill = document.getElementById('progressFill');
            progressContainer.style.display = 'block';
            
            try {
                // ステップ1: Google Drive APIでファイルアップロード
                showMessage('☁️ Google Driveに写真をアップロード中...', 'info');
                updateProgress(20);
                
                // Google API初期化（必要に応じて）
                if (!gapi.client.drive) {
                    await new Promise((resolve, reject) => {
                        gapi.load('client', {
                            callback: resolve,
                            onerror: reject
                        });
                    });
                    
                    await gapi.client.init({
                        apiKey: apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                }
                
                updateProgress(40);
                
                // ファイルメタデータ準備
                const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                const fileExtension = selectedPhotoFile.type.split('/')[1] || 'jpg';
                const fileName = `water_meter_${propertyId}_${roomId}_${timestamp}.${fileExtension}`;
                
                // マルチパートアップロード準備
                const metadata = {
                    name: fileName,
                    parents: ['1BcD5E6FgHiJkLmNoPqRsTuVwXyZ'] // Google DriveフォルダID（要設定）
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', selectedPhotoFile);
                
                updateProgress(60);
                
                // Google Drive APIでアップロード
                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${await getAccessToken()}`,
                    },
                    body: form
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Drive API エラー: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }
                
                const uploadResult = await uploadResponse.json();
                const photoUrl = `https://drive.google.com/file/d/${uploadResult.id}/view`;
                
                updateProgress(80);
                showMessage(`✅ Google Driveアップロード完了: ${fileName}`, 'success');
                
                // ステップ2: GASに写真URLを送信（GET方式）
                showMessage('📊 スプレッドシートに写真URLを記録中...', 'info');
                  const gasParams = new URLSearchParams({
                    action: 'updatePhotoUrl',
                    propertyId: propertyId,
                    roomNumber: roomId,
                    photoUrl: photoUrl,
                    fileName: fileName,
                    meterReading: document.getElementById('meterReading').value || '',
                    remarks: document.getElementById('remarks').value || '',
                    timestamp: new Date().toISOString()
                });
                
                const gasResponse = await fetch(`${gasUrl}?${gasParams}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                updateProgress(100);
                
                if (gasResponse.ok) {
                    const gasResult = await gasResponse.json();
                    showMessage('✅ スプレッドシート更新完了！', 'success');
                    showMessage(`📋 記録されました: ${fileName}`, 'info');
                    
                    // 完了ステップ
                    updateStep(4);
                    showMessage('🎉 写真アップロード処理が完了しました！', 'success');
                    
                } else {
                    throw new Error(`GAS エラー: ${gasResponse.status} ${gasResponse.statusText}`);
                }
                
            } catch (error) {
                showMessage(`❌ アップロード失敗: ${error.message}`, 'error');
                console.error('アップロードエラー:', error);
                
                // オフライン保存を提案
                showMessage('💾 オフライン保存を試すか、ネットワーク接続を確認してください。', 'warning');
                
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = '📤 写真をアップロード';
                progressContainer.style.display = 'none';
                updateProgress(0);
            }
        }

        // アクセストークン取得（簡易版 - 実際は OAuth2.0 が必要）
        async function getAccessToken() {
            // 注意: 実際の実装ではOAuth2.0フローを実装する必要があります
            // ここでは簡易的にAPIキーを使用していますが、制限があります
            const apiKey = document.getElementById('apiKey').value;
            return apiKey; // 実際はOAuth2.0トークンを返す
        }

        // オフライン保存
        async function saveToIndexedDB() {
            if (!selectedPhotoFile || !offlineDB) {
                showMessage('❌ 写真が選択されていないか、データベースが利用できません。', 'error');
                return;
            }
            
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!propertyId || !roomId) {
                showMessage('❌ 物件IDと部屋IDを入力してください。', 'error');
                return;
            }
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const photoData = {
                    propertyId: propertyId,
                    roomId: roomId,
                    fileName: selectedPhotoFile.name,
                    fileType: selectedPhotoFile.type,
                    fileSize: selectedPhotoFile.size,
                    photoData: selectedPhotoData,
                    meterReading: document.getElementById('meterReading').value || '',
                    remarks: document.getElementById('remarks').value || '',
                    timestamp: new Date().toISOString(),
                    synced: false
                };
                
                const request = store.add(photoData);
                
                request.onsuccess = () => {
                    showMessage('💾 オフライン保存完了！オンライン時に同期できます。', 'success');
                    loadOfflineData();
                };
                
                request.onerror = () => {
                    showMessage('❌ オフライン保存に失敗しました。', 'error');
                };
                
            } catch (error) {
                showMessage(`❌ オフライン保存エラー: ${error.message}`, 'error');
            }
        }

        // オフラインデータ読み込み
        async function loadOfflineData() {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const offlineData = request.result;
                    const offlineList = document.getElementById('offlineList');
                    
                    if (offlineData.length === 0) {
                        offlineList.innerHTML = '<div class="message info">📱 オフラインデータはありません</div>';
                        return;
                    }
                    
                    offlineList.innerHTML = '<h4>📱 オフライン保存済みデータ:</h4>';
                    
                    offlineData.forEach((item, index) => {
                        const syncStatus = item.synced ? '✅ 同期済み' : '⏳ 未同期';
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'message ' + (item.synced ? 'success' : 'warning');
                        itemDiv.innerHTML = `
                            <strong>${item.fileName}</strong><br>
                            物件: ${item.propertyId} / 部屋: ${item.roomId}<br>
                            日時: ${new Date(item.timestamp).toLocaleString()}<br>
                            状態: ${syncStatus}
                            ${!item.synced ? `<button onclick="syncSingleItem(${item.id})" style="margin-left: 10px;">🔄 同期</button>` : ''}
                        `;
                        offlineList.appendChild(itemDiv);
                    });
                };
                
            } catch (error) {
                console.error('オフラインデータ読み込みエラー:', error);
            }
        }

        // オフラインデータ同期
        async function syncOfflineData() {
            if (!offlineDB) {
                showMessage('❌ オフラインデータベースが利用できません。', 'error');
                return;
            }
            
            if (!navigator.onLine) {
                showMessage('❌ オフライン状態です。インターネット接続を確認してください。', 'error');
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = '🔄 同期中...';
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.index('timestamp').getAll();
                
                request.onsuccess = async () => {
                    const unsyncedData = request.result.filter(item => !item.synced);
                    
                    if (unsyncedData.length === 0) {
                        showMessage('📱 同期が必要なデータはありません。', 'info');
                        return;
                    }
                    
                    showMessage(`🔄 ${unsyncedData.length}件のデータを同期中...`, 'info');
                    
                    for (const item of unsyncedData) {
                        try {
                            // 個別アイテムの同期処理をここに実装
                            await syncSingleItemData(item);
                            
                            // 同期完了フラグを更新
                            const updateTransaction = offlineDB.transaction(['photos'], 'readwrite');
                            const updateStore = updateTransaction.objectStore('photos');
                            item.synced = true;
                            updateStore.put(item);
                            
                        } catch (syncError) {
                            showMessage(`❌ ${item.fileName} の同期に失敗: ${syncError.message}`, 'error');
                        }
                    }
                    
                    showMessage('✅ オフラインデータの同期が完了しました！', 'success');
                    loadOfflineData();
                };
                
            } catch (error) {
                showMessage(`❌ 同期エラー: ${error.message}`, 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.textContent = '🔄 オフラインデータを同期';
            }
        }

        // 個別データ同期
        async function syncSingleItemData(item) {
            // この関数でGoogle Drive APIアップロードとGAS URL送信を実行
            // uploadPhoto() の処理をベースに個別データ用にカスタマイズ
            console.log('個別同期:', item);
            // 実装は uploadPhoto() 関数と同様の処理
        }

        // ユーティリティ関数
        function updateStep(stepNumber) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
        }

        function showMessage(text, type = 'info') {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
            messages.appendChild(messageDiv);
            
            // 自動スクロール
            messageDiv.scrollIntoView({ behavior: 'smooth' });
            
            // メッセージが多くなりすぎた場合の制限
            const allMessages = messages.querySelectorAll('.message');
            if (allMessages.length > 50) {
                allMessages[0].remove();
            }
        }

        function clearForm() {
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoInfo').innerHTML = '';
            document.getElementById('meterReading').value = '';
            document.getElementById('remarks').value = '';
            
            selectedPhotoFile = null;
            selectedPhotoData = null;
            
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('saveOfflineBtn').disabled = true;
            
            updateStep(2);
            showMessage('🗑️ フォームをクリアしました。', 'info');
        }

        function clearLog() {
            document.getElementById('messages').innerHTML = '';
            showMessage('📝 ログをクリアしました。', 'info');
        }
        
        // 単一アイテム同期
        async function syncSingleItem(itemId) {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.get(itemId);
                
                request.onsuccess = async () => {
                    const item = request.result;
                    if (item) {
                        await syncSingleItemData(item);
                        item.synced = true;
                        store.put(item);
                        loadOfflineData();
                        showMessage(`✅ ${item.fileName} を同期しました。`, 'success');
                    }
                };
                
            } catch (error) {
                showMessage(`❌ 個別同期エラー: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
