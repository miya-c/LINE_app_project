<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´é“æ¤œé‡å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆDirect Google Drive APIç‰ˆï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            color: #2c5aa0;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #2c5aa0;
            outline: none;
        }
        button {
            padding: 12px 24px;
            background-color: #2c5aa0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1e3d72;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .success-btn {
            background-color: #28a745;
        }
        .success-btn:hover {
            background-color: #1e7e34;
        }
        .danger-btn {
            background-color: #dc3545;
        }
        .danger-btn:hover {
            background-color: #c82333;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background-color: #e0a800;
        }
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin: 0 5px;
            position: relative;
        }
        .step.active {
            background-color: #2c5aa0;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background-color: #dc3545;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .offline-indicator.show {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #2c5aa0;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        ğŸ“¶ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ - æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸš¿ æ°´é“æ¤œé‡å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
            <p>Google Drive APIç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç‰ˆ - CORSå•é¡Œå®Œå…¨å›é¿</p>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—æŒ‡ç¤º -->
        <div class="step-indicator">
            <div class="step completed" id="step1">
                <strong>STEP 1</strong><br>
                APIè¨­å®š
            </div>
            <div class="step active" id="step2">
                <strong>STEP 2</strong><br>
                å†™çœŸé¸æŠ
            </div>
            <div class="step" id="step3">
                <strong>STEP 3</strong><br>
                ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </div>
            <div class="step" id="step4">
                <strong>STEP 4</strong><br>
                å®Œäº†
            </div>
        </div>

        <!-- APIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ”§ APIè¨­å®š</h3>
            <div class="form-group">
                <label for="apiKey">Google Drive API ã‚­ãƒ¼:</label>
                <input type="password" id="apiKey" placeholder="Google Cloud Consoleã®APIã‚­ãƒ¼ã‚’å…¥åŠ›">
                <small style="color: #666; font-size: 12px;">
                    â€» Google Cloud Console > èªè¨¼æƒ…å ± > APIã‚­ãƒ¼ ã§å–å¾—
                </small>
            </div>
            <div class="form-group">
                <label for="gasUrl">Google Apps Script URL:</label>
                <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <small style="color: #666; font-size: 12px;">
                    â€» å†™çœŸURLã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹ãŸã‚ã®GAS Webã‚¢ãƒ—ãƒªURL
                </small>
            </div>
            <button onclick="testApiConnection()" id="testApiBtn">APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>

        <!-- æ¤œé‡æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ“‹ æ¤œé‡æƒ…å ±</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="propertyId">ç‰©ä»¶ID:</label>
                    <input type="text" id="propertyId" value="PROP_001" required>
                </div>
                <div class="form-group">
                    <label for="roomId">éƒ¨å±‹ID:</label>
                    <input type="text" id="roomId" value="ROOM_001" required>
                </div>
            </div>
            <div class="form-group">
                <label for="meterReading">ãƒ¡ãƒ¼ã‚¿ãƒ¼æŒ‡ç¤ºæ•°:</label>
                <input type="number" id="meterReading" step="0.1" placeholder="ä¾‹: 123.4">
            </div>
            <div class="form-group">
                <label for="remarks">å‚™è€ƒ:</label>
                <textarea id="remarks" rows="3" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥"></textarea>
            </div>
        </div>

        <!-- å†™çœŸé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ“¸ å†™çœŸé¸æŠ</h3>
            <div class="form-group">
                <label for="photoInput">å†™çœŸã‚’é¸æŠ:</label>
                <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp" required>
                <small style="color: #666; font-size: 12px;">
                    â€» JPEGã€PNGã€WebPå½¢å¼ / æœ€å¤§10MB
                </small>
            </div>
            <div id="photoPreview"></div>
            <div id="photoInfo"></div>
        </div>

        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>â˜ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div class="progress-bar" id="progressBarContainer" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="uploadPhoto()" id="uploadBtn" class="success-btn" disabled>
                    ğŸ“¤ å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
                <button onclick="saveToIndexedDB()" id="saveOfflineBtn" class="warning-btn" disabled>
                    ğŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜
                </button>
                <button onclick="clearForm()" class="danger-btn">
                    ğŸ—‘ï¸ ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>

        <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ“± ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç®¡ç†</h3>
            <div id="offlineList"></div>
            <button onclick="syncOfflineData()" id="syncBtn" class="warning-btn">
                ğŸ”„ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
            </button>
        </div>

        <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h3>ğŸ“ ãƒ­ã‚°</h3>
            <div id="messages" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="clearLog()" class="danger-btn">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <!-- Google APIs Core Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedPhotoFile = null;
        let selectedPhotoData = null;
        let offlineDB = null;
        
        // IndexedDBåˆæœŸåŒ–
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WaterMeterPhotoDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    offlineDB = request.result;
                    resolve(offlineDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('propertyId', 'propertyId', { unique: false });
                    }
                };
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            showMessage('ğŸ“± æ°´é“æ¤œé‡å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info');
            
            try {
                await initIndexedDB();
                showMessage('ğŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'success');
                await loadOfflineData();
            } catch (error) {
                showMessage('âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—: ' + error.message, 'error');
            }
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showMessage('ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã«å¾©å¸°ã—ã¾ã—ãŸ', 'success');
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
                showMessage('ğŸ“¶ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™', 'warning');
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('photoInput').addEventListener('change', handleFileSelection);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæ¤œè¨¼ï¼ˆ10MBåˆ¶é™ï¼‰
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ${Math.round(file.size / 1024 / 1024)}MBï¼‰ã€‚10MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`, 'error');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼æ¤œè¨¼
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showMessage(`âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆ${file.type}ï¼‰ã€‚JPEGã€PNGã€WebPå½¢å¼ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`, 'error');
                return;
            }

            selectedPhotoFile = file;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedPhotoData = e.target.result;
                
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = `
                    <h4>ğŸ“¸ é¸æŠã•ã‚ŒãŸç”»åƒ:</h4>
                    <img src="${selectedPhotoData}" class="photo-preview" alt="é¸æŠã•ã‚ŒãŸç”»åƒ">
                `;
                
                const info = document.getElementById('photoInfo');
                info.innerHTML = `
                    <div class="message info">
                        <strong>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:</strong><br>
                        ãƒ•ã‚¡ã‚¤ãƒ«å: ${file.name}<br>
                        ã‚µã‚¤ã‚º: ${Math.round(file.size / 1024)} KB<br>
                        å½¢å¼: ${file.type}<br>
                        æœ€çµ‚æ›´æ–°: ${new Date(file.lastModified).toLocaleString()}
                    </div>
                `;
                
                // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
                updateStep(3);
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('saveOfflineBtn').disabled = false;
                
                showMessage('âœ… ç”»åƒã‚’é¸æŠã—ã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
            };

            reader.onerror = function() {
                showMessage('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            };

            reader.readAsDataURL(file);
        }

        // APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testApiConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const gasUrl = document.getElementById('gasUrl').value;
            
            if (!apiKey || !gasUrl) {
                showMessage('âŒ APIã‚­ãƒ¼ã¨GAS URLã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const testBtn = document.getElementById('testApiBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                // Google Drive API ãƒ†ã‚¹ãƒˆ
                showMessage('ğŸ”§ Google Drive APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
                
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                await gapi.client.init({
                    apiKey: apiKey,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });
                
                // ç°¡å˜ãªAPIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
                const response = await gapi.client.drive.about.get({
                    fields: 'user'
                });
                
                showMessage('âœ… Google Drive APIæ¥ç¶šæˆåŠŸ', 'success');
                
                // GASæ¥ç¶šãƒ†ã‚¹ãƒˆ
                showMessage('ğŸ”§ Google Apps Scriptæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
                
                const testResponse = await fetch(`${gasUrl}?action=getVersion`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    showMessage('âœ… Google Apps Scriptæ¥ç¶šæˆåŠŸ', 'success');
                    showMessage(`ğŸ“‹ GASãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version || 'ä¸æ˜'}`, 'info');
                } else {
                    throw new Error(`GASæ¥ç¶šå¤±æ•—: ${testResponse.status}`);
                }
                
                updateStep(2);
                showMessage('ğŸ‰ APIæ¥ç¶šãƒ†ã‚¹ãƒˆå®Œäº†ï¼å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');
                
            } catch (error) {
                showMessage(`âŒ APIæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                console.error('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'APIæ¥ç¶šãƒ†ã‚¹ãƒˆ';
            }
        }

        // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆGoogle Drive APIç›´æ¥ï¼‰
        async function uploadPhoto() {
            if (!selectedPhotoFile) {
                showMessage('âŒ ã¾ãšå†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value;
            const gasUrl = document.getElementById('gasUrl').value;
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!apiKey || !gasUrl || !propertyId || !roomId) {
                showMessage('âŒ ã™ã¹ã¦ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            
            const progressContainer = document.getElementById('progressBarContainer');
            const progressFill = document.getElementById('progressFill');
            progressContainer.style.display = 'block';
            
            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: Google Drive APIã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                showMessage('â˜ï¸ Google Driveã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
                updateProgress(20);
                
                // Google APIåˆæœŸåŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                if (!gapi.client.drive) {
                    await new Promise((resolve, reject) => {
                        gapi.load('client', {
                            callback: resolve,
                            onerror: reject
                        });
                    });
                    
                    await gapi.client.init({
                        apiKey: apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                }
                
                updateProgress(40);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æº–å‚™
                const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                const fileExtension = selectedPhotoFile.type.split('/')[1] || 'jpg';
                const fileName = `water_meter_${propertyId}_${roomId}_${timestamp}.${fileExtension}`;
                
                // ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™
                const metadata = {
                    name: fileName,
                    parents: ['1BcD5E6FgHiJkLmNoPqRsTuVwXyZ'] // Google Driveãƒ•ã‚©ãƒ«ãƒ€IDï¼ˆè¦è¨­å®šï¼‰
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', selectedPhotoFile);
                
                updateProgress(60);
                
                // Google Drive APIã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${await getAccessToken()}`,
                    },
                    body: form
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Drive API ã‚¨ãƒ©ãƒ¼: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }
                
                const uploadResult = await uploadResponse.json();
                const photoUrl = `https://drive.google.com/file/d/${uploadResult.id}/view`;
                
                updateProgress(80);
                showMessage(`âœ… Google Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${fileName}`, 'success');
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: GASã«å†™çœŸURLã‚’é€ä¿¡ï¼ˆGETæ–¹å¼ï¼‰
                showMessage('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å†™çœŸURLã‚’è¨˜éŒ²ä¸­...', 'info');
                  const gasParams = new URLSearchParams({
                    action: 'updatePhotoUrl',
                    propertyId: propertyId,
                    roomNumber: roomId,
                    photoUrl: photoUrl,
                    fileName: fileName,
                    meterReading: document.getElementById('meterReading').value || '',
                    remarks: document.getElementById('remarks').value || '',
                    timestamp: new Date().toISOString()
                });
                
                const gasResponse = await fetch(`${gasUrl}?${gasParams}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                updateProgress(100);
                
                if (gasResponse.ok) {
                    const gasResult = await gasResponse.json();
                    showMessage('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°å®Œäº†ï¼', 'success');
                    showMessage(`ğŸ“‹ è¨˜éŒ²ã•ã‚Œã¾ã—ãŸ: ${fileName}`, 'info');
                    
                    // å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—
                    updateStep(4);
                    showMessage('ğŸ‰ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    
                } else {
                    throw new Error(`GAS ã‚¨ãƒ©ãƒ¼: ${gasResponse.status} ${gasResponse.statusText}`);
                }
                
            } catch (error) {
                showMessage(`âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}`, 'error');
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã‚’ææ¡ˆ
                showMessage('ğŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã‚’è©¦ã™ã‹ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
                
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ“¤ å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
                progressContainer.style.display = 'none';
                updateProgress(0);
            }
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆç°¡æ˜“ç‰ˆ - å®Ÿéš›ã¯ OAuth2.0 ãŒå¿…è¦ï¼‰
        async function getAccessToken() {
            // æ³¨æ„: å®Ÿéš›ã®å®Ÿè£…ã§ã¯OAuth2.0ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€åˆ¶é™ãŒã‚ã‚Šã¾ã™
            const apiKey = document.getElementById('apiKey').value;
            return apiKey; // å®Ÿéš›ã¯OAuth2.0ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜
        async function saveToIndexedDB() {
            if (!selectedPhotoFile || !offlineDB) {
                showMessage('âŒ å†™çœŸãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!propertyId || !roomId) {
                showMessage('âŒ ç‰©ä»¶IDã¨éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const photoData = {
                    propertyId: propertyId,
                    roomId: roomId,
                    fileName: selectedPhotoFile.name,
                    fileType: selectedPhotoFile.type,
                    fileSize: selectedPhotoFile.size,
                    photoData: selectedPhotoData,
                    meterReading: document.getElementById('meterReading').value || '',
                    remarks: document.getElementById('remarks').value || '',
                    timestamp: new Date().toISOString(),
                    synced: false
                };
                
                const request = store.add(photoData);
                
                request.onsuccess = () => {
                    showMessage('ğŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜å®Œäº†ï¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«åŒæœŸã§ãã¾ã™ã€‚', 'success');
                    loadOfflineData();
                };
                
                request.onerror = () => {
                    showMessage('âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                };
                
            } catch (error) {
                showMessage(`âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadOfflineData() {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const offlineData = request.result;
                    const offlineList = document.getElementById('offlineList');
                    
                    if (offlineData.length === 0) {
                        offlineList.innerHTML = '<div class="message info">ğŸ“± ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                        return;
                    }
                    
                    offlineList.innerHTML = '<h4>ğŸ“± ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿:</h4>';
                    
                    offlineData.forEach((item, index) => {
                        const syncStatus = item.synced ? 'âœ… åŒæœŸæ¸ˆã¿' : 'â³ æœªåŒæœŸ';
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'message ' + (item.synced ? 'success' : 'warning');
                        itemDiv.innerHTML = `
                            <strong>${item.fileName}</strong><br>
                            ç‰©ä»¶: ${item.propertyId} / éƒ¨å±‹: ${item.roomId}<br>
                            æ—¥æ™‚: ${new Date(item.timestamp).toLocaleString()}<br>
                            çŠ¶æ…‹: ${syncStatus}
                            ${!item.synced ? `<button onclick="syncSingleItem(${item.id})" style="margin-left: 10px;">ğŸ”„ åŒæœŸ</button>` : ''}
                        `;
                        offlineList.appendChild(itemDiv);
                    });
                };
                
            } catch (error) {
                console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncOfflineData() {
            if (!offlineDB) {
                showMessage('âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            if (!navigator.onLine) {
                showMessage('âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = 'ğŸ”„ åŒæœŸä¸­...';
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.index('timestamp').getAll();
                
                request.onsuccess = async () => {
                    const unsyncedData = request.result.filter(item => !item.synced);
                    
                    if (unsyncedData.length === 0) {
                        showMessage('ğŸ“± åŒæœŸãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', 'info');
                        return;
                    }
                    
                    showMessage(`ğŸ”„ ${unsyncedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...`, 'info');
                    
                    for (const item of unsyncedData) {
                        try {
                            // å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ ã®åŒæœŸå‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
                            await syncSingleItemData(item);
                            
                            // åŒæœŸå®Œäº†ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                            const updateTransaction = offlineDB.transaction(['photos'], 'readwrite');
                            const updateStore = updateTransaction.objectStore('photos');
                            item.synced = true;
                            updateStore.put(item);
                            
                        } catch (syncError) {
                            showMessage(`âŒ ${item.fileName} ã®åŒæœŸã«å¤±æ•—: ${syncError.message}`, 'error');
                        }
                    }
                    
                    showMessage('âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    loadOfflineData();
                };
                
            } catch (error) {
                showMessage(`âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.textContent = 'ğŸ”„ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ';
            }
        }

        // å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncSingleItemData(item) {
            // ã“ã®é–¢æ•°ã§Google Drive APIã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨GAS URLé€ä¿¡ã‚’å®Ÿè¡Œ
            // uploadPhoto() ã®å‡¦ç†ã‚’ãƒ™ãƒ¼ã‚¹ã«å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ç”¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
            console.log('å€‹åˆ¥åŒæœŸ:', item);
            // å®Ÿè£…ã¯ uploadPhoto() é–¢æ•°ã¨åŒæ§˜ã®å‡¦ç†
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function updateStep(stepNumber) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
        }

        function showMessage(text, type = 'info') {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
            messages.appendChild(messageDiv);
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            messageDiv.scrollIntoView({ behavior: 'smooth' });
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤šããªã‚Šã™ããŸå ´åˆã®åˆ¶é™
            const allMessages = messages.querySelectorAll('.message');
            if (allMessages.length > 50) {
                allMessages[0].remove();
            }
        }

        function clearForm() {
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoInfo').innerHTML = '';
            document.getElementById('meterReading').value = '';
            document.getElementById('remarks').value = '';
            
            selectedPhotoFile = null;
            selectedPhotoData = null;
            
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('saveOfflineBtn').disabled = true;
            
            updateStep(2);
            showMessage('ğŸ—‘ï¸ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'info');
        }

        function clearLog() {
            document.getElementById('messages').innerHTML = '';
            showMessage('ğŸ“ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'info');
        }
        
        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ åŒæœŸ
        async function syncSingleItem(itemId) {
            if (!offlineDB) return;
            
            try {
                const transaction = offlineDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.get(itemId);
                
                request.onsuccess = async () => {
                    const item = request.result;
                    if (item) {
                        await syncSingleItemData(item);
                        item.synced = true;
                        store.put(item);
                        loadOfflineData();
                        showMessage(`âœ… ${item.fileName} ã‚’åŒæœŸã—ã¾ã—ãŸã€‚`, 'success');
                    }
                };
                
            } catch (error) {
                showMessage(`âŒ å€‹åˆ¥åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
