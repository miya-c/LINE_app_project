<!DOCTYPE html>
<html lang="ja">
<head>
  <title>📊 スプレッドシート接続テスト v20250614c</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #007bff;
    }
    .header h1 {
      color: #007bff;
      font-size: 2.5em;
      margin: 0;
    }
    .header p {
      color: #666;
      font-size: 1.1em;
      margin: 10px 0 0 0;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: #f8f9fa;
    }
    .test-section h3 {
      color: #495057;
      margin: 0 0 15px 0;
      font-size: 1.3em;
    }
    .status {
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.loading {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .status.success {
      background: #d1edff;
      border: 1px solid #74b9ff;
      color: #0984e3;
    }
    .status.error {
      background: #ffe0e0;
      border: 1px solid #ff7675;
      color: #d63031;
    }
    .data-display {
      background: #343a40;
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }
    .test-button:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    .test-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    .summary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .summary h3 {
      color: #8b4513;
      margin: 0 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 スプレッドシート接続テスト</h1>
      <p>Google Sheets連携とデータ読み込み状況を確認</p>
    </div>

    <!-- テスト結果サマリー -->
    <div class="summary">
      <h3>🎯 テスト結果サマリー</h3>
      <div id="overall-status">テスト準備中...</div>
    </div>

    <!-- 1. GAS WebApp URL テスト -->
    <div class="test-section">
      <h3>🔗 1. GAS WebApp URL 接続テスト</h3>
      <button class="test-button" onclick="testGasConnection()">接続テスト実行</button>
      <div id="gas-status" class="status loading">テスト待機中...</div>
      <div id="gas-data" class="data-display" style="display: none;"></div>
    </div>

    <!-- 2. 物件マスタ読み込みテスト -->
    <div class="test-section">
      <h3>🏢 2. 物件マスタ読み込みテスト</h3>
      <button class="test-button" onclick="testGetProperties()">物件データ取得</button>
      <div id="properties-status" class="status loading">テスト待機中...</div>
      <div id="properties-data" class="data-display" style="display: none;"></div>
    </div>

    <!-- 3. 部屋マスタ読み込みテスト -->
    <div class="test-section">
      <h3>🏠 3. 部屋マスタ読み込みテスト</h3>
      <button class="test-button" onclick="testGetRooms()">部屋データ取得</button>
      <div id="rooms-status" class="status loading">テスト待機中...</div>
      <div id="rooms-data" class="data-display" style="display: none;"></div>
    </div>

    <!-- 4. 検針データ読み込みテスト -->
    <div class="test-section">
      <h3>📋 4. 検針データ読み込みテスト</h3>
      <button class="test-button" onclick="testGetMeterReadings()">検針データ取得</button>
      <div id="meter-status" class="status loading">テスト待機中...</div>
      <div id="meter-data" class="data-display" style="display: none;"></div>
    </div>

    <!-- 5. スプレッドシート構造確認 -->
    <div class="test-section">
      <h3>📝 5. スプレッドシート構造確認</h3>
      <button class="test-button" onclick="testSheetStructure()">構造確認</button>
      <div id="structure-status" class="status loading">テスト待機中...</div>
      <div id="structure-data" class="data-display" style="display: none;"></div>
    </div>

    <!-- 全テスト実行ボタン -->
    <div style="text-align: center; margin: 30px 0;">
      <button class="test-button" style="background: #28a745; font-size: 1.1em; padding: 15px 30px;" onclick="runAllTests()">
        🚀 全テスト実行
      </button>
    </div>
  </div>

  <script>
    // GAS WebApp URL（property_select.htmlから取得）
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbzc90nBqci0SDVA7BaV55E1li-SVjYTFO6asIFoK6ZaCXx0KOA0ekL4S3YsxslpwKuo3A/exec';
    
    // テスト結果を保存
    const testResults = {
      gasConnection: null,
      properties: null,
      rooms: null,
      meterReadings: null,
      structure: null
    };

    // ステータス更新ヘルパー
    function updateStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status ${type}`;
      element.textContent = message;
    }

    // データ表示ヘルパー
    function displayData(elementId, data) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.textContent = JSON.stringify(data, null, 2);
    }

    // 1. GAS接続テスト
    async function testGasConnection() {
      updateStatus('gas-status', 'loading', '🔄 GAS WebApp接続テスト中...');
      
      try {
        const response = await fetch(`${gasWebAppUrl}?action=getVersion&_t=${Date.now()}`);
        const data = await response.json();
        
        if (response.ok) {
          testResults.gasConnection = true;
          updateStatus('gas-status', 'success', '✅ GAS WebApp接続成功');
          displayData('gas-data', data);
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        testResults.gasConnection = false;
        updateStatus('gas-status', 'error', `❌ GAS接続失敗: ${error.message}`);
        displayData('gas-data', { error: error.message, url: gasWebAppUrl });
      }
      
      updateOverallStatus();
    }

    // 2. 物件マスタ読み込みテスト
    async function testGetProperties() {
      updateStatus('properties-status', 'loading', '🔄 物件マスタ読み込み中...');
      
      try {
        const response = await fetch(`${gasWebAppUrl}?action=getProperties&_t=${Date.now()}`);
        const data = await response.json();
        
        if (response.ok && !data.error) {
          const count = Array.isArray(data) ? data.length : (data.data ? data.data.length : 0);
          testResults.properties = count;
          updateStatus('properties-status', 'success', `✅ 物件マスタ読み込み成功 (${count}件)`);
          displayData('properties-data', data);
        } else {
          throw new Error(data.error || '物件データ取得失敗');
        }
      } catch (error) {
        testResults.properties = false;
        updateStatus('properties-status', 'error', `❌ 物件マスタ読み込み失敗: ${error.message}`);
        displayData('properties-data', { error: error.message });
      }
      
      updateOverallStatus();
    }

    // 3. 部屋マスタ読み込みテスト
    async function testGetRooms() {
      updateStatus('rooms-status', 'loading', '🔄 部屋マスタ読み込み中...');
      
      try {
        // テスト用物件ID（パルハイツ平田）
        const testPropertyId = 'P000001';
        const response = await fetch(`${gasWebAppUrl}?action=getRooms&propertyId=${testPropertyId}&_t=${Date.now()}`);
        const data = await response.json();
        
        if (response.ok && !data.error) {
          const count = Array.isArray(data) ? data.length : (data.data ? data.data.length : 0);
          testResults.rooms = count;
          updateStatus('rooms-status', 'success', `✅ 部屋マスタ読み込み成功 (${count}件) - 物件: ${testPropertyId}`);
          displayData('rooms-data', data);
        } else {
          throw new Error(data.error || '部屋データ取得失敗');
        }
      } catch (error) {
        testResults.rooms = false;
        updateStatus('rooms-status', 'error', `❌ 部屋マスタ読み込み失敗: ${error.message}`);
        displayData('rooms-data', { error: error.message });
      }
      
      updateOverallStatus();
    }

    // 4. 検針データ読み込みテスト（強化版）
    async function testGetMeterReadings() {
      updateStatus('meter-status', 'loading', '🔄 検針データ読み込み中...');
      
      try {
        // テスト用データ（パルハイツ平田 101号室）
        const testPropertyId = 'P000001';
        const testRoomId = 'R000001';
        const fetchUrl = `${gasWebAppUrl}?action=getMeterReadings&propertyId=${testPropertyId}&roomId=${testRoomId}&_t=${Date.now()}`;
        
        console.log('[Test] Meter readings fetch URL:', fetchUrl);
        
        const response = await fetch(fetchUrl);
        const data = await response.json();
        
        console.log('[Test] Meter readings response:', data);
        console.log('[Test] Response type:', typeof data);
        console.log('[Test] Response isArray:', Array.isArray(data));
        
        if (response.ok && !data.error) {
          let readings;
          let actualDataPayload;
          
          // 統一レスポンス判定処理（meter_reading.htmlと同じロジック）
          if (data && data.success === true && Array.isArray(data.data)) {
            actualDataPayload = { 
              readings: data.data,
              debugInfo: data.debugInfo || {}
            };
            console.log('[Test] ✅ 統一形式採用 - データ件数:', data.data.length);
          }
          else if (data && Array.isArray(data.readings)) {
            actualDataPayload = data;
            console.log('[Test] ⚠️ readings形式採用');
          }
          else if (Array.isArray(data)) {
            actualDataPayload = { 
              readings: data, 
              debugInfo: { directArray: true }
            };
            console.log('[Test] ⚠️ 直接配列形式採用');
          }
          else {
            console.error('[Test] ❌ すべてのパターンに該当しない:', data);
            throw new Error('検針データの形式が認識できません');
          }
          
          readings = actualDataPayload.readings;
          const count = Array.isArray(readings) ? readings.length : 0;
          
          testResults.meterReadings = count;
          updateStatus('meter-status', 'success', `✅ 検針データ読み込み成功 (${count}件) - 部屋: ${testPropertyId}/${testRoomId}`);
          
          // より詳細な表示情報
          const detailedData = {
            originalResponse: data,
            processedData: actualDataPayload,
            readingsCount: count,
            readingsContent: readings,
            debugInfo: actualDataPayload.debugInfo,
            testParams: { testPropertyId, testRoomId, fetchUrl }
          };
          
          displayData('meter-data', detailedData);
        } else {
          throw new Error(data.error || '検針データ取得失敗');
        }
      } catch (error) {
        testResults.meterReadings = false;
        updateStatus('meter-status', 'error', `❌ 検針データ読み込み失敗: ${error.message}`);
        displayData('meter-data', { error: error.message });
      }
      
      updateOverallStatus();
    }

    // 5. スプレッドシート構造確認（代理的にエラーメッセージから推測）
    async function testSheetStructure() {
      updateStatus('structure-status', 'loading', '🔄 スプレッドシート構造確認中...');
      
      try {
        // 複数のAPIを実行してシート存在を確認
        const tests = [
          { name: '物件マスタ', action: 'getProperties' },
          { name: '部屋マスタ', action: 'getRooms', params: '&propertyId=P000001' },
          { name: '検針データ', action: 'getMeterReadings', params: '&propertyId=P000001&roomId=R000001' }
        ];
        
        const results = {};
        
        for (const test of tests) {
          try {
            const url = `${gasWebAppUrl}?action=${test.action}${test.params || ''}&_t=${Date.now()}`;
            const response = await fetch(url);
            const data = await response.json();
            
            results[test.name] = {
              status: response.ok && !data.error ? '✅ 正常' : '❌ エラー',
              error: data.error || null,
              available: response.ok && !data.error
            };
          } catch (error) {
            results[test.name] = {
              status: '❌ エラー',
              error: error.message,
              available: false
            };
          }
        }
        
        const availableSheets = Object.values(results).filter(r => r.available).length;
        testResults.structure = availableSheets;
        
        updateStatus('structure-status', 'success', `✅ スプレッドシート構造確認完了 (${availableSheets}/3 シート利用可能)`);
        displayData('structure-data', results);
        
      } catch (error) {
        testResults.structure = false;
        updateStatus('structure-status', 'error', `❌ 構造確認失敗: ${error.message}`);
        displayData('structure-data', { error: error.message });
      }
      
      updateOverallStatus();
    }

    // 全体ステータス更新
    function updateOverallStatus() {
      const overallElement = document.getElementById('overall-status');
      const completedTests = Object.values(testResults).filter(r => r !== null).length;
      const successfulTests = Object.values(testResults).filter(r => r !== null && r !== false).length;
      
      if (completedTests === 0) {
        overallElement.textContent = 'テスト準備中...';
        return;
      }
      
      const percentage = Math.round((successfulTests / 5) * 100);
      const status = percentage >= 80 ? '🟢 良好' : percentage >= 60 ? '🟡 注意' : '🔴 問題あり';
      
      overallElement.innerHTML = `
        <strong>${status}</strong> - 
        成功: ${successfulTests}/5 テスト (${percentage}%)<br>
        <small>完了: ${completedTests}/5 テスト</small>
      `;
    }

    // 全テスト実行
    async function runAllTests() {
      console.log('🚀 全テスト実行開始');
      
      // ボタンを無効化
      const buttons = document.querySelectorAll('.test-button');
      buttons.forEach(btn => btn.disabled = true);
      
      try {
        await testGasConnection();
        await new Promise(resolve => setTimeout(resolve, 500)); // 500ms待機
        
        await testGetProperties();
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await testGetRooms();
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await testGetMeterReadings();
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await testSheetStructure();
        
        console.log('🎉 全テスト完了');
        
        // 全テスト完了後にmeter reading画面への直接リンクテストを提案
        showMeterReadingTestOption();
        
      } finally {
        // ボタンを再有効化
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    // Meter Reading画面テストオプション表示
    function showMeterReadingTestOption() {
      const container = document.querySelector('.container');
      
      const testSection = document.createElement('div');
      testSection.className = 'test-section';
      testSection.style.backgroundColor = '#e8f5e8';
      testSection.style.borderColor = '#4caf50';
      
      testSection.innerHTML = `
        <h3>🧪 Meter Reading画面 直接テスト</h3>
        <p>スプレッドシート接続が正常な場合、実際のmeter reading画面をテストできます。</p>
        <div style="margin: 15px 0;">
          <button class="test-button" onclick="testMeterReadingPage()" style="background: #4caf50;">
            🔗 Meter Reading画面を開く (テスト用パラメータ)
          </button>
          <button class="test-button" onclick="openPropertySelect()" style="background: #2196f3;">
            🏠 Property Select画面を開く
          </button>
        </div>
        <div id="meter-test-status" class="status" style="display: none;"></div>
      `;
      
      container.appendChild(testSection);
    }

    // Meter Reading画面を直接テスト
    function testMeterReadingPage() {
      // テスト用パラメータでmeter reading画面を開く
      const testUrl = `meter_reading.html?propertyId=P000001&propertyName=パルハイツ平田&roomId=R000001&roomName=101号室&debug=true`;
      
      const statusDiv = document.getElementById('meter-test-status');
      statusDiv.className = 'status loading';
      statusDiv.style.display = 'block';
      statusDiv.textContent = '🔄 Meter Reading画面を開いています...';
      
      // sessionStorageにgasWebAppUrlを設定
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      
      setTimeout(() => {
        statusDiv.className = 'status success';
        statusDiv.innerHTML = `✅ 新しいタブでMeter Reading画面が開きました<br><small>デバッグ情報はブラウザのコンソールで確認してください</small>`;
      }, 1000);
      
      window.open(testUrl, '_blank');
    }

    // Property Select画面を開く
    function openPropertySelect() {
      sessionStorage.setItem('gasWebAppUrl', gasWebAppUrl);
      window.open('property_select.html', '_blank');
    }

    // ページ読み込み時の初期表示
    window.addEventListener('load', () => {
      console.log('📊 スプレッドシート接続テストページ読み込み完了');
      console.log('GAS WebApp URL:', gasWebAppUrl);
      updateOverallStatus();
    });
  </script>
</body>
</html>
