<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤œé‡ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .debug-info { 
            background-color: #e8f4fd; 
            border: 1px solid #bee5eb; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-size: 14px;
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin: 20px 0;
            background-color: white;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            background-color: #f2f2f2; 
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¤œé‡ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="debug-info" id="debug-info">
        <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
        ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...
    </div>

    <button class="test-button" onclick="testWithThreeTimesPrevious()">å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚ã‚Šã§ãƒ†ã‚¹ãƒˆ</button>
    <button class="test-button" onclick="testWithoutThreeTimesPrevious()">å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ãªã—ã§ãƒ†ã‚¹ãƒˆ</button>
    <button class="test-button" onclick="testMixedData()">æ··åˆãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ</button>

    <div id="meter-readings-list">
        <table id="meter-readings-table" style="display: none;">
            <thead>
                <tr>
                    <th>æ¤œé‡æ—¥æ™‚</th>
                    <th>ä»Šå›(ã¥)</th>
                    <th>å‰å›</th>
                    <th>å‰ã€…å›</th>
                    <th>ä»Šå›ä½¿ç”¨é‡</th>
                    <th>çŠ¶æ…‹</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="no-data-message" style="display: none;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <script>
        // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
        const testDataWithThreeTimesPrevious = {
            readings: [
                {
                    date: "2025/05/31",
                    currentReading: "1208",
                    previousReading: "1186",
                    previousPreviousReading: "1170",
                    threeTimesPrevious: "1150",
                    usage: "22",
                    status: "æ­£å¸¸"
                },
                {
                    date: "2025/04/30",
                    currentReading: "1186",
                    previousReading: "1170",
                    previousPreviousReading: "1150",
                    threeTimesPrevious: "1130",
                    usage: "16",
                    status: "æ­£å¸¸"
                }
            ],
            debugInfo: {
                detectedHeaders: ["è¨˜éŒ²ID", "ç‰©ä»¶å", "ç‰©ä»¶ID", "éƒ¨å±‹ID", "éƒ¨å±‹å", "æ¤œé‡æ—¥æ™‚", "è­¦å‘Šãƒ•ãƒ©ã‚°", "æ¨™æº–åå·®å€¤", "ä»Šå›ä½¿ç”¨é‡", "ä»Šå›ã®æŒ‡ç¤ºæ•°", "å‰å›æŒ‡ç¤ºæ•°", "å‰ã€…å›æŒ‡ç¤ºæ•°", "å‰ã€…ã€…å›æŒ‡ç¤ºæ•°", "å†™çœŸURL"],
                headerCount: 14,
                threeTimesPreviousIndex: 12,
                threeTimesPreviousExists: true,
                columnMapping: {
                    "ç‰©ä»¶å": 1,
                    "ç‰©ä»¶ID": 2,
                    "éƒ¨å±‹ID": 3,
                    "æ¤œé‡æ—¥æ™‚": 5,
                    "ä»Šå›ã®æŒ‡ç¤ºæ•°": 9,
                    "å‰å›æŒ‡ç¤ºæ•°": 10,
                    "å‰ã€…å›æŒ‡ç¤ºæ•°": 11,
                    "å‰ã€…ã€…å›æŒ‡ç¤ºæ•°": 12,
                    "ä»Šå›ä½¿ç”¨é‡": 8,
                    "è­¦å‘Šãƒ•ãƒ©ã‚°": 6
                },
                totalDataRows: 2,
                filteredReadings: 2,
                sampleReadingData: {
                    firstReading: {
                        date: "2025/05/31",
                        currentReading: "1208",
                        threeTimesPrevious: "1150"
                    },
                    lastReading: {
                        date: "2025/04/30",
                        currentReading: "1186",
                        threeTimesPrevious: "1130"
                    },
                    hasThreeTimesPrevious: true,
                    threeTimesPreviousValues: ["1150", "1130"],
                    threeTimesPreviousCount: 2
                },
                message: "ã“ã®æƒ…å ±ã¯ãƒ‡ãƒãƒƒã‚°ç”¨ã§ã™ã€‚threeTimesPreviousIndexãŒ-1ã®å ´åˆã€'å‰ã€…ã€…å›æŒ‡ç¤ºæ•°'ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã£ã¦ã„ã¾ã›ã‚“ã€‚"
            }
        };

        const testDataWithoutThreeTimesPrevious = {
            readings: [
                {
                    date: "2025/05/31",
                    currentReading: "1208",
                    previousReading: "1186",
                    previousPreviousReading: "1170",
                    threeTimesPrevious: null,
                    usage: "22",
                    status: "æ­£å¸¸"
                }
            ],
            debugInfo: {
                detectedHeaders: ["è¨˜éŒ²ID", "ç‰©ä»¶å", "ç‰©ä»¶ID", "éƒ¨å±‹ID", "éƒ¨å±‹å", "æ¤œé‡æ—¥æ™‚", "è­¦å‘Šãƒ•ãƒ©ã‚°", "æ¨™æº–åå·®å€¤", "ä»Šå›ä½¿ç”¨é‡", "ä»Šå›ã®æŒ‡ç¤ºæ•°", "å‰å›æŒ‡ç¤ºæ•°", "å‰ã€…å›æŒ‡ç¤ºæ•°", "å†™çœŸURL"],
                headerCount: 13,
                threeTimesPreviousIndex: -1,
                threeTimesPreviousExists: false,
                totalDataRows: 1,
                filteredReadings: 1,
                sampleReadingData: {
                    hasThreeTimesPrevious: false,
                    threeTimesPreviousValues: [],
                    threeTimesPreviousCount: 0
                },
                message: "å‰ã€…ã€…å›æŒ‡ç¤ºæ•°åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            }
        };

        function testWithThreeTimesPrevious() {
            console.log('ğŸ§ª å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚ã‚Šã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
            displayTestData(testDataWithThreeTimesPrevious);
        }

        function testWithoutThreeTimesPrevious() {
            console.log('ğŸ§ª å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ãªã—ã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
            displayTestData(testDataWithoutThreeTimesPrevious);
        }

        function testMixedData() {
            console.log('ğŸ§ª æ··åˆãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
            const mixedData = {
                readings: [
                    testDataWithThreeTimesPrevious.readings[0],
                    {
                        date: "2025/04/30",
                        currentReading: "1186",
                        previousReading: "1170",
                        previousPreviousReading: "1150",
                        threeTimesPrevious: undefined,
                        usage: "16",
                        status: "æ­£å¸¸"
                    }
                ],
                debugInfo: testDataWithThreeTimesPrevious.debugInfo
            };
            displayTestData(mixedData);
        }

        function displayTestData(responseObject) {
            const debugInfoDiv = document.getElementById('debug-info');
            const tableElement = document.getElementById('meter-readings-table');
            const tableBody = tableElement.getElementsByTagName('tbody')[0];
            const noDataMessageElement = document.getElementById('no-data-message');

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º (meter_reading.htmlã‹ã‚‰ç§»æ¤)
            const readings = responseObject.readings;
            const debugInfo = responseObject.debugInfo;

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
            if (debugInfo) {
                console.log('[test] Server Debug Info:', debugInfo);
                debugInfoDiv.innerHTML = `<p><strong>ğŸ“Š Server Debug Info:</strong><br>
                  <strong>ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:</strong><br>
                  &nbsp;&nbsp;æ¤œå‡ºã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼æ•°: ${debugInfo.headerCount || 'N/A'}<br>
                  &nbsp;&nbsp;ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§: ${JSON.stringify(debugInfo.detectedHeaders || [])}<br>
                  <strong>å‰ã€…ã€…å›æŒ‡ç¤ºæ•°åˆ—:</strong><br>
                  &nbsp;&nbsp;åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${debugInfo.threeTimesPreviousIndex !== undefined ? debugInfo.threeTimesPreviousIndex : 'N/A'}<br>
                  &nbsp;&nbsp;åˆ—ãŒå­˜åœ¨: ${debugInfo.threeTimesPreviousExists ? 'ã¯ã„' : 'ã„ã„ãˆ'}<br>
                  <strong>åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°:</strong><br>
                  ${debugInfo.columnMapping ? Object.entries(debugInfo.columnMapping).map(([col, index]) => 
                    `&nbsp;&nbsp;${col}: ${index !== -1 ? index : 'è¦‹ã¤ã‹ã‚‰ãš'}`).join('<br>') : 'ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ãªã—'}<br>
                  <strong>ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:</strong><br>
                  &nbsp;&nbsp;ç·ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${debugInfo.totalDataRows || 'N/A'}<br>
                  &nbsp;&nbsp;ãƒ•ã‚£ãƒ«ã‚¿å¾Œèª­ã¿å–ã‚Šæ•°: ${debugInfo.filteredReadings || 'N/A'}<br>
                  <strong>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿åˆ†æ:</strong><br>
                  ${debugInfo.sampleReadingData ? `
                    &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚’æŒã¤èª­ã¿å–ã‚Š: ${debugInfo.sampleReadingData.hasThreeTimesPrevious ? 'ã‚ã‚Š' : 'ãªã—'}<br>
                    &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã®å€¤ã®æ•°: ${debugInfo.sampleReadingData.threeTimesPreviousCount || 0}<br>
                    &nbsp;&nbsp;å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã®å€¤: ${JSON.stringify(debugInfo.sampleReadingData.threeTimesPreviousValues || [])}<br>
                    &nbsp;&nbsp;æœ€åˆã®èª­ã¿å–ã‚Š: ${JSON.stringify(debugInfo.sampleReadingData.firstReading || {})}<br>
                    &nbsp;&nbsp;æœ€å¾Œã®èª­ã¿å–ã‚Š: ${JSON.stringify(debugInfo.sampleReadingData.lastReading || {})}
                  ` : '&nbsp;&nbsp;ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—'}<br>
                  <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${debugInfo.message || ''}</p>`;
            }

            // å„readingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®threeTimesPreviousã®å€¤ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ›
            console.log('[test] å…¨èª­æ›¸ãƒ‡ãƒ¼ã‚¿ã®threeTimesPreviousè©³ç´°ãƒã‚§ãƒƒã‚¯:');
            if (Array.isArray(readings)) {
                readings.forEach((reading, index) => {
                    console.log(`  èª­æ›¸[${index}] - date: ${reading.date}, threeTimesPrevious: ${reading.threeTimesPrevious} (type: ${typeof reading.threeTimesPrevious})`);
                });
            }

            if (Array.isArray(readings) && readings.length > 0) {
                tableElement.style.display = '';
                noDataMessageElement.style.display = 'none';
                tableBody.innerHTML = ''; 

                readings.forEach(reading => {
                    console.log('[test] Processing reading object:', JSON.stringify(reading));
                    const row = tableBody.insertRow();

                    // æ—¥ä»˜ã‚»ãƒ«
                    const dateCell = row.insertCell();
                    dateCell.textContent = reading.date;

                    // ä»Šå›æŒ‡ç¤ºæ•°ã‚»ãƒ«
                    const currentReadingCell = row.insertCell();
                    currentReadingCell.textContent = reading.currentReading || 'N/A';

                    const prevReadingCell = row.insertCell();
                    let prevReadingText = reading.previousReading || 'N/A';

                    const prevPrevReadingCell = row.insertCell();
                    let prevPrevReadingText = reading.previousPreviousReading || 'N/A';

                    // å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ã‚’å–å¾—
                    const prevPrevPrevReadingText = reading.threeTimesPrevious || 'N/A';

                    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                    console.log(`[test] å·®åˆ†è¨ˆç®—å‰ãƒ‡ãƒ¼ã‚¿ç¢ºèª (æ—¥ä»˜: ${reading.date}):`);
                    console.log(`  reading.previousReading: ${reading.previousReading}`);
                    console.log(`  reading.previousPreviousReading: ${reading.previousPreviousReading}`);
                    console.log(`  reading.threeTimesPrevious: ${reading.threeTimesPrevious}`);
                    console.log(`  prevPrevReadingText (åˆæœŸå€¤): ${prevPrevReadingText}`);
                    console.log(`  prevPrevPrevReadingText: ${prevPrevPrevReadingText}`);

                    if (reading.threeTimesPrevious === undefined) {
                        console.warn(`[test] å‰ã€…ã€…å›æŒ‡ç¤ºæ•°ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚`);
                    }

                    const prev = parseFloat(reading.previousReading);
                    const prevPrev = parseFloat(reading.previousPreviousReading);
                    const prevPrevPrev = parseFloat(reading.threeTimesPrevious);

                    // è¿½åŠ ãƒ­ã‚°: parseFloatå¾Œã®å€¤
                    console.log(`  parseFloat(reading.previousPreviousReading) -> prevPrev: ${prevPrev}`);
                    console.log(`  parseFloat(reading.threeTimesPrevious) -> prevPrevPrev: ${prevPrevPrev}`);

                    // å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—ã¨è¡¨ç¤º
                    if (prevPrevReadingText !== 'N/A' && prevPrevPrevReadingText !== 'N/A' && !isNaN(prevPrev) && !isNaN(prevPrevPrev)) {
                        const diff = prevPrev - prevPrevPrev;
                        prevPrevReadingText += ` [${diff >= 0 ? '+' : ''}${diff}]`;
                        console.log(`  å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—çµæœ: diff=${diff}, æ›´æ–°å¾ŒprevPrevReadingText=${prevPrevReadingText}`);
                    } else {
                        console.log(`  å‰ã€…å›ã¨å‰ã€…ã€…å›ã®å·®åˆ†è¨ˆç®—ã‚¹ã‚­ãƒƒãƒ—:`);
                        console.log(`    prevPrevReadingText !== 'N/A': ${prevPrevReadingText !== 'N/A'} (å€¤: ${prevPrevReadingText})`);
                        console.log(`    prevPrevPrevReadingText !== 'N/A': ${prevPrevPrevReadingText !== 'N/A'} (å€¤: ${prevPrevPrevReadingText})`);
                        console.log(`    !isNaN(prevPrev): ${!isNaN(prevPrev)} (å€¤: ${prevPrev})`);
                        console.log(`    !isNaN(prevPrevPrev): ${!isNaN(prevPrevPrev)} (å€¤: ${prevPrevPrev})`);
                    }

                    // å‰å›ã¨å‰ã€…å›ã®å·®åˆ†è¨ˆç®—ã¨è¡¨ç¤º
                    if (prevReadingText !== 'N/A' && (reading.previousPreviousReading || 'N/A') !== 'N/A' && !isNaN(prev) && !isNaN(prevPrev)) {
                        const diff = prev - prevPrev;
                        prevReadingText += ` [${diff >= 0 ? '+' : ''}${diff}]`;
                    }

                    prevReadingCell.textContent = prevReadingText;
                    prevPrevReadingCell.textContent = prevPrevReadingText;

                    const usageCell = row.insertCell();
                    usageCell.textContent = reading.usage || 'N/A';

                    const statusCell = row.insertCell();
                    statusCell.textContent = reading.status || 'N/A';
                });
            } else {
                tableElement.style.display = 'none';
                noDataMessageElement.style.display = 'block';
                noDataMessageElement.textContent = 'è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            testWithThreeTimesPrevious();
        });
    </script>
</body>
</html>
