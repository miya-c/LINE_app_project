<!DOCTYPE html>
<html lang="ja">
<head>
  <title>物件選択 - 水道メーター読み取りアプリ</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- キャッシュコントロール メタタグ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- PWA メタタグ -->
  <meta name="description" content="水道メーターの読み取りを管理するアプリケーション">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="メーター読み取り">
  <meta name="msapplication-TileColor" content="#007bff">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  
  <!-- WOFF SDK removed for general browser compatibility -->
  
  <!-- クリティカルCSS (インライン) - 初回表示の改善 -->
  <style>
    /* Critical CSS for immediate styling */
    * { box-sizing: border-box; }
    body { 
      margin: 0; padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6; 
      background: linear-gradient(135deg, #f0f4f8 0%, #e1e8ed 100%);
      min-height: 100vh;
      font-size: 16px; /* ベースフォントサイズを追加 */
    }
    #root { 
      min-height: 100vh; 
      background: linear-gradient(135deg, #f0f4f8 0%, #e1e8ed 100%); 
    }
    .loading-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f4f8; }
    .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .mantine-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .mantine-stack { display: flex; flex-direction: column; gap: 16px; }
    .mantine-title { 
      font-size: 32px; font-weight: 700; margin: 0 0 32px 0; 
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center; 
      position: relative;
    }
    .mantine-title::after {
      content: '';
      position: absolute;
      bottom: -8px; left: 50%; transform: translateX(-50%);
      width: 60px; height: 3px;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border-radius: 2px;
    }
    .mantine-text-input { margin-bottom: 20px; }
    .mantine-text-input input { 
      width: 100%; padding: 18px 20px; border: 2px solid #e9ecef; border-radius: 16px; 
      font-size: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      box-shadow: 
        0 2px 8px rgba(0,0,0,0.04),
        inset 0 1px 2px rgba(0,0,0,0.02);
    }
    .mantine-text-input input:focus { 
      outline: none; 
      border-color: #007bff; 
      box-shadow: 
        0 0 0 4px rgba(0,123,255,0.15),
        0 4px 12px rgba(0,123,255,0.1); 
      background: #ffffff;
      transform: translateY(-1px);
    }
    .mantine-alert { 
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); 
      border: 1px solid #fecaca; border-radius: 16px; 
      padding: 20px; color: #b91c1c; 
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.1);
    }
    .mantine-center { display: flex; justify-content: center; align-items: center; }
    .mantine-loader { 
      width: 24px; height: 24px; border: 2px solid #e9ecef; 
      border-top: 2px solid #007bff; border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    /* Property Card Styles */
    .mantine-paper { 
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); 
      border-radius: 20px; /* 16px → 20px 丸みを強調 */
      padding: 20px; 
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.08),
        0 1px 3px rgba(0,0,0,0.05); 
      border: 1px solid rgba(255,255,255,0.8); 
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .mantine-paper::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(145deg, rgba(0,123,255,0.03) 0%, rgba(0,123,255,0.01) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 20px; /* 角丸を一致させる */
    }
    .mantine-paper:hover::before {
      opacity: 1;
    }
    .mantine-paper:hover { 
      transform: translateY(-4px) scale(1.02); 
      box-shadow: 
        0 12px 32px rgba(0,123,255,0.15),
        0 4px 12px rgba(0,0,0,0.1); 
      border-color: rgba(0,123,255,0.3); 
    }
    .mantine-paper.disabled { 
      opacity: 0.6; cursor: not-allowed; 
    }
    .property-card { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      gap: 16px; /* 要素間の間隔を追加 */
    }
    .property-info { flex: 1; }
    .property-id { 
      font-size: 14px; color: #495057; font-weight: 600; 
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
      padding: 6px 10px; border-radius: 8px; 
      display: inline-block; margin-bottom: 10px;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .property-name-row { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      flex-wrap: wrap; gap: 8px; 
      min-height: auto; 
    }
    .completion-date { 
      font-size: 12px; color: #ffffff; font-weight: 600; 
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
      padding: 6px 10px; border-radius: 12px; 
      white-space: nowrap; 
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
      border: 1px solid rgba(255,255,255,0.3);
    }
    .property-arrow { 
      width: 24px; height: 24px; color: #6c757d; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      margin-left: 16px; 
      flex-shrink: 0; /* アイコンのサイズを固定 */
      margin-top: 4px; /* 少し上にオフセット */
    }
    .mantine-paper:hover .property-arrow { 
      color: #007bff; 
      transform: translateX(4px) rotate(5deg);
    }
    /* Responsive design */
    @media (max-width: 768px) { 
      .mantine-container { padding: 16px; } 
      .mantine-title { font-size: 32px; margin-bottom: 24px; } /* 28px → 32px */
      .mantine-paper { padding: 20px; border-radius: 18px; } /* 16px → 20px → 18px */
      .property-id { font-size: 14px; padding: 6px 10px; } /* 12px → 14px */
      .completion-date { font-size: 12px; padding: 6px 10px; } /* 11px → 12px */
      .mantine-text-input input { padding: 18px 20px; } /* 16px → 18px */
      .property-name-row { flex-direction: column; align-items: flex-start; }
    }
    
    /* Extra small devices - very long property names */
    @media (max-width: 480px) {
      .mantine-paper { padding: 16px; border-radius: 14px; } /* 12px → 16px, 丸みも調整 */
      .property-id { font-size: 13px; padding: 6px 10px; } /* 12px → 13px */
      .mantine-title { font-size: 28px; } /* 新規追加 */
    }
    
    /* Styles loading state management */
    .styles-loading { 
      opacity: 0; 
      transform: translateY(20px);
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .styles-loaded { 
      opacity: 1; 
      transform: translateY(0);
    }
    
    /* Fade-in animation for cards */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .mantine-paper {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .mantine-paper:nth-child(1) { animation-delay: 0.1s; }
    .mantine-paper:nth-child(2) { animation-delay: 0.2s; }
    .mantine-paper:nth-child(3) { animation-delay: 0.3s; }
    .mantine-paper:nth-child(4) { animation-delay: 0.4s; }
    .mantine-paper:nth-child(5) { animation-delay: 0.5s; }
  </style>
  
  <!-- 重要: CSS ファイルを最初に読み込む (レンダリングブロッキング) -->
  <script>
    // 動的 CSS キャッシュバスティング
    const timestamp = Date.now();
    document.write(`<link rel="stylesheet" href="../../css_styles/meter_reading.css?t=${timestamp}">`);
    document.write(`<link rel="stylesheet" href="../../css_styles/pwa-styles.css?t=${timestamp}">`);
  </script>
  
  <!-- CSS プリロード (パフォーマンス向上) -->
  <script>
    // 動的 CSS プリロード
    const ts = Date.now();
    document.write(`<link rel="preload" href="../../css_styles/meter_reading.css?t=${ts}" as="style">`);
    document.write(`<link rel="preload" href="../../css_styles/pwa-styles.css?t=${ts}" as="style">`);
  </script>
  
  <!-- ReactとReactDOMのCDN (Cache Busting Version) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- BabelのCDN (JSXをブラウザで変換するため) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- PWA Utilities -->
  <script src="/pwa-utils.js"></script>
  
  <!-- 動的CSS読み込みヘルパー -->
  <script>
    // 開発用動的CSS読み込み機能
    window.reloadCSS = function() {
      const timestamp = Date.now();
      const cssLinks = document.querySelectorAll('link[rel="stylesheet"]');
      cssLinks.forEach(link => {
        const href = link.href.split('?')[0]; // クエリパラメータを除去
        link.href = `${href}?t=${timestamp}`;
      });
      console.log(`[CSS] スタイルシートをリロードしました: ${timestamp}`);
    };
    
    // 開発用: CSSファイル監視（10秒間隔）
    if (window.location.search.includes('devmode=true')) {
      setInterval(window.reloadCSS, 10000);
      console.log('[CSS] 開発モード: 10秒間隔でCSSを自動リロードします');
    }
  </script>
</head>
<body>
  <div id="root" class="styles-loading"></div>

  <link rel="stylesheet" href="../../css_styles/property_select.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="../../css_styles/room_select.css"><!-- Material UI変数・共通色用 -->

  <!-- Material UI AppBar -->
  <header class="MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic mui-elevation-4" role="banner">
    <nav class="MuiToolbar-root MuiToolbar-regular" aria-label="物件選択ナビゲーション">
      <button class="MuiIconButton-root MuiIconButton-colorInherit" onclick="window.location.href='/'" aria-label="戻る">
        <span class="material-icons MuiSvgIcon-root">arrow_back</span>
      </button>
      <span class="MuiTypography-root MuiTypography-h6 app-title" aria-label="画面タイトル">物件選択</span>
    </nav>
  </header>

  <main class="MuiContainer-root MuiContainer-maxWidthLg" style="padding-top:32px;">
    <!-- エラーアラート -->
    <div class="MuiAlert-root MuiAlert-standardError" id="errorMessage" style="display:none;">
      <span class="MuiAlert-icon"><span class="material-icons MuiSvgIcon-root">error</span></span>
      <span class="MuiAlert-message" id="errorText"></span>
    </div>
    <!-- ローディング -->
    <div class="loading-container" id="loading">
      <span class="MuiCircularProgress-root" aria-label="読み込み中"></span>
      <span class="MuiTypography-root MuiTypography-body1">物件データを読み込み中...</span>
    </div>
    <!-- 物件グリッド -->
    <section class="property-grid" id="propertyGrid" style="display:none;" aria-label="物件一覧"></section>
  </main>

<script>
    // 🦁 Brave Browser Cache Busting Version 20250614c
    // WOFF完全削除済み - 一般ブラウザ専用
    // CSS読み込み完了待機機能追加
    
    console.log('🚀 Property Select App v20250615a - Debug Mode Enabled (FIXED)');
    console.log('WOFF Status:', typeof woff !== 'undefined' ? '❌ ERROR: WOFF still loaded!' : '✅ WOFF successfully removed');
    console.log('🔧 Enhanced Debug Mode Active for data flow tracking');
    console.log('🔧 Cache Busting Active: Forcing latest version');
    
    // CSS読み込み完了を待機する関数（改良版）
    function waitForStylesLoaded() {
      return new Promise((resolve) => {
        const check = () => {
          const root = document.getElementById('root');
          if (root && getComputedStyle(root).opacity !== '0.3') {
            root.classList.remove('styles-loading');
            root.classList.add('styles-loaded');
            resolve();
          } else {
            setTimeout(check, 50);
          }
        };
        check();
      });
    }

    const App = () => {
      const [properties, setProperties] = React.useState([]);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [isNavigating, setIsNavigating] = React.useState(false);
      const [navigationMessage, setNavigationMessage] = React.useState('');
      const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbzzK3mKFuP8KT5l_irp0kMPJv4-zZUUQSCG2ssVYlTmg9wtDwSZUAJ3eIQD1vbH4jKXQQ/exec';

      // 検針完了日フォーマット関数
      const formatCompletionDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
      };

      React.useEffect(() => {
        setLoading(true);
        setError(null);
        fetch(gasWebAppUrl + '?action=getProperties')
          .then((res) => {
            if (!res.ok) throw new Error('物件データの取得に失敗しました');
            return res.json();
          })
          .then((data) => {
            setProperties(Array.isArray(data) ? data : []);
            setLoading(false);
          })
          .catch((e) => {
            setError(e.message);
            setLoading(false);
          });
      }, [gasWebAppUrl]);

      const handleSearchChange = (event) => {
        setSearchTerm(event.target.value);
      };

      const handlePropertySelect = async (property) => {
        setIsNavigating(true);
        setNavigationMessage('部屋一覧に移動中...');
        // 遷移先URL例: room_select.html?propertyId=xxx
        window.location.href = `room_select.html?propertyId=${encodeURIComponent(property.id)}`;
      };

      // LoadingOverlayコンポーネント（モダンデザイン版）
      const LoadingOverlay = ({ message }) => (
        <div className="loading-overlay">
          <div className="loading-overlay-content">
            <div className="mantine-loader" />
            <div style={{ marginTop: 16, fontSize: '1.1rem', color: '#555' }}>{message}</div>
          </div>
        </div>
      );

      const filteredProperties = properties.filter(property => {
        if (!searchTerm) return true;
        return (
          (property.name && property.name.includes(searchTerm)) ||
          (property.id && property.id.includes(searchTerm))
        );
      });

      // 物件データ取得中の初期ローディング
      if (loading && properties.length === 0) {
        return <LoadingOverlay message="物件データを取得中..." />;
      }

      // 物件データ取得エラー (初期ロード時)
      if (error && properties.length === 0) {
        return (
          <div className="mantine-container mantine-stack center">
            <div className="mantine-alert">{error}</div>
          </div>
        );
      }

      return (
        <div className="mantine-container">
          {/* AppBar */}
          <header className="MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic mui-elevation-4" role="banner">
            <nav className="MuiToolbar-root MuiToolbar-regular" aria-label="物件選択ナビゲーション">
              <span className="app-title" style={{ flex: 1, textAlign: 'center' }}>物件一覧</span>
            </nav>
          </header>

          {/* 検索ボックス */}
          <div className="mantine-text-input" style={{ margin: '32px 0 0 0' }}>
            <input
              type="text"
              placeholder="物件名またはIDで検索"
              value={searchTerm}
              onChange={handleSearchChange}
              aria-label="物件検索"
              style={{ fontSize: '1.1rem', padding: '12px 16px', borderRadius: 8, border: '1.5px solid #ddd', width: '100%' }}
            />
          </div>

          {/* エラー表示 */}
          {error && (
            <div className="mantine-alert" style={{ marginBottom: 16 }}>{error}</div>
          )}

          {/* ローディングオーバーレイ（遷移時） */}
          {isNavigating && <LoadingOverlay message={navigationMessage || '遷移中...'} />}

          {/* 物件グリッド */}
          <section className="property-grid" aria-label="物件一覧">
            {filteredProperties.length === 0 ? (
              <div className="no-rooms-message">該当する物件がありません</div>
            ) : (
              filteredProperties.map((property, idx) => (
                <div
                  key={property.id || idx}
                  className="property-card"
                  tabIndex={0}
                  role="button"
                  aria-label={`物件 ${property.name || ''}`}
                  onClick={() => handlePropertySelect(property)}
                  onKeyDown={e => { if (e.key === 'Enter' || e.key === ' ') handlePropertySelect(property); }}
                  style={{ animation: `fadeInUp 0.4s ease ${0.1 * idx}s both` }}
                >
                  <div className="property-info-row">
                    <span className="material-icons property-icon" aria-hidden="true">home_work</span>
                    <span className="property-name-row">
                      <span className="property-name">{property.name}</span>
                      <span className="property-id">{property.id}</span>
                    </span>
                  </div>
                  {property.completionDate && (
                    <div className="completion-date" style={{ color: '#888', fontSize: '0.95rem', marginLeft: 56, marginBottom: 8 }}>
                      完了日: {formatCompletionDate(property.completionDate)}
                    </div>
                  )}
                  <span className="property-arrow material-icons" aria-hidden="true" style={{ position: 'absolute', right: 18, top: '50%', transform: 'translateY(-50%)', color: '#007bff', fontSize: '2rem' }}>arrow_forward_ios</span>
                </div>
              ))
            )}
          </section>
        </div>
      );
    };

    // CSS読み込み完了後にアプリを起動
    waitForStylesLoaded().then(() => {
      console.log('🎨 物件選択アプリ起動: CSS読み込み完了後に実行');
      // Use React 18 createRoot API instead of ReactDOM.render
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    });
  </script>
  
  <!-- PWA初期化スクリプト -->
  <script>
    // PWA機能の初期化
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[PWA] Property Select page loaded with PWA support');
      
      // Service Worker登録（既にpwa-utils.jsで実行されるが、確実性のため）
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('[PWA] Service Worker registered from property select page');
            })
            .catch(error => {
              console.error('[PWA] Service Worker registration failed:', error);
            });
        });
      }
      
      // PWAインストール状態の確認
      if (window.pwaUtils) {
        const appInfo = window.pwaUtils.getAppInfo();
        console.log('[PWA] App info:', appInfo);
        
        // インストール済みの場合、UI調整
        if (appInfo.isInstalled) {
          document.body.classList.add('pwa-installed');
        }
        
        // オフライン状態の場合、警告表示
        if (!appInfo.isOnline) {
          window.pwaUtils.showNetworkStatus('オフライン', 'warning');
        }
      }
    });
  </script>
</body>
</html>