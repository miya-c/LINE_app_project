<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部屋選択 - 水道メーター読み取りアプリ</title>
    <!-- Robotoフォント & Material Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Material UI風CSS -->
    <link rel="stylesheet" href="../../css_styles/room_select.css">
    <style>
      body { font-family: 'Roboto', 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background: #f0f4f8; }
      .app-header {
        background: #1976d2;
        color: #fff;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
        display: flex; align-items: center; height: 64px; padding: 0 24px;
      }
      .back-button {
        background: none; border: none; color: #fff; font-size: 2rem; margin-right: 16px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%; width: 40px; height: 40px; transition: background 0.2s;
      }
      .back-button:focus, .back-button:hover { background: rgba(255,255,255,0.12); outline: none; }
      .header-title { font-size: 1.5rem; font-weight: 700; letter-spacing: 0.01em; }
      .mui-container { max-width: 900px; margin: 32px auto 0; padding: 0 16px; }
      .property-info-card {
        background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
        padding: 24px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;
      }
      .property-name { font-size: 1.3rem; font-weight: 600; color: #1976d2; letter-spacing: 0.01em; }
      .room-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
      .mui-card.room-card {
        background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.10);
        transition: box-shadow 0.2s, transform 0.2s; cursor: pointer; overflow: hidden; position: relative;
        padding: 0; min-height: 64px; display: flex; align-items: center;
      }
      .mui-card.room-card:active { box-shadow: 0 4px 16px rgba(25, 118, 210, 0.18); transform: scale(0.98); }
      .mui-card-content { width: 100%; padding: 20px 24px; display: flex; align-items: center; }
      .room-info-row { display: flex; align-items: center; gap: 16px; width: 100%; flex-wrap: nowrap; }
      .status-icon { font-size: 2rem; margin-right: 8px; }
      .room-name { flex: 1; font-size: 1.1rem; font-weight: 500; color: #222; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .room-status { font-size: 0.95rem; color: #1976d2; font-weight: 500; white-space: nowrap; margin-left: 12px; }
      .status-completed .room-status, .status-completed .status-icon { color: #43a047; }
      .status-pending .room-status, .status-pending .status-icon { color: #ff9800; }
      .mui-alert { display: flex; align-items: center; background: #fff3e0; color: #b26a00; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; font-size: 1rem; box-shadow: 0 1px 4px rgba(255,193,7,0.08); }
      .mui-alert .material-icons { margin-right: 8px; }
      .mui-button {
        display: inline-flex; align-items: center; justify-content: center;
        background: #1976d2; color: #fff; border: none; border-radius: 8px;
        font-size: 1.1rem; font-weight: 600; padding: 14px 28px; margin: 0 auto; cursor: pointer;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.10); transition: background 0.2s, box-shadow 0.2s;
        position: relative; overflow: hidden;
      }
      .mui-button:active { background: #1565c0; }
      .mui-button:focus { outline: 2px solid #1976d2; }
      .mui-button .material-icons { margin-right: 8px; }
      .mui-loader { display: flex; justify-content: center; align-items: center; min-height: 120px; }
      .mui-loader .loading-spinner { width: 40px; height: 40px; border: 4px solid #e3e3e3; border-top: 4px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @media (max-width: 600px) {
        .mui-container { padding: 0 4px; }
        .property-info-card { padding: 16px 8px; }
        .mui-card-content { padding: 14px 8px; }
        .room-grid { grid-template-columns: 1fr; gap: 14px; }
      }
    </style>
</head>
<body>
  <header class="app-header">
    <button class="back-button" onclick="goBack()" aria-label="戻る">
      <span class="material-icons">arrow_back</span>
    </button>
    <span class="header-title">部屋選択</span>
  </header>
  <main class="mui-container">
    <div class="property-info-card">
      <span class="material-icons" style="color:#1976d2; font-size:2rem; margin-right:8px;">home</span>
      <span class="property-name" id="propertyName">物件名読み込み中...</span>
    </div>
    <div id="errorMessage" class="mui-alert" style="display:none;"><span class="material-icons">error</span><span id="errorText"></span></div>
    <div class="mui-loader" id="loading"><div class="loading-spinner"></div></div>
    <div class="room-grid" id="roomGrid" style="display:none;"></div>
    <div style="text-align:center; margin-top:32px;">
      <button class="mui-button" id="completeInspectionBtn" onclick="completeInspection()" style="display:none;">
        <span class="material-icons">check_circle</span>この物件の検針を完了する
      </button>
    </div>
  </main>
  <script>
    // 戻るボタン
    function goBack() { window.location.href = '/property_select'; }
    // Ripple effect
    function addRippleEffect(element) {
      element.addEventListener('click', function(e) {
        const circle = document.createElement('span');
        circle.className = 'ripple';
        const rect = element.getBoundingClientRect();
        circle.style.left = (e.clientX - rect.left) + 'px';
        circle.style.top = (e.clientY - rect.top) + 'px';
        element.appendChild(circle);
        setTimeout(() => circle.remove(), 600);
      });
    }
    // Ripple CSS
    const rippleStyle = document.createElement('style');
    rippleStyle.innerHTML = `.ripple { position: absolute; border-radius: 50%; background: rgba(25,118,210,0.18); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; z-index: 2; }
    @keyframes ripple { to { transform: scale(2.5); opacity: 0; } }`;
    document.head.appendChild(rippleStyle);
    // 部屋データ取得・描画
    async function loadRoomData() {
      const loading = document.getElementById('loading');
      const grid = document.getElementById('roomGrid');
      const errorDiv = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      try {
        const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('propertyId');
        if (!gasWebAppUrl || !propertyId) throw new Error('必要なパラメータが不足しています');
        const fetchUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
        const response = await fetch(fetchUrl);
        if (!response.ok) throw new Error(`API呼び出しに失敗: ${response.status}`);
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'データ取得失敗');
        document.getElementById('propertyName').textContent = data.propertyName || '物件名不明';
        grid.innerHTML = '';
        data.rooms.forEach(room => {
          const card = document.createElement('div');
          card.className = 'mui-card room-card ' + (room.readingStatus === 'completed' || room.isCompleted ? 'status-completed' : 'status-pending');
          card.tabIndex = 0;
          card.setAttribute('role', 'button');
          card.setAttribute('aria-label', `${room.name || room['部屋名'] || room.id} ${room.readingStatus === 'completed' ? '検針済み' : '未検針'}`);
          card.innerHTML = `<div class="mui-card-content"><div class="room-info-row"><span class="material-icons status-icon">${room.readingStatus === 'completed' || room.isCompleted ? 'check_circle' : 'warning'}</span><span class="room-name">${room.name || room['部屋名'] || room.id || '不明'}</span><span class="room-status">${room.readingStatus === 'completed' && room.readingDateFormatted ? `検針済み：${room.readingDateFormatted}` : '未検針'}</span></div></div>`;
          card.onclick = () => {
            window.location.href = `/meter_reading?propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(room.id)}`;
          };
          addRippleEffect(card);
          grid.appendChild(card);
        });
        loading.style.display = 'none';
        grid.style.display = 'grid';
        errorDiv.style.display = 'none';
      } catch (e) {
        loading.style.display = 'none';
        errorText.textContent = e.message;
        errorDiv.style.display = 'flex';
      }
    }
    // 検針完了ボタン表示
    function completeInspection() { alert('検針完了処理を実装してください'); }
    // 初期化
    window.onload = loadRoomData;
  </script>
</body>
</html>
