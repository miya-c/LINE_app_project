<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨å±‹é¸æŠ - æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒª</title>
    
    <!-- PWA ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="description" content="æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®èª­ã¿å–ã‚Šã‚’ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="../../css_styles/room_select.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <!-- Material UI AppBar -->
    <header class="MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic mui-elevation-4" role="banner">
      <nav class="MuiToolbar-root MuiToolbar-regular" aria-label="éƒ¨å±‹é¸æŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <button class="MuiIconButton-root MuiIconButton-colorInherit" onclick="goBack()" aria-label="æˆ»ã‚‹">
          <span class="material-icons MuiSvgIcon-root">arrow_back</span>
        </button>
        <span class="MuiTypography-root MuiTypography-h6 app-title" aria-label="ç”»é¢ã‚¿ã‚¤ãƒˆãƒ«">éƒ¨å±‹é¸æŠ</span>
      </nav>
    </header>

    <main class="MuiContainer-root MuiContainer-maxWidthLg" style="padding-top:32px;" role="main" aria-label="éƒ¨å±‹é¸æŠãƒ¡ã‚¤ãƒ³">
      <!-- ç‰©ä»¶åã‚«ãƒ¼ãƒ‰ -->
      <section class="MuiCard-root MuiPaper-root MuiPaper-elevation1 property-card" aria-label="ç‰©ä»¶æƒ…å ±" tabindex="0" role="region">
        <div class="MuiCardHeader-root property-header">
          <span class="material-icons MuiSvgIcon-root property-icon" aria-hidden="true">home</span>
          <span class="MuiTypography-root MuiTypography-h5" id="propertyName">ç‰©ä»¶åèª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      </section>

      <!-- ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ -->
      <div class="MuiAlert-root MuiAlert-standardError" id="errorMessage" style="display:none;" role="alert" aria-live="assertive">
        <span class="MuiAlert-icon"><span class="material-icons MuiSvgIcon-root" aria-hidden="true">error</span></span>
        <span class="MuiAlert-message" id="errorText"></span>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div class="loading-container" id="loading" aria-live="polite" aria-busy="true">
        <span class="MuiCircularProgress-root" aria-label="èª­ã¿è¾¼ã¿ä¸­"></span>
        <span class="MuiTypography-root MuiTypography-body1">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>

      <!-- éƒ¨å±‹ã‚°ãƒªãƒƒãƒ‰ -->
      <section class="room-grid" id="roomGrid" style="display:none;" aria-label="éƒ¨å±‹ä¸€è¦§" role="list"></section>

      <!-- å®Œäº†ãƒœã‚¿ãƒ³ -->
      <div class="complete-button-container">
        <button class="MuiButton-root MuiButton-contained MuiButton-containedPrimary MuiButton-sizeLarge complete-button" id="completeInspectionBtn" onclick="completeInspection()" style="display:none;" aria-label="ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹" tabindex="0" role="button">
          <span class="material-icons MuiSvgIcon-root" aria-hidden="true">check_circle</span>
          <span class="MuiButton-label">ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹</span>
        </button>
      </div>
    </main>

<script>
        // Ripple effect for buttons and cards
        function addRippleEffect(element) {
            element.addEventListener('click', function(e) {
                const circle = document.createElement('span');
                circle.className = 'ripple';
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                circle.style.width = circle.style.height = size + 'px';
                circle.style.left = (e.clientX - rect.left - size / 2) + 'px';
                circle.style.top = (e.clientY - rect.top - size / 2) + 'px';
                element.appendChild(circle);
                setTimeout(() => {
                    if (circle.parentNode) {
                        circle.parentNode.removeChild(circle);
                    }
                }, 600);
            });
        }

        // GAS Web App URLå–å¾—ï¼ˆproperty_select.htmlã‹ã‚‰ç¶™æ‰¿ï¼‰
        const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
        
        // URLæ¤œè¨¼
        if (!gasWebAppUrl) {
            showError('Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠç”»é¢ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">Web App URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            setTimeout(() => window.location.href = '/property_select', 3000);
        } else {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰©ä»¶IDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');
            
            console.log('[room_select] URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª:', {
                propertyId: propertyId,
                fullUrl: window.location.href,
                searchParams: window.location.search
            });
            
            if (!propertyId) {
                console.error('[room_select] ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                if (confirm('ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                    window.location.href = '/property_select';
                } else {
                    document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">ç‰©ä»¶IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                    setTimeout(() => window.location.href = '/property_select', 3000);
                }
            } else {
                console.log('[room_select] ç‰©ä»¶IDç¢ºèªå®Œäº†:', propertyId);
                // æ­£å¸¸ãªå ´åˆã®ã¿loadRoomDataã‚’å®Ÿè¡Œ
                console.log('[room_select] window.onloadã«loadRoomDataè¨­å®š');
                window.onload = function() {
                    console.log('[room_select] window.onloadç™ºç« - loadRoomDataå®Ÿè¡Œé–‹å§‹');
                    loadRoomData();
                };
                
                // æ—¢ã«ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
                if (document.readyState === 'complete') {
                    console.log('[room_select] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ¸ˆã¿ - loadRoomDataå³åº§å®Ÿè¡Œ');
                    loadRoomData();
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'flex';
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚’å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function blockAllKeyEvents(e) {
            // ESCã€Tabã€Enterã€Spaceã€Arrow keysç­‰ã‚’ç„¡åŠ¹åŒ–
            const blockedKeys = ['Escape', 'Tab', 'Enter', ' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            if (blockedKeys.includes(e.key) || e.keyCode === 27 || e.keyCode === 9) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹æ™‚ã®æ“ä½œãƒ–ãƒ­ãƒƒã‚¯è¨­å®š
        function enableLoadingBlock() {
            document.body.style.overflow = 'hidden';
            document.body.style.pointerEvents = 'none';
            document.addEventListener('keydown', blockAllKeyEvents, true);
            document.addEventListener('keyup', blockAllKeyEvents, true);
            document.addEventListener('keypress', blockAllKeyEvents, true);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã¯æ“ä½œå¯èƒ½ã«ã™ã‚‹
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.pointerEvents = 'all';
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†æ™‚ã®æ“ä½œãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
        function disableLoadingBlock() {
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
            document.removeEventListener('keydown', blockAllKeyEvents, true);
            document.removeEventListener('keyup', blockAllKeyEvents, true);
            document.removeEventListener('keypress', blockAllKeyEvents, true);
        }

        async function loadRoomData() {
            console.log('[room_select] loadRoomDataé–¢æ•°é–‹å§‹');
            let rooms = [];
            try {
                console.log('[room_select] enableLoadingBlocké–‹å§‹');
                enableLoadingBlock();
                
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                
                console.log('[room_select] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª:', {
                    gasWebAppUrl: gasWebAppUrl ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š',
                    propertyId: propertyId
                });
                
                if (!gasWebAppUrl || !propertyId) {
                    throw new Error('å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                const fetchUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
                console.log('[room_select] APIå‘¼ã³å‡ºã—é–‹å§‹:', fetchUrl);
                
                const response = await fetch(fetchUrl);
                console.log('[room_select] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.ok);
                
                if (!response.ok) {
                    throw new Error(`APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[room_select] APIãƒ‡ãƒ¼ã‚¿è§£æå®Œäº†:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                let propertyName = 'ç‰©ä»¶åä¸æ˜';
                if (data.data) {
                    propertyName = data.data.propertyName
                        || (data.data.property && data.data.property.name)
                        || data.data.property_name
                        || data.data.name
                        || 'ç‰©ä»¶åä¸æ˜';
                }
                console.log('[room_select] ç‰©ä»¶åè¨­å®š:', propertyName);
                document.getElementById('propertyName').textContent = propertyName;
                
                rooms = (data.data && Array.isArray(data.data.rooms)) ? data.data.rooms : [];
                console.log('[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿æŠ½å‡º:', rooms.length, 'ä»¶');
                
                if (!Array.isArray(rooms)) {
                    throw new Error('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆroomsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                }
                
                console.log('[room_select] displayRoomså‘¼ã³å‡ºã—é–‹å§‹');
                displayRooms(rooms);
                console.log('[room_select] updateCompleteButtonå‘¼ã³å‡ºã—é–‹å§‹');
                updateCompleteButton(rooms);
                
            } catch (error) {
                console.error('[room_select] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
                showError(error.message);
            } finally {
                console.log('[room_select] finallyå‡¦ç†é–‹å§‹ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤');
                // å¿…ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                    loadingElement.style.visibility = 'hidden';
                    loadingElement.style.opacity = '0';
                    loadingElement.style.pointerEvents = 'none';
                    loadingElement.style.zIndex = '-1';
                    console.log('[room_select] loadingè¦ç´ å®Œå…¨éè¡¨ç¤ºå®Œäº†');
                } else {
                    console.error('[room_select] loadingè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                disableLoadingBlock();
                console.log('[room_select] disableLoadingBlockå®Œäº†');
            }
        }

        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¿…ãšéè¡¨ç¤ºã«ã™ã‚‹
        function hideLoadingOnPageShow() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
                loadingElement.style.visibility = 'hidden';
                loadingElement.style.opacity = '0';
                loadingElement.style.pointerEvents = 'none';
                loadingElement.style.zIndex = '-1';
            }
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
        }

        window.addEventListener('pageshow', function(event) {
            hideLoadingOnPageShow();
        });

        function displayRooms(rooms) {
            console.log('[room_select] displayRoomsé–‹å§‹:', rooms.length, 'ä»¶');
            const roomGrid = document.getElementById('roomGrid');
            const loading = document.getElementById('loading');
            
            if (!roomGrid) {
                console.error('[room_select] roomGridè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            roomGrid.innerHTML = '';
            
            if (rooms.length === 0) {
                console.log('[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º');
                roomGrid.innerHTML = '<div class="no-rooms-message">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                roomGrid.style.display = 'block';
                // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®å ´åˆã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œå…¨éè¡¨ç¤º
                if (loading) {
                    loading.style.display = 'none';
                    loading.style.visibility = 'hidden';
                    loading.style.opacity = '0';
                    loading.style.pointerEvents = 'none';
                    loading.style.zIndex = '-1';
                    console.log('[room_select] 0ä»¶æ™‚ã®loadingå®Œå…¨éè¡¨ç¤ºå®Œäº†');
                }
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');
            
            console.log('[room_select] éƒ¨å±‹ã‚«ãƒ¼ãƒ‰ä½œæˆé–‹å§‹');
            rooms.forEach((room, index) => {
                console.log(`[room_select] éƒ¨å±‹[${index}]å‡¦ç†:`, room.name || room['éƒ¨å±‹å'] || room.id);
                // Material UI Cardæ§‹é€ 
                const card = document.createElement('div');
                card.className = 'MuiCard-root MuiPaper-root MuiPaper-elevation1 MuiCardActionArea-root room-card' +
                  (room.readingStatus === 'completed' || room.isCompleted ? ' status-completed' : ' status-pending');
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `${room.name || room['éƒ¨å±‹å'] || room.id || 'ä¸æ˜'} ${room.readingStatus === 'completed' ? 'æ¤œé‡æ¸ˆã¿' : 'æœªæ¤œé‡'}`);
                // 1è¡Œè¡¨ç¤º
                card.innerHTML = `
                  <div class="MuiCardContent-root room-info-row">
                    <span class="material-icons MuiSvgIcon-root status-icon" aria-hidden="true" style="color:${room.readingStatus === 'completed' ? '#2e7d32' : '#ed6c02'};">
                      ${room.readingStatus === 'completed' ? 'check_circle' : 'warning'}
                    </span>
                    <span class="MuiTypography-root MuiTypography-h6 room-name">${room.name || room['éƒ¨å±‹å'] || room.id || 'ä¸æ˜'}</span>
                    <span class="MuiTypography-root MuiTypography-body2 room-status">${room.readingStatus === 'completed' && room.readingDateFormatted ? `æ¤œé‡æ¸ˆã¿ï¼š${room.readingDateFormatted}` : 'æœªæ¤œé‡'}</span>
                  </div>
                `;
                card.onclick = () => {
                  const meterReadingUrl = `/meter_reading?propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(room.id)}`;
                  window.location.href = meterReadingUrl;
                };
                addRippleEffect(card);
                roomGrid.appendChild(card);
            });
            
            console.log('[room_select] éƒ¨å±‹ã‚«ãƒ¼ãƒ‰ä½œæˆå®Œäº†ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã¨ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º');
            if (loading) {
                loading.style.display = 'none';
                loading.style.visibility = 'hidden';
                loading.style.opacity = '0';
                loading.style.pointerEvents = 'none';
                console.log('[room_select] loadingå®Œå…¨éè¡¨ç¤ºè¨­å®šå®Œäº†');
            }
            roomGrid.style.display = 'grid';
            console.log('[room_select] displayRoomså®Œäº†');
        }

        function updateCompleteButton(rooms) {
            const completeBtn = document.getElementById('completeInspectionBtn');
            const allCompleted = rooms.every(room => room.readingStatus === 'completed' || room.isCompleted === true);
            
            if (allCompleted && rooms.length > 0) {
                completeBtn.style.display = 'flex';
                completeBtn.innerHTML = `
                    <span class="material-icons MuiSvgIcon-root">check_circle</span>
                    <span class="MuiButton-label">ã“ã®ç‰©ä»¶ã®æ¤œé‡ã‚’å®Œäº†ã™ã‚‹</span>
                `;
            }
        }

        async function completeInspection() {
            console.log('[room_select] æ¤œé‡å®Œäº†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - å‡¦ç†é–‹å§‹');
            
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
                enableLoadingBlock();
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'flex';
                    loadingElement.style.visibility = 'visible';
                    loadingElement.style.opacity = '1';
                    loadingElement.style.pointerEvents = 'all';
                    loadingElement.style.zIndex = '9999';
                    loadingElement.querySelector('.MuiTypography-root').textContent = 'æ¤œé‡å®Œäº†å‡¦ç†ä¸­...';
                }
                
                // å®Œäº†ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const completeBtn = document.getElementById('completeInspectionBtn');
                if (completeBtn) {
                    completeBtn.disabled = true;
                    completeBtn.style.opacity = '0.6';
                    completeBtn.style.cursor = 'not-allowed';
                }
                
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                
                if (!gasWebAppUrl || !propertyId) {
                    throw new Error('å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // æ¤œé‡å®Œäº†APIå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
                const currentDateTime = new Date().toISOString();
                const completeUrl = `${gasWebAppUrl}?action=completeInspection&propertyId=${encodeURIComponent(propertyId)}&completedAt=${encodeURIComponent(currentDateTime)}&completedBy=user`;
                console.log('[room_select] ğŸ¯ æ¤œé‡å®Œäº†APIå‘¼ã³å‡ºã—é–‹å§‹');
                console.log('[room_select] ğŸ“ API URL:', completeUrl);
                console.log('[room_select] ğŸ“ propertyId:', propertyId);
                console.log('[room_select] ğŸ“ gasWebAppUrl:', gasWebAppUrl);
                
                let response;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timeout')), 30000)
                        );
                        
                        const fetchPromise = fetch(completeUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            }
                        });
                        
                        response = await Promise.race([fetchPromise, timeoutPromise]);
                        
                        console.log('[room_select] ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', {
                            status: response.status,
                            ok: response.ok,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries())
                        });
                        
                        if (response.ok) {
                            break; // æˆåŠŸã—ãŸã®ã§ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                        } else {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (fetchError) {
                        retryCount++;
                        console.warn(`[room_select] âš ï¸ APIå‘¼ã³å‡ºã—å¤±æ•— (è©¦è¡Œ ${retryCount}/${maxRetries}):`, fetchError.message);
                        
                        if (retryCount >= maxRetries) {
                            throw new Error(`APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ (${maxRetries}å›è©¦è¡Œ): ${fetchError.message}`);
                        }
                        
                        // 1ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                console.log('[room_select] âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ');
                
                if (!response.ok) {
                    throw new Error(`æ¤œé‡å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('[room_select] ğŸ“‹ æ¤œé‡å®Œäº†APIçµæœè§£æ:', {
                    raw: result,
                    success: result.success,
                    message: result.message,
                    error: result.error
                });
                
                if (!result.success) {
                    console.error('[room_select] âŒ APIçµæœã‚¨ãƒ©ãƒ¼:', result.error || result.message);
                    throw new Error(result.error || result.message || 'æ¤œé‡å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // æˆåŠŸæ™‚ã®å‡¦ç†
                console.log('[room_select] ğŸ‰ æ¤œé‡å®Œäº†å‡¦ç†æˆåŠŸ');
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
                const successMessage = document.createElement('div');
                successMessage.className = 'MuiAlert-root MuiAlert-standardSuccess';
                successMessage.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 16px;
                    margin: 16px 0;
                    border-radius: 16px;
                    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
                    border: 1px solid #4caf50;
                    color: #2e7d32;
                    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    min-width: 300px;
                    text-align: center;
                    font-weight: 500;
                `;
                successMessage.innerHTML = `
                    <span class="material-icons" style="margin-right: 8px; color: #4caf50;">check_circle</span>
                    <span>æ¤œé‡ãŒå®Œäº†ã—ã¾ã—ãŸï¼</span>
                `;
                document.body.appendChild(successMessage);
                
                // 2ç§’å¾Œã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã€ç‰©ä»¶é¸æŠç”»é¢ã«æˆ»ã‚‹
                setTimeout(() => {
                    successMessage.remove();
                    console.log('[room_select] ç‰©ä»¶é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™');
                    window.location.href = 'property_select.html';
                }, 2000);
                
            } catch (error) {
                console.error('[room_select] âŒ æ¤œé‡å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    type: typeof error
                });
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const errorMessage = document.createElement('div');
                errorMessage.className = 'MuiAlert-root MuiAlert-standardError';
                errorMessage.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 16px;
                    margin: 16px 0;
                    border-radius: 16px;
                    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
                    border: 1px solid #fecaca;
                    color: #b91c1c;
                    box-shadow: 0 4px 12px rgba(185, 28, 28, 0.1);
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    min-width: 300px;
                    text-align: center;
                    font-weight: 500;
                `;
                errorMessage.innerHTML = `
                    <span class="material-icons" style="margin-right: 8px; color: #f44336;">error</span>
                    <span>${error.message}</span>
                `;
                document.body.appendChild(errorMessage);
                
                // 3ç§’å¾Œã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                setTimeout(() => {
                    errorMessage.remove();
                }, 3000);
                
                // å®Œäº†ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                const completeBtn = document.getElementById('completeInspectionBtn');
                if (completeBtn) {
                    completeBtn.disabled = false;
                    completeBtn.style.opacity = '1';
                    completeBtn.style.cursor = 'pointer';
                }
                
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                    loadingElement.style.visibility = 'hidden';
                    loadingElement.style.opacity = '0';
                    loadingElement.style.pointerEvents = 'none';
                    loadingElement.style.zIndex = '-1';
                }
                disableLoadingBlock();
                console.log('[room_select] æ¤œé‡å®Œäº†å‡¦ç†çµ‚äº†');
            }
        }

        function goBack() {
            console.log('[room_select] æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            window.location.href = '/property_select';
        }
    </script>
</body>
</html>
