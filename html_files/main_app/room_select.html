<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部屋選択</title>
    <!-- MUI, React, Babel CDN -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@mui/material@5.11.16/umd/material-ui.development.js" crossorigin></script>
    <script src="https://unpkg.com/@mui/icons-material@5.11.16/umd/material-ui-icons.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- External CSS -->
    <link rel="stylesheet" href="../../css_styles/room_select.css">
    <style>
      body { background: #f0f4f8; }
      #root { min-height: 100vh; }
    </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { AppBar, Toolbar, Typography, IconButton, Paper, Box, Button, Grid, Card, CardContent, CardActions, CircularProgress, Alert } = MaterialUI;
    const { ArrowBack, CheckCircle, WarningAmber, Home } = window.MaterialUIIcons;

    function RoomSelectApp() {
      const [property, setProperty] = useState(null);
      const [rooms, setRooms] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState("");
      const [completeLoading, setCompleteLoading] = useState(false);
      const [completeSuccess, setCompleteSuccess] = useState(false);
      const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('propertyId');

      useEffect(() => {
        if (!gasWebAppUrl || !propertyId) {
          setError('Web App URLまたは物件IDが設定されていません。物件選択画面から再度アクセスしてください。');
          setLoading(false);
          setTimeout(() => window.location.href = '/property_select', 3000);
          return;
        }
        fetchRooms();
      }, []);

      async function fetchRooms() {
        setLoading(true);
        setError("");
        try {
          const fetchUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
          const response = await fetch(fetchUrl);
          if (!response.ok) throw new Error(`API呼び出しに失敗: ${response.status}`);
          const data = await response.json();
          if (!data.success) throw new Error(data.error || 'データ取得失敗');
          setProperty(data.data.property);
          setRooms(data.data.rooms);
        } catch (e) {
          setError(e.message);
        } finally {
          setLoading(false);
        }
      }

      async function handleCompleteInspection() {
        if (!window.confirm('この物件の検針を完了にしますか？\n物件一覧画面に完了バッジが表示されます。')) return;
        setCompleteLoading(true);
        setError("");
        try {
          const fetchUrl = `${gasWebAppUrl}?action=completePropertyInspection&propertyId=${encodeURIComponent(propertyId)}`;
          const response = await fetch(fetchUrl);
          if (!response.ok) throw new Error(`API呼び出しに失敗: ${response.status}`);
          const result = await response.json();
          if (!result.success) throw new Error(result.error || '検針完了処理に失敗');
          setCompleteSuccess(true);
          setTimeout(() => window.location.href = '/property_select', 2000);
        } catch (e) {
          setError(e.message);
        } finally {
          setCompleteLoading(false);
        }
      }

      function handleBack() {
        window.location.href = '/property_select';
      }

      function handleRoomClick(roomId) {
        window.location.href = `/meter_reading?propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(roomId)}`;
      }

      // --- UI ---
      return (
        <Box sx={{ minHeight: '100vh', bgcolor: '#f0f4f8' }}>
          <AppBar position="static" sx={{ background: 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', boxShadow: 2 }}>
            <Toolbar>
              <IconButton edge="start" color="inherit" aria-label="back" onClick={handleBack} sx={{ mr: 2 }}>
                <ArrowBack />
              </IconButton>
              <Typography variant="h6" component="div" sx={{ flexGrow: 1, fontWeight: 700, letterSpacing: '0.02em', textAlign: 'center', position: 'relative' }}>
                部屋選択
                <Box sx={{ position: 'absolute', left: '50%', bottom: -8, transform: 'translateX(-50%)', width: 60, height: 3, bgcolor: '#fff', borderRadius: 2 }} />
              </Typography>
            </Toolbar>
          </AppBar>

          <Box sx={{ maxWidth: 700, mx: 'auto', mt: 3, px: { xs: 1, sm: 2 }, pb: 4 }}>
            {/* 物件情報カード */}
            <Paper elevation={3} sx={{ mb: 2, borderRadius: 3, p: 2, bgcolor: '#1976d2', color: '#fff', textAlign: 'center' }}>
              <Typography variant="h5" sx={{ fontWeight: 700, letterSpacing: '0.02em', fontSize: { xs: '1.3rem', sm: '2rem' } }}>
                {property ? property.name : '物件名読み込み中...'}
              </Typography>
            </Paper>

            {/* 検針完了ボタン */}
            <Box sx={{ textAlign: 'center', mb: 2 }}>
              <Button
                variant="contained"
                color="success"
                size="large"
                startIcon={<CheckCircle />}
                onClick={handleCompleteInspection}
                disabled={completeLoading || completeSuccess}
                sx={{ minWidth: 220, fontWeight: 700, fontSize: '1.1rem', borderRadius: 2, boxShadow: 2, py: 1.5, px: 4, background: 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' }}
              >
                {completeLoading ? '⏳ 処理中...' : completeSuccess ? '✅ 完了しました！' : 'この物件の検針を完了する'}
              </Button>
            </Box>

            {/* エラー表示 */}
            {error && <Alert severity="error" sx={{ mb: 2 }}>{error}</Alert>}
            {/* ローディング */}
            {loading ? (
              <Box sx={{ textAlign: 'center', py: 6 }}><CircularProgress color="primary" /><Box mt={2}>部屋データを読み込み中...</Box></Box>
            ) : (
              <Grid container spacing={3}>
                {rooms.length === 0 ? (
                  <Grid item xs={12}><Typography align="center">部屋データがありません</Typography></Grid>
                ) : rooms.map((room, idx) => {
                  const isCompleted = room.readingStatus === 'completed' || room.isCompleted === true;
                  return (
                    <Grid item xs={12} sm={6} md={4} key={room.id || idx}>
                      <Card
                        sx={{
                          borderRadius: 3,
                          boxShadow: 3,
                          bgcolor: isCompleted ? '#e8f5e9' : '#fffde7',
                          border: isCompleted ? '1.5px solid #43a047' : '1.5px solid #fbc02d',
                          cursor: 'pointer',
                          transition: 'box-shadow 0.2s, transform 0.2s',
                          '&:hover': { boxShadow: 8, transform: 'translateY(-2px) scale(1.01)' },
                        }}
                        onClick={() => handleRoomClick(room.id)}
                      >
                        <CardContent sx={{ textAlign: 'center', py: 3 }}>
                          <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 1 }}>
                            {isCompleted ? <CheckCircle sx={{ color: '#2E7D32', mr: 1 }} /> : <WarningAmber sx={{ color: '#F57C00', mr: 1 }} />}
                            <Typography variant="h6" sx={{ fontWeight: 700, color: isCompleted ? '#2E7D32' : '#F57C00', fontSize: { xs: '1.1rem', sm: '1.2rem' } }}>
                              {room.name || room['部屋名'] || room.id || '不明'}
                            </Typography>
                          </Box>
                          <Typography variant="body2" sx={{ color: '#333', fontWeight: 500 }}>
                            {isCompleted && room.readingDateFormatted ? `検針済み：${room.readingDateFormatted}` : '未検針'}
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                  );
                })}
              </Grid>
            )}
          </Box>
        </Box>
      );
    }

    // React 18 createRoot fallback
    const rootEl = document.getElementById('root');
    if (window.ReactDOM.createRoot) {
      window.ReactDOM.createRoot(rootEl).render(<RoomSelectApp />);
    } else {
      window.ReactDOM.render(<RoomSelectApp />, rootEl);
    }
  </script>
</body>
</html>
