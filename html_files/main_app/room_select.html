<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部屋選択 - 水道メーター読み取りアプリ</title>
    
    <!-- PWA メタタグ -->
    <meta name="description" content="水道メーターの読み取りを管理するアプリケーション">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="メーター読み取り">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
    
    <!-- Roboto Font & Material Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="../../css_styles/room_select.css">
</head>
<body>
    <!-- Material UI App Bar -->
    <div class="MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic">
        <div class="MuiToolbar-root MuiToolbar-regular">
            <button class="MuiIconButton-root MuiIconButton-colorInherit" onclick="goBack()" aria-label="戻る">
                <span class="material-icons MuiSvgIcon-root">arrow_back</span>
            </button>
            <h6 class="MuiTypography-root MuiTypography-h6 app-title">部屋選択</h6>
        </div>
    </div>

    <!-- Material UI Container -->
    <div class="MuiContainer-root MuiContainer-maxWidthLg">
        <!-- Property Info Card -->
        <div class="MuiPaper-root MuiPaper-elevation1 MuiCard-root property-card">
            <div class="MuiCardContent-root">
                <div class="property-header">
                    <span class="material-icons MuiSvgIcon-root property-icon">home</span>
                    <h5 class="MuiTypography-root MuiTypography-h5" id="propertyName">物件名読み込み中...</h5>
                </div>
            </div>
        </div>
        
        <!-- Error Alert -->
        <div class="MuiAlert-root MuiAlert-standardError" id="errorMessage" style="display: none;">
            <div class="MuiAlert-icon">
                <span class="material-icons MuiSvgIcon-root">error</span>
            </div>
            <div class="MuiAlert-message" id="errorText"></div>
        </div>
        
        <!-- Loading State -->
        <div class="loading-container" id="loading">
            <div class="MuiCircularProgress-root"></div>
            <p class="MuiTypography-root MuiTypography-body1">部屋データを読み込み中...</p>
        </div>
        
        <!-- Room Grid -->
        <div class="room-grid" id="roomGrid" style="display: none;"></div>
        
        <!-- Complete Inspection Button -->
        <div class="complete-button-container">
            <button 
                class="MuiButton-root MuiButton-contained MuiButton-containedPrimary complete-button" 
                id="completeInspectionBtn" 
                onclick="completeInspection()" 
                style="display: none;"
            >
                <span class="material-icons MuiSvgIcon-root">check_circle</span>
                <span class="MuiButton-label">この物件の検針を完了する</span>
            </button>
        </div>
    </div>

    <script>
        // Ripple effect for buttons and cards
        function addRippleEffect(element) {
            element.addEventListener('click', function(e) {
                const circle = document.createElement('span');
                circle.className = 'ripple';
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                circle.style.width = circle.style.height = size + 'px';
                circle.style.left = (e.clientX - rect.left - size / 2) + 'px';
                circle.style.top = (e.clientY - rect.top - size / 2) + 'px';
                element.appendChild(circle);
                setTimeout(() => {
                    if (circle.parentNode) {
                        circle.parentNode.removeChild(circle);
                    }
                }, 600);
            });
        }

        // GAS Web App URL取得（property_select.htmlから継承）
        const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
        
        // URL検証
        if (!gasWebAppUrl) {
            showError('Web App URLが設定されていません。物件選択画面から再度アクセスしてください。');
            document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">Web App URLが設定されていません</p>';
            setTimeout(() => window.location.href = '/property_select', 3000);
        } else {
            // URLパラメータから物件IDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');
            
            console.log('[room_select] URLパラメータ確認:', {
                propertyId: propertyId,
                fullUrl: window.location.href,
                searchParams: window.location.search
            });
            
            if (!propertyId) {
                console.error('[room_select] 物件IDが指定されていません');
                if (confirm('物件IDが指定されていません。物件選択画面に戻りますか？')) {
                    window.location.href = '/property_select';
                } else {
                    document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p class="loading-text">物件IDが指定されていません</p>';
                    setTimeout(() => window.location.href = '/property_select', 3000);
                }
            } else {
                console.log('[room_select] 物件ID確認完了:', propertyId);
                // 正常な場合のみloadRoomDataを実行
                window.onload = loadRoomData;
            }
        }

        // エラーメッセージ表示
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'flex';
        }

        async function loadRoomData() {
            try {
                // 関数内でURLとパラメータを再取得
                const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('propertyId');
                
                console.log('[room_select] loadRoomData開始:', {
                    gasWebAppUrl: gasWebAppUrl ? 'あり' : 'なし',
                    propertyId: propertyId
                });
                
                if (!gasWebAppUrl || !propertyId) {
                    throw new Error('必要なパラメータが不足しています');
                }
                
                const fetchUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
                console.log('[room_select] API呼び出しURL:', fetchUrl);
                
                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    throw new Error(`API呼び出しに失敗しました: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[room_select] API応答:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'データの取得に失敗しました');
                }
                
                // 物件名表示（複数パターンに対応）
                let propertyName = '物件名不明';
                if (data.data) {
                    propertyName = data.data.propertyName
                        || (data.data.property && data.data.property.name)
                        || data.data.property_name
                        || data.data.name
                        || '物件名不明';
                }
                document.getElementById('propertyName').textContent = propertyName;
                
                // 部屋リスト取得
                const rooms = (data.data && Array.isArray(data.data.rooms)) ? data.data.rooms : [];
                if (!Array.isArray(rooms)) {
                    throw new Error('部屋データの取得に失敗しました（roomsが配列ではありません）');
                }
                // 部屋表示
                displayRooms(rooms);
                
                // 完了ボタン表示判定
                updateCompleteButton(rooms);
                
            } catch (error) {
                console.error('[room_select] エラー:', error);
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayRooms(rooms) {
            const roomGrid = document.getElementById('roomGrid');
            const loading = document.getElementById('loading');
            
            roomGrid.innerHTML = '';

            if (rooms.length === 0) {
                roomGrid.innerHTML = '<div class="no-rooms-message">部屋データがありません</div>';
                loading.style.display = 'none';
                roomGrid.style.display = 'block';
                return;
            }

            // URLパラメータから物件IDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('propertyId');

            console.log('[room_select] 部屋表示開始 - 部屋数:', rooms.length, '物件ID:', propertyId);

            rooms.forEach((room, index) => {
                // Room Card with proper Material UI structure
                const card = document.createElement('div');
                card.className = 'MuiPaper-root MuiPaper-elevation1 MuiCard-root room-card';
                
                const isCompleted = room.readingStatus === 'completed' || room.isCompleted === true;
                if (isCompleted) {
                    card.classList.add('status-completed');
                } else {
                    card.classList.add('status-pending');
                }

                // 部屋名を取得（優先順位: name > 部屋名 > id）
                const roomName = room.name || room['部屋名'] || room.id || '不明';
                
                const displayText = isCompleted && room.readingDateFormatted 
                    ? `検針済み：${room.readingDateFormatted}`
                    : '未検針';

                // Card Content with Material UI CardContent structure
                card.innerHTML = `
                    <div class="MuiCardActionArea-root">
                        <div class="MuiCardContent-root">
                            <div class="room-info-row">
                                <span class="material-icons MuiSvgIcon-root status-icon">
                                    ${isCompleted ? 'check_circle' : 'warning'}
                                </span>
                                <span class="MuiTypography-root MuiTypography-h6 room-name">${roomName}</span>
                                <span class="MuiTypography-root MuiTypography-body2 room-status">${displayText}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                card.onclick = () => {
                    const meterReadingUrl = `/meter_reading?propertyId=${encodeURIComponent(propertyId)}&roomId=${encodeURIComponent(room.id)}`;
                    console.log(`[room_select] 部屋[${index}]クリック:`, meterReadingUrl);
                    window.location.href = meterReadingUrl;
                };

                // Ripple effect追加
                addRippleEffect(card);
                
                roomGrid.appendChild(card);
            });
            
            loading.style.display = 'none';
            roomGrid.style.display = 'grid';
            
            console.log('[room_select] 部屋ボタン生成完了');
        }

        function updateCompleteButton(rooms) {
            const completeBtn = document.getElementById('completeInspectionBtn');
            const allCompleted = rooms.every(room => room.readingStatus === 'completed' || room.isCompleted === true);
            
            if (allCompleted && rooms.length > 0) {
                completeBtn.style.display = 'flex';
                completeBtn.innerHTML = `
                    <span class="material-icons MuiSvgIcon-root">check_circle</span>
                    <span class="MuiButton-label">この物件の検針を完了する</span>
                `;
            }
        }

        function completeInspection() {
            console.log('[room_select] 検針完了ボタンクリック');
            // 検針完了処理を実装してください
            alert('検針完了処理を実装してください');
        }

        function goBack() {
            console.log('[room_select] 戻るボタンクリック');
            window.location.href = '/property_select';
        }
    </script>
</body>
</html>
