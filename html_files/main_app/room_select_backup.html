<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨å±‹é¸æŠ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .building-name {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .room-button {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .room-button:hover {
            background-color: #f0f0f0;
        }
        .room-button.reading-completed {
            background-color: #e8f5e8;
            border-color: #4CAF50;
        }
        .room-button.reading-not-completed {
            background-color: #fff8e1;
            border-color: #FF9800;
        }
        .room-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }
        .room-button.reading-completed .room-text {
            color: #2E7D32;
        }
        .room-button.reading-not-completed .room-text {
            color: #F57C00;
        }
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .back-button:hover {
            background-color: #5a6268;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 480px) {
            .room-grid {
                grid-template-columns: 1fr;
            }
            .room-text {
                font-size: 14px;
            }
        } 
      font-size: 32px; font-weight: 700; margin: 0 0 32px 0; 
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center; 
      position: relative;
    }
    .mantine-title::after {
      content: '';
      position: absolute;
      bottom: -8px; left: 50%; transform: translateX(-50%);
      width: 60px; height: 3px;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border-radius: 2px;
    }
    .mantine-subtitle { 
      font-size: 18px; font-weight: 600; color: #495057; text-align: center; margin-bottom: 24px; 
    }
    .mantine-text-input { margin-bottom: 20px; }
    .mantine-text-input input { 
      width: 100%; padding: 18px 20px; border: 2px solid #e9ecef; border-radius: 16px; 
      font-size: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      box-shadow: 
        0 2px 8px rgba(0,0,0,0.04),
        inset 0 1px 2px rgba(0,0,0,0.02);
    }
    .mantine-text-input input:focus { 
      outline: none; 
      border-color: #007bff; 
      box-shadow: 
        0 0 0 4px rgba(0,123,255,0.15),
        0 4px 12px rgba(0,123,255,0.1); 
      background: #ffffff;
      transform: translateY(-1px);
    }
    .mantine-alert { 
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); 
      border: 1px solid #fecaca; border-radius: 16px; 
      padding: 20px; color: #b91c1c; 
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.1);
    }
    .mantine-center { display: flex; justify-content: center; align-items: center; }
    .mantine-loader { 
      width: 24px; height: 24px; border: 2px solid #e9ecef; 
      border-top: 2px solid #007bff; border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    .mantine-text { color: #495057; text-align: center; }
    .weight-600 { font-weight: 600; }
    /* Button Styles */
    .mantine-button {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 14px 24px; border: none; border-radius: 12px; 
      font-size: 16px; font-weight: 600; line-height: 1;
      text-decoration: none; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none; min-height: 48px;
    }
    .mantine-button.variant-filled {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .mantine-button.variant-filled:hover {
      background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 123, 255, 0.35);
    }
    .mantine-button.variant-outline {
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #007bff; color: #007bff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .mantine-button.variant-outline:hover {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white; transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.25);
    }
    .mantine-button:disabled {
      opacity: 0.6; cursor: not-allowed; transform: none !important;
    }
    .inspection-complete-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white; margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .inspection-complete-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.35);
    }
    /* Room Card Styles */
    .mantine-paper { 
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); 
      border-radius: 16px; padding: 20px; 
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.08),
        0 1px 3px rgba(0,0,0,0.05); 
      border: 1px solid rgba(255,255,255,0.8); 
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .mantine-paper::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(145deg, rgba(0,123,255,0.03) 0%, rgba(0,123,255,0.01) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .mantine-paper:hover::before {
      opacity: 1;
    }
    .mantine-paper:hover { 
      transform: translateY(-4px) scale(1.02); 
      box-shadow: 
        0 12px 32px rgba(0,123,255,0.15),
        0 4px 12px rgba(0,0,0,0.1); 
      border-color: rgba(0,123,255,0.3); 
    }
    .mantine-paper.disabled { 
      opacity: 0.6; cursor: not-allowed; 
      pointer-events: none;
    }
    .room-card { 
      display: flex; justify-content: space-between; align-items: center; 
      width: 100%; background: none; border: none; font: inherit;
      text-align: left; cursor: inherit; padding: 0;
    }
    .room-info { flex: 1; pointer-events: none; }
    .room-header { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    .room-number { 
      font-size: 18px; font-weight: 600; color: #212529; 
      line-height: 1.3; 
    }
    .room-arrow { 
      width: 24px; height: 24px; color: #6c757d; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin-left: 16px;
      pointer-events: none;
    }
    .mantine-paper:hover .room-arrow { 
      color: #007bff; 
      transform: translateX(4px) rotate(5deg);
    }
    /* Loading overlay */
    .loading-overlay { 
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
      background: rgba(0,0,0,0.5); display: flex; 
      justify-content: center; align-items: center; z-index: 1000; 
    }
    .loading-overlay-content { 
      background: white; padding: 24px; border-radius: 12px; 
      text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
    }
    /* Responsive design */
    @media (max-width: 768px) { 
      .mantine-container { padding: 16px; } 
      .mantine-title { font-size: 28px; margin-bottom: 24px; }
      .mantine-subtitle { font-size: 16px; }
      .mantine-paper { padding: 16px; }
      .room-number { font-size: 16px; }
      .room-header { flex-direction: column; align-items: flex-start; }
      .mantine-text-input input { padding: 16px 18px; }
    }
    /* Styles loading state management */
    .styles-loading { 
      opacity: 0; 
      transform: translateY(20px);
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .styles-loaded { 
      opacity: 1; 
      transform: translateY(0);
    }
    
    /* Fade-in animation for cards */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .mantine-paper {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .mantine-paper:nth-child(1) { animation-delay: 0.1s; }
    .mantine-paper:nth-child(2) { animation-delay: 0.2s; }
    .mantine-paper:nth-child(3) { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="building-name" id="buildingName">å»ºç‰©åèª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="loading" class="loading">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="roomGrid" class="room-grid" style="display: none;"></div>
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>

    <script>
        let buildingData = null;
        let roomsData = null;

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å»ºç‰©IDã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const buildingId = urlParams.get('buildingId');

        if (!buildingId) {
            alert('å»ºç‰©IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            window.location.href = 'building_select.html';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.onload = function() {
            loadRoomData();
        };

        function loadRoomData() {
            console.log('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿é–‹å§‹:', buildingId);
            
            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onError)
                .getRoomsForBuilding(buildingId);
        }

        function onDataLoaded(data) {
            console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
            
            if (!data || !data.building || !data.rooms) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™:', data);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }

            buildingData = data.building;
            roomsData = data.rooms;

            document.getElementById('buildingName').textContent = buildingData.name;
            displayRooms();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('roomGrid').style.display = 'grid';
        }

        function displayRooms() {
            const roomGrid = document.getElementById('roomGrid');
            roomGrid.innerHTML = '';

            if (!roomsData || roomsData.length === 0) {
                roomGrid.innerHTML = '<p>éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            roomsData.forEach(room => {
                const roomButton = document.createElement('div');
                roomButton.className = 'room-button';
                
                const isCompleted = checkReadingStatus(room);
                
                if (isCompleted) {
                    roomButton.classList.add('reading-completed');
                } else {
                    roomButton.classList.add('reading-not-completed');
                }

                // ä¸€è¡Œã§æ¨ªä¸¦ã³è¡¨ç¤º
                let displayText = '';
                if (isCompleted && room.readingDateFormatted) {
                    displayText = `${room.roomNumber} æ¤œé‡æ¸ˆã¿ï¼š${room.readingDateFormatted}`;
                } else {
                    displayText = `${room.roomNumber} æœªæ¤œé‡`;
                }

                roomButton.innerHTML = `
                    <div class="room-text">${displayText}</div>
                `;

                roomButton.onclick = () => {
                    window.location.href = `meter_reading.html?buildingId=${buildingId}&roomId=${room.id}`;
                };

                roomGrid.appendChild(roomButton);
            });
        }

        function checkReadingStatus(room) {
            console.log('æ¤œé‡çŠ¶æ³ãƒã‚§ãƒƒã‚¯:', room);
            
            if (room.readingStatus !== undefined) {
                console.log('readingStatusã‹ã‚‰åˆ¤å®š:', room.readingStatus);
                return room.readingStatus === 'completed';
            }
            
            if (room.isCompleted !== undefined) {
                console.log('isCompletedã‹ã‚‰åˆ¤å®š:', room.isCompleted);
                return room.isCompleted === true;
            }
            
            console.log('æ¤œé‡çŠ¶æ³ä¸æ˜ã€æœªæ¤œé‡ã¨ã—ã¦æ‰±ã†');
            return false;
        }

        function onError(error) {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('loading').innerHTML = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
            alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }

        function goBack() {
            window.location.href = 'building_select.html';
        }
    </script>
</body>
</html>
      });
    }
    
    const formatDateForDisplay = (rawDate) => {
      if (!rawDate) return null;
      
      try {
        if (rawDate instanceof Date && !isNaN(rawDate.getTime())) {
          console.log('[room_select] formatDateForDisplay - Dateå‹ã‚’å‡¦ç†:', rawDate);
          const month = rawDate.getMonth() + 1;
          const day = rawDate.getDate();
          console.log(`[room_select] formatDateForDisplay - Dateå‹ã‹ã‚‰æŠ½å‡º: ${month}æœˆ${day}æ—¥`);
          return `${month}æœˆ${day}æ—¥`;
        }
        
        let dateStr = String(rawDate).trim();
        console.log('[room_select] formatDateForDisplay - æ–‡å­—åˆ—ã‚’å‡¦ç†:', dateStr);
        
        const match = dateStr.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
        if (match) {
          const [, year, month, day] = match;
          const result = `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
          console.log(`[room_select] formatDateForDisplay - æ–‡å­—åˆ—ã‹ã‚‰æŠ½å‡º: ${result}`);
          return result;
        }
        
        const dateObj = new Date(dateStr);
        if (!isNaN(dateObj.getTime())) {
          const month = dateObj.getMonth() + 1;
          const day = dateObj.getDate();
          console.log(`[room_select] formatDateForDisplay - Dateå¤‰æ›æˆåŠŸ: ${month}æœˆ${day}æ—¥`);
          return `${month}æœˆ${day}æ—¥`;
        }
        
        return null;
      } catch (error) {
        console.warn('[room_select] æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', rawDate, error);
        return null;
      }
    };
      const formatInspectionStatus = (rawDate) => {
      console.log('[room_select] formatInspectionStatus å‘¼ã³å‡ºã— - å¼•æ•°:', rawDate);
      
      // æœ€å„ªå…ˆ: hasActualReadingãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã‚‹åˆ¤å®š
      if (rawDate && typeof rawDate.hasActualReading === 'boolean') {
        const result = rawDate.hasActualReading
          ? { status: 'æ¤œé‡æ¸ˆã¿', displayDate: formatDateForDisplay(rawDate.rawInspectionDate || rawDate.inspectionDate) }
          : { status: 'æœªæ¤œé‡', displayDate: null };
        console.log('[room_select] formatInspectionStatus çµæœ (hasActualReadingåˆ¤å®š):', result);
        return result;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¥ä»˜ã®å­˜åœ¨ã«ã‚ˆã‚‹åˆ¤å®šï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
      const formattedDate = formatDateForDisplay(rawDate);
      const result = formattedDate ? 
        { status: 'æ¤œé‡æ¸ˆã¿', displayDate: formattedDate } : 
        { status: 'æœªæ¤œé‡', displayDate: null };
      
      console.log('[room_select] formatInspectionStatus çµæœ (æ—¥ä»˜åˆ¤å®š):', result);
      return result;
    };

    const getJSTDateString = () => {
      const now = new Date();
      const jstOffset = 9 * 60;
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const jstTime = new Date(utc + (jstOffset * 60000));
      
      const year = jstTime.getFullYear();
      const month = String(jstTime.getMonth() + 1).padStart(2, '0');
      const day = String(jstTime.getDate()).padStart(2, '0');
      
      const jstDateString = `${year}-${month}-${day}`;
      console.log(`[getJSTDateString] Stringå‹JSTæ—¥ä»˜ç”Ÿæˆ: ${jstDateString}`);
      return jstDateString;
    };
    
    const RoomSelectApp = () => {
      const [propertyId, setPropertyId] = React.useState(null);
      const [propertyName, setPropertyName] = React.useState('');
      const [rooms, setRooms] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [isNavigating, setIsNavigating] = React.useState(false);
      const [navigationMessage, setNavigationMessage] = React.useState('');

      React.useEffect(() => {
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        window.scrollTo(0, 0);
        
        // ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆWOFFåˆæœŸåŒ–ãªã—ï¼‰
        const loadRoomData = async () => {
          try {
            // sessionStorageã‹ã‚‰ç‰©ä»¶æƒ…å ±ã‚’å–å¾—
            const storedPropertyId = sessionStorage.getItem('selectedPropertyId');
            const storedPropertyName = sessionStorage.getItem('selectedPropertyName');
            
            console.log('[room_select] sessionStorageæƒ…å ± - propertyId:', storedPropertyId, 'propertyName:', storedPropertyName);

            if (storedPropertyName) {
              setPropertyName(storedPropertyName);
            } else {
              setPropertyName('ç‰©ä»¶æƒ…å ±ãªã—');
            }

            if (!storedPropertyId) {
              setError('ç‰©ä»¶IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
              setLoading(false);
              return;
            }

            setPropertyId(storedPropertyId);

            // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®ãƒã‚§ãƒƒã‚¯
            const forceRefresh = sessionStorage.getItem('forceRefreshRooms');
            const updatedRoomId = sessionStorage.getItem('updatedRoomId');
            const lastUpdateTime = sessionStorage.getItem('lastUpdateTime');
            
            console.log('[room_select] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒã‚§ãƒƒã‚¯ - forceRefresh:', forceRefresh, 'updatedRoomId:', updatedRoomId, 'lastUpdateTime:', lastUpdateTime);

            // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®å ´åˆï¼šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (forceRefresh === 'true') {
              console.log('[room_select] ğŸ”„ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œä¸­ - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—');
              
              try {
                const latestRooms = await refreshRoomDataFromBackend(storedPropertyId);
                
                if (updatedRoomId) {
                  const updatedRoom = latestRooms.find(room => room.roomId === updatedRoomId || room.id === updatedRoomId);
                  if (updatedRoom) {
                    console.log('[room_select] âœ… æ¤œé‡å®Œäº†ã«ã‚ˆã‚Šæ›´æ–°ã•ã‚ŒãŸéƒ¨å±‹:', updatedRoom.roomName || updatedRoom.name, 'æ¤œé‡æ—¥æ™‚:', updatedRoom.rawInspectionDate);
                  }
                }
                
                setRooms(latestRooms);
                
                // ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('forceRefreshRooms');
                sessionStorage.removeItem('updatedRoomId');
                sessionStorage.removeItem('lastUpdateTime');
                
                console.log('[room_select] ğŸ‰ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†');
              } catch (refreshError) {
                console.error('[room_select] âŒ å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—:', refreshError);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿
                const roomsString = sessionStorage.getItem('selectedRooms');
                if (roomsString) {
                  try {
                    const parsedRooms = JSON.parse(roomsString);
                    setRooms(Array.isArray(parsedRooms) ? parsedRooms : []);
                    console.log('[room_select] ğŸ“¦ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿å®Œäº†');
                    setError(null);
                  } catch (parseError) {
                    console.error('[room_select] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®è§£æå¤±æ•—:', parseError);
                    setRooms([]);
                    setError('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™ã€‚');
                  }
                } else {
                  console.warn('[room_select] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ãªã„å ´åˆã¯ç©ºé…åˆ—ã§ç¶™ç¶š');
                  setRooms([]);
                  setError('éƒ¨å±‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ãŒã€ç©ºã®çŠ¶æ…‹ã§ç¶™ç¶šã—ã¾ã™ã€‚');
                }
              }
            } 
            // é€šå¸¸æ™‚ï¼šçµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿
            else {
              const roomsString = sessionStorage.getItem('selectedRooms');
              console.log('[room_select] ğŸ“¦ çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ (selectedRooms) ã‹ã‚‰èª­ã¿è¾¼ã¿ - ãƒ‡ãƒ¼ã‚¿é•·:', roomsString?.length);
              
              if (roomsString) {
                try {
                  const parsedRooms = JSON.parse(roomsString);
                  console.log('[room_select] ğŸ” ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿è©³ç´°:', {
                    type: typeof parsedRooms,
                    isArray: Array.isArray(parsedRooms),
                    length: parsedRooms ? parsedRooms.length : 'no length property',
                    content: parsedRooms
                  });
                  console.log('[room_select] Parsed rooms from unified cache:', Array.isArray(parsedRooms) ? parsedRooms.length : 'not array', 'ä»¶');
                  setRooms(Array.isArray(parsedRooms) ? parsedRooms : []);
                } catch (e) {
                  console.error('[room_select] sessionStorageã‹ã‚‰éƒ¨å±‹æƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                  setRooms([]);
                  setError('éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç©ºã®çŠ¶æ…‹ã§ç¶™ç¶šã—ã¾ã™ã€‚');
                }
              } else {
                console.warn('[room_select] çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãªã— - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ');
                
                try {
                  const latestRooms = await refreshRoomDataFromBackend(storedPropertyId);
                  setRooms(latestRooms);
                } catch (fetchError) {
                  console.error('[room_select] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', fetchError);
                  setRooms([]);
                  setError('éƒ¨å±‹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç©ºã®çŠ¶æ…‹ã§ç¶™ç¶šã—ã¾ã™ã€‚');
                }
              }
            }
          } catch (error) {
            console.error('[room_select] Error during room data loading:', error);
            
            // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã§ã‚‚æœ€ä½é™ã®çŠ¶æ…‹ã‚’ä¿æŒ
            setRooms([]);
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šï¼ˆä½†ã—ã€è‡´å‘½çš„ã§ã¯ãªã„å ´åˆã¯ç¶™ç¶šï¼‰
            if (error.message && error.message.includes('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼')) {
              console.warn('[room_select] ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ã§ã™ãŒã€ç©ºé…åˆ—ã§ç¶™ç¶šã—ã¾ã™:', error.message);
              setError(null);
            } else {
              setError(`éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
          } finally {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’å¿…ãšè§£é™¤
            console.log('[room_select] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤ã—ã¾ã™');
            setLoading(false);
          }
        };

        loadRoomData();
      }, []);

      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ã®éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      const refreshRoomDataFromBackend = async (propertyId) => {
        try {
          console.log('[room_select] ğŸ”„ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', propertyId);
          
          const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
          if (!gasWebAppUrl) {
            throw new Error('GAS Web Appã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }

          const requestUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${encodeURIComponent(propertyId)}`;
          const response = await fetch(requestUrl, { method: 'GET' });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('[room_select] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
          
          if (result.error) {
            throw new Error(result.error);
          }

          // çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ¤å®šå‡¦ç†
          let roomsData = [];
          console.log('[room_select] ğŸ” ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼åˆ¤å®šé–‹å§‹');
          console.log('[room_select] ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°:', {
            type: typeof result,
            isNull: result === null,
            isUndefined: result === undefined,
            hasSuccess: result && typeof result === 'object' && 'success' in result,
            successValue: result?.success,
            successType: typeof result?.success,
            hasData: result && typeof result === 'object' && 'data' in result,
            dataValue: result?.data,
            dataType: typeof result?.data,
            isDataArray: Array.isArray(result?.data),
            isDirectArray: Array.isArray(result),
            hasRooms: result && typeof result === 'object' && 'rooms' in result,
            roomsValue: result?.rooms,
            isRoomsArray: Array.isArray(result?.rooms)
          });

          // ãƒ‘ã‚¿ãƒ¼ãƒ³1: çµ±ä¸€å½¢å¼ {success: true, data: []}
          if (result && 
              typeof result === 'object' && 
              result !== null && 
              result.success === true && 
              result.data && 
              Array.isArray(result.data)) {
            roomsData = result.data;
            console.log('[room_select] âœ… çµ±ä¸€å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', roomsData.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç›´æ¥é…åˆ—
          else if (Array.isArray(result)) {
            roomsData = result;
            console.log('[room_select] âš ï¸ ç›´æ¥é…åˆ—å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', roomsData.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³3: rooms ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
          else if (result && 
                   typeof result === 'object' && 
                   result !== null && 
                   result.rooms && 
                   Array.isArray(result.rooms)) {
            roomsData = result.rooms;
            console.log('[room_select] âš ï¸ roomså½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', roomsData.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚‚ç¶™ç¶šå‡¦ç†
          else if (result && typeof result === 'object' && result !== null) {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã‚ã‚‹ãŒã€äºˆæœŸã•ã‚ŒãŸå½¢å¼ã§ã¯ãªã„å ´åˆ
            console.warn('[room_select] âš ï¸ äºˆæœŸã—ãªã„å½¢å¼ã ãŒç©ºé…åˆ—ã§ç¶™ç¶š:', result);
            roomsData = [];
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³5: å®Œå…¨ã«ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
          else {
            console.error('[room_select] âŒ å®Œå…¨ã«ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
            roomsData = [];
          }

          console.log('[room_select] æœ€çµ‚æ¡ç”¨ãƒ‡ãƒ¼ã‚¿:', roomsData.length, 'ä»¶');

          console.log('[room_select] âœ… æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', roomsData.length, 'ä»¶');
          
          // çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã§ä¿å­˜
          sessionStorage.setItem('selectedRooms', JSON.stringify(roomsData));
          console.log('[room_select] ğŸ“¦ çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ (selectedRooms) ã§ä¿å­˜å®Œäº†');
          
          return roomsData;
          
        } catch (error) {
          console.error('[room_select] âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ç©ºé…åˆ—ã‚’è¿”ã—ã¦å‡¦ç†ã‚’ç¶™ç¶š
          console.warn('[room_select] ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã—ã¦å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™');
          return [];
        }
      };

      const handleBackToPropertySelect = () => {
        setIsNavigating(true);
        setNavigationMessage('ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...');
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é·ç§»
        window.scrollTo(0, 0);
        window.location.href = '/property_select';
      };

      // LoadingOverlayã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      const LoadingOverlay = ({ message }) => (
        <div className="loading-overlay">
          <div className="loading-overlay-content">
            <div className="mantine-loader" />
            <p style={{
              marginTop: '16px',
              color: '#666',
              fontSize: '14px',
              textAlign: 'center',
            }}>
              {message}
            </p>
          </div>
        </div>
      );

      const handleRoomSelect = (room) => {
        console.log('[room_select] handleRoomSelect called:', { room, propertyId, propertyName, loading, isNavigating });
        
        if (!propertyId || !propertyName || !room) {
          console.error('[room_select] Invalid data for room selection:', { propertyId, propertyName, room });
          alert('é¸æŠã•ã‚ŒãŸéƒ¨å±‹æƒ…å ±ãŒç„¡åŠ¹ã§ã™ã€‚');
          return;
        }

        if (loading || isNavigating) {
          console.warn('[room_select] Room selection blocked - currently loading or navigating');
          return;
        }

        console.log('[room_select] Starting room selection process...');
        setIsNavigating(true);
        setNavigationMessage('æ¤œé‡ç”»é¢ã«ç§»å‹•ã—ã¦ã„ã¾ã™...');
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é·ç§»
        window.scrollTo(0, 0);

        // meter_reading.html ã«ç‰©ä»¶IDã€ç‰©ä»¶åã€éƒ¨å±‹IDã€éƒ¨å±‹åã‚’æ¸¡ã—ã¦ç”»é¢é·ç§»
        const params = new URLSearchParams();
        params.append('propertyId', propertyId);
        params.append('propertyName', propertyName);
        params.append('roomId', room.id);
        params.append('roomName', room.name);
        
        const targetUrl = `/meter_reading?${params.toString()}`;
        
        console.log(`[room_select] Redirecting to: ${targetUrl}`);
        window.location.href = targetUrl;
      };

      const handleInspectionComplete = async () => {
        if (!propertyId) {
          alert('ç‰©ä»¶IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        try {
          setLoading(true);

          // sessionStorageã‹ã‚‰GAS URLã‚’å–å¾—ï¼ˆproperty_select.htmlã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼‰
          const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl');
          
          if (!gasWebAppUrl) {
            alert('ã‚¨ãƒ©ãƒ¼: GAS Web Appã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            console.error('[room_select] gasWebAppUrlãŒsessionStorageã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            setLoading(false);
            return;
          }
          
          const requestUrl = `${gasWebAppUrl}?action=updateInspectionComplete&propertyId=${encodeURIComponent(propertyId)}`;

          console.log('[room_select] æ¤œé‡å®Œäº†ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ (GETæ–¹å¼):', {
            url: requestUrl,
            propertyId: propertyId
          });

          const response = await fetch(requestUrl, {
            method: 'GET'
          });

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          alert('æ¤œé‡å®Œäº†æ—¥ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
          
        } catch (error) {
          console.error('[room_select] æ¤œé‡å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          alert(`æ¤œé‡å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­
      if (loading) {
        return (
          <div className="mantine-container">
            <div className="mantine-stack">
              <button
                onClick={handleBackToPropertySelect}
                className="mantine-button variant-outline"
              >
                ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
              </button>
              <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
              <p className="mantine-subtitle">ç‰©ä»¶åï¼šèª­ã¿è¾¼ã¿ä¸­...</p>
              <div className="mantine-center">
                <div className="mantine-stack center">
                  <div className="mantine-loader"></div>
                  <p className="mantine-text">éƒ¨å±‹æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤º
      if (error) {
        return (
          <div className="mantine-container">
            <div className="mantine-stack">
              <button
                onClick={handleBackToPropertySelect}
                className="mantine-button variant-outline"
              >
                ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
              </button>
              <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
              <p className="mantine-subtitle">ç‰©ä»¶åï¼š{propertyName}</p>
              <div className="mantine-alert">
                <h3 className="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p className="mantine-text">{error}</p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="mantine-container">
          {isNavigating && <LoadingOverlay message={navigationMessage} />}
          <div className="mantine-stack">
            <button
              onClick={handleBackToPropertySelect}
              className="mantine-button variant-outline"
            >
              ç‰©ä»¶é¸æŠã¸æˆ»ã‚‹
            </button>
            <h1 className="mantine-title">éƒ¨å±‹é¸æŠ</h1>
            <p className="mantine-subtitle">ç‰©ä»¶åï¼š{propertyName}</p>
            
            <button
              onClick={handleInspectionComplete}
              disabled={loading}
              className="mantine-button variant-filled inspection-complete-btn"
            >
              {loading ? 'æ›´æ–°ä¸­...' : 'æ¤œé‡å®Œäº†'}
            </button>

            {!Array.isArray(rooms) && (
              <div className="mantine-alert">
                <h3 className="mantine-text weight-600">ã‚¨ãƒ©ãƒ¼</h3>
                <p className="mantine-text">éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              </div>
            )}
            
            {Array.isArray(rooms) && rooms.length === 0 && (
              <p className="mantine-text center">ã“ã®ç‰©ä»¶ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            )}            {Array.isArray(rooms) && rooms.length > 0 && (
              <div className="mantine-stack">
                {rooms.map((room, index) => {
                  // ğŸ” å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ãƒ‡ãƒãƒƒã‚°
                  console.log(`[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿[${index}] å®Ÿéš›ã®æ§‹é€ :`, room);
                  console.log(`[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿[${index}] ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸€è¦§:`, Object.keys(room));
                  
                  // ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å‡¦ç†ã‚’è¿½åŠ 
                  const normalizedRoom = {
                    ...room,
                    // è‹±èªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã¯æ—¥æœ¬èªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
                    id: room.id || room.roomId || room['éƒ¨å±‹ID'] || `room-${index}`,
                    name: room.name || room.roomName || room['éƒ¨å±‹å'] || 'éƒ¨å±‹åæœªè¨­å®š',
                    rawInspectionDate: room.rawInspectionDate || room.inspectionDate || room['æ¤œé‡æ—¥æ™‚'],
                    hasActualReading: room.hasActualReading || room.hasReading || room['æ¤œé‡æ¸ˆã¿'] || false
                  };
                  
                  console.log(`[room_select] æ­£è¦åŒ–å¾Œãƒ‡ãƒ¼ã‚¿[${index}]:`, normalizedRoom);
                  
                  // ãƒ‡ãƒãƒƒã‚°: å„éƒ¨å±‹ã®æ­£è¦åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
                  console.log('[room_select] éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å‡¦ç†:', {
                    roomId: normalizedRoom.id,
                    name: normalizedRoom.name,
                    rawInspectionDate: normalizedRoom.rawInspectionDate,
                    hasActualReading: normalizedRoom.hasActualReading,
                    rawInspectionDateType: typeof normalizedRoom.rawInspectionDate
                  });
                  
                  // åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ã‚’ä½¿ç”¨
                  const displayName = normalizedRoom.name || 'éƒ¨å±‹åæœªè¨­å®š';
                  // hasActualReadingã‚’å„ªå…ˆçš„ã«ä½¿ã†
                  const inspectionStatus = formatInspectionStatus({
                    rawInspectionDate: normalizedRoom.rawInspectionDate,
                    hasActualReading: normalizedRoom.hasActualReading
                  });                  // æ¤œé‡æ¸ˆã¿ã®å ´åˆã¯æœˆæ—¥ã®ã¿ã‚’è¡¨ç¤ºã€æœªæ¤œé‡ã®å ´åˆã¯[æœªæ¤œé‡]
                  let statusDisplay = null;
                  if (inspectionStatus.status === 'æ¤œé‡æ¸ˆã¿' && inspectionStatus.displayDate) {
                    statusDisplay = (
                      <span style={{
                        color: 'var(--mantine-color-blue-6)',
                        fontWeight: '500',
                        fontSize: '0.9em',
                        marginLeft: '8px'
                      }}>
                        [{inspectionStatus.displayDate}]
                      </span>
                    );
                  } else if (inspectionStatus.status === 'æ¤œé‡æ¸ˆã¿' && !inspectionStatus.displayDate) {
                    // æ¤œé‡æ¸ˆã¿ã ãŒæ—¥ä»˜ãŒãªã„å ´åˆã‚‚[æ¤œé‡æ¸ˆã¿]ã¨è¡¨ç¤º
                    statusDisplay = (
                      <span style={{
                        color: 'var(--mantine-color-blue-6)',
                        fontWeight: '500',
                        fontSize: '0.9em',
                        marginLeft: '8px'
                      }}>
                        [æ¤œé‡æ¸ˆã¿]
                      </span>
                    );
                  } else if (inspectionStatus.status === 'æœªæ¤œé‡') {
                    statusDisplay = (
                      <span style={{
                        color: 'var(--mantine-color-red-6)',
                        fontWeight: '600',
                        fontSize: '0.9em',
                        marginLeft: '8px'
                      }}>
                        [æœªæ¤œé‡]
                      </span>
                    );
                  }
                    return (
                    <div 
                      key={normalizedRoom.id}
                      className={`mantine-paper ${loading || isNavigating ? 'disabled' : ''}`}
                      onClick={() => {
                        if (!loading && !isNavigating) {
                          console.log('[room_select] Room card clicked:', normalizedRoom);
                          handleRoomSelect(normalizedRoom);
                        } else {
                          console.log('[room_select] Click ignored - loading/navigating state');
                        }
                      }}
                      style={{
                        cursor: loading || isNavigating ? 'not-allowed' : 'pointer',
                        pointerEvents: 'auto'
                      }}
                    >
                      <div className="room-card">
                        <div className="room-info">
                          <div className="room-header">
                            <span className="room-number">
                              {displayName}
                              {/* åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿æ¤œé‡çŠ¶æ³ã‚’è¡¨ç¤º */}
                              {statusDisplay}
                            </span>
                          </div>
                        </div>
                        <svg className="room-arrow" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    };

    // CSSèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
    waitForStylesLoaded().then(() => {
      console.log('ğŸ¨ éƒ¨å±‹é¸æŠã‚¢ãƒ—ãƒªèµ·å‹•: CSSèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ');
      
      // Use React 18 createRoot API instead of ReactDOM.render
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<RoomSelectApp />);
      console.log('ğŸ‰ éƒ¨å±‹é¸æŠã‚¢ãƒ—ãƒªèµ·å‹•å®Œäº†');
    }).catch(error => {
      console.error('CSSèª­ã¿è¾¼ã¿å¾…æ©Ÿã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<RoomSelectApp />);
    });
  </script>
  
  <!-- PWAåˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // PWAæ©Ÿèƒ½ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[PWA] Room Select page loaded with PWA support (Browser version)');
      
      // Service Workerç™»éŒ²
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('[PWA] Service Worker registered from room select page');
            })
            .catch(error => {
              console.error('[PWA] Service Worker registration failed:', error);
            });
        });
      }
      
      // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã®ç¢ºèª
      if (window.pwaUtils) {
        const appInfo = window.pwaUtils.getAppInfo();
        console.log('[PWA] App info:', appInfo);
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã€UIèª¿æ•´
        if (appInfo.isInstalled) {
          document.body.classList.add('pwa-installed');
        }
        
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®å ´åˆã€è­¦å‘Šè¡¨ç¤º
        if (!appInfo.isOnline) {
          window.pwaUtils.showNetworkStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³', 'warning');
        }
      }
    });
  </script>
</body>
</html>