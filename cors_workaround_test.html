<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ CORSå›é¿ãƒ†ã‚¹ãƒˆï¼ˆiframeä½¿ç”¨ï¼‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ CORSå›é¿ãƒ†ã‚¹ãƒˆï¼ˆiframeä½¿ç”¨ï¼‰</h1>
        
        <div class="test-section">
            <h3>Method 1: ç›´æ¥iframeè¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h3>
            <p>GAS Web AppãŒå®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‹iframeã§ç¢ºèª</p>
            <button class="btn" onclick="testWithIframe()">iframeãƒ†ã‚¹ãƒˆ</button>
            <iframe id="gasIframe" src="about:blank"></iframe>
        </div>

        <div class="test-section">
            <h3>Method 2: ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ</h3>
            <p>CORSåˆ¶é™ã‚’å›é¿ã—ã¦GAS Web Appã¸ã®åˆ°é”å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ</p>
            <button class="btn" onclick="testWithImage()">ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div class="test-section">
            <h3>Method 3: å¤–éƒ¨ã‹ã‚‰cURLãƒ†ã‚¹ãƒˆ</h3>
            <p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:</p>
            <code style="background: #f0f0f0; padding: 10px; display: block; margin: 10px 0;">
curl -L "https://script.google.com/macros/s/AKfycbw4dn-KCK-iafRzd2Oq0GGMwID6mPwA9C3uuBHYq4yKcjKjJJmkzrkodRMZIVcSy1eu3A/exec?action=test"
            </code>
        </div>

        <div class="test-section">
            <h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆCORSå›é¿ç‰ˆï¼‰</h3>
            <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" value="test_user">
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="test_password">
            <br>
            <button class="btn" onclick="testLoginCorsWorkaround()">CORSå›é¿ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div id="results"></div>
        <div class="log" id="log"></div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw4dn-KCK-iafRzd2Oq0GGMwID6mPwA9C3uuBHYq4yKcjKjJJmkzrkodRMZIVcSy1eu3A/exec';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logElement = document.getElementById('log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showResult(type, message) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            results.appendChild(div);
        }

        function testWithIframe() {
            log('=== iframeãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const iframe = document.getElementById('gasIframe');
            const testUrl = `${GAS_WEB_APP_URL}?action=test&timestamp=${Date.now()}`;
            
            log(`iframe URL: ${testUrl}`);
            
            iframe.onload = function() {
                log('iframeèª­ã¿è¾¼ã¿å®Œäº†');
                showResult('success', 'iframeã§GAS Web AppãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                
                // iframeå†…å®¹ã‚’ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã‚ã‚Šï¼‰
                try {
                    const content = iframe.contentDocument || iframe.contentWindow.document;
                    log(`iframeå†…å®¹: ${content.body ? content.body.innerText.substring(0, 200) : 'å†…å®¹ç¢ºèªä¸å¯ï¼ˆCORSåˆ¶é™ï¼‰'}`);
                } catch (e) {
                    log(`iframeå†…å®¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}ï¼ˆæ­£å¸¸ï¼šCORSåˆ¶é™ï¼‰`);
                }
            };
            
            iframe.onerror = function() {
                log('iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                showResult('error', 'iframeã§ã®GAS Web Appè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
            };
            
            iframe.src = testUrl;
        }

        function testWithImage() {
            log('=== ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const img = new Image();
            const testUrl = `${GAS_WEB_APP_URL}?action=test&timestamp=${Date.now()}`;
            
            log(`ç”»åƒURL: ${testUrl}`);
            
            img.onload = function() {
                log('ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸï¼ˆåˆ°é”å¯èƒ½ï¼‰');
                showResult('success', 'GAS Web Appã‚µãƒ¼ãƒãƒ¼ã«åˆ°é”å¯èƒ½ã§ã™');
            };
            
            img.onerror = function() {
                log('ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚ã‚Šï¼‰');
                showResult('success', 'GAS Web Appã‚µãƒ¼ãƒãƒ¼ã«åˆ°é”ã—ã€å¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸï¼ˆç”»åƒä»¥å¤–ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰');
            };
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
            setTimeout(() => {
                if (!img.complete) {
                    log('ç”»åƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                    showResult('error', 'GAS Web Appã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                }
            }, 10000);
            
            img.src = testUrl;
        }

        function testLoginCorsWorkaround() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showResult('error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            log('=== CORSå›é¿ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${username}`);
            
            // Method: æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§GAS Web Appã‚’é–‹ã
            const authUrl = `${GAS_WEB_APP_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&t=${Date.now()}`;
            log(`èªè¨¼URL: ${authUrl.substring(0, 150)}...`);
            
            const popup = window.open(authUrl, 'gasAuth', 'width=600,height=400');
            
            if (popup) {
                log('èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ');
                showResult('success', 'èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§GAS Web Appã®å¿œç­”ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ç›£è¦–
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        log('èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ');
                        showResult('success', 'èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã®çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                }, 1000);
                
                // 30ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                setTimeout(() => {
                    if (!popup.closed) {
                        clearInterval(checkClosed);
                        popup.close();
                        log('èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                    }
                }, 30000);
            } else {
                log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                showResult('error', 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                
                // ä»£æ›¿æ–¹æ³•ï¼šç›´æ¥ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                const linkDiv = document.createElement('div');
                linkDiv.innerHTML = `<a href="${authUrl}" target="_blank">ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èªè¨¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„</a>`;
                document.getElementById('results').appendChild(linkDiv);
            }
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            log('CORSå›é¿ãƒ†ã‚¹ãƒˆé–‹å§‹');
            log(`GAS URL: ${GAS_WEB_APP_URL}`);
        });
    </script>
</body>
</html>
