<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 CORS回避テスト（iframe使用）</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 CORS回避テスト（iframe使用）</h1>
        
        <div class="test-section">
            <h3>Method 1: 直接iframe表示テスト</h3>
            <p>GAS Web Appが実際に動作するかiframeで確認</p>
            <button class="btn" onclick="testWithIframe()">iframeテスト</button>
            <iframe id="gasIframe" src="about:blank"></iframe>
        </div>

        <div class="test-section">
            <h3>Method 2: 画像リクエストテスト</h3>
            <p>CORS制限を回避してGAS Web Appへの到達可能性をテスト</p>
            <button class="btn" onclick="testWithImage()">画像リクエストテスト</button>
        </div>

        <div class="test-section">
            <h3>Method 3: 外部からcURLテスト</h3>
            <p>以下のコマンドをターミナルで実行してください:</p>
            <code style="background: #f0f0f0; padding: 10px; display: block; margin: 10px 0;">
curl -L "https://script.google.com/macros/s/AKfycbw4dn-KCK-iafRzd2Oq0GGMwID6mPwA9C3uuBHYq4yKcjKjJJmkzrkodRMZIVcSy1eu3A/exec?action=test"
            </code>
        </div>

        <div class="test-section">
            <h3>ログインテスト（CORS回避版）</h3>
            <input type="text" id="username" placeholder="ユーザー名" value="test_user">
            <input type="password" id="password" placeholder="パスワード" value="test_password">
            <br>
            <button class="btn" onclick="testLoginCorsWorkaround()">CORS回避ログインテスト</button>
        </div>

        <div id="results"></div>
        <div class="log" id="log"></div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw4dn-KCK-iafRzd2Oq0GGMwID6mPwA9C3uuBHYq4yKcjKjJJmkzrkodRMZIVcSy1eu3A/exec';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logElement = document.getElementById('log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showResult(type, message) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            results.appendChild(div);
        }

        function testWithIframe() {
            log('=== iframeテスト開始 ===');
            
            const iframe = document.getElementById('gasIframe');
            const testUrl = `${GAS_WEB_APP_URL}?action=test&timestamp=${Date.now()}`;
            
            log(`iframe URL: ${testUrl}`);
            
            iframe.onload = function() {
                log('iframe読み込み完了');
                showResult('success', 'iframeでGAS Web Appが表示されました');
                
                // iframe内容を確認（セキュリティ制限あり）
                try {
                    const content = iframe.contentDocument || iframe.contentWindow.document;
                    log(`iframe内容: ${content.body ? content.body.innerText.substring(0, 200) : '内容確認不可（CORS制限）'}`);
                } catch (e) {
                    log(`iframe内容確認エラー: ${e.message}（正常：CORS制限）`);
                }
            };
            
            iframe.onerror = function() {
                log('iframe読み込みエラー');
                showResult('error', 'iframeでのGAS Web App表示に失敗しました');
            };
            
            iframe.src = testUrl;
        }

        function testWithImage() {
            log('=== 画像リクエストテスト開始 ===');
            
            const img = new Image();
            const testUrl = `${GAS_WEB_APP_URL}?action=test&timestamp=${Date.now()}`;
            
            log(`画像URL: ${testUrl}`);
            
            img.onload = function() {
                log('画像リクエスト成功（到達可能）');
                showResult('success', 'GAS Web Appサーバーに到達可能です');
            };
            
            img.onerror = function() {
                log('画像リクエストエラー（サーバー応答あり）');
                showResult('success', 'GAS Web Appサーバーに到達し、応答を受信しました（画像以外のレスポンス）');
            };
            
            // タイムアウト設定
            setTimeout(() => {
                if (!img.complete) {
                    log('画像リクエストタイムアウト');
                    showResult('error', 'GAS Web Appサーバーからの応答がタイムアウトしました');
                }
            }, 10000);
            
            img.src = testUrl;
        }

        function testLoginCorsWorkaround() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showResult('error', 'ユーザー名とパスワードを入力してください');
                return;
            }
            
            log('=== CORS回避ログインテスト開始 ===');
            log(`ユーザー名: ${username}`);
            
            // Method: 新しいウィンドウでGAS Web Appを開く
            const authUrl = `${GAS_WEB_APP_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&t=${Date.now()}`;
            log(`認証URL: ${authUrl.substring(0, 150)}...`);
            
            const popup = window.open(authUrl, 'gasAuth', 'width=600,height=400');
            
            if (popup) {
                log('認証ウィンドウを開きました');
                showResult('success', '認証ウィンドウでGAS Web Appの応答を確認してください');
                
                // ポップアップの監視
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        log('認証ウィンドウが閉じられました');
                        showResult('success', '認証ウィンドウでの結果を確認してください');
                    }
                }, 1000);
                
                // 30秒後にタイムアウト
                setTimeout(() => {
                    if (!popup.closed) {
                        clearInterval(checkClosed);
                        popup.close();
                        log('認証ウィンドウタイムアウト');
                    }
                }, 30000);
            } else {
                log('ポップアップブロックされました');
                showResult('error', 'ポップアップがブロックされました。ブラウザ設定を確認してください。');
                
                // 代替方法：直接リンクを表示
                const linkDiv = document.createElement('div');
                linkDiv.innerHTML = `<a href="${authUrl}" target="_blank">こちらをクリックして認証をテストしてください</a>`;
                document.getElementById('results').appendChild(linkDiv);
            }
        }

        // 初期化
        window.addEventListener('load', function() {
            log('CORS回避テスト開始');
            log(`GAS URL: ${GAS_WEB_APP_URL}`);
        });
    </script>
</body>
</html>
