<!DOCTYPE html>
<html lang="ja">
<head>
  <title>統合CSS読み込み検証ツール</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px; margin: 20px 0;
    }
    .test-card {
      background: #f8f9fa; padding: 20px; border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .test-card h3 { margin-top: 0; color: #007bff; }
    .test-result {
      margin: 10px 0; padding: 10px; border-radius: 4px;
      background-color: #fff; border-left: 3px solid #28a745;
      font-family: monospace; font-size: 14px;
    }
    .error { border-left-color: #dc3545; background-color: #f8d7da; }
    .warning { border-left-color: #ffc107; background-color: #fff3cd; }
    .success { border-left-color: #28a745; background-color: #d4edda; }
    button {
      padding: 8px 16px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .link-button {
      display: inline-block; padding: 8px 16px; margin: 5px;
      background-color: #6c757d; color: white; text-decoration: none;
      border-radius: 4px; transition: all 0.2s;
    }
    .link-button:hover { background-color: #545b62; }
    iframe {
      width: 100%; height: 300px; border: 1px solid #ddd;
      border-radius: 4px; margin: 10px 0;
    }
    .status-indicator {
      display: inline-block; width: 10px; height: 10px;
      border-radius: 50%; margin-right: 8px;
    }
    .status-ok { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-error { background-color: #dc3545; }
    .metrics {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px; margin: 15px 0;
    }
    .metric {
      background: white; padding: 10px; border-radius: 4px;
      text-align: center; border: 1px solid #ddd;
    }
    .metric-value { font-size: 20px; font-weight: bold; color: #007bff; }
    .metric-label { font-size: 12px; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 水道メーター読み取りアプリ - CSS読み込み修正検証</h1>
    <p>実装されたCSS読み込み修正の効果を総合的に検証します。</p>
    
    <div class="test-grid">
      <!-- 物件選択ページテスト -->
      <div class="test-card">
        <h3>📋 物件選択ページ</h3>
        <div id="property-status"></div>
        <button onclick="testPage('property_select.html', 'property')">テスト実行</button>
        <a href="property_select.html" target="_blank" class="link-button">ページを開く</a>
        <div id="property-results"></div>
      </div>
      
      <!-- 部屋選択ページテスト -->
      <div class="test-card">
        <h3>🏠 部屋選択ページ</h3>
        <div id="room-status"></div>
        <button onclick="testPage('room_select.html', 'room')">テスト実行</button>
        <a href="room_select.html" target="_blank" class="link-button">ページを開く</a>
        <div id="room-results"></div>
      </div>
      
      <!-- メーター読み取りページテスト -->
      <div class="test-card">
        <h3>📊 メーター読み取りページ</h3>
        <div id="meter-status"></div>
        <button onclick="testPage('meter_reading.html', 'meter')">テスト実行</button>
        <a href="meter_reading.html" target="_blank" class="link-button">ページを開く</a>
        <div id="meter-results"></div>
      </div>
    </div>
    
    <!-- 総合結果 -->
    <div class="test-card">
      <h3>📊 総合テスト結果</h3>
      <div class="metrics" id="overall-metrics"></div>
      <button onclick="runAllTests()">🚀 全ページテスト実行</button>
      <button onclick="generateReport()">📄 レポート生成</button>
      <button onclick="clearAllResults()">🗑️ 結果クリア</button>
      <div id="overall-results"></div>
    </div>
    
    <!-- ブラウザ比較テスト -->
    <div class="test-card">
      <h3>🌐 ブラウザ比較テスト</h3>
      <p>異なるブラウザでのCSS読み込み動作を比較します。</p>
      <div id="browser-info"></div>
      <button onclick="detectBrowserInfo()">ブラウザ情報取得</button>
    </div>
  </div>

  <script>
    let testResults = {
      property: null,
      room: null,
      meter: null
    };

    // 個別ページテスト
    function testPage(url, pageType) {
      const statusDiv = document.getElementById(`${pageType}-status`);
      const resultsDiv = document.getElementById(`${pageType}-results`);
      
      statusDiv.innerHTML = '<span class="status-indicator status-warning"></span>テスト実行中...';
      resultsDiv.innerHTML = '';
      
      const startTime = performance.now();
      
      // 隠しiframeでページを読み込んでテスト
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      
      iframe.onload = () => {
        const loadTime = performance.now() - startTime;
        
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          const iframeWindow = iframe.contentWindow;
          
          // CSS読み込み状況をチェック
          const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
          const cssLoaded = Array.from(cssLinks).every(link => link.sheet !== null);
          
          // クリティカルCSSの効果をチェック
          const testElement = iframeDoc.createElement('div');
          testElement.className = 'mantine-button';
          testElement.style.position = 'absolute';
          testElement.style.visibility = 'hidden';
          iframeDoc.body.appendChild(testElement);
          
          const computedStyle = iframeWindow.getComputedStyle(testElement);
          const hasButtonStyles = computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                                 computedStyle.backgroundColor !== 'transparent';
          
          iframeDoc.body.removeChild(testElement);
          
          // Root要素のFOUC対策チェック
          const rootElement = iframeDoc.getElementById('root');
          const hasStylesClass = rootElement && 
            (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
          
          // 結果をまとめ
          const result = {
            url,
            loadTime: loadTime.toFixed(2),
            cssLoaded,
            hasButtonStyles,
            hasStylesClass,
            cssCount: cssLinks.length,
            timestamp: new Date().toLocaleTimeString()
          };
          
          testResults[pageType] = result;
          displayTestResult(pageType, result);
          
        } catch (error) {
          const errorResult = {
            url,
            error: error.message,
            loadTime: loadTime.toFixed(2),
            timestamp: new Date().toLocaleTimeString()
          };
          
          testResults[pageType] = errorResult;
          displayErrorResult(pageType, errorResult);
        }
        
        document.body.removeChild(iframe);
      };
      
      iframe.onerror = () => {
        const errorResult = {
          url,
          error: 'ページ読み込みエラー',
          timestamp: new Date().toLocaleTimeString()
        };
        
        testResults[pageType] = errorResult;
        displayErrorResult(pageType, errorResult);
        document.body.removeChild(iframe);
      };
      
      document.body.appendChild(iframe);
    }

    function displayTestResult(pageType, result) {
      const statusDiv = document.getElementById(`${pageType}-status`);
      const resultsDiv = document.getElementById(`${pageType}-results`);
      
      const overallStatus = result.cssLoaded && result.hasButtonStyles && result.hasStylesClass;
      const statusClass = overallStatus ? 'status-ok' : 'status-warning';
      const statusText = overallStatus ? '✅ 正常' : '⚠️ 要確認';
      
      statusDiv.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;
      
      resultsDiv.innerHTML = `
        <div class="test-result ${overallStatus ? 'success' : 'warning'}">
          <strong>読み込み時間:</strong> ${result.loadTime}ms<br>
          <strong>CSS読み込み:</strong> ${result.cssLoaded ? '✅' : '❌'} (${result.cssCount}ファイル)<br>
          <strong>スタイル適用:</strong> ${result.hasButtonStyles ? '✅' : '❌'}<br>
          <strong>FOUC対策:</strong> ${result.hasStylesClass ? '✅' : '❌'}<br>
          <strong>テスト時刻:</strong> ${result.timestamp}
        </div>
      `;
    }

    function displayErrorResult(pageType, result) {
      const statusDiv = document.getElementById(`${pageType}-status`);
      const resultsDiv = document.getElementById(`${pageType}-results`);
      
      statusDiv.innerHTML = '<span class="status-indicator status-error"></span>❌ エラー';
      
      resultsDiv.innerHTML = `
        <div class="test-result error">
          <strong>エラー:</strong> ${result.error}<br>
          <strong>URL:</strong> ${result.url}<br>
          <strong>時刻:</strong> ${result.timestamp}
        </div>
      `;
    }

    // 全ページテスト
    function runAllTests() {
      testPage('property_select.html', 'property');
      setTimeout(() => testPage('room_select.html', 'room'), 1000);
      setTimeout(() => testPage('meter_reading.html', 'meter'), 2000);
      setTimeout(updateOverallMetrics, 3000);
    }

    // 総合メトリクス更新
    function updateOverallMetrics() {
      const metricsDiv = document.getElementById('overall-metrics');
      
      const completedTests = Object.values(testResults).filter(r => r !== null).length;
      const successfulTests = Object.values(testResults).filter(r => 
        r && !r.error && r.cssLoaded && r.hasButtonStyles && r.hasStylesClass
      ).length;
      
      const averageLoadTime = Object.values(testResults)
        .filter(r => r && r.loadTime)
        .reduce((sum, r, _, arr) => sum + parseFloat(r.loadTime) / arr.length, 0);
      
      metricsDiv.innerHTML = `
        <div class="metric">
          <div class="metric-value">${completedTests}/3</div>
          <div class="metric-label">完了テスト</div>
        </div>
        <div class="metric">
          <div class="metric-value">${successfulTests}/3</div>
          <div class="metric-label">成功テスト</div>
        </div>
        <div class="metric">
          <div class="metric-value">${averageLoadTime.toFixed(1)}ms</div>
          <div class="metric-label">平均読み込み時間</div>
        </div>
        <div class="metric">
          <div class="metric-value">${Math.round((successfulTests/completedTests)*100)}%</div>
          <div class="metric-label">成功率</div>
        </div>
      `;
    }

    // レポート生成
    function generateReport() {
      const reportData = {
        timestamp: new Date().toLocaleString(),
        testResults,
        userAgent: navigator.userAgent,
        url: window.location.href
      };
      
      const reportText = `
# CSS読み込み修正検証レポート

## 実行情報
- 実行日時: ${reportData.timestamp}
- URL: ${reportData.url}
- ユーザーエージェント: ${reportData.userAgent}

## テスト結果

### 物件選択ページ
${formatResultForReport(testResults.property)}

### 部屋選択ページ
${formatResultForReport(testResults.room)}

### メーター読み取りページ
${formatResultForReport(testResults.meter)}

## 総合評価
${generateOverallAssessment()}
      `;
      
      // レポートをダウンロード
      const blob = new Blob([reportText], { type: 'text/plain; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `css-validation-report-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function formatResultForReport(result) {
      if (!result) return '- テスト未実行';
      if (result.error) return `- エラー: ${result.error}`;
      
      return `
- 読み込み時間: ${result.loadTime}ms
- CSS読み込み: ${result.cssLoaded ? '成功' : '失敗'}
- スタイル適用: ${result.hasButtonStyles ? '成功' : '失敗'}
- FOUC対策: ${result.hasStylesClass ? '適用済み' : '未適用'}
      `;
    }

    function generateOverallAssessment() {
      const results = Object.values(testResults).filter(r => r !== null);
      const successCount = results.filter(r => 
        !r.error && r.cssLoaded && r.hasButtonStyles && r.hasStylesClass
      ).length;
      
      if (successCount === results.length && results.length === 3) {
        return '✅ 全ページでCSS読み込み修正が正常に機能しています。';
      } else if (successCount > 0) {
        return `⚠️ ${successCount}/${results.length}ページで修正が機能していますが、一部に問題があります。`;
      } else {
        return '❌ CSS読み込み修正に問題があります。確認が必要です。';
      }
    }

    // ブラウザ情報取得
    function detectBrowserInfo() {
      const browserInfoDiv = document.getElementById('browser-info');
      
      const info = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        screenResolution: `${screen.width}x${screen.height}`,
        colorDepth: screen.colorDepth,
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };
      
      browserInfoDiv.innerHTML = `
        <div class="test-result">
          <strong>ブラウザ:</strong> ${getBrowserName(info.userAgent)}<br>
          <strong>プラットフォーム:</strong> ${info.platform}<br>
          <strong>言語:</strong> ${info.language}<br>
          <strong>画面解像度:</strong> ${info.screenResolution}<br>
          <strong>色深度:</strong> ${info.colorDepth}bit<br>
          <strong>タイムゾーン:</strong> ${info.timeZone}<br>
          <strong>オンライン:</strong> ${info.onLine ? 'はい' : 'いいえ'}
        </div>
      `;
    }

    function getBrowserName(userAgent) {
      if (userAgent.includes('Chrome')) return 'Chrome';
      if (userAgent.includes('Firefox')) return 'Firefox';
      if (userAgent.includes('Safari')) return 'Safari';
      if (userAgent.includes('Edge')) return 'Edge';
      return '不明';
    }

    function clearAllResults() {
      testResults = { property: null, room: null, meter: null };
      ['property', 'room', 'meter'].forEach(type => {
        document.getElementById(`${type}-status`).innerHTML = '';
        document.getElementById(`${type}-results`).innerHTML = '';
      });
      document.getElementById('overall-metrics').innerHTML = '';
      document.getElementById('overall-results').innerHTML = '';
    }

    // 初期化
    detectBrowserInfo();
  </script>
</body>
</html>
