<!DOCTYPE html>
<html lang="ja">
<head>
    <title>CSS Loading Verification - Final Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        
        .test-card h3 {
            margin: 0 0 15px 0;
            color: #007bff;
            font-size: 1.3em;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.testing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .metrics {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .metrics h4 {
            margin: 0 0 10px 0;
            color: #0056b3;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .summary {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .summary h2 {
            color: #495057;
            margin: 0 0 15px 0;
        }
        
        .overall-status {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }
        
        .continuous-test {
            text-align: center;
            margin-top: 20px;
        }
        
        .continuous-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            margin: 0 10px;
        }
        
        .continuous-button:hover {
            background: #218838;
        }
        
        .continuous-button.stop {
            background: #dc3545;
        }
        
        .continuous-button.stop:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CSS Loading Verification - Final Test</h1>
        
        <div class="test-grid">
            <div class="test-card">
                <h3>üìä Property Select Page</h3>
                <button class="test-button" onclick="testPage('property_select.html', 'property')">Test Property Select</button>
                <div id="property-status" class="status" style="display:none;"></div>
                <div id="property-metrics" class="metrics" style="display:none;">
                    <h4>Metrics</h4>
                    <div id="property-metrics-content"></div>
                </div>
                <div class="iframe-container" id="property-container" style="display:none;">
                    <iframe id="property-frame"></iframe>
                    <div class="loading-overlay" id="property-loading">Loading...</div>
                </div>
            </div>
            
            <div class="test-card">
                <h3>üè† Room Select Page</h3>
                <button class="test-button" onclick="testPage('room_select.html', 'room')">Test Room Select</button>
                <div id="room-status" class="status" style="display:none;"></div>
                <div id="room-metrics" class="metrics" style="display:none;">
                    <h4>Metrics</h4>
                    <div id="room-metrics-content"></div>
                </div>
                <div class="iframe-container" id="room-container" style="display:none;">
                    <iframe id="room-frame"></iframe>
                    <div class="loading-overlay" id="room-loading">Loading...</div>
                </div>
            </div>
            
            <div class="test-card">
                <h3>üìè Meter Reading Page</h3>
                <button class="test-button" onclick="testPage('meter_reading.html', 'meter')">Test Meter Reading</button>
                <div id="meter-status" class="status" style="display:none;"></div>
                <div id="meter-metrics" class="metrics" style="display:none;">
                    <h4>Metrics</h4>
                    <div id="meter-metrics-content"></div>
                </div>
                <div class="iframe-container" id="meter-container" style="display:none;">
                    <iframe id="meter-frame"></iframe>
                    <div class="loading-overlay" id="meter-loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="continuous-test">
            <button class="continuous-button" onclick="startContinuousTest()">Start Continuous Testing</button>
            <button class="continuous-button stop" onclick="stopContinuousTest()">Stop Testing</button>
        </div>
        
        <div class="summary">
            <h2>üìã Test Summary</h2>
            <div id="overall-status" class="overall-status">Ready to test</div>
            <div id="summary-details"></div>
        </div>
    </div>

    <script>
        let testResults = {};
        let continuousTestInterval = null;
        let testCount = 0;
        
        async function testPage(pageUrl, pageType) {
            const statusElement = document.getElementById(`${pageType}-status`);
            const metricsElement = document.getElementById(`${pageType}-metrics`);
            const metricsContent = document.getElementById(`${pageType}-metrics-content`);
            const containerElement = document.getElementById(`${pageType}-container`);
            const frameElement = document.getElementById(`${pageType}-frame`);
            const loadingElement = document.getElementById(`${pageType}-loading`);
            
            // Show testing status
            statusElement.style.display = 'block';
            statusElement.className = 'status testing';
            statusElement.textContent = 'Testing in progress...';
            
            // Show iframe container
            containerElement.style.display = 'block';
            loadingElement.style.display = 'flex';
            
            const startTime = performance.now();
            
            try {
                // Load page in iframe
                frameElement.src = pageUrl + '?t=' + Date.now();
                
                // Wait for page to load and test CSS
                const result = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Test timeout'));
                    }, 10000);
                    
                    frameElement.onload = () => {
                        clearTimeout(timeout);
                        
                        try {
                            const frameDoc = frameElement.contentDocument;
                            const loadTime = performance.now() - startTime;
                            
                            // Wait a bit for CSS to apply
                            setTimeout(() => {
                                try {
                                    // Check if styles loaded properly
                                    const rootElement = frameDoc.documentElement;
                                    const hasStylesLoaded = rootElement.classList.contains('styles-loaded');
                                    const hasStylesLoading = rootElement.classList.contains('styles-loading');
                                    
                                    // Check critical elements styling
                                    const mainContent = frameDoc.querySelector('.mantine-stack, .property-grid, .room-grid, main');
                                    const computedStyle = mainContent ? window.getComputedStyle(mainContent) : null;
                                    
                                    const result = {
                                        loadTime: Math.round(loadTime),
                                        hasStylesLoaded,
                                        hasStylesLoading,
                                        hasMainContent: !!mainContent,
                                        isStyled: computedStyle && computedStyle.display !== 'none',
                                        opacity: computedStyle ? computedStyle.opacity : 'unknown',
                                        cssRules: frameDoc.styleSheets.length,
                                        timestamp: new Date().toLocaleTimeString()
                                    };
                                    
                                    result.success = result.hasStylesLoaded && result.isStyled && !result.hasStylesLoading;
                                    
                                    resolve(result);
                                } catch (error) {
                                    reject(error);
                                }
                            }, 500);
                            
                        } catch (error) {
                            clearTimeout(timeout);
                            reject(error);
                        }
                    };
                    
                    frameElement.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to load page'));
                    };
                });
                
                // Hide loading overlay
                loadingElement.style.display = 'none';
                
                // Store result
                testResults[pageType] = result;
                
                // Update status
                if (result.success) {
                    statusElement.className = 'status success';
                    statusElement.textContent = `‚úÖ Test passed - CSS loaded successfully`;
                } else {
                    statusElement.className = 'status error';
                    statusElement.textContent = `‚ùå Test failed - CSS loading issues detected`;
                }
                
                // Update metrics
                metricsElement.style.display = 'block';
                metricsContent.innerHTML = `
                    <div class="metric-item">
                        <span>Load Time:</span>
                        <span>${result.loadTime}ms</span>
                    </div>
                    <div class="metric-item">
                        <span>Styles Loaded:</span>
                        <span>${result.hasStylesLoaded ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric-item">
                        <span>Still Loading:</span>
                        <span>${result.hasStylesLoading ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                    </div>
                    <div class="metric-item">
                        <span>Main Content:</span>
                        <span>${result.hasMainContent ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric-item">
                        <span>Is Styled:</span>
                        <span>${result.isStyled ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <div class="metric-item">
                        <span>Opacity:</span>
                        <span>${result.opacity}</span>
                    </div>
                    <div class="metric-item">
                        <span>CSS Rules:</span>
                        <span>${result.cssRules}</span>
                    </div>
                    <div class="metric-item">
                        <span>Test Time:</span>
                        <span>${result.timestamp}</span>
                    </div>
                `;
                
            } catch (error) {
                console.error('Test error:', error);
                
                // Hide loading overlay
                loadingElement.style.display = 'none';
                
                statusElement.className = 'status error';
                statusElement.textContent = `‚ùå Test error: ${error.message}`;
                
                testResults[pageType] = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toLocaleTimeString()
                };
            }
            
            updateOverallStatus();
        }
        
        function updateOverallStatus() {
            const overallStatus = document.getElementById('overall-status');
            const summaryDetails = document.getElementById('summary-details');
            
            const results = Object.values(testResults);
            const successCount = results.filter(r => r.success).length;
            const totalTests = results.length;
            
            if (totalTests === 0) {
                overallStatus.className = 'overall-status';
                overallStatus.style.background = '#f8f9fa';
                overallStatus.style.color = '#495057';
                overallStatus.textContent = 'Ready to test';
                summaryDetails.innerHTML = '';
                return;
            }
            
            if (successCount === totalTests && totalTests === 3) {
                overallStatus.className = 'overall-status';
                overallStatus.style.background = '#d4edda';
                overallStatus.style.color = '#155724';
                overallStatus.textContent = `üéâ All tests passed! (${successCount}/${totalTests})`;
            } else {
                overallStatus.className = 'overall-status';
                overallStatus.style.background = '#f8d7da';
                overallStatus.style.color = '#721c24';
                overallStatus.textContent = `‚ö†Ô∏è ${successCount}/${totalTests} tests passed`;
            }
            
            const avgLoadTime = results.filter(r => r.loadTime).reduce((sum, r) => sum + r.loadTime, 0) / results.filter(r => r.loadTime).length || 0;
            
            summaryDetails.innerHTML = `
                <p><strong>Average Load Time:</strong> ${Math.round(avgLoadTime)}ms</p>
                <p><strong>Total Tests Run:</strong> ${testCount}</p>
                <p><strong>Last Update:</strong> ${new Date().toLocaleTimeString()}</p>
            `;
        }
        
        async function startContinuousTest() {
            if (continuousTestInterval) return;
            
            const pages = [
                { url: 'property_select.html', type: 'property' },
                { url: 'room_select.html', type: 'room' },
                { url: 'meter_reading.html', type: 'meter' }
            ];
            
            let currentPageIndex = 0;
            
            continuousTestInterval = setInterval(async () => {
                const page = pages[currentPageIndex];
                testCount++;
                
                try {
                    await testPage(page.url, page.type);
                } catch (error) {
                    console.error('Continuous test error:', error);
                }
                
                currentPageIndex = (currentPageIndex + 1) % pages.length;
            }, 3000);
            
            // Run first test immediately
            const firstPage = pages[0];
            testCount++;
            testPage(firstPage.url, firstPage.type);
        }
        
        function stopContinuousTest() {
            if (continuousTestInterval) {
                clearInterval(continuousTestInterval);
                continuousTestInterval = null;
            }
        }
        
        // Initial status update
        updateOverallStatus();
    </script>
</body>
</html>
