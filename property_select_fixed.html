<!DOCTYPE html>
<html lang="ja">
<head>
  <title>ç‰©ä»¶é¸æŠ - æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒª</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA ãƒ¡ã‚¿ã‚¿ã‚° -->
  <meta name="description" content="æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®èª­ã¿å–ã‚Šã‚’ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š">
  <meta name="msapplication-TileColor" content="#007bff">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2JmZiIvPgo8c3ZnIHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMwMDdiZmYiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+">
  
  <!-- WOFF SDK removed for general browser compatibility -->
  
  <!-- Reactã¨ReactDOMã®CDN (Cache Busting Version) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js?v=20250614b" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js?v=20250614b" crossorigin></script>
  <!-- Babelã®CDN (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ã™ã‚‹ãŸã‚) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=20250614b"></script>
  
  <!-- PWA Utilities -->
  <script src="/pwa-utils.js?v=20250614b"></script>
  
  <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ -->
  <link rel="stylesheet" href="css_styles/property_select.css?v=20250614b">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ===================================
    // ä¸€èˆ¬ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ç‰©ä»¶é¸æŠã‚¢ãƒ—ãƒª
    // WOFF SDKä¾å­˜ãªã— - Cache Busting v20250614b
    // ===================================
    
    console.log('ğŸš€ Property Select App v20250614c - Debug Mode Enabled');
    console.log('WOFF Status:', typeof woff !== 'undefined' ? 'âŒ ERROR: WOFF still loaded!' : 'âœ… WOFF successfully removed');
    
    // GAS Web Appã®URLï¼ˆè¨­å®šï¼‰
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbzNIgKK01N-eMYcIilA5q6J12X0ZTAiwVvW3gtQ1ruNVhHtdD-zJV9lLM_9iACQBNb9Uw/exec';
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
    let appState = {
      properties: [],
      loading: true,
      error: null,
      filterQuery: ''
    };

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    const formatDate = (dateString) => {
      if (!dateString) return 'æœªå®Œäº†';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP');
      } catch (error) {
        return 'æœªå®Œäº†';
      }
    };

    const filterProperties = (properties, query) => {
      if (!query.trim()) return properties;
      return properties.filter(property => 
        property.name && property.name.toLowerCase().includes(query.toLowerCase())
      );
    };

    // UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    const LoadingSpinner = () => (
      <div className="loading-container">
        <div className="spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>
    );

    const ErrorDisplay = ({ error, onRetry }) => (
      <div className="error-container">
        <div className="error-message">
          <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
          <p>{error}</p>
          <button onClick={onRetry} className="retry-button">
            å†è©¦è¡Œ
          </button>
        </div>
      </div>
    );

    const SearchInput = ({ value, onChange }) => (
      <div className="search-container">
        <input
          type="text"
          placeholder="ç‰©ä»¶åã§æ¤œç´¢..."
          value={value}
          onChange={(e) => onChange(e.target.value)}
          className="search-input"
        />
      </div>
    );

    const PropertyCard = ({ property, onSelect }) => (
      <div className="property-card" onClick={() => onSelect(property)}>
        <div className="property-info">
          <h3 className="property-name">{property.name}</h3>
          <p className="property-id">ç‰©ä»¶ID: {property.id}</p>
          <div className="property-status">
            <span className={`status-badge ${property.inspectionDate ? 'completed' : 'pending'}`}>
              {property.inspectionDate ? 'å®Œäº†' : 'æœªå®Œäº†'}
            </span>
            {property.inspectionDate && (
              <span className="completion-date">
                {formatDate(property.inspectionDate)}
              </span>
            )}
          </div>
        </div>
        <div className="property-arrow">â†’</div>
      </div>
    );

    const EmptyState = ({ hasFilter, onClearFilter }) => (
      <div className="empty-state">
        {hasFilter ? (
          <>
            <h3>æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„</p>
            <button onClick={onClearFilter} className="clear-filter-button">
              ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            </button>
          </>
        ) : (
          <>
            <h3>ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p>ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€ç‰©ä»¶ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          </>
        )}
      </div>
    );

    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    const App = () => {
      const [state, setState] = React.useState(appState);

      // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
      const fetchProperties = async () => {
        try {
          setState(prev => ({ ...prev, loading: true, error: null }));
          
          const requestUrl = `${gasWebAppUrl}?action=getProperties&cache=${Date.now()}`;
          console.log('[ReactApp] Fetching properties...');
          console.log('[ReactApp] Request URL:', requestUrl);
          
          const response = await fetch(requestUrl);
          console.log('[ReactApp] Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}. è©³ç´°: ${errorText}`);
          }
          
          const data = await response.json();
          console.log('[ReactApp] Fetched data:', data);
          
          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®çµ±ä¸€å‡¦ç†
          let properties = [];
          if (data && Array.isArray(data.data)) {
            properties = data.data;
            console.log('[ReactApp] âœ… çµ±ä¸€å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', properties.length);
          } else if (Array.isArray(data)) {
            properties = data;
            console.log('[ReactApp] âš ï¸ ç›´æ¥é…åˆ—å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', properties.length);
          } else if (data && Array.isArray(data.result)) {
            properties = data.result;
            console.log('[ReactApp] âš ï¸ resultå½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', properties.length);
          } else {
            console.warn('[ReactApp] âš ï¸ äºˆæœŸã—ãªã„å½¢å¼:', data);
            properties = [];
          }
          
          setState(prev => ({
            ...prev,
            properties,
            loading: false,
            error: null
          }));
          
        } catch (error) {
          console.error('[ReactApp] Fetch error:', error);
          setState(prev => ({
            ...prev,
            loading: false,
            error: error.message
          }));
        }
      };

      // ç‰©ä»¶é¸æŠå‡¦ç†
      const handlePropertySelect = async (property) => {
        try {
          const requestUrl = `${gasWebAppUrl}?action=getRooms&propertyId=${property.id}&cache=${Date.now()}`;
          console.log(`[ReactApp] Fetching rooms for propertyId: ${property.id}`);
          console.log('[ReactApp] Room request URL breakdown:', {
            fullUrl: requestUrl,
            propertyId: property.id,
            propertyName: property.name
          });
          
          const roomResponse = await fetch(requestUrl);
          
          console.log('[ReactApp] Room Response Status:', roomResponse.status);
          console.log('[ReactApp] Room Response Headers:', [...roomResponse.headers.entries()]);
          
          if (!roomResponse.ok) {
            const errorText = await roomResponse.text();
            throw new Error(`éƒ¨å±‹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${roomResponse.status}. è©³ç´°: ${errorText}`);
          }
          
          const roomData = await roomResponse.json();
          console.log('[ReactApp] Fetched room data:', roomData);
          console.log('[ReactApp] Room data type:', typeof roomData);

          // ğŸ”¥ FINAL FIX: æœ€çµ‚çš„ãªçµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ¤å®šå‡¦ç† (property_selectç‰ˆ)
          let rooms = [];
          console.log('[ReactApp] ğŸ” ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼åˆ¤å®šé–‹å§‹');
          console.log('[ReactApp] ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°:', {
            hasData: !!roomData?.data,
            isDataArray: Array.isArray(roomData?.data),
            hasResult: !!roomData?.result,
            isResultArray: Array.isArray(roomData?.result),
            hasRooms: !!roomData?.rooms,
            isRoomsArray: Array.isArray(roomData?.rooms),
            isDirectArray: Array.isArray(roomData)
          });

          // ãƒ‘ã‚¿ãƒ¼ãƒ³1: çµ±ä¸€å½¢å¼ {success: true, data: []}
          if (roomData && 
              typeof roomData === 'object' && 
              roomData !== null && 
              roomData.data && 
              Array.isArray(roomData.data)) {
            rooms = roomData.data;
            console.log('[ReactApp] âœ… çµ±ä¸€å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', rooms.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç›´æ¥é…åˆ—
          else if (Array.isArray(roomData)) {
            rooms = roomData;
            console.log('[ReactApp] âš ï¸ ç›´æ¥é…åˆ—å½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', rooms.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³3: result ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
          else if (roomData && 
                   typeof roomData === 'object' && 
                   roomData !== null && 
                   roomData.result && 
                   Array.isArray(roomData.result)) {
            rooms = roomData.result;
            console.log('[ReactApp] âš ï¸ resultå½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', rooms.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³4: rooms ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
          else if (roomData && 
                   typeof roomData === 'object' && 
                   roomData !== null && 
                   roomData.rooms && 
                   Array.isArray(roomData.rooms)) {
            rooms = roomData.rooms;
            console.log('[ReactApp] âš ï¸ roomså½¢å¼æ¡ç”¨ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', rooms.length);
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³5: ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚‚ç¶™ç¶šå‡¦ç†
          else if (roomData && typeof roomData === 'object' && roomData !== null) {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã‚ã‚‹ãŒã€äºˆæœŸã•ã‚ŒãŸå½¢å¼ã§ã¯ãªã„å ´åˆ
            console.warn('[ReactApp] âš ï¸ äºˆæœŸã—ãªã„å½¢å¼ã ãŒç©ºé…åˆ—ã§ç¶™ç¶š:', roomData);
            rooms = [];
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³6: å®Œå…¨ã«ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
          else {
            console.error('[ReactApp] âŒ å®Œå…¨ã«ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹:', roomData);
            rooms = [];
          }

          console.log('[ReactApp] æœ€çµ‚æ¡ç”¨ãƒ‡ãƒ¼ã‚¿:', rooms.length, 'ä»¶');
          
          console.log('[ReactApp] Processed rooms:', rooms);
          console.log('[ReactApp] Rooms array check:', Array.isArray(rooms));
          console.log('[ReactApp] Rooms length:', rooms.length);

          console.log('[ReactApp] Storing to sessionStorage...');
          console.log('[ReactApp] - propertyId:', property.id, '(type:', typeof property.id, ')');
          console.log('[ReactApp] - propertyName:', property.name, '(type:', typeof property.name, ')');
          console.log('[ReactApp] - rooms length:', Array.isArray(rooms) ? rooms.length : 'not array');
          
          sessionStorage.setItem('selectedPropertyId', String(property.id));
          sessionStorage.setItem('selectedPropertyName', String(property.name));
          sessionStorage.setItem('selectedRooms', JSON.stringify(rooms));
          
          console.log('[ReactApp] SessionStorage verification:');
          console.log('- selectedPropertyId:', sessionStorage.getItem('selectedPropertyId'));
          console.log('- selectedPropertyName:', sessionStorage.getItem('selectedPropertyName'));
          console.log('- selectedRooms length:', JSON.parse(sessionStorage.getItem('selectedRooms') || '[]').length);
          
          // éƒ¨å±‹é¸æŠç”»é¢ã«é·ç§»
          console.log('[ReactApp] Navigating to room_select.html...');
          setTimeout(() => {
            window.location.href = 'room_select.html';
          }, 300);
          
        } catch (error) {
          console.error('[ReactApp] Property select error:', error);
          alert(`éƒ¨å±‹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
      };

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
      const handleFilterChange = (query) => {
        setState(prev => ({ ...prev, filterQuery: query }));
      };

      const handleClearFilter = () => {
        setState(prev => ({ ...prev, filterQuery: '' }));
      };

      // å†è©¦è¡Œå‡¦ç†
      const handleRetry = () => {
        fetchProperties();
      };

      // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
      React.useEffect(() => {
        console.log('[ReactApp] Component mounted, fetching properties...');
        fetchProperties();
      }, []);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸç‰©ä»¶ãƒªã‚¹ãƒˆ
      const filteredProperties = filterProperties(state.properties, state.filterQuery);

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      if (state.loading) {
        return <LoadingSpinner />;
      }

      // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
      if (state.error) {
        return <ErrorDisplay error={state.error} onRetry={handleRetry} />;
      }

      return (
        <div className="app-container">
          <header className="app-header">
            <h1>ç‰©ä»¶é¸æŠ</h1>
            <p>æ¤œé‡ã‚’è¡Œã†ç‰©ä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          </header>

          <SearchInput 
            value={state.filterQuery} 
            onChange={handleFilterChange} 
          />

          <main className="properties-container">
            {filteredProperties.length > 0 ? (
              <div className="properties-grid">
                {filteredProperties.map((property) => (
                  <PropertyCard
                    key={property.id}
                    property={property}
                    onSelect={handlePropertySelect}
                  />
                ))}
              </div>
            ) : (
              <EmptyState 
                hasFilter={state.filterQuery.trim().length > 0}
                onClearFilter={handleClearFilter}
              />
            )}
          </main>

          <footer className="app-footer">
            <p>æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒª v20250614c</p>
          </footer>
        </div>
      );
    };

    // React DOM ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <!-- PWAåˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // PWAæ©Ÿèƒ½ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => console.log('SW registered:', registration))
          .catch(error => console.log('SW registration failed:', error));
      }
    });
  </script>
</body>
</html>
