<!DOCTYPE html>
<html lang="ja">
<head>
  <title>CSS読み込みテスト - 水道メーター読み取りアプリ</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    /* Critical CSS */
    * { box-sizing: border-box; }
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6; background-color: #f5f5f5;
    }
    .test-container {
      max-width: 800px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      margin: 10px 0; padding: 10px;
      border-radius: 4px; border-left: 4px solid #007bff;
      background-color: #f8f9fa;
    }
    .success { border-left-color: #28a745; background-color: #d4edda; }
    .warning { border-left-color: #ffc107; background-color: #fff3cd; }
    .error { border-left-color: #dc3545; background-color: #f8d7da; }
    .metric { display: inline-block; margin: 5px 10px; font-weight: bold; }
    button {
      padding: 10px 20px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: background-color 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .styles-loading { opacity: 0; transition: opacity 0.3s ease-in-out; }
    .styles-loaded { opacity: 1; }
  </style>

  <!-- テスト対象のCSSファイル -->
  <link rel="stylesheet" href="css_styles/property_select.css?v=20250614c">
  <link rel="stylesheet" href="css_styles/pwa-styles.css?v=20250614c">
</head>
<body>
  <div class="test-container">
    <h1>CSS読み込みテスト結果</h1>
    <p>水道メーター読み取りアプリのCSS読み込み修正をテストします。</p>
    
    <div id="test-results"></div>
    
    <button onclick="runCSSLoadTest()">CSS読み込みテストを実行</button>
    <button onclick="testPagePerformance()">ページパフォーマンステスト</button>
    <button onclick="testStyleTransition()">スタイル遷移テスト</button>
    <button onclick="clearResults()">結果をクリア</button>
    
    <h2>各ページへのリンク</h2>
    <ul>
      <li><a href="property_select.html" target="_blank">物件選択ページ</a></li>
      <li><a href="room_select.html" target="_blank">部屋選択ページ</a></li>
      <li><a href="meter_reading.html" target="_blank">メーター読み取りページ</a></li>
    </ul>
  </div>

  <script>
    const resultsContainer = document.getElementById('test-results');
    let testStartTime = performance.now();

    function addResult(message, type = 'test-result') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      resultsContainer.appendChild(div);
      resultsContainer.scrollTop = resultsContainer.scrollHeight;
    }

    // CSS読み込みテスト
    function runCSSLoadTest() {
      addResult('CSS読み込みテストを開始...', 'test-result');
      
      const startTime = performance.now();
      let cssLoaded = false;
      let attempts = 0;
      const maxAttempts = 100;
      
      function checkCSSLoaded() {
        attempts++;
        
        // 計算されたスタイルをチェック
        const testElement = document.createElement('div');
        testElement.className = 'mantine-button';
        testElement.style.position = 'absolute';
        testElement.style.visibility = 'hidden';
        document.body.appendChild(testElement);
        
        const computedStyle = window.getComputedStyle(testElement);
        const hasButtonStyles = computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                               computedStyle.backgroundColor !== 'transparent';
        
        document.body.removeChild(testElement);
        
        if (hasButtonStyles) {
          cssLoaded = true;
          const loadTime = performance.now() - startTime;
          addResult(`✅ CSS読み込み成功! (${loadTime.toFixed(2)}ms, ${attempts}回目の確認)`, 'success');
          
          // 詳細情報
          addResult(`📊 CSS読み込み詳細: 
            <span class="metric">読み込み時間: ${loadTime.toFixed(2)}ms</span>
            <span class="metric">確認回数: ${attempts}</span>
            <span class="metric">平均確認間隔: ${(loadTime/attempts).toFixed(2)}ms</span>`, 'test-result');
          
        } else if (attempts >= maxAttempts) {
          addResult(`❌ CSS読み込みタイムアウト (${maxAttempts}回確認後)`, 'error');
        } else {
          setTimeout(checkCSSLoaded, 10);
        }
      }
      
      checkCSSLoaded();
    }

    // ページパフォーマンステスト
    function testPagePerformance() {
      addResult('ページパフォーマンステストを開始...', 'test-result');
      
      if (window.performance && window.performance.timing) {
        const timing = window.performance.timing;
        const navigation = window.performance.navigation;
        
        const domContentLoaded = timing.domContentLoadedEventEnd - timing.navigationStart;
        const pageLoad = timing.loadEventEnd - timing.navigationStart;
        const domInteractive = timing.domInteractive - timing.navigationStart;
        const firstPaint = performance.getEntriesByType('paint')[0]?.startTime || 0;
        
        addResult(`📈 ページパフォーマンス指標:
          <span class="metric">DOM読み込み: ${domContentLoaded}ms</span>
          <span class="metric">ページ完了: ${pageLoad}ms</span>
          <span class="metric">DOM対話可能: ${domInteractive}ms</span>
          <span class="metric">初回描画: ${firstPaint.toFixed(2)}ms</span>
          <span class="metric">ナビゲーション種別: ${navigation.type === 0 ? '通常' : navigation.type === 1 ? 'リロード' : 'その他'}</span>`, 'test-result');
          
        // パフォーマンス評価
        if (domContentLoaded < 1000) {
          addResult('✅ DOM読み込み速度: 高速 (<1秒)', 'success');
        } else if (domContentLoaded < 3000) {
          addResult('⚠️ DOM読み込み速度: 普通 (1-3秒)', 'warning');
        } else {
          addResult('❌ DOM読み込み速度: 低速 (>3秒)', 'error');
        }
      } else {
        addResult('❌ Performance APIが利用できません', 'error');
      }
    }

    // スタイル遷移テスト
    function testStyleTransition() {
      addResult('スタイル遷移テストを開始...', 'test-result');
      
      const testDiv = document.createElement('div');
      testDiv.className = 'styles-loading';
      testDiv.style.position = 'absolute';
      testDiv.style.top = '-1000px';
      testDiv.innerHTML = 'テスト要素';
      document.body.appendChild(testDiv);
      
      const initialOpacity = window.getComputedStyle(testDiv).opacity;
      addResult(`🔍 初期透明度: ${initialOpacity}`, 'test-result');
      
      // styles-loadedクラスに変更
      setTimeout(() => {
        testDiv.className = 'styles-loaded';
        
        setTimeout(() => {
          const finalOpacity = window.getComputedStyle(testDiv).opacity;
          addResult(`🔍 最終透明度: ${finalOpacity}`, 'test-result');
          
          if (initialOpacity === '0' && finalOpacity === '1') {
            addResult('✅ スタイル遷移テスト成功!', 'success');
          } else {
            addResult('❌ スタイル遷移テスト失敗', 'error');
          }
          
          document.body.removeChild(testDiv);
        }, 500);
      }, 100);
    }

    function clearResults() {
      resultsContainer.innerHTML = '';
    }

    // ページ読み込み時に自動テスト実行
    window.addEventListener('DOMContentLoaded', () => {
      const loadTime = performance.now() - testStartTime;
      addResult(`🚀 ページDOMContentLoaded (${loadTime.toFixed(2)}ms)`, 'success');
      
      // CSS読み込みテストを自動実行
      setTimeout(runCSSLoadTest, 100);
    });

    window.addEventListener('load', () => {
      const loadTime = performance.now() - testStartTime;
      addResult(`🏁 ページ完全読み込み完了 (${loadTime.toFixed(2)}ms)`, 'success');
    });

    // エラーハンドリング
    window.addEventListener('error', (e) => {
      addResult(`❌ JavaScriptエラー: ${e.message}`, 'error');
    });
  </script>
</body>
</html>
