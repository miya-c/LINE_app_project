<!DOCTYPE html>
<html>
<head>
    <title>GAS接続テスト</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>GAS Web App 接続テスト</h1>
    
    <div class="test-section">
        <h3>1. バージョン確認テスト</h3>
        <button onclick="testVersion()">バージョン確認</button>
        <div id="version-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 物件一覧取得テスト</h3>
        <button onclick="testGetProperties()">物件一覧取得</button>
        <div id="properties-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 検針データ取得テスト</h3>
        <input type="text" id="propertyId" placeholder="物件ID" value="P000001">
        <input type="text" id="roomId" placeholder="部屋ID" value="R000001">
        <button onclick="testGetMeterReadings()">検針データ取得</button>
        <div id="meter-result" class="result"></div>
    </div>
      <div class="test-section">
        <h3>4. 検針データ更新テスト</h3>
        <button onclick="testUpdateMeterReadings()">検針データ更新 (GET)</button>
        <button onclick="testUpdateMeterReadingsPost()">検針データ更新 (POST)</button>
        <div id="update-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>5. 検針完了更新テスト</h3>
        <input type="text" id="inspectionPropertyId" placeholder="物件ID" value="P000001">
        <button onclick="testUpdateInspectionComplete()">検針完了更新</button>
        <div id="inspection-result" class="result"></div>
    </div>

    <script>        // GAS Web App URL (property_select.htmlから取得、またはテスト用URL)        const gasWebAppUrl = sessionStorage.getItem('gasWebAppUrl') || 
                       'https://script.google.com/macros/s/AKfycbwvA8Ou6cwKhCsZNzFXPrcN5U92BSdaTngO4X6dbE6g053SD8I5VtWUi1WZ-NJUCX0sow/exec';
        
        console.log('使用するGAS URL:', gasWebAppUrl);

        async function makeRequest(action, params = {}) {
            try {
                const urlParams = new URLSearchParams({action, ...params});
                const requestUrl = `${gasWebAppUrl}?${urlParams.toString()}`;
                
                console.log('リクエストURL:', requestUrl);
                
                const response = await fetch(requestUrl, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                return { success: true, data: result };
                
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testVersion() {
            const resultDiv = document.getElementById('version-result');
            resultDiv.textContent = 'テスト中...';
            
            const result = await makeRequest('getVersion');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'エラー: ' + result.error;
            }
        }

        async function testGetProperties() {
            const resultDiv = document.getElementById('properties-result');
            resultDiv.textContent = 'テスト中...';
            
            const result = await makeRequest('getProperties');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'エラー: ' + result.error;
            }
        }

        async function testGetMeterReadings() {
            const resultDiv = document.getElementById('meter-result');
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '物件IDと部屋IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'テスト中...';
            
            const result = await makeRequest('getMeterReadings', { propertyId, roomId });
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'エラー: ' + result.error;
            }
        }

        async function testUpdateMeterReadings() {
            const resultDiv = document.getElementById('update-result');
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '物件IDと部屋IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'テスト中...';
            
            // テスト用の検針データ
            const testReadings = [
                {
                    date: '2024-03-01',
                    currentReading: '1100',
                    photoData: null
                }
            ];
            
            const result = await makeRequest('updateMeterReadings', { 
                propertyId, 
                roomId, 
                readings: JSON.stringify(testReadings) 
            });
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'エラー: ' + result.error;
            }        }

        async function testUpdateMeterReadingsPost() {
            const resultDiv = document.getElementById('update-result');
            const propertyId = document.getElementById('propertyId').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!propertyId || !roomId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '物件IDと部屋IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'POSTテスト中...';
            
            // テスト用の検針データ
            const testReadings = [
                {
                    date: '2024-03-01',
                    currentReading: '1100',
                    photoUrl: '',
                    usage: '50'
                }
            ];
            
            try {
                const response = await fetch(gasWebAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'updateMeterReadings',
                        propertyId: propertyId,
                        roomId: roomId,
                        readings: testReadings
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'POSTエラー: ' + error.message;
            }
        }

        async function testUpdateInspectionComplete() {
            const resultDiv = document.getElementById('inspection-result');
            const propertyId = document.getElementById('inspectionPropertyId').value;
            
            if (!propertyId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '物件IDを入力してください';
                return;
            }
            
            resultDiv.textContent = 'テスト中...';
            
            const result = await makeRequest('updateInspectionComplete', { propertyId });
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'エラー: ' + result.error;
            }
        }
    </script>
</body>
</html>
