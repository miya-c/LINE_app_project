<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ GAS ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç¢ºèªãƒ†ã‚¹ãƒˆ ğŸ”¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #ff4444;
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            font-weight: bold;
            font-size: 1.2em;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ”¥ GAS ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç¢ºèªãƒ†ã‚¹ãƒˆ ğŸ”¥</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªæ‰‹é †</h3>
            <ol>
                <li>Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã§ã€Œç‰©ä»¶.gsã€ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ã‚³ãƒ”ãƒšã—ã¦ä¿å­˜</li>
                <li>å³ä¸Šã®ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ã€Œç¨®é¡ã‚’é¸æŠã€ã§ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’é¸æŠ</li>
                <li>ã€Œæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®èª¬æ˜ã€ã«ã€Œv3-DEBUGå¼·åˆ¶ãƒ†ã‚¹ãƒˆã€ã¨å…¥åŠ›</li>
                <li>ã€Œå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œè‡ªåˆ†ã€ã«è¨­å®š</li>
                <li>ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œå…¨å“¡ã€ã«è¨­å®š</li>
                <li>ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>æ–°ã—ã„URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸‹è¨˜ã«è²¼ã‚Šä»˜ã‘</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ GAS URLè¨­å®š</h3>
            <input type="text" 
                   id="gasUrl" 
                   class="url-input" 
                   value="https://script.google.com/macros/s/AKfycbxlled-ot17rnp-yWMbKJqa8biDFV2XTFtgaWoQOhC7947dpYgn5qA0uSH7e9uKlgMcYA/exec"
                   placeholder="æ–°ã—ã„GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            <button onclick="updateUrl()">URLæ›´æ–°</button>
        </div>

        <div class="test-section">
            <h3>ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testVersion()">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª</button>
            <div id="versionResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testGetProperties()">getProperties</button>
            <button onclick="testGetRooms()">getRooms</button>
            <button onclick="testUpdateInspectionComplete()">updateInspectionComplete</button>
            <button onclick="testGetMeterReadings()">getMeterReadings</button>
            <button onclick="testUpdateMeterReadings()">updateMeterReadings (POST)</button>
            <div id="actionResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨ºæ–­</h3>
            <button onclick="runFullDiagnostic()">å®Œå…¨è¨ºæ–­å®Ÿè¡Œ</button>
            <div id="diagnosticResult" class="test-result"></div>
        </div>

        <div id="deploymentStatus" class="status"></div>
    </div>

    <script>
        let gasWebAppUrl = '';

        function updateUrl() {
            gasWebAppUrl = document.getElementById('gasUrl').value.trim();
            if (!gasWebAppUrl.endsWith('/exec')) {
                gasWebAppUrl += '/exec';
            }
            document.getElementById('gasUrl').value = gasWebAppUrl;
            console.log('ğŸ”„ GAS URLæ›´æ–°:', gasWebAppUrl);
            
            // URLã®å¤‰æ›´ã‚’é€šçŸ¥
            document.getElementById('deploymentStatus').innerHTML = 
                `ğŸ“ ç¾åœ¨ã®GAS URL: <span style="color: blue;">${gasWebAppUrl}</span>`;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateUrl();
        });

        async function makeRequest(action, additionalParams = {}, method = 'GET') {
            try {
                const params = { action, ...additionalParams };
                let url = gasWebAppUrl;
                let options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (method === 'GET') {
                    const searchParams = new URLSearchParams(params);
                    url += '?' + searchParams.toString();
                } else {
                    options.body = JSON.stringify(params);
                }

                console.log(`ğŸš€ ${method}ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:`, { url, params });
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', data);
                return { success: true, data };
                
            } catch (error) {
                console.error('âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                return { success: false, error: error.message };
            }
        }

        async function testVersion() {
            const resultDiv = document.getElementById('versionResult');
            resultDiv.innerHTML = 'ğŸ”„ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªä¸­...';
            
            const result = await makeRequest('getVersion');
            
            if (result.success) {
                const data = result.data;
                let resultClass = 'success';
                let statusMessage = '';
                
                if (data.version && data.version.includes('v3-DEBUG')) {
                    statusMessage = 'âœ… æ­£å¸¸ï¼šv3-DEBUGç‰ˆãŒå‹•ä½œä¸­ã§ã™ï¼';
                } else if (data.error && data.error.includes('ç„¡åŠ¹ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³')) {
                    resultClass = 'error';
                    statusMessage = 'âŒ å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå‹•ä½œä¸­ï¼šæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ï¼';
                } else {
                    resultClass = 'warning';
                    statusMessage = 'âš ï¸ ä¸æ˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼šç¢ºèªãŒå¿…è¦ã§ã™';
                }
                
                resultDiv.className = `test-result ${resultClass}`;
                resultDiv.innerHTML = `
${statusMessage}

ğŸ“Š è©³ç´°ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
${JSON.stringify(data, null, 2)}
                `;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—: ${result.error}`;
            }
        }

        async function testGetProperties() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = 'ğŸ”„ ç‰©ä»¶ä¸€è¦§å–å¾—ä¸­...';
            
            const result = await makeRequest('getProperties');
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `âœ… getPropertiesæˆåŠŸ:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ getPropertieså¤±æ•—: ${result.error}`;
            }
        }

        async function testGetRooms() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = 'ğŸ”„ éƒ¨å±‹ä¸€è¦§å–å¾—ä¸­...';
            
            const result = await makeRequest('getRooms', { propertyId: 'TEST001' });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `âœ… getRoomsæˆåŠŸ:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ getRoomså¤±æ•—: ${result.error}`;
            }
        }

        async function testUpdateInspectionComplete() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = 'ğŸ”„ æ¤œé‡å®Œäº†æ—¥æ›´æ–°ä¸­...';
            
            const result = await makeRequest('updateInspectionComplete', { propertyId: 'TEST001' });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `âœ… updateInspectionCompleteæˆåŠŸ:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ updateInspectionCompleteå¤±æ•—: ${result.error}`;
            }
        }

        async function testGetMeterReadings() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = 'ğŸ”„ æ¤œé‡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
            
            const result = await makeRequest('getMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001' 
            });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `âœ… getMeterReadingsæˆåŠŸ:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ getMeterReadingså¤±æ•—: ${result.error}`;
            }
        }

        async function testUpdateMeterReadings() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = 'ğŸ”„ æ¤œé‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...';
            
            const testReadings = [
                { date: '2024-01-01', currentReading: '1000', usage: '50' },
                { date: '2024-02-01', currentReading: '1050', usage: '45' }
            ];
            
            const result = await makeRequest('updateMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001',
                readings: testReadings
            }, 'POST');
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `âœ… updateMeterReadings (POST)æˆåŠŸ:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `âŒ updateMeterReadings (POST)å¤±æ•—: ${result.error}`;
            }
        }

        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            resultDiv.innerHTML = 'ğŸ”„ å®Œå…¨è¨ºæ–­å®Ÿè¡Œä¸­...';
            
            const diagnosticResults = [];
            
            // 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
            console.log('ğŸ” è¨ºæ–­1: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª');
            const versionResult = await makeRequest('getVersion');
            diagnosticResults.push({
                test: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª',
                success: versionResult.success,
                result: versionResult.data || versionResult.error,
                isNewVersion: versionResult.success && versionResult.data.version && versionResult.data.version.includes('v3-DEBUG')
            });
            
            // 2. å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
            const actions = [
                { name: 'getProperties', params: {} },
                { name: 'getRooms', params: { propertyId: 'TEST001' } },
                { name: 'updateInspectionComplete', params: { propertyId: 'TEST001' } },
                { name: 'getMeterReadings', params: { propertyId: 'TEST001', roomId: 'ROOM001' } }
            ];
            
            for (const action of actions) {
                console.log(`ğŸ” è¨ºæ–­: ${action.name}`);
                const actionResult = await makeRequest(action.name, action.params);
                diagnosticResults.push({
                    test: action.name,
                    success: actionResult.success,
                    result: actionResult.data || actionResult.error
                });
            }
            
            // 3. POSTãƒ†ã‚¹ãƒˆ
            console.log('ğŸ” è¨ºæ–­: updateMeterReadings (POST)');
            const postResult = await makeRequest('updateMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001',
                readings: [{ date: '2024-01-01', currentReading: '1000' }]
            }, 'POST');
            diagnosticResults.push({
                test: 'updateMeterReadings (POST)',
                success: postResult.success,
                result: postResult.data || postResult.error
            });
            
            // çµæœã®è¡¨ç¤º
            const versionTest = diagnosticResults[0];
            let overallStatus = '';
            let resultClass = '';
            
            if (versionTest.isNewVersion) {
                overallStatus = 'ğŸ‰ SUCCESS: v3-DEBUGç‰ˆãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ï¼';
                resultClass = 'success';
            } else if (versionTest.success && versionTest.result.error && versionTest.result.error.includes('ç„¡åŠ¹ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³')) {
                overallStatus = 'âš ï¸ WARNING: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå‹•ä½œä¸­ã§ã™ã€‚æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ï¼';
                resultClass = 'error';
            } else {
                overallStatus = 'â“ UNKNOWN: çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                resultClass = 'warning';
            }
            
            resultDiv.className = `test-result ${resultClass}`;
            resultDiv.innerHTML = `
${overallStatus}

ğŸ“Š è¨ºæ–­çµæœè©³ç´°:
${diagnosticResults.map(r => `
${r.success ? 'âœ…' : 'âŒ'} ${r.test}: ${r.success ? 'SUCCESS' : 'FAILED'}
${JSON.stringify(r.result, null, 2)}
`).join('\n---\n')}
            `;
        }
    </script>
</body>
</html>
