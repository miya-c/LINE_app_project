<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔥 GAS デプロイメント確認テスト 🔥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #ff4444;
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            font-weight: bold;
            font-size: 1.2em;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">🔥 GAS デプロイメント確認テスト 🔥</h1>
        
        <div class="test-section">
            <h3>📋 デプロイ確認手順</h3>
            <ol>
                <li>Google Apps Scriptエディタで「物件.gs」ファイル全体をコピペして保存</li>
                <li>右上の「デプロイ」→「新しいデプロイ」をクリック</li>
                <li>「種類を選択」で「ウェブアプリ」を選択</li>
                <li>「新しいバージョンの説明」に「v3-DEBUG強制テスト」と入力</li>
                <li>「実行ユーザー」を「自分」に設定</li>
                <li>「アクセスできるユーザー」を「全員」に設定</li>
                <li>「デプロイ」ボタンをクリック</li>
                <li>新しいURLをコピーして下記に貼り付け</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🎯 GAS URL設定</h3>
            <input type="text" 
                   id="gasUrl" 
                   class="url-input" 
                   value="https://script.google.com/macros/s/AKfycbxlled-ot17rnp-yWMbKJqa8biDFV2XTFtgaWoQOhC7947dpYgn5qA0uSH7e9uKlgMcYA/exec"
                   placeholder="新しいGAS URLを入力してください">
            <button onclick="updateUrl()">URL更新</button>
        </div>

        <div class="test-section">
            <h3>🔍 バージョン確認テスト</h3>
            <button onclick="testVersion()">バージョン確認</button>
            <div id="versionResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>📊 アクション一覧テスト</h3>
            <button onclick="testGetProperties()">getProperties</button>
            <button onclick="testGetRooms()">getRooms</button>
            <button onclick="testUpdateInspectionComplete()">updateInspectionComplete</button>
            <button onclick="testGetMeterReadings()">getMeterReadings</button>
            <button onclick="testUpdateMeterReadings()">updateMeterReadings (POST)</button>
            <div id="actionResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>🚨 デプロイメント診断</h3>
            <button onclick="runFullDiagnostic()">完全診断実行</button>
            <div id="diagnosticResult" class="test-result"></div>
        </div>

        <div id="deploymentStatus" class="status"></div>
    </div>

    <script>
        let gasWebAppUrl = '';

        function updateUrl() {
            gasWebAppUrl = document.getElementById('gasUrl').value.trim();
            if (!gasWebAppUrl.endsWith('/exec')) {
                gasWebAppUrl += '/exec';
            }
            document.getElementById('gasUrl').value = gasWebAppUrl;
            console.log('🔄 GAS URL更新:', gasWebAppUrl);
            
            // URLの変更を通知
            document.getElementById('deploymentStatus').innerHTML = 
                `📍 現在のGAS URL: <span style="color: blue;">${gasWebAppUrl}</span>`;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateUrl();
        });

        async function makeRequest(action, additionalParams = {}, method = 'GET') {
            try {
                const params = { action, ...additionalParams };
                let url = gasWebAppUrl;
                let options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (method === 'GET') {
                    const searchParams = new URLSearchParams(params);
                    url += '?' + searchParams.toString();
                } else {
                    options.body = JSON.stringify(params);
                }

                console.log(`🚀 ${method}リクエスト送信:`, { url, params });
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                console.log('📥 レスポンス受信:', data);
                return { success: true, data };
                
            } catch (error) {
                console.error('❌ リクエストエラー:', error);
                return { success: false, error: error.message };
            }
        }

        async function testVersion() {
            const resultDiv = document.getElementById('versionResult');
            resultDiv.innerHTML = '🔄 バージョン確認中...';
            
            const result = await makeRequest('getVersion');
            
            if (result.success) {
                const data = result.data;
                let resultClass = 'success';
                let statusMessage = '';
                
                if (data.version && data.version.includes('v3-DEBUG')) {
                    statusMessage = '✅ 正常：v3-DEBUG版が動作中です！';
                } else if (data.error && data.error.includes('無効なアクション')) {
                    resultClass = 'error';
                    statusMessage = '❌ 古いバージョンが動作中：新しいデプロイが必要です！';
                } else {
                    resultClass = 'warning';
                    statusMessage = '⚠️ 不明なレスポンス：確認が必要です';
                }
                
                resultDiv.className = `test-result ${resultClass}`;
                resultDiv.innerHTML = `
${statusMessage}

📊 詳細レスポンス:
${JSON.stringify(data, null, 2)}
                `;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ リクエスト失敗: ${result.error}`;
            }
        }

        async function testGetProperties() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = '🔄 物件一覧取得中...';
            
            const result = await makeRequest('getProperties');
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `✅ getProperties成功:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ getProperties失敗: ${result.error}`;
            }
        }

        async function testGetRooms() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = '🔄 部屋一覧取得中...';
            
            const result = await makeRequest('getRooms', { propertyId: 'TEST001' });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `✅ getRooms成功:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ getRooms失敗: ${result.error}`;
            }
        }

        async function testUpdateInspectionComplete() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = '🔄 検針完了日更新中...';
            
            const result = await makeRequest('updateInspectionComplete', { propertyId: 'TEST001' });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `✅ updateInspectionComplete成功:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ updateInspectionComplete失敗: ${result.error}`;
            }
        }

        async function testGetMeterReadings() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = '🔄 検針データ取得中...';
            
            const result = await makeRequest('getMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001' 
            });
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `✅ getMeterReadings成功:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ getMeterReadings失敗: ${result.error}`;
            }
        }

        async function testUpdateMeterReadings() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.innerHTML = '🔄 検針データ更新中...';
            
            const testReadings = [
                { date: '2024-01-01', currentReading: '1000', usage: '50' },
                { date: '2024-02-01', currentReading: '1050', usage: '45' }
            ];
            
            const result = await makeRequest('updateMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001',
                readings: testReadings
            }, 'POST');
            
            if (result.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `✅ updateMeterReadings (POST)成功:\n${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ updateMeterReadings (POST)失敗: ${result.error}`;
            }
        }

        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            resultDiv.innerHTML = '🔄 完全診断実行中...';
            
            const diagnosticResults = [];
            
            // 1. バージョン確認
            console.log('🔍 診断1: バージョン確認');
            const versionResult = await makeRequest('getVersion');
            diagnosticResults.push({
                test: 'バージョン確認',
                success: versionResult.success,
                result: versionResult.data || versionResult.error,
                isNewVersion: versionResult.success && versionResult.data.version && versionResult.data.version.includes('v3-DEBUG')
            });
            
            // 2. 各アクションテスト
            const actions = [
                { name: 'getProperties', params: {} },
                { name: 'getRooms', params: { propertyId: 'TEST001' } },
                { name: 'updateInspectionComplete', params: { propertyId: 'TEST001' } },
                { name: 'getMeterReadings', params: { propertyId: 'TEST001', roomId: 'ROOM001' } }
            ];
            
            for (const action of actions) {
                console.log(`🔍 診断: ${action.name}`);
                const actionResult = await makeRequest(action.name, action.params);
                diagnosticResults.push({
                    test: action.name,
                    success: actionResult.success,
                    result: actionResult.data || actionResult.error
                });
            }
            
            // 3. POSTテスト
            console.log('🔍 診断: updateMeterReadings (POST)');
            const postResult = await makeRequest('updateMeterReadings', { 
                propertyId: 'TEST001', 
                roomId: 'ROOM001',
                readings: [{ date: '2024-01-01', currentReading: '1000' }]
            }, 'POST');
            diagnosticResults.push({
                test: 'updateMeterReadings (POST)',
                success: postResult.success,
                result: postResult.data || postResult.error
            });
            
            // 結果の表示
            const versionTest = diagnosticResults[0];
            let overallStatus = '';
            let resultClass = '';
            
            if (versionTest.isNewVersion) {
                overallStatus = '🎉 SUCCESS: v3-DEBUG版が正常にデプロイされています！';
                resultClass = 'success';
            } else if (versionTest.success && versionTest.result.error && versionTest.result.error.includes('無効なアクション')) {
                overallStatus = '⚠️ WARNING: 古いバージョンが動作中です。新しいデプロイが必要です！';
                resultClass = 'error';
            } else {
                overallStatus = '❓ UNKNOWN: 状況を確認してください';
                resultClass = 'warning';
            }
            
            resultDiv.className = `test-result ${resultClass}`;
            resultDiv.innerHTML = `
${overallStatus}

📊 診断結果詳細:
${diagnosticResults.map(r => `
${r.success ? '✅' : '❌'} ${r.test}: ${r.success ? 'SUCCESS' : 'FAILED'}
${JSON.stringify(r.result, null, 2)}
`).join('\n---\n')}
            `;
        }
    </script>
</body>
</html>
