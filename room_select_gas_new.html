<!DOCTYPE html>
<html>
<head>
  <title>éƒ¨å±‹é¸æŠ (GASç‰ˆ)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- CSSã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ– -->
  <style>
    /* ã“ã“ã«æ—¢å­˜ã®CSSã‚³ãƒ¼ãƒ‰ */
    /* (ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç°¡ç•¥åŒ–) */
  </style>
</head>
<body>
  <div id="root">
    <div class="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
  </div>

  <script>
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
    const appState = {
      propertyId: '',
      propertyName: '',
      rooms: [],
      filteredRooms: [],
      searchTerm: '',
      loading: true,
      error: null,
      isNavigating: false,
      navigationMessage: ''
    };

    // ç’°å¢ƒåˆ¤å®š
    function isWebApp() {
      try {
        // GASãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å ´åˆã¯google.script.runãŒå­˜åœ¨ã—ã€window.parent !== window
        const isInIframe = window.parent !== window;
        const hasGoogleScript = typeof google !== 'undefined' && google.script && google.script.run;
        
        // Web Appç’°å¢ƒã®å ´åˆã€google.script.runã¯å­˜åœ¨ã™ã‚‹ãŒIframeå†…ã§ã¯ãªã„
        const isWebApp = hasGoogleScript && !isInIframe;
        console.log('ç’°å¢ƒåˆ¤å®š:', { hasGoogleScript, isInIframe, isWebApp });
        
        return isWebApp;
      } catch (e) {
        console.error('ç’°å¢ƒåˆ¤å®šã‚¨ãƒ©ãƒ¼:', e);
        return false;
      }
    }

    // æ¤œé‡çŠ¶æ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatInspectionStatus(room) {
      console.log('[formatInspectionStatus] å…¥åŠ›:', {
        roomId: room.id,
        rawInspectionDate: room.rawInspectionDate,
        hasActualReading: room.hasActualReading,
        type: room.rawInspectionDate ? typeof room.rawInspectionDate : 'undefined'
      });
      
      const result = {
        status: 'æœªæ¤œé‡',
        displayDate: '',
        isCompleted: false
      };
      
      // å®Œäº†åˆ¤å®šã¯å®Ÿéš›ã®æ¤œé‡å€¤ãŒã‚ã‚‹ã‹ã©ã†ã‹
      const hasActualReading = room.hasActualReading === true;
      result.isCompleted = hasActualReading;
      
      if (hasActualReading) {
        result.status = 'æ¤œé‡æ¸ˆã¿';
        
        // æ¤œé‡æ—¥ã®å‡¦ç†
        if (room.rawInspectionDate) {
          try {
            // æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®å‹ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹
            let dateValue = null;
            
            if (typeof room.rawInspectionDate === 'string') {
              // ISOæ–‡å­—åˆ—ãªã©ã®å ´åˆ
              dateValue = new Date(room.rawInspectionDate);
            } else if (typeof room.rawInspectionDate === 'number') {
              // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®å ´åˆ
              dateValue = new Date(room.rawInspectionDate);
            } else if (room.rawInspectionDate instanceof Date) {
              // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
              dateValue = room.rawInspectionDate;
            }
            
            if (dateValue && !isNaN(dateValue.getTime())) {
              // æœ‰åŠ¹ãªæ—¥ä»˜ã®å ´åˆã ã‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
              const year = dateValue.getFullYear();
              const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
              const day = dateValue.getDate().toString().padStart(2, '0');
              result.displayDate = `${year}/${month}/${day}`;
            }
          } catch (e) {
            console.error('[formatInspectionStatus] æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', e);
          }
        }
      }
      
      console.log('[formatInspectionStatus] çµæœ:', result);
      return result;
    }

    // UIæç”»é–¢æ•° (çœç•¥)
    const renderLoadingOverlay = (message) => {
      // çœç•¥
    };

    // çœç•¥: ãã®ä»–ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°

    // çœç•¥: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©

    // åˆæœŸåŒ–å‡¦ç†
    const initializeApp = async () => {
      try {
        console.log('=== Room Select App åˆæœŸåŒ–é–‹å§‹ ===');
        console.log('ç¾åœ¨ã®URL:', window.location.href);
        console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', window.location.search);
        
        // ç’°å¢ƒåˆ¤å®š
        const webAppMode = isWebApp();
        console.log('å®Ÿè¡Œç’°å¢ƒ:', webAppMode ? 'Web App' : 'GAS ãƒ€ã‚¤ã‚¢ãƒ­ã‚°');
        
        // Web Appç’°å¢ƒã§ã®URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
        if (webAppMode) {
          console.log('ğŸŒ Web Appç’°å¢ƒã§ã®åˆæœŸåŒ–é–‹å§‹');
          
          const urlParams = new URLSearchParams(window.location.search);
          const propertyIdFromUrl = urlParams.get('propertyId');
          const propertyNameFromUrl = urlParams.get('propertyName');
          
          console.log('ğŸ” URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª:');
          console.log('- propertyId:', `"${propertyIdFromUrl}"`);
          console.log('- propertyName:', `"${propertyNameFromUrl}"`);
          console.log('- å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', Array.from(urlParams.entries()));
          
          // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å³å¯†ãªæ¤œè¨¼
          if (!propertyIdFromUrl || !propertyNameFromUrl || 
              propertyIdFromUrl.trim() === '' || propertyNameFromUrl.trim() === '') {
            console.error('âŒ Web Appç’°å¢ƒ: å¿…è¦ãªURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã¾ãŸã¯ç©º');
            console.error('âŒ æœŸå¾…å€¤: propertyId, propertyName');
            console.error('âŒ å®Ÿéš›ã®å€¤:', { propertyIdFromUrl, propertyNameFromUrl });
            
            appState.error = `URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç‰©ä»¶é¸æŠç”»é¢ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚

è©³ç´°æƒ…å ±:
- propertyId: ${propertyIdFromUrl || '(ãªã—)'}
- propertyName: ${propertyNameFromUrl || '(ãªã—)'}
- ç¾åœ¨ã®URL: ${window.location.href}
- å¿…è¦ãªæ“ä½œ: ç‰©ä»¶é¸æŠç”»é¢ã‹ã‚‰éƒ¨å±‹ã‚’å†é¸æŠã—ã¦ãã ã•ã„`;
            
            appState.loading = false;
            renderApp();
            return;
          }
          
          if (propertyIdFromUrl && propertyNameFromUrl) {
            appState.propertyId = decodeURIComponent(propertyIdFromUrl);
            appState.propertyName = decodeURIComponent(propertyNameFromUrl);
            
            console.log('ğŸ“ ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:');
            console.log('- propertyId:', `"${appState.propertyId}"`);
            console.log('- propertyName:', `"${appState.propertyName}"`);
            
            console.log('ğŸ“¡ Web App API éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
            
            try {
              const baseUrl = window.location.origin + window.location.pathname;
              const apiUrl = `${baseUrl}?action=getRooms&propertyId=${encodeURIComponent(appState.propertyId)}`;
              
              console.log('ğŸ“¡ API URL:', apiUrl);
              
              // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
              const controller = new AbortController();
              const timeoutId = setTimeout(() => {
                console.error('â° API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (10ç§’)');
                controller.abort();
              }, 10000);
              
              const response = await fetch(apiUrl, { 
                signal: controller.signal,
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                  'Cache-Control': 'no-cache'
                }
              });
              
              clearTimeout(timeoutId);
              
              console.log('ğŸ“¡ API Response Status:', response.status);
              console.log('ğŸ“¡ API Response OK:', response.ok);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('ğŸ“¡ HTTP Error Response Body:', errorText.substring(0, 500));
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const contentType = response.headers.get('Content-Type');
              console.log('ğŸ“¡ Content-Typeç¢ºèª:', contentType);
              
              let data;
              try {
                if (contentType && contentType.includes('application/json')) {
                  data = await response.json();
                } else {
                  const textData = await response.text();
                  console.log('ğŸ“¡ Non-JSON Response (first 500 chars):', textData.substring(0, 500));
                  
                  // HTMLãŒè¿”ã•ã‚ŒãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                  if (textData.trim().startsWith('<')) {
                    console.error('âŒ HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œå‡º - GASå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ');
                    
                    // HTMLã‹ã‚‰ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’æŠ½å‡º
                    const titleMatch = textData.match(/<title>(.*?)<\/title>/i);
                    const errorTitle = titleMatch ? titleMatch[1] : 'Unknown Error';
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯
                    const errorMsgMatch = textData.match(/Exception: (.*?)(<|\n|$)/);
                    const errorDetail = errorMsgMatch ? errorMsgMatch[1] : '';
                    
                    throw new Error(`GASå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorTitle}. ${errorDetail}`);
                  }
                  
                  // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                  try {
                    data = JSON.parse(textData);
                  } catch (parseError) {
                    console.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
                    // éƒ¨åˆ†çš„ã«JSONã®ã‚ˆã†ãªæ–‡å­—åˆ—ãŒå«ã¾ã‚Œã‚‹ã‹ç¢ºèª
                    const jsonMatch = textData.match(/(\{.*\}|\[.*\])/);
                    if (jsonMatch) {
                      try {
                        console.log('ğŸ“¡ éƒ¨åˆ†çš„ãªJSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã€è§£æã‚’è©¦è¡Œ:', jsonMatch[0].substring(0, 100));
                        data = JSON.parse(jsonMatch[0]);
                      } catch (nestedError) {
                        console.error('âŒ éƒ¨åˆ†çš„ãªJSONè§£æã«ã‚‚å¤±æ•—:', nestedError);
                        throw new Error(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${parseError.message}`);
                      }
                    } else {
                      throw new Error(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${parseError.message}`);
                    }
                  }
                }
              } catch (parseError) {
                console.error('âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚¨ãƒ©ãƒ¼:', parseError);
                throw new Error(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${parseError.message}`);
              }
              
              console.log('âœ… API Response Data:', data);
              console.log('âœ… Data Type:', typeof data);
              
              // çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®å‡¦ç†
              if (data && data.success === false) {
                console.error('âŒ APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ:', data.error);
                throw new Error(data.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
              }
              
              // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã®å„ªå…ˆé †ä½
              let roomsData = [];
              if (data && data.success === true && Array.isArray(data.data)) {
                roomsData = data.data;
                console.log('ğŸ“Š çµ±ä¸€å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', roomsData.length, 'ä»¶');
              } else if (data && data.result && Array.isArray(data.result)) {
                roomsData = data.result;
                console.log('ğŸ“Š resultå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', roomsData.length, 'ä»¶');
              } else if (Array.isArray(data)) {
                roomsData = data;
                console.log('ğŸ“Š ç›´æ¥é…åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', roomsData.length, 'ä»¶');
              } else if (data && data.rooms && Array.isArray(data.rooms)) {
                // rooms ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆ
                roomsData = data.rooms;
                console.log('ğŸ“Š roomså½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', roomsData.length, 'ä»¶');
              } else {
                console.error('âŒ äºˆæœŸã—ãªã„APIå¿œç­”å½¢å¼:', data);
                
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€é…åˆ—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¢ã™
                if (data && typeof data === 'object') {
                  for (const key in data) {
                    if (Array.isArray(data[key])) {
                      console.log(`ğŸ” ã‚­ãƒ¼ "${key}" ã«é…åˆ—ã‚’ç™ºè¦‹:`, data[key].length, 'ä»¶');
                      roomsData = data[key];
                      break;
                    }
                  }
                }
                
                // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                if (roomsData.length === 0) {
                  throw new Error('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
              }
              
              appState.rooms = roomsData;
              appState.filteredRooms = [...roomsData];
              appState.loading = false;
              console.log('âœ… Web App API éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ!');
              console.log('- éƒ¨å±‹æ•°:', appState.rooms.length);
              if (appState.rooms.length > 0) {
                console.log('- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(appState.rooms[0]));
              }
              
            } catch (apiError) {
              console.error('âŒ Web App API ã‚¨ãƒ©ãƒ¼:', apiError);
              
              // ã‚ˆã‚Šå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              let errorMessage = `éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${apiError.message}`;
              
              if (apiError.name === 'AbortError') {
                errorMessage = 'APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
              } else if (apiError.message.includes('Failed to fetch')) {
                errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
              } else if (apiError.message.includes('GASå´ã§ã‚¨ãƒ©ãƒ¼')) {
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚';
              }
              
              appState.error = errorMessage;
            }
            
            appState.loading = false;
            renderApp();
          }
        } 
        // GASãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç’°å¢ƒã§ã®å‡¦ç†
        else {
          // çœç•¥: GASãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç’°å¢ƒã§ã®å‡¦ç†
          appState.loading = false;
          renderApp();
        }
        
      } catch (globalError) {
        console.error('ğŸ”¥ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', globalError);
        appState.error = `ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${globalError.message}`;
        appState.loading = false;
        renderApp();
      }
    };

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
