<!DOCTYPE html>
<html lang="ja">
<head>
  <title>CSS読み込み性能監査ツール</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5; line-height: 1.6;
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .audit-section {
      background: #f8f9fa; margin: 20px 0; padding: 20px;
      border-radius: 8px; border-left: 4px solid #007bff;
    }
    .audit-section h3 { margin-top: 0; color: #007bff; }
    .score-circle {
      width: 80px; height: 80px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px; color: white;
      margin: 10px auto;
    }
    .score-good { background-color: #28a745; }
    .score-average { background-color: #ffc107; color: #212529; }
    .score-poor { background-color: #dc3545; }
    .metrics-table {
      width: 100%; border-collapse: collapse; margin: 15px 0;
      background: white; border-radius: 4px; overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .metrics-table th, .metrics-table td {
      padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;
    }
    .metrics-table th { background-color: #f8f9fa; font-weight: 600; }
    .metric-good { color: #28a745; font-weight: bold; }
    .metric-average { color: #ffc107; font-weight: bold; }
    .metric-poor { color: #dc3545; font-weight: bold; }
    .progress-bar {
      width: 100%; height: 8px; background-color: #e9ecef;
      border-radius: 4px; overflow: hidden; margin: 5px 0;
    }
    .progress-fill {
      height: 100%; transition: width 0.3s ease;
    }
    .progress-good { background-color: #28a745; }
    .progress-average { background-color: #ffc107; }
    .progress-poor { background-color: #dc3545; }
    button {
      padding: 10px 20px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .running { opacity: 0.6; pointer-events: none; }
    .audit-item {
      display: flex; align-items: center; margin: 10px 0;
      padding: 10px; background: white; border-radius: 4px;
      border-left: 3px solid #dee2e6;
    }
    .audit-item.pass { border-left-color: #28a745; }
    .audit-item.fail { border-left-color: #dc3545; }
    .audit-item.warn { border-left-color: #ffc107; }
    .audit-icon {
      width: 24px; height: 24px; margin-right: 12px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: white; font-size: 14px;
    }
    .audit-icon.pass { background-color: #28a745; }
    .audit-icon.fail { background-color: #dc3545; }
    .audit-icon.warn { background-color: #ffc107; color: #212529; }
    .recommendation {
      background: #e7f5ff; border: 1px solid #bee5eb;
      border-radius: 4px; padding: 15px; margin: 10px 0;
    }
    .recommendation h4 { margin: 0 0 10px 0; color: #0c5460; }
    .chart-container {
      position: relative; height: 200px; margin: 20px 0;
      background: white; border-radius: 4px; padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 CSS読み込み性能監査ツール</h1>
    <p>水道メーター読み取りアプリのCSS読み込み性能を詳細に監査し、改善提案を行います。</p>
    
    <!-- 監査対象選択 -->
    <div class="audit-section">
      <h3>📋 監査対象</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <label><input type="checkbox" id="audit-property" checked> 物件選択ページ</label>
        <label><input type="checkbox" id="audit-room" checked> 部屋選択ページ</label>
        <label><input type="checkbox" id="audit-meter" checked> メーター読み取りページ</label>
        <label><input type="checkbox" id="audit-broken"> 修正前ページ (比較用)</label>
      </div>
      <button onclick="startAudit()" id="audit-button">🚀 監査開始</button>
      <button onclick="generateReport()">📊 レポート生成</button>
      <button onclick="clearResults()">🗑️ 結果クリア</button>
    </div>
    
    <!-- 総合スコア -->
    <div class="audit-section" id="overall-score" style="display: none;">
      <h3>📊 総合パフォーマンススコア</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
        <div>
          <div class="score-circle" id="performance-score">-</div>
          <div>パフォーマンス</div>
        </div>
        <div>
          <div class="score-circle" id="css-score">-</div>
          <div>CSS読み込み</div>
        </div>
        <div>
          <div class="score-circle" id="fouc-score">-</div>
          <div>FOUC対策</div>
        </div>
        <div>
          <div class="score-circle" id="critical-score">-</div>
          <div>クリティカルCSS</div>
        </div>
      </div>
    </div>
    
    <!-- 詳細メトリクス -->
    <div class="audit-section" id="detailed-metrics" style="display: none;">
      <h3>📈 詳細メトリクス</h3>
      <table class="metrics-table" id="metrics-table">
        <thead>
          <tr>
            <th>ページ</th>
            <th>読み込み時間</th>
            <th>First Paint</th>
            <th>CSS完了</th>
            <th>React初期化</th>
            <th>対話可能</th>
            <th>スコア</th>
          </tr>
        </thead>
        <tbody id="metrics-tbody">
        </tbody>
      </table>
    </div>
    
    <!-- 監査項目 -->
    <div class="audit-section" id="audit-items" style="display: none;">
      <h3>✅ 監査項目</h3>
      <div id="audit-checklist"></div>
    </div>
    
    <!-- 改善提案 -->
    <div class="audit-section" id="recommendations" style="display: none;">
      <h3>💡 改善提案</h3>
      <div id="recommendations-list"></div>
    </div>
    
    <!-- パフォーマンスチャート -->
    <div class="audit-section" id="performance-chart" style="display: none;">
      <h3>📊 パフォーマンス推移</h3>
      <div class="chart-container">
        <canvas id="performance-canvas" width="600" height="150"></canvas>
      </div>
    </div>
  </div>

  <script>
    let auditResults = [];
    let auditInProgress = false;

    async function startAudit() {
      if (auditInProgress) return;
      
      auditInProgress = true;
      const button = document.getElementById('audit-button');
      button.textContent = '監査実行中...';
      button.classList.add('running');
      
      // 監査対象を取得
      const targets = [];
      if (document.getElementById('audit-property').checked) targets.push({ name: '物件選択', url: 'property_select.html' });
      if (document.getElementById('audit-room').checked) targets.push({ name: '部屋選択', url: 'room_select.html' });
      if (document.getElementById('audit-meter').checked) targets.push({ name: 'メーター読み取り', url: 'meter_reading.html' });
      if (document.getElementById('audit-broken').checked) targets.push({ name: '修正前', url: 'property_select_broken.html' });
      
      auditResults = [];
      
      // 各ページを監査
      for (let i = 0; i < targets.length; i++) {
        const target = targets[i];
        button.textContent = `監査中... ${target.name} (${i+1}/${targets.length})`;
        
        const result = await auditPage(target.name, target.url);
        auditResults.push(result);
        
        // 少し待機
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      // 結果を表示
      displayAuditResults();
      
      auditInProgress = false;
      button.textContent = '🚀 監査開始';
      button.classList.remove('running');
    }

    function auditPage(name, url) {
      return new Promise((resolve) => {
        const startTime = performance.now();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        
        let firstPaintTime = null;
        let cssCompleteTime = null;
        let reactInitTime = null;
        
        iframe.onload = () => {
          try {
            const loadTime = performance.now() - startTime;
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const iframeWindow = iframe.contentWindow;
            
            // CSS読み込み状況
            const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
            const cssLoaded = Array.from(cssLinks).every(link => link.sheet !== null);
            
            // クリティカルCSS
            const inlineStyles = iframeDoc.querySelectorAll('style');
            const hasCriticalCSS = inlineStyles.length > 0;
            
            // FOUC対策
            const rootElement = iframeDoc.getElementById('root');
            const hasFOUCProtection = rootElement && 
              (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
            
            // スタイル適用確認
            const testElement = iframeDoc.createElement('div');
            testElement.className = 'mantine-button';
            testElement.style.position = 'absolute';
            testElement.style.visibility = 'hidden';
            iframeDoc.body.appendChild(testElement);
            
            const computedStyle = iframeWindow.getComputedStyle(testElement);
            const hasButtonStyles = computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                                   computedStyle.backgroundColor !== 'transparent';
            
            iframeDoc.body.removeChild(testElement);
            
            // React初期化確認
            const hasReact = typeof iframeWindow.React !== 'undefined';
            const hasReactDOM = typeof iframeWindow.ReactDOM !== 'undefined';
            
            // パフォーマンス計算
            const performanceScore = calculatePerformanceScore(loadTime, cssLoaded, hasButtonStyles);
            const cssScore = calculateCSSScore(cssLoaded, hasCriticalCSS, cssLinks.length);
            const foucScore = hasFOUCProtection ? 100 : 0;
            const criticalScore = hasCriticalCSS ? 100 : 0;
            
            const result = {
              name,
              url,
              loadTime: loadTime.toFixed(2),
              cssLoaded,
              hasCriticalCSS,
              hasFOUCProtection,
              hasButtonStyles,
              hasReact,
              hasReactDOM,
              cssCount: cssLinks.length,
              performanceScore,
              cssScore,
              foucScore,
              criticalScore,
              overallScore: Math.round((performanceScore + cssScore + foucScore + criticalScore) / 4),
              timestamp: Date.now()
            };
            
            resolve(result);
            
          } catch (error) {
            resolve({
              name,
              url,
              error: error.message,
              loadTime: (performance.now() - startTime).toFixed(2),
              timestamp: Date.now()
            });
          }
          
          document.body.removeChild(iframe);
        };
        
        iframe.onerror = () => {
          resolve({
            name,
            url,
            error: 'ページ読み込みエラー',
            timestamp: Date.now()
          });
          document.body.removeChild(iframe);
        };
        
        document.body.appendChild(iframe);
      });
    }

    function calculatePerformanceScore(loadTime, cssLoaded, hasStyles) {
      let score = 100;
      
      // 読み込み時間によるスコア減点
      if (loadTime > 3000) score -= 40;
      else if (loadTime > 1500) score -= 20;
      else if (loadTime > 800) score -= 10;
      
      // CSS読み込み失敗
      if (!cssLoaded) score -= 30;
      
      // スタイル適用失敗
      if (!hasStyles) score -= 30;
      
      return Math.max(0, score);
    }

    function calculateCSSScore(cssLoaded, hasCritical, cssCount) {
      let score = 0;
      
      if (cssLoaded) score += 40;
      if (hasCritical) score += 30;
      if (cssCount <= 3) score += 20; // CSS ファイル数が適切
      else score += 10;
      
      return Math.min(100, score);
    }

    function displayAuditResults() {
      if (auditResults.length === 0) return;
      
      // 総合スコア表示
      displayOverallScores();
      
      // 詳細メトリクス表示
      displayDetailedMetrics();
      
      // 監査項目表示
      displayAuditItems();
      
      // 改善提案表示
      displayRecommendations();
      
      // セクションを表示
      ['overall-score', 'detailed-metrics', 'audit-items', 'recommendations'].forEach(id => {
        document.getElementById(id).style.display = 'block';
      });
    }

    function displayOverallScores() {
      const avgPerformance = Math.round(auditResults.reduce((sum, r) => sum + (r.performanceScore || 0), 0) / auditResults.length);
      const avgCSS = Math.round(auditResults.reduce((sum, r) => sum + (r.cssScore || 0), 0) / auditResults.length);
      const avgFOUC = Math.round(auditResults.reduce((sum, r) => sum + (r.foucScore || 0), 0) / auditResults.length);
      const avgCritical = Math.round(auditResults.reduce((sum, r) => sum + (r.criticalScore || 0), 0) / auditResults.length);
      
      updateScoreCircle('performance-score', avgPerformance);
      updateScoreCircle('css-score', avgCSS);
      updateScoreCircle('fouc-score', avgFOUC);
      updateScoreCircle('critical-score', avgCritical);
    }

    function updateScoreCircle(id, score) {
      const element = document.getElementById(id);
      element.textContent = score;
      element.className = 'score-circle ' + getScoreClass(score);
    }

    function getScoreClass(score) {
      if (score >= 80) return 'score-good';
      if (score >= 50) return 'score-average';
      return 'score-poor';
    }

    function displayDetailedMetrics() {
      const tbody = document.getElementById('metrics-tbody');
      tbody.innerHTML = '';
      
      auditResults.forEach(result => {
        if (result.error) return;
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${result.name}</td>
          <td class="${getMetricClass(result.loadTime, 1000, 2000)}">${result.loadTime}ms</td>
          <td class="metric-good">-</td>
          <td class="${result.cssLoaded ? 'metric-good' : 'metric-poor'}">${result.cssLoaded ? '✅' : '❌'}</td>
          <td class="${result.hasReact ? 'metric-good' : 'metric-poor'}">${result.hasReact ? '✅' : '❌'}</td>
          <td class="metric-good">-</td>
          <td class="${getScoreClass(result.overallScore)} score-circle" style="width: 40px; height: 40px; font-size: 14px;">${result.overallScore}</td>
        `;
      });
    }

    function getMetricClass(value, good, poor) {
      if (parseFloat(value) <= good) return 'metric-good';
      if (parseFloat(value) <= poor) return 'metric-average';
      return 'metric-poor';
    }

    function displayAuditItems() {
      const checklist = document.getElementById('audit-checklist');
      checklist.innerHTML = '';
      
      const auditItems = [
        { name: 'CSS読み込み順序の最適化', check: result => result.cssLoaded },
        { name: 'クリティカルCSSの実装', check: result => result.hasCriticalCSS },
        { name: 'FOUC対策の実装', check: result => result.hasFOUCProtection },
        { name: 'React初期化の確認', check: result => result.hasReact },
        { name: 'スタイル適用の確認', check: result => result.hasButtonStyles },
        { name: '適切な読み込み時間 (<1秒)', check: result => parseFloat(result.loadTime) < 1000 }
      ];
      
      auditItems.forEach(item => {
        const passCount = auditResults.filter(r => !r.error && item.check(r)).length;
        const totalCount = auditResults.filter(r => !r.error).length;
        const status = passCount === totalCount ? 'pass' : passCount > 0 ? 'warn' : 'fail';
        
        const div = document.createElement('div');
        div.className = `audit-item ${status}`;
        div.innerHTML = `
          <div class="audit-icon ${status}">${status === 'pass' ? '✓' : status === 'warn' ? '!' : '✗'}</div>
          <div>
            <strong>${item.name}</strong><br>
            <small>${passCount}/${totalCount} ページで合格</small>
          </div>
        `;
        checklist.appendChild(div);
      });
    }

    function displayRecommendations() {
      const recommendations = document.getElementById('recommendations-list');
      recommendations.innerHTML = '';
      
      const issues = [];
      
      // CSS読み込みの問題
      const cssIssues = auditResults.filter(r => !r.error && !r.cssLoaded);
      if (cssIssues.length > 0) {
        issues.push({
          title: 'CSS読み込みの問題',
          description: `${cssIssues.length}ページでCSS読み込みに失敗しています。CSSファイルのパスとサーバー設定を確認してください。`,
          priority: 'high'
        });
      }
      
      // FOUC対策未実装
      const foucIssues = auditResults.filter(r => !r.error && !r.hasFOUCProtection);
      if (foucIssues.length > 0) {
        issues.push({
          title: 'FOUC対策の改善',
          description: 'styles-loading/styles-loadedクラスを使用したFOUC対策を全ページに実装することを推奨します。',
          priority: 'medium'
        });
      }
      
      // クリティカルCSS未実装
      const criticalIssues = auditResults.filter(r => !r.error && !r.hasCriticalCSS);
      if (criticalIssues.length > 0) {
        issues.push({
          title: 'クリティカルCSSの実装',
          description: 'インラインクリティカルCSSを追加して初回レンダリングを高速化できます。',
          priority: 'medium'
        });
      }
      
      // パフォーマンス問題
      const slowPages = auditResults.filter(r => !r.error && parseFloat(r.loadTime) > 1500);
      if (slowPages.length > 0) {
        issues.push({
          title: 'ページ読み込み速度の改善',
          description: 'CSSファイルの最適化、CDNの使用、キャッシュ設定の見直しを検討してください。',
          priority: 'low'
        });
      }
      
      issues.forEach(issue => {
        const div = document.createElement('div');
        div.className = 'recommendation';
        div.innerHTML = `
          <h4>🔧 ${issue.title} (優先度: ${issue.priority === 'high' ? '高' : issue.priority === 'medium' ? '中' : '低'})</h4>
          <p>${issue.description}</p>
        `;
        recommendations.appendChild(div);
      });
      
      if (issues.length === 0) {
        recommendations.innerHTML = '<div class="recommendation"><h4>🎉 素晴らしい!</h4><p>特に改善が必要な問題は見つかりませんでした。</p></div>';
      }
    }

    function generateReport() {
      if (auditResults.length === 0) {
        alert('まず監査を実行してください。');
        return;
      }
      
      const reportData = {
        timestamp: new Date().toLocaleString(),
        summary: {
          totalPages: auditResults.length,
          averageLoadTime: (auditResults.reduce((sum, r) => sum + parseFloat(r.loadTime || 0), 0) / auditResults.length).toFixed(2),
          cssSuccessRate: Math.round((auditResults.filter(r => r.cssLoaded).length / auditResults.length) * 100),
          foucProtectionRate: Math.round((auditResults.filter(r => r.hasFOUCProtection).length / auditResults.length) * 100)
        },
        results: auditResults
      };
      
      const reportText = `
# CSS読み込み性能監査レポート

実行日時: ${reportData.timestamp}

## 概要
- 監査対象ページ数: ${reportData.summary.totalPages}
- 平均読み込み時間: ${reportData.summary.averageLoadTime}ms
- CSS読み込み成功率: ${reportData.summary.cssSuccessRate}%
- FOUC対策実装率: ${reportData.summary.foucProtectionRate}%

## 詳細結果
${auditResults.map(result => `
### ${result.name}
- URL: ${result.url}
- 読み込み時間: ${result.loadTime}ms
- CSS読み込み: ${result.cssLoaded ? '成功' : '失敗'}
- クリティカルCSS: ${result.hasCriticalCSS ? 'あり' : 'なし'}
- FOUC対策: ${result.hasFOUCProtection ? '実装済み' : '未実装'}
- 総合スコア: ${result.overallScore}/100
`).join('')}

## 推奨事項
1. 全ページでCSS読み込みが確実に完了するよう監視を強化
2. クリティカルCSSの実装でFirst Paintを改善
3. FOUC対策を全ページに統一実装
4. 定期的なパフォーマンス監査の実施
      `;
      
      const blob = new Blob([reportText], { type: 'text/plain; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `css-performance-audit-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearResults() {
      auditResults = [];
      ['overall-score', 'detailed-metrics', 'audit-items', 'recommendations', 'performance-chart'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }
  </script>
</body>
</html>
