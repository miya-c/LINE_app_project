<!DOCTYPE html>
<html lang="ja">
<head>
  <title>CSSèª­ã¿è¾¼ã¿æ€§èƒ½ç›£æŸ»ãƒ„ãƒ¼ãƒ«</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body { 
      margin: 0; padding: 20px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5; line-height: 1.6;
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      background: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .audit-section {
      background: #f8f9fa; margin: 20px 0; padding: 20px;
      border-radius: 8px; border-left: 4px solid #007bff;
    }
    .audit-section h3 { margin-top: 0; color: #007bff; }
    .score-circle {
      width: 80px; height: 80px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px; color: white;
      margin: 10px auto;
    }
    .score-good { background-color: #28a745; }
    .score-average { background-color: #ffc107; color: #212529; }
    .score-poor { background-color: #dc3545; }
    .metrics-table {
      width: 100%; border-collapse: collapse; margin: 15px 0;
      background: white; border-radius: 4px; overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .metrics-table th, .metrics-table td {
      padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;
    }
    .metrics-table th { background-color: #f8f9fa; font-weight: 600; }
    .metric-good { color: #28a745; font-weight: bold; }
    .metric-average { color: #ffc107; font-weight: bold; }
    .metric-poor { color: #dc3545; font-weight: bold; }
    .progress-bar {
      width: 100%; height: 8px; background-color: #e9ecef;
      border-radius: 4px; overflow: hidden; margin: 5px 0;
    }
    .progress-fill {
      height: 100%; transition: width 0.3s ease;
    }
    .progress-good { background-color: #28a745; }
    .progress-average { background-color: #ffc107; }
    .progress-poor { background-color: #dc3545; }
    button {
      padding: 10px 20px; margin: 5px;
      border: 1px solid #007bff; border-radius: 4px;
      background-color: #007bff; color: white;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .running { opacity: 0.6; pointer-events: none; }
    .audit-item {
      display: flex; align-items: center; margin: 10px 0;
      padding: 10px; background: white; border-radius: 4px;
      border-left: 3px solid #dee2e6;
    }
    .audit-item.pass { border-left-color: #28a745; }
    .audit-item.fail { border-left-color: #dc3545; }
    .audit-item.warn { border-left-color: #ffc107; }
    .audit-icon {
      width: 24px; height: 24px; margin-right: 12px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: white; font-size: 14px;
    }
    .audit-icon.pass { background-color: #28a745; }
    .audit-icon.fail { background-color: #dc3545; }
    .audit-icon.warn { background-color: #ffc107; color: #212529; }
    .recommendation {
      background: #e7f5ff; border: 1px solid #bee5eb;
      border-radius: 4px; padding: 15px; margin: 10px 0;
    }
    .recommendation h4 { margin: 0 0 10px 0; color: #0c5460; }
    .chart-container {
      position: relative; height: 200px; margin: 20px 0;
      background: white; border-radius: 4px; padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” CSSèª­ã¿è¾¼ã¿æ€§èƒ½ç›£æŸ»ãƒ„ãƒ¼ãƒ«</h1>
    <p>æ°´é“ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šã‚¢ãƒ—ãƒªã®CSSèª­ã¿è¾¼ã¿æ€§èƒ½ã‚’è©³ç´°ã«ç›£æŸ»ã—ã€æ”¹å–„ææ¡ˆã‚’è¡Œã„ã¾ã™ã€‚</p>
    
    <!-- ç›£æŸ»å¯¾è±¡é¸æŠ -->
    <div class="audit-section">
      <h3>ğŸ“‹ ç›£æŸ»å¯¾è±¡</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <label><input type="checkbox" id="audit-property" checked> ç‰©ä»¶é¸æŠãƒšãƒ¼ã‚¸</label>
        <label><input type="checkbox" id="audit-room" checked> éƒ¨å±‹é¸æŠãƒšãƒ¼ã‚¸</label>
        <label><input type="checkbox" id="audit-meter" checked> ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Šãƒšãƒ¼ã‚¸</label>
        <label><input type="checkbox" id="audit-broken"> ä¿®æ­£å‰ãƒšãƒ¼ã‚¸ (æ¯”è¼ƒç”¨)</label>
      </div>
      <button onclick="startAudit()" id="audit-button">ğŸš€ ç›£æŸ»é–‹å§‹</button>
      <button onclick="generateReport()">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
      <button onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
    </div>
    
    <!-- ç·åˆã‚¹ã‚³ã‚¢ -->
    <div class="audit-section" id="overall-score" style="display: none;">
      <h3>ğŸ“Š ç·åˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
        <div>
          <div class="score-circle" id="performance-score">-</div>
          <div>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
        </div>
        <div>
          <div class="score-circle" id="css-score">-</div>
          <div>CSSèª­ã¿è¾¼ã¿</div>
        </div>
        <div>
          <div class="score-circle" id="fouc-score">-</div>
          <div>FOUCå¯¾ç­–</div>
        </div>
        <div>
          <div class="score-circle" id="critical-score">-</div>
          <div>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSS</div>
        </div>
      </div>
    </div>
    
    <!-- è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
    <div class="audit-section" id="detailed-metrics" style="display: none;">
      <h3>ğŸ“ˆ è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹</h3>
      <table class="metrics-table" id="metrics-table">
        <thead>
          <tr>
            <th>ãƒšãƒ¼ã‚¸</th>
            <th>èª­ã¿è¾¼ã¿æ™‚é–“</th>
            <th>First Paint</th>
            <th>CSSå®Œäº†</th>
            <th>ReactåˆæœŸåŒ–</th>
            <th>å¯¾è©±å¯èƒ½</th>
            <th>ã‚¹ã‚³ã‚¢</th>
          </tr>
        </thead>
        <tbody id="metrics-tbody">
        </tbody>
      </table>
    </div>
    
    <!-- ç›£æŸ»é …ç›® -->
    <div class="audit-section" id="audit-items" style="display: none;">
      <h3>âœ… ç›£æŸ»é …ç›®</h3>
      <div id="audit-checklist"></div>
    </div>
    
    <!-- æ”¹å–„ææ¡ˆ -->
    <div class="audit-section" id="recommendations" style="display: none;">
      <h3>ğŸ’¡ æ”¹å–„ææ¡ˆ</h3>
      <div id="recommendations-list"></div>
    </div>
    
    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="audit-section" id="performance-chart" style="display: none;">
      <h3>ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¨ç§»</h3>
      <div class="chart-container">
        <canvas id="performance-canvas" width="600" height="150"></canvas>
      </div>
    </div>
  </div>

  <script>
    let auditResults = [];
    let auditInProgress = false;

    async function startAudit() {
      if (auditInProgress) return;
      
      auditInProgress = true;
      const button = document.getElementById('audit-button');
      button.textContent = 'ç›£æŸ»å®Ÿè¡Œä¸­...';
      button.classList.add('running');
      
      // ç›£æŸ»å¯¾è±¡ã‚’å–å¾—
      const targets = [];
      if (document.getElementById('audit-property').checked) targets.push({ name: 'ç‰©ä»¶é¸æŠ', url: 'property_select.html' });
      if (document.getElementById('audit-room').checked) targets.push({ name: 'éƒ¨å±‹é¸æŠ', url: 'room_select.html' });
      if (document.getElementById('audit-meter').checked) targets.push({ name: 'ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­ã¿å–ã‚Š', url: 'meter_reading.html' });
      if (document.getElementById('audit-broken').checked) targets.push({ name: 'ä¿®æ­£å‰', url: 'property_select_broken.html' });
      
      auditResults = [];
      
      // å„ãƒšãƒ¼ã‚¸ã‚’ç›£æŸ»
      for (let i = 0; i < targets.length; i++) {
        const target = targets[i];
        button.textContent = `ç›£æŸ»ä¸­... ${target.name} (${i+1}/${targets.length})`;
        
        const result = await auditPage(target.name, target.url);
        auditResults.push(result);
        
        // å°‘ã—å¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      // çµæœã‚’è¡¨ç¤º
      displayAuditResults();
      
      auditInProgress = false;
      button.textContent = 'ğŸš€ ç›£æŸ»é–‹å§‹';
      button.classList.remove('running');
    }

    function auditPage(name, url) {
      return new Promise((resolve) => {
        const startTime = performance.now();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        
        let firstPaintTime = null;
        let cssCompleteTime = null;
        let reactInitTime = null;
        
        iframe.onload = () => {
          try {
            const loadTime = performance.now() - startTime;
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const iframeWindow = iframe.contentWindow;
            
            // CSSèª­ã¿è¾¼ã¿çŠ¶æ³
            const cssLinks = iframeDoc.querySelectorAll('link[rel="stylesheet"]');
            const cssLoaded = Array.from(cssLinks).every(link => link.sheet !== null);
            
            // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSS
            const inlineStyles = iframeDoc.querySelectorAll('style');
            const hasCriticalCSS = inlineStyles.length > 0;
            
            // FOUCå¯¾ç­–
            const rootElement = iframeDoc.getElementById('root');
            const hasFOUCProtection = rootElement && 
              (rootElement.classList.contains('styles-loading') || rootElement.classList.contains('styles-loaded'));
            
            // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ç¢ºèª
            const testElement = iframeDoc.createElement('div');
            testElement.className = 'mantine-button';
            testElement.style.position = 'absolute';
            testElement.style.visibility = 'hidden';
            iframeDoc.body.appendChild(testElement);
            
            const computedStyle = iframeWindow.getComputedStyle(testElement);
            const hasButtonStyles = computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                                   computedStyle.backgroundColor !== 'transparent';
            
            iframeDoc.body.removeChild(testElement);
            
            // ReactåˆæœŸåŒ–ç¢ºèª
            const hasReact = typeof iframeWindow.React !== 'undefined';
            const hasReactDOM = typeof iframeWindow.ReactDOM !== 'undefined';
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆç®—
            const performanceScore = calculatePerformanceScore(loadTime, cssLoaded, hasButtonStyles);
            const cssScore = calculateCSSScore(cssLoaded, hasCriticalCSS, cssLinks.length);
            const foucScore = hasFOUCProtection ? 100 : 0;
            const criticalScore = hasCriticalCSS ? 100 : 0;
            
            const result = {
              name,
              url,
              loadTime: loadTime.toFixed(2),
              cssLoaded,
              hasCriticalCSS,
              hasFOUCProtection,
              hasButtonStyles,
              hasReact,
              hasReactDOM,
              cssCount: cssLinks.length,
              performanceScore,
              cssScore,
              foucScore,
              criticalScore,
              overallScore: Math.round((performanceScore + cssScore + foucScore + criticalScore) / 4),
              timestamp: Date.now()
            };
            
            resolve(result);
            
          } catch (error) {
            resolve({
              name,
              url,
              error: error.message,
              loadTime: (performance.now() - startTime).toFixed(2),
              timestamp: Date.now()
            });
          }
          
          document.body.removeChild(iframe);
        };
        
        iframe.onerror = () => {
          resolve({
            name,
            url,
            error: 'ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼',
            timestamp: Date.now()
          });
          document.body.removeChild(iframe);
        };
        
        document.body.appendChild(iframe);
      });
    }

    function calculatePerformanceScore(loadTime, cssLoaded, hasStyles) {
      let score = 100;
      
      // èª­ã¿è¾¼ã¿æ™‚é–“ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢æ¸›ç‚¹
      if (loadTime > 3000) score -= 40;
      else if (loadTime > 1500) score -= 20;
      else if (loadTime > 800) score -= 10;
      
      // CSSèª­ã¿è¾¼ã¿å¤±æ•—
      if (!cssLoaded) score -= 30;
      
      // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨å¤±æ•—
      if (!hasStyles) score -= 30;
      
      return Math.max(0, score);
    }

    function calculateCSSScore(cssLoaded, hasCritical, cssCount) {
      let score = 0;
      
      if (cssLoaded) score += 40;
      if (hasCritical) score += 30;
      if (cssCount <= 3) score += 20; // CSS ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒé©åˆ‡
      else score += 10;
      
      return Math.min(100, score);
    }

    function displayAuditResults() {
      if (auditResults.length === 0) return;
      
      // ç·åˆã‚¹ã‚³ã‚¢è¡¨ç¤º
      displayOverallScores();
      
      // è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
      displayDetailedMetrics();
      
      // ç›£æŸ»é …ç›®è¡¨ç¤º
      displayAuditItems();
      
      // æ”¹å–„ææ¡ˆè¡¨ç¤º
      displayRecommendations();
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      ['overall-score', 'detailed-metrics', 'audit-items', 'recommendations'].forEach(id => {
        document.getElementById(id).style.display = 'block';
      });
    }

    function displayOverallScores() {
      const avgPerformance = Math.round(auditResults.reduce((sum, r) => sum + (r.performanceScore || 0), 0) / auditResults.length);
      const avgCSS = Math.round(auditResults.reduce((sum, r) => sum + (r.cssScore || 0), 0) / auditResults.length);
      const avgFOUC = Math.round(auditResults.reduce((sum, r) => sum + (r.foucScore || 0), 0) / auditResults.length);
      const avgCritical = Math.round(auditResults.reduce((sum, r) => sum + (r.criticalScore || 0), 0) / auditResults.length);
      
      updateScoreCircle('performance-score', avgPerformance);
      updateScoreCircle('css-score', avgCSS);
      updateScoreCircle('fouc-score', avgFOUC);
      updateScoreCircle('critical-score', avgCritical);
    }

    function updateScoreCircle(id, score) {
      const element = document.getElementById(id);
      element.textContent = score;
      element.className = 'score-circle ' + getScoreClass(score);
    }

    function getScoreClass(score) {
      if (score >= 80) return 'score-good';
      if (score >= 50) return 'score-average';
      return 'score-poor';
    }

    function displayDetailedMetrics() {
      const tbody = document.getElementById('metrics-tbody');
      tbody.innerHTML = '';
      
      auditResults.forEach(result => {
        if (result.error) return;
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${result.name}</td>
          <td class="${getMetricClass(result.loadTime, 1000, 2000)}">${result.loadTime}ms</td>
          <td class="metric-good">-</td>
          <td class="${result.cssLoaded ? 'metric-good' : 'metric-poor'}">${result.cssLoaded ? 'âœ…' : 'âŒ'}</td>
          <td class="${result.hasReact ? 'metric-good' : 'metric-poor'}">${result.hasReact ? 'âœ…' : 'âŒ'}</td>
          <td class="metric-good">-</td>
          <td class="${getScoreClass(result.overallScore)} score-circle" style="width: 40px; height: 40px; font-size: 14px;">${result.overallScore}</td>
        `;
      });
    }

    function getMetricClass(value, good, poor) {
      if (parseFloat(value) <= good) return 'metric-good';
      if (parseFloat(value) <= poor) return 'metric-average';
      return 'metric-poor';
    }

    function displayAuditItems() {
      const checklist = document.getElementById('audit-checklist');
      checklist.innerHTML = '';
      
      const auditItems = [
        { name: 'CSSèª­ã¿è¾¼ã¿é †åºã®æœ€é©åŒ–', check: result => result.cssLoaded },
        { name: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSã®å®Ÿè£…', check: result => result.hasCriticalCSS },
        { name: 'FOUCå¯¾ç­–ã®å®Ÿè£…', check: result => result.hasFOUCProtection },
        { name: 'ReactåˆæœŸåŒ–ã®ç¢ºèª', check: result => result.hasReact },
        { name: 'ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ã®ç¢ºèª', check: result => result.hasButtonStyles },
        { name: 'é©åˆ‡ãªèª­ã¿è¾¼ã¿æ™‚é–“ (<1ç§’)', check: result => parseFloat(result.loadTime) < 1000 }
      ];
      
      auditItems.forEach(item => {
        const passCount = auditResults.filter(r => !r.error && item.check(r)).length;
        const totalCount = auditResults.filter(r => !r.error).length;
        const status = passCount === totalCount ? 'pass' : passCount > 0 ? 'warn' : 'fail';
        
        const div = document.createElement('div');
        div.className = `audit-item ${status}`;
        div.innerHTML = `
          <div class="audit-icon ${status}">${status === 'pass' ? 'âœ“' : status === 'warn' ? '!' : 'âœ—'}</div>
          <div>
            <strong>${item.name}</strong><br>
            <small>${passCount}/${totalCount} ãƒšãƒ¼ã‚¸ã§åˆæ ¼</small>
          </div>
        `;
        checklist.appendChild(div);
      });
    }

    function displayRecommendations() {
      const recommendations = document.getElementById('recommendations-list');
      recommendations.innerHTML = '';
      
      const issues = [];
      
      // CSSèª­ã¿è¾¼ã¿ã®å•é¡Œ
      const cssIssues = auditResults.filter(r => !r.error && !r.cssLoaded);
      if (cssIssues.length > 0) {
        issues.push({
          title: 'CSSèª­ã¿è¾¼ã¿ã®å•é¡Œ',
          description: `${cssIssues.length}ãƒšãƒ¼ã‚¸ã§CSSèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚CSSãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
          priority: 'high'
        });
      }
      
      // FOUCå¯¾ç­–æœªå®Ÿè£…
      const foucIssues = auditResults.filter(r => !r.error && !r.hasFOUCProtection);
      if (foucIssues.length > 0) {
        issues.push({
          title: 'FOUCå¯¾ç­–ã®æ”¹å–„',
          description: 'styles-loading/styles-loadedã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ãŸFOUCå¯¾ç­–ã‚’å…¨ãƒšãƒ¼ã‚¸ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚',
          priority: 'medium'
        });
      }
      
      // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSæœªå®Ÿè£…
      const criticalIssues = auditResults.filter(r => !r.error && !r.hasCriticalCSS);
      if (criticalIssues.length > 0) {
        issues.push({
          title: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSã®å®Ÿè£…',
          description: 'ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSã‚’è¿½åŠ ã—ã¦åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é«˜é€ŸåŒ–ã§ãã¾ã™ã€‚',
          priority: 'medium'
        });
      }
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ
      const slowPages = auditResults.filter(r => !r.error && parseFloat(r.loadTime) > 1500);
      if (slowPages.length > 0) {
        issues.push({
          title: 'ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é€Ÿåº¦ã®æ”¹å–„',
          description: 'CSSãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–ã€CDNã®ä½¿ç”¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚',
          priority: 'low'
        });
      }
      
      issues.forEach(issue => {
        const div = document.createElement('div');
        div.className = 'recommendation';
        div.innerHTML = `
          <h4>ğŸ”§ ${issue.title} (å„ªå…ˆåº¦: ${issue.priority === 'high' ? 'é«˜' : issue.priority === 'medium' ? 'ä¸­' : 'ä½'})</h4>
          <p>${issue.description}</p>
        `;
        recommendations.appendChild(div);
      });
      
      if (issues.length === 0) {
        recommendations.innerHTML = '<div class="recommendation"><h4>ğŸ‰ ç´ æ™´ã‚‰ã—ã„!</h4><p>ç‰¹ã«æ”¹å–„ãŒå¿…è¦ãªå•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p></div>';
      }
    }

    function generateReport() {
      if (auditResults.length === 0) {
        alert('ã¾ãšç›£æŸ»ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      const reportData = {
        timestamp: new Date().toLocaleString(),
        summary: {
          totalPages: auditResults.length,
          averageLoadTime: (auditResults.reduce((sum, r) => sum + parseFloat(r.loadTime || 0), 0) / auditResults.length).toFixed(2),
          cssSuccessRate: Math.round((auditResults.filter(r => r.cssLoaded).length / auditResults.length) * 100),
          foucProtectionRate: Math.round((auditResults.filter(r => r.hasFOUCProtection).length / auditResults.length) * 100)
        },
        results: auditResults
      };
      
      const reportText = `
# CSSèª­ã¿è¾¼ã¿æ€§èƒ½ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

å®Ÿè¡Œæ—¥æ™‚: ${reportData.timestamp}

## æ¦‚è¦
- ç›£æŸ»å¯¾è±¡ãƒšãƒ¼ã‚¸æ•°: ${reportData.summary.totalPages}
- å¹³å‡èª­ã¿è¾¼ã¿æ™‚é–“: ${reportData.summary.averageLoadTime}ms
- CSSèª­ã¿è¾¼ã¿æˆåŠŸç‡: ${reportData.summary.cssSuccessRate}%
- FOUCå¯¾ç­–å®Ÿè£…ç‡: ${reportData.summary.foucProtectionRate}%

## è©³ç´°çµæœ
${auditResults.map(result => `
### ${result.name}
- URL: ${result.url}
- èª­ã¿è¾¼ã¿æ™‚é–“: ${result.loadTime}ms
- CSSèª­ã¿è¾¼ã¿: ${result.cssLoaded ? 'æˆåŠŸ' : 'å¤±æ•—'}
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSS: ${result.hasCriticalCSS ? 'ã‚ã‚Š' : 'ãªã—'}
- FOUCå¯¾ç­–: ${result.hasFOUCProtection ? 'å®Ÿè£…æ¸ˆã¿' : 'æœªå®Ÿè£…'}
- ç·åˆã‚¹ã‚³ã‚¢: ${result.overallScore}/100
`).join('')}

## æ¨å¥¨äº‹é …
1. å…¨ãƒšãƒ¼ã‚¸ã§CSSèª­ã¿è¾¼ã¿ãŒç¢ºå®Ÿã«å®Œäº†ã™ã‚‹ã‚ˆã†ç›£è¦–ã‚’å¼·åŒ–
2. ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSã®å®Ÿè£…ã§First Paintã‚’æ”¹å–„
3. FOUCå¯¾ç­–ã‚’å…¨ãƒšãƒ¼ã‚¸ã«çµ±ä¸€å®Ÿè£…
4. å®šæœŸçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»ã®å®Ÿæ–½
      `;
      
      const blob = new Blob([reportText], { type: 'text/plain; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `css-performance-audit-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearResults() {
      auditResults = [];
      ['overall-score', 'detailed-metrics', 'audit-items', 'recommendations', 'performance-chart'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }
  </script>
</body>
</html>
