<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v5 CORSä¿®æ­£ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        input[type="url"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ v5-CORS-FINAL-FIX ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="section warning">
            <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
            <ol>
                <li><strong>Google Apps Script</strong> ã§ ç‰©ä»¶.gs ã‚’æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã—ã¦ä½œæˆ</li>
                <li>æ–°ã—ã„ <strong>Web ã‚¢ãƒ—ãƒªã®URL</strong> ã‚’ä¸‹è¨˜ã«è²¼ã‚Šä»˜ã‘</li>
                <li><strong>ã€Œãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆã€</strong> ã§ v5 ãŒç¢ºèªã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆ</li>
                <li><strong>ã€ŒPOST ãƒ†ã‚¹ãƒˆã€</strong> ã§ CORS ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚ŒãŸã‹ãƒ†ã‚¹ãƒˆ</li>
            </ol>
        </div>

        <div class="section">
            <h3>ğŸ”— Google Apps Script URL</h3>            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec" 
                   value="https://script.google.com/macros/s/AKfycbxepQizPpyqJAj7zBd7OE4tu-2FNKjblIVkPCwdR33BHQe7uqkCeIisOvHbEICwTg2Rkw/exec">
            <small>æ³¨æ„: æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã®URLã«æ›´æ–°ã—ã¦ãã ã•ã„</small>
        </div>

        <div class="section">
            <h3>1ï¸âƒ£ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testVersion()">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="versionResult" class="log"></div>
        </div>

        <div class="section">
            <h3>2ï¸âƒ£ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆï¼ˆCORSä¿®æ­£ç¢ºèªï¼‰</h3>
            <button onclick="testPost()">POST ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="postResult" class="log"></div>
        </div>

        <div class="section">
            <h3>3ï¸âƒ£ æœŸå¾…ã™ã‚‹çµæœ</h3>
            <div class="success">
                <strong>âœ… æˆåŠŸæ™‚ã®è¡¨ç¤º:</strong><br>
                - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: "2025-06-06-v5-CORS-FINAL-FIX"<br>
                - POST ãƒ¬ã‚¹ãƒãƒ³ã‚¹: success ã¾ãŸã¯é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸<br>
                - <strong>CORS ã‚¨ãƒ©ãƒ¼ãªã—</strong>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
            <p>ä¸¡æ–¹ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€<code>property_select.html</code> ã® URL ã‚’æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ URL ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            element.textContent += logMessage;
            
            if (isError) {
                element.style.backgroundColor = '#f8d7da';
                element.style.borderColor = '#f5c6cb';
            } else {
                element.style.backgroundColor = '#d4edda';
                element.style.borderColor = '#c3e6cb';
            }
        }

        async function testVersion() {
            const gasUrl = document.getElementById('gasUrl').value;
            const resultDiv = document.getElementById('versionResult');
            resultDiv.textContent = '';
            
            if (!gasUrl) {
                log('versionResult', 'ã‚¨ãƒ©ãƒ¼: Google Apps Script URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            try {
                log('versionResult', 'ğŸ”„ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªãƒ†ã‚¹ãƒˆé–‹å§‹...');
                log('versionResult', `URL: ${gasUrl}?action=getVersion`);
                
                const response = await fetch(`${gasUrl}?action=getVersion`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                log('versionResult', `ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('versionResult', 'âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æˆåŠŸ');
                log('versionResult', `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version || 'å–å¾—å¤±æ•—'}`);
                log('versionResult', `èª¬æ˜: ${data.description || 'ãªã—'}`);
                log('versionResult', `CORSä¿®æ­£æ¸ˆã¿: ${data.corsFixed || 'false'}`);
                log('versionResult', `ContentServiceä½¿ç”¨: ${data.contentServiceUsed || 'false'}`);
                
                if (data.version && data.version.includes('v5-CORS-FINAL-FIX')) {
                    log('versionResult', 'ğŸ‰ v5ä¿®æ­£ç‰ˆãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ï¼');
                } else {
                    log('versionResult', 'âš ï¸ ã¾ã å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚ˆã†ã§ã™ã€‚æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚', true);
                }

            } catch (error) {
                log('versionResult', `âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`, true);
                log('versionResult', 'è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :', true);
                log('versionResult', '- URL ãŒé–“é•ã£ã¦ã„ã‚‹', true);
                log('versionResult', '- æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã¾ã åæ˜ ã•ã‚Œã¦ã„ãªã„', true);
                log('versionResult', '- Google Apps Script ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹', true);
            }
        }

        async function testPost() {
            const gasUrl = document.getElementById('gasUrl').value;
            const resultDiv = document.getElementById('postResult');
            resultDiv.textContent = '';
            
            if (!gasUrl) {
                log('postResult', 'ã‚¨ãƒ©ãƒ¼: Google Apps Script URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            try {
                log('postResult', 'ğŸ”„ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹...');
                log('postResult', 'ã“ã‚ŒãŒæˆåŠŸã™ã‚Œã° CORS å•é¡Œã¯è§£æ±ºã•ã‚Œã¦ã„ã¾ã™');
                
                const testData = {
                    action: 'updateMeterReadings',
                    propertyId: 'TEST001',
                    roomId: '101',
                    readings: [{
                        date: '2025-06-07',
                        currentReading: '12345'
                    }]
                };

                log('postResult', `é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(testData, null, 2)}`);

                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                log('postResult', `ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} ${response.statusText}`);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª
                log('postResult', 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ãƒ˜ãƒƒãƒ€ãƒ¼:');
                for (let [key, value] of response.headers.entries()) {
                    log('postResult', `  ${key}: ${value}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('postResult', 'âœ… POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸï¼CORS ã‚¨ãƒ©ãƒ¼ã¯è§£æ±ºã•ã‚Œã¾ã—ãŸï¼');
                log('postResult', `ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    log('postResult', 'ğŸ‰ æ¤œé‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚‚æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼');
                } else if (data.error) {
                    log('postResult', `âš ï¸ æ¥­å‹™ã‚¨ãƒ©ãƒ¼ (CORSã¯è§£æ±ºæ¸ˆã¿): ${data.error}`);
                }

            } catch (error) {
                if (error.message.includes('CORS')) {
                    log('postResult', `âŒ CORS ã‚¨ãƒ©ãƒ¼ãŒã¾ã ç™ºç”Ÿã—ã¦ã„ã¾ã™: ${error.message}`, true);
                    log('postResult', 'ä¿®æ­£ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:', true);
                    log('postResult', '- æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ãªã„', true);
                    log('postResult', '- URLãŒå¤ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’æŒ‡ã—ã¦ã„ã‚‹', true);
                } else {
                    log('postResult', `âŒ ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                }
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('versionResult', 'è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
                testVersion();
            }, 1000);
        });
    </script>
</body>
</html>
